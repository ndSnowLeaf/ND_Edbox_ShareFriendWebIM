define("spellpoem/directive/spellpoem.directive",["components/site-directive/assets-select/assets-select","components/site-directive/error-tip/error-tip","components/site-directive/edit-box/new-edit-box","components/site-directive/foot-tool/time-box/new-time-box","components/site-directive/foot-tool/foot-tool","components/site-services/charset.service"],function(){}),define(["app","spellpoem/directive/spellpoem.directive"],function(app){"use strict";app.controller("spellpoem_ctrl",["$scope","skin_service","$stateParams","CustomEditorService","CharsetService","$rootScope","$filter","$timeout",function($scope,skin_service,$stateParams,CustomEditorService,CharsetService,$rootScope,$filter,$timeout){function canClean(){return!!$scope.model.content.title}function getChineseChars(str,length){if(str&&"string"==typeof str){var changeText=CharsetService.getChineses(str);return changeText=changeText.substring(0,length)}return str}function voidPoemInfos(showGenerate){var hasTitle=validStr($scope.model.content.title),hasAuthor=validStr($scope.model.content.author),hasPoemtry=validPoemBody(),tips="";return hasTitle?hasAuthor?hasPoemtry||(tips=$filter("translate")("spellpoem.please")+$filter("translate")("spellpoem.poem_body")+$filter("translate")("spellpoem.exclamation_mark")):tips=hasPoemtry?$filter("translate")("spellpoem.please")+$filter("translate")("spellpoem.poem_author")+$filter("translate")("spellpoem.exclamation_mark"):$filter("translate")("spellpoem.please")+$filter("translate")("spellpoem.poem_author")+$filter("translate")("spellpoem.stop_mark")+$filter("translate")("spellpoem.poem_body")+$filter("translate")("spellpoem.exclamation_mark"):tips=hasAuthor?hasPoemtry?$filter("translate")("spellpoem.please")+$filter("translate")("spellpoem.poem_title")+$filter("translate")("spellpoem.exclamation_mark"):$filter("translate")("spellpoem.please")+$filter("translate")("spellpoem.poem_title")+$filter("translate")("spellpoem.stop_mark")+$filter("translate")("spellpoem.poem_body")+$filter("translate")("spellpoem.exclamation_mark"):hasPoemtry?$filter("translate")("spellpoem.please")+$filter("translate")("spellpoem.poem_title")+$filter("translate")("spellpoem.stop_mark")+$filter("translate")("spellpoem.poem_author")+$filter("translate")("spellpoem.exclamation_mark"):$filter("translate")("spellpoem.please")+$filter("translate")("spellpoem.poem_title")+$filter("translate")("spellpoem.stop_mark")+$filter("translate")("spellpoem.poem_author")+$filter("translate")("spellpoem.stop_mark")+$filter("translate")("spellpoem.poem_body")+$filter("translate")("spellpoem.exclamation_mark"),tips}function validStr(str){if(str&&"string"==typeof str){var strTrim=str.trim();return""!==strTrim}return!1}function validPoemBody(){if(void 0===$scope.model.content.sentences)return!1;for(var flag=!1,length=$scope.model.content.sentences.length,i=0;i<length;i++){var words=$scope.model.content.sentences[i].words.trim();if(""!==words){flag=!0;break}}return flag}function showErrorTips(text,delay){if(void 0!==delay&&0!==delay||(delay=1e3),null!==text&&void 0!==text&&""!==text)try{$scope.errorModel.errorText=text,$scope.errorModel.dismissErrorTip(delay)}catch(err){}}$rootScope.moduleScope=$scope,$scope.errorModel={},$scope.model={id:"",module_code:"nd_spellpoem",title:"",skin:{code:"wood",css_url:"${ref-path}/edu/esp/preparecustomeditor/spellpoem/wood/css/wood.css",name:$filter("translate")("app.skin.wood"),package_url:"${ref-path}/edu/esp/preparecustomeditor/spellpoem/wood"},timer:{timer_type:"countdown",time_minute:"1",time_second:"0"},properties:[{name:"question_id",display_name:"题目ID",type:"string",value:"",is_localized:!1},{name:"question_url",display_name:"题目内容",type:"jsonFile",value:"",is_localized:!1}],content:{title:"登鹳雀楼",author:"王之涣",dynasty:"",sentences:[{words:"白日依山尽"},{words:"黄河入海流"},{words:"欲穷千里目"},{words:"更上一层楼"}],hasedited:!1}};var loadingData=function(id){$scope.isloadingData=!0,CustomEditorService.getQuestionInfoById(id).then(function(rtnData){rtnData?(""!=rtnData.skin.code?$scope.model=$scope.decodeData(rtnData,!0):($scope.model.id=rtnData.id,$scope.generatePoemBody()),skin_service.set_skin_by_code($scope.model.skin.code,"v1"),$scope.errorModel.errorText="",$scope.isloadingData=!1):$scope.errorModel.errorText=$filter("translate")("app.unvalidno")},function(error){$scope.errorModel.errorText=$filter("translate")("app.question.get.error")})};$stateParams.id?loadingData($stateParams.id):skin_service.set_skin_by_code($scope.model.skin.code,"v1"),$scope.$on("changgedSkin",function(){$rootScope.scaleHtml()}),$scope.validPostData=function(){var regExp=/[^\u4e00-\u9fa5]+/g,isTitleTxtChineseChar=!0,titleTxt=$scope.model.content.title;if(regExp.test(titleTxt)&&(isTitleTxtChineseChar=!1),!isTitleTxtChineseChar)return void showErrorTips($filter("translate")("spellpoem.tips.titileOnlyChinese"),1e3);var authorTxt=$scope.model.content.author,isAuthorTxtChineseChar=!0;if(regExp.test(authorTxt)&&(isAuthorTxtChineseChar=!1),!isAuthorTxtChineseChar)return void showErrorTips($filter("translate")("spellpoem.tips.authorOnlyChinese"),1e3);for(var isSentencesChineseChar=!0,tmpWords="",i=0;i<$scope.model.content.sentences.length;++i)if(tmpWords=$scope.model.content.sentences[i].words,regExp.test(tmpWords)){isSentencesChineseChar=!1;break}if(!isSentencesChineseChar)return void showErrorTips($filter("translate")("spellpoem.tips.contentOnlyChinese"),1e3);for(var hasBlankRow=!1,i=0;i<$scope.model.content.sentences.length;++i)""===$scope.model.content.sentences[i].words.trim()&&(hasBlankRow=!0);if(hasBlankRow)return void showErrorTips($filter("translate")("spellpoem.tips.noBlankLine"),1e3);if(validStr($scope.model.title)||($scope.model.title="这是古诗的title信息"),validStr($scope.model.title)){var tips=voidPoemInfos(!1);return""===tips||(showErrorTips(tips,0),!1)}return showErrorTips($filter("translate")("spellpoem.no_title"),0),!1},$scope.encodeData=function(model){return model.content.hasedited||(model.content.hasedited=!0),$(".com_pop_nubuck").hide(),model},$scope.decodeData=function(model,isInitLoad){return model},$scope.wordsMaxThan8=!1,$scope.poemTitleLength=15,$scope.poemAuthorLength=8,$scope.poemSentenceLength=10;var firstOnFocus=!1,DEFAULT_TITLE=$filter("translate")("spellpoem.title_tips");$scope.addLine=function(){var currentLength=$scope.model.content.sentences.length;currentLength<10&&($scope.model.content.sentences[currentLength]={words:""}),$(".poem_list2").animate({scrollTop:$(".btn_add").offset().top},2)},$scope.generatePoemBody=function(){var tips=voidPoemInfos(!0);""!==tips&&showErrorTips(tips,0)},$scope.cleanPoemBody=function(){canClean()&&$(".com_pop_nubuck").show()},$scope.cleanPoemBodyOk=function(){$(".com_pop_nubuck").hide(),$scope.model.content.title="",$scope.model.content.author="",$scope.model.content.hasedited=!1,$scope.model.content.sentences=new Array;for(var i=0;i<4;i++)$scope.model.content.sentences[i]={words:""}},$scope.cleanPoemBodyCancel=function(){$(".com_pop_nubuck").hide()},$scope.checkPoemTitle=function(){var text=$scope.model.content.title;$scope.model.content.title=getChineseChars(text,$scope.poemTitleLength)},$scope.checkPoemAuthor=function(){var text=$scope.model.content.author;$scope.model.content.author=getChineseChars(text,$scope.poemAuthorLength)},$scope.checkPoemSentence=function(index){console.log("keypress");var sentenceWords=angular.copy($scope.model.content.sentences[index].words);console.log(sentenceWords),sentenceWords=getChineseChars(sentenceWords,$scope.poemSentenceLength),$scope.model.content.sentences[index].words=sentenceWords},$scope.checkPoemSentence2=function(index){console.log("keydown");var sentence=$scope.model.content.sentences[index];console.log(sentence),sentence&&(sentence.words=getChineseChars(sentence.words,$scope.poemSentenceLength))},$scope.checkPoemSentence3=function(index){console.log("blur");var sentence=$scope.model.content.sentences[index];sentence&&(sentence.words=getChineseChars(sentence.words,$scope.poemSentenceLength))},$scope.contentFocus=function(){firstOnFocus||$scope.model.content.hasedited||(firstOnFocus=!0,$scope.cleanPoemBody())},$scope.focusOnTitle=function($event){$.trim($scope.model.title)==DEFAULT_TITLE&&($scope.model.title="",$($event.target).css({color:""}))},$scope.blurOnTitle=function($event){$scope.model.title||($scope.model.title=DEFAULT_TITLE,$($event.target).css({color:"#D3D3D3"}))}}])});