define("classified/directive/classification-item/classification-item",["angularAMD"],function(angularAMD){angularAMD.directive("classificationItem",[function(){return{restrict:"E",replace:!0,templateUrl:"interaction/classified/directive/classification-item/classification-item.html",scope:{itemData:"=itemData",itemsData:"=itemsData"},controller:["$scope","$rootScope","$timeout","$filter","CharsetService",function($scope,$rootScope,$timeout,$filter,CharsetService){$scope.CARD_TYPE={IMAGE:"image",TEXT:"text"},$scope.PLACE_HOLDER=$filter("translate")("classified.class_name_placeholder"),$scope.OPTION_PLACE_HOLDER=$filter("translate")("classified.option_text_placeholder"),$scope.CARD_MAX_SIZE=6,$scope.CARD_TEXT_MAXLEN=15,$scope.wordTipStyle={float:"right"},$.isArray($scope.itemData.items)||($scope.itemData.items=[]),$scope.getTextBytes=function(text){return CharsetService.getTextBytes(text)},$scope.itemNameLength=$scope.getTextBytes($scope.itemData.name),$scope.$watch("itemData.name",function(){$scope.itemNameLength=$scope.getTextBytes($scope.itemData.name)}),$scope.removeCategory=function(){$rootScope.moduleScope.openDelCategoryPopBox($scope.itemData)},$scope.addItemCard=function(card_type,$event){(!$scope.itemData.items||$scope.itemData.items.length<$scope.CARD_MAX_SIZE)&&($scope.itemData.items.push({type:card_type,content:""}),$timeout(function(){card_type===$scope.CARD_TYPE.IMAGE?($($event.target).parents(".list_box").find("li .list_text:last").blur(),$($event.target).parents(".list_box").find("li .list_img:last").click()):$($event.target).parents(".list_box").find("li .list_text:last").focus()},100))},$scope.removeCard=function(index){$scope.itemData.items.splice(index,1)},$scope.afterAddAssets=function(card,index){card.content||$scope.itemData.items.splice(index,1)},$scope.resourceValidParam={imageType:["image/jpg","image/jpeg","image/webp","image/gif","image/png","image/bmp"],imageSize:1048576}}]}}])}),define("classified/directive/classified.directive",["components/site-directive/assets-select/assets-select","components/site-directive/edit-box/new-edit-box","components/site-directive/foot-tool/time-box/new-time-box","components/site-directive/foot-tool/foot-tool","components/site-directive/error-tip/error-tip","components/site-directive/contenteditable/contenteditable","components/site-directive/text-editor/text-editor","classified/directive/classification-item/classification-item","components/site-services/utils.service","components/site-services/charset.service"],function(){}),define(["app","classified/directive/classified.directive"],function(app){"use strict";app.controller("classified_ctrl",["$scope","skin_service","$stateParams","CustomEditorService","UtilsService","$rootScope","$filter","$timeout",function($scope,skin_service,$stateParams,CustomEditorService,UtilsService,$rootScope,$filter,$timeout){function setInvalidAttr(entity,attr){entity[attr]=!0,$timeout(function(){entity[attr]=!1},2500)}$scope.errorModel={},$scope.model={title:"",skin:{code:"wood",css_url:"${ref-path}/edu/esp/preparecustomeditor/classified/wood/css/wood.css",name:$filter("translate")("classified.muwen"),package_url:"${ref-path}/edu/esp/preparecustomeditor/classified/wood"},timer:{timer_type:"sequence",time_minute:"0",time_second:"0"},categories:[{},{}],classified_options:[]},$rootScope.moduleScope=$scope,$scope.defaultTitleSetting={isCleared:!1,title:$filter("translate")("classified.default.title")},$scope.model.title=$scope.defaultTitleSetting.title,$scope.MIN_SIZE=2,$scope.MAX_SIZE=5;var loadingData=function(id){$scope.isloadingData=!0,CustomEditorService.getQuestionInfoById(id).then(function(rtnData){rtnData?(""!=rtnData.skin.code?($scope.model=$scope.decodeData(rtnData),skin_service.set_skin_by_code($scope.model.skin.code,"v1")):($scope.model.id=rtnData.id,skin_service.set_skin_by_code($scope.model.skin.code,"v1")),$scope.errorModel.errorText="",$scope.isloadingData=!1,setValues()):$scope.errorModel.errorText=$filter("translate")("classified.unvalidno")},function(error){$scope.errorModel.errorText=$filter("translate")("classified.get_title_error")})},setValues=function(){};$stateParams.id?loadingData($stateParams.id):(skin_service.set_skin_by_code($scope.model.skin.code,"v1"),setValues()),$scope.$on("changgedSkin",function(){$rootScope.scaleHtml()}),$scope.validPostData=function(){$scope.errorModel.errorText="";var modelData=$scope.model;if(""!==$.trim(modelData.title)){var isValid=!0;if((!modelData.categories||modelData.categories.length<2)&&($scope.errorModel.errorText=$filter("translate")("classified.class_mincount_hint"),isValid=!1),isValid){var categoryName=[];angular.forEach(modelData.categories,function(category,categoryIndex){if(isValid){if(!category.name||""==category.name)return $(".classify_title:eq("+categoryIndex+")").focus(),setInvalidAttr(category,"invalidName"),$scope.errorModel.errorText=$filter("translate")("classified.classname_is_empty",{classIndex:categoryIndex+1}),isValid=!1,!1;if(categoryName[category.name])return $scope.errorModel.errorText=$filter("translate")("classified.classname_duplicated",{classIndexI:categoryName[category.name],classIndexJ:categoryIndex+1}),isValid=!1,!1;if(!category.items||category.items.length<1)return setInvalidAttr(category,"invalid"),$scope.errorModel.errorText=$filter("translate")("classified.card_mincount_hint"),isValid=!1,!1;if(angular.forEach(category.items,function(item,itemIndex){if(!item.content||""==item.content)return"image"==item.type?$scope.errorModel.errorText=$filter("translate")("classified.imagecard_empty_hint",{classIndex:categoryIndex+1,cardIndex:itemIndex+1}):(setInvalidAttr(item,"invalidContent"),$scope.errorModel.errorText=$filter("translate")("classified.textcard_empty_hint",{classIndex:categoryIndex+1,cardIndex:itemIndex+1})),isValid=!1,!1}),!isValid)return!1;categoryName[category.name]=categoryIndex+1}})}return isValid}$scope.errorModel.errorText=$filter("translate")("classified.no_title"),$("#modelTitle").focus(),setInvalidAttr($scope,"invalidTitle")};var categoryIdPrefix="C",itemIdPrefix="I";$scope.encodeData=function(model){var newModel=angular.copy(model);return newModel.classified_options=[],angular.forEach(newModel.categories,function(category,index){category.id=categoryIdPrefix+(index+1);var itemidArray=[];angular.forEach(category.items,function(item,itemIndex){item.id=category.id+itemIdPrefix+(itemIndex+1),itemidArray.push(item.id),newModel.classified_options.push(item)}),category.items=itemidArray}),UtilsService.shuffleArray(newModel.classified_options),newModel},$scope.decodeData=function(model){var newModel=angular.copy(model),optionsMap=[];return angular.forEach(newModel.classified_options,function(item){optionsMap[item.id]=item}),angular.forEach(newModel.categories,function(category){var items=[];angular.forEach(category.items,function(item){items.push(optionsMap[item])}),category.items=items}),newModel},$scope.addCategory=function(){$scope.model.categories.push({items:[]})},$scope.removeCategory=function(){$scope.model.categories.splice($.inArray($scope.category2Deleted,$scope.model.categories),1),$scope.closeDelCategoryPopBox()},$scope.delCategoryPopBoxTitle=$filter("translate")("app.label.tip"),$scope.openDelCategoryPopBox=function(category){$scope.category2Deleted=category,$scope.delCategoryPopBoxText=$filter("translate")("classified.delete_class_confirm",{categoryName:$scope.category2Deleted.name}),$scope.delCategoryPopBoxVisible=!0},$scope.closeDelCategoryPopBox=function(){$scope.delCategoryPopBoxVisible=!1},$scope.sortCategoryItem={handle:"> div.sort_handler",start:function(e,ui){ui.item.sortable.model||ui.item.sortable.cancel()},stop:function(e,ui){ui.item.scope().$index}}}])});