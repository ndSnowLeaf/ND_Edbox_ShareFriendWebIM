define("fillblank/directive/contenteditable/contenteditable",["angularAMD"],function(angularAMD){angularAMD.directive("contenteditable",[function(){return{require:"?ngModel",link:function(scope,element,attrs,ctrl){ctrl&&(element.bind("input enterKey",function(){var rerender=!1,html=element.html();attrs.noLineBreaks&&(html=html.replace(/<div>/g,"").replace(/<br>/g,"").replace(/<\/div>/g,""),rerender=!0),scope.$apply(function(){ctrl.$setViewValue(html),rerender&&ctrl.$render()})}),element.keyup(function(e){13===e.keyCode&&element.trigger("enterKey")}),ctrl.$render=function(){element.html(ctrl.$viewValue)},ctrl.$render())}}}])}),define("fillblank/directive/setfocus/setfocus",["angularAMD"],function(angularAMD){angularAMD.directive("setfocus",[function(){return function(scope,element){element[0].focus()}}])}),define("fillblank/directive/fillblank.directive",["components/site-directive/foot-tool/time-box/new-time-box","components/site-directive/foot-tool/foot-tool","components/site-directive/edit-box/new-edit-box","components/site-directive/error-tip/error-tip","fillblank/directive/contenteditable/contenteditable","fillblank/directive/setfocus/setfocus"],function(){}),define(["app","fillblank/directive/fillblank.directive"],function(app){"use strict";app.controller("fillblank_ctrl",["$scope","skin_service","$stateParams","CustomEditorService","$rootScope","$filter","$timeout",function($scope,skin_service,$stateParams,CustomEditorService,$rootScope,$filter,$timeout){function getCharacterSize(text,flag){for(var size=0,len=text.length,i=0;i<len;i++){var a=text.charAt(i);size+=null!=a.match(/[^\x00-\xff]/gi)?2:1}return size}function isEnabledCode(code){var isEnabled=!1;return isEnabled=code>64&&code<91||(code>47&&code<58||(code>95&&code<108||(code>108&&code<112||(code>185&&code<223||(229==code||32==code)))))}function countContent(s){var text=s||$(".side_titinp").text();return getCharSize(text)}function getCharSize(str){for(var characterSize=0,i=0,len=str.length;i<len;i++)str.charCodeAt(i)>255?characterSize+=2:characterSize++;return characterSize}function translateContent(content){return content=content.replace(/&/g,"&amp;"),content=content.replace(/</g,"&lt;"),content=content.replace(/>/g,"&gt;")}function getContentByHtml(text){var index=0;return $(".side_titinp").find("ins.selected").each(function(){$(this).attr("data-num",index++)}),text?$(".side_titinp").text():$(".side_titinp").html()}function checkData(range){return range.startContainer==range.endContainer&&("PRE"==range.startContainer.parentElement.tagName||"DIV"==range.startContainer.parentElement.tagName)}function getContent(){var article=$scope.model.article,candidates=$scope.model.candidates;for(var idx in candidates)article=article.replace("{"+candidates[idx].num+"}",function(){return'<ins class="selected" data-num="'+candidates[idx].num+'" contenteditable="false">'+candidates[idx].value+"</ins>"});return article}function resetOptionNum(content){var count=0;return content=content.replace(/data-num="\d+"/g,function(){return'data-num="'+count++ +'"'})}function setCandidateFormContent(s){var options=$(".side_titinp ins.selected"),newCandidates=[],candidates=$scope.model.candidates,count=0;"string"==typeof s&&(options=$("<div>"+s+"</div>").find("ins.selected")),options.each(function(){var size=0;size=getCharacterSize($(this).text(),!0),newCandidates.push({num:$(this).data("num"),value:$(this).text(),size:size,readOnly:1}),count++}),angular.forEach(candidates,function(candidate,key){candidate.num===-1&&newCandidates.push(candidate)}),$scope.model.candidates=newCandidates,$scope.view.options=count}function countOptions(interfere){var count=0,interfereCount=0;return angular.forEach($scope.model.candidates,function(candidate,key){candidate.num!==-1?count++:interfereCount++}),interfere?interfereCount:count}function delOption(candidate){if(candidate.num!==-1){var value=translateContent(candidate.value),target='<ins class="selected" data-num="'+candidate.num+'" contenteditable="false">'+value+"</ins>",content=getContentByHtml().replace(target,function(){return value});content=resetOptionNum(content),setCandidateFormContent(content),$scope.view.content=content}else delCandidate(candidate)}function hideAddButton(){$scope.view.left=0,$scope.view.top=0,$scope.view.showButton=!1}function addInvalidCandidate(){var candidate={num:-1,value:"",size:1,readOnly:0,isFull:!1};$scope.model.candidates.push(candidate),$scope.view.interfereOptions++}function isInCorrectCandidates(value,candidates){var isIn=!1;return angular.forEach(candidates,function(data,index){data.value==value&&data.num!==-1&&(isIn=!0)}),isIn}function isInWrongCandidates(value,candidates){var isIn=!1;return angular.forEach(candidates,function(data,index){data.value==value&&data.num===-1&&(isIn=!0)}),isIn}function delCandidate(candidate){var candidates=$scope.model.candidates;candidates.splice(candidates.indexOf(candidate),1),candidate.num===-1?$scope.view.interfereOptions--:$scope.view.options--}function checkSubLength(s){var text=s||$(".side_titinp").text();return countContent(text)<=$scope.limitSpace.MAX_CONTENT_SIZE}$scope.errorModel={},$scope.model={title:"",skin:{code:"wood",css_url:"${ref-path}/edu/esp/preparecustomeditor/fillblank/wood/css/wood.css",name:$filter("translate")("fillblank.muwen"),package_url:"${ref-path}/edu/esp/preparecustomeditor/fillblank/wood"},timer:{timer_type:"sequence",time_minute:0,time_second:0},article:"",candidates:[]},$rootScope.moduleScope=$scope,$scope.defaultTitleSetting={isCleared:!1,title:$filter("translate")("fillblank.default.title")},$scope.model.title=$scope.defaultTitleSetting.title,$scope.view={left:0,top:0,interfereOptions:0,options:0,selection:null,showButton:!1,buttonActive:!1,content:getContent(),contentSize:0,size:1,curLength:0,isFull:!1},$scope.handle={},$scope.limitSpace={MAX_CONTENT_SIZE:1e3,MAX_OPTION_SIZE:20,MAX_CHARACTOR_NUM:40,MAX_CORRECT_OPTIONS:1,CHINESE_PUNCTUATION:"·-=、】【；‘、。，~！@#￥%……&*（）——+|}{“：？》《"};var helper={startContainer:null,startOffset:null,textLength:null,nodeIndex:null,oldLength:null},loadingData=function(id){CustomEditorService.getQuestionInfoById(id).then(function(rtnData){rtnData?(""!=rtnData.skin.code?($scope.model=$scope.decodeOrder(rtnData),$scope.view.content=getContent(),$scope.view.options=countOptions(),$scope.view.interfereOptions=countOptions("interfere"),setTimeout(function(){$scope.view.contentSize=countContent()},0)):$scope.model.id=rtnData.id,$scope.errorModel.errorText="",skin_service.set_skin_by_code($scope.model.skin.code,"v1")):$scope.errorModel.errorText=$filter("translate")("fillblank.unvalidno")},function(){$scope.errorModel.errorText=$filter("translate")("fillblank.get_title_error")})};$stateParams.id?loadingData($stateParams.id):skin_service.set_skin_by_code($scope.model.skin.code,"v1"),$scope.$on("changgedSkin",function(){$rootScope.scaleHtml()}),$(".side_titinp")[0].oncontextmenu=function(){return!1},$scope.handle.startSelect=function(e){window.getSelection().removeAllRanges(),$scope.view.showButton=!1,$scope.view.selection=null},$scope.handle.endSelect=function(e){var selection=window.getSelection();$scope.view.showButton=!1,""!=selection.toString()&&($scope.view.selection=selection,$scope.view.left=e.pageX,$scope.view.top=e.pageY-30,$scope.view.showButton=!0)},$scope.handle.cancel=function(){$scope.view.buttonActive||hideAddButton()},$scope.handle.addOption=function(){if(!($scope.view.options<10))return $scope.errorModel.errorText=$filter("translate")("fillblank.maxcount_hint"),!1;var selection=window.getSelection(),range=selection.getRangeAt(0),isInWrong=isInWrongCandidates(range.toString(),$scope.model.candidates),temp="";if(hideAddButton(),isInWrong)return $scope.errorModel.errorText=$filter("translate")("fillblank.repeat_with_wrong_answer"),void window.getSelection().removeAllRanges();if(!checkData(range))return $scope.errorModel.errorText=$filter("translate")("fillblank.body_error"),void window.getSelection().removeAllRanges();var selected=range.toString();if(selected.length>$scope.limitSpace.MAX_OPTION_SIZE)return $scope.errorModel.errorText=$filter("translate")("fillblank.maxlen_option"),void window.getSelection().removeAllRanges();if(selected.length){var num=$(".side_titinp").find("ins.selected").length+1,ins=document.createElement("ins");ins.className="selected",ins.setAttribute("data-num",num),ins.setAttribute("contenteditable","false"),range.surroundContents(ins),range.insertNode(ins);var temp=resetOptionNum(getContentByHtml());$scope.view.content=temp,setCandidateFormContent(temp),$timeout(function(){var container=$(".side_titinp")[0];if("INS"==container.lastChild.nodeName){container.appendChild(document.createTextNode(" "));var newRange=document.createRange();newRange.setStart(container,container.childNodes.length-1),newRange.collapse(!0),selection=window.getSelection(),selection.removeAllRanges(),selection.addRange(newRange)}})}},$scope.handle.addInvalidOption=function(){addInvalidCandidate(),$scope.view.curLength=0},$scope.handle.endEdit=function(candidate,e){var isInCorrect=isInCorrectCandidates(candidate.value,$scope.model.candidates);$scope.view.curLength=0,""===candidate.value?delCandidate(candidate):candidate.value.replace(/<(?:.|\s)*?>/g,"").length>$scope.limitSpace.MAX_OPTION_SIZE?($scope.errorModel.errorText=$filter("translate")("fillblank.maxlen_xoption"),delCandidate(candidate)):isInCorrect?($scope.errorModel.errorText=$filter("translate")("fillblank.repeat_with_correct_answer"),delCandidate(candidate)):candidate.readOnly=1},$scope.handle.checkInvalidLength=function(candidate,e){var value=candidate.value,len=value.length,size=0;$scope.view.curLength=len,size=getCharacterSize(value,!1),len>$scope.limitSpace.MAX_OPTION_SIZE&&($scope.errorModel.errorText=$filter("translate")("fillblank.maxlen_xoption")),size<1?candidate.size=1:size>$scope.limitSpace.MAX_CHARACTOR_NUM?candidate.size=$scope.limitSpace.MAX_CHARACTOR_NUM:candidate.size=size},$scope.handle.changeSize=function(candidate,e){candidate.isFull=!1,candidate.value.length<$scope.limitSpace.MAX_OPTION_SIZE?isEnabledCode(e.keyCode)&&(candidate.size+=1):8!=e.keyCode&&(candidate.isFull=!0,$scope.errorModel.errorText=$filter("translate")("fillblank.maxlen_xoption"))},$scope.handle.delOption=function(candidate){delOption(candidate)},$scope.handle.pasteContent=function(e){var oldContent=$.trim(getContentByHtml()),oldContentText=getContentByHtml(!0),selection=window.getSelection(),range=selection.getRangeAt(0);range.startContainer;setTimeout(function(){var content=getContentByHtml(),contentText=content.replace(/<(?:.|\s)*?>/g,"");checkSubLength(contentText)||($scope.errorModel.errorText=$filter("translate")("fillblank.maxlen_hint"),$scope.view.isFull=!0),""===oldContent?content=contentText:(content=content.replace(/(<pre[^>]*>)(.*?)(<\/pre[^>]*>)/gi,function(match,n1,n2,n3){return n2?n1+n2.replace(/<(?:.|\s)*?>/g,"")+n3:match}),content=content.replace(/<(?!ins)(?!\/ins)[^>]*>/gi,""),content=content.replace(/<ins class="selected" data-num="\d+" style=".*?">(.*?)<\/ins>/gi,"$1")),content=content.replace(/&nbsp;/g," "),content=content.replace(/(\n|\r)/g,"");content.length-oldContentText.length;content=resetOptionNum(content),setCandidateFormContent(content),$(".side_titinp").html(content),$scope.view.contentSize=countContent()},0)},$scope.handle.editWithKeyboard=function(e){hideAddButton();var range,selection,startNode,container=$(".side_titinp")[0];container.textContent;if(86===e.keyCode&&e.ctrlKey===!0){selection=window.getSelection(),range=selection.getRangeAt(0);var startNode=container.childNodes[helper.nodeIndex],newRange=document.createRange();startNode&&3===startNode.nodeType?newRange.setStart(startNode,helper.startOffset+startNode.length-helper.oldLength):newRange.setStart(container.childNodes[0],container.childNodes[0].length),newRange.collapse(!0),selection.removeAllRanges(),selection.addRange(newRange),console.log(window.getSelection().getRangeAt(0))}if(8===e.keyCode||46===e.keyCode||e.ctrlKey&&88===e.keyCode){var content=(container.childNodes.length,getContentByHtml());setCandidateFormContent(content),$timeout(function(){"INS"==container.lastChild.nodeName&&container.appendChild(document.createTextNode(" "));for(var len=container.childNodes.length,i=0;i<len;i++){var curNode=container.childNodes[i],curLen=curNode.textContent.length;if(3==curNode.nodeType&&curNode.nextSibling&&3==curNode.nextSibling.nodeType){curNode.textContent+=curNode.nextSibling.textContent,container.removeChild(curNode.nextSibling),range=document.createRange(),range.setStart(curNode,curLen),range.collapse(!0),selection=window.getSelection(),selection.removeAllRanges(),selection.addRange(range);break}}})}$scope.view.contentSize=countContent()},$scope.handle.editCheck=function(e){if($scope.view.isFull=!1,isEnabledCode(e.keyCode)){var len=countContent();if(len>=$scope.limitSpace.MAX_CONTENT_SIZE&&(setTimeout(function(){$scope.view.isFull=!0},0),$scope.errorModel.errorText=$filter("translate")("fillblank.maxlen_hint")),86===e.keyCode&&e.ctrlKey===!0)for(var range=window.getSelection().getRangeAt(0),childNodes=$(".side_titinp")[0].childNodes,i=0,len=childNodes.length;i<len;i++)range.startContainer.isSameNode(childNodes[i])&&(helper.nodeIndex=i,helper.startOffset=range.startOffset,helper.oldLength=range.startContainer.length)}},$scope.handle.activeButton=function(){$scope.view.buttonActive=!0},$scope.handle.inactiveButton=function(){$scope.view.buttonActive=!1},$scope.validPostData=function(){var modelData=$scope.model;return""==$.trim(modelData.title)?($scope.errorModel.errorText=$filter("translate")("fillblank.no_title"),!1):""==$.trim(getContentByHtml())?($scope.errorModel.errorText=$filter("translate")("fillblank.no_words"),!1):$scope.view.options<$scope.limitSpace.MAX_CORRECT_OPTIONS?($scope.errorModel.errorText=$filter("translate")("fillblank.mincount_hint"),!1):$scope.view.options>10?($scope.errorModel.errorText=$filter("translate")("fillblank.maxcount_hint"),!1):!!checkSubLength()||($scope.errorModel.errorText=$filter("translate")("fillblank.maxlen_hint"),!1)},$scope.encodeOrder=function(model){var model=angular.copy(model),content=getContentByHtml(),reg=/<ins class="selected" data-num="(\d+)" contenteditable="false">.*?<\/ins>/g;model.article=content.replace(reg,"{$1}");for(var i in model.candidates)delete model.candidates[i].size,delete model.candidates[i].readOnly,delete model.candidates[i].curLength,delete model.candidates[i].isFull;return model},$scope.decodeOrder=function(data){var model=angular.copy(data);for(var i in model.candidates)model.candidates[i].readOnly=1;return model}}])});