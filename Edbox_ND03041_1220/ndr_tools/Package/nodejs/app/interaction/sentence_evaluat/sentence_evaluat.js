define("sentence_evaluat/utils",[],function(){return String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),{removeItemByValue:function(arr,value){if(arr.length>0){var tempIndex=arr.indexOf(value);tempIndex>-1&&arr.splice(tempIndex,1)}}}}),define("sentence_evaluat/directive/select",["angularAMD"],function(angularAMD){angularAMD.directive("unitSelect",["sentenceService",function(sentenceService){return{restrict:"E",templateUrl:"interaction/sentence_evaluat/directive/select.html",scope:{content:"=content"},replace:!0,link:function(scope,element,attrs){scope.opts={menuShow:!1},scope.showSentencesById=function(id){scope.content.show_sentences=sentenceService.getSentencesByUnit(id),scope.content.current_unit=id}}}}])}),define("sentence_evaluat/contenteditable",["angularAMD","components/site-services/utils.service"],function(angularAMD){angularAMD.directive("contenteditable",["UtilsService",function(UtilsService){return{require:"?ngModel",restrict:"A",link:function(scope,element,attr,ngModel){function readViewText(){if("true"===attr.escapseHtml||attr.escapseHtml===!0){var isMaxLen=isExceedMaxLen(!1),text=element.text();isMaxLen&&(text=text.substr(0,maxLength)),ngModel.$setViewValue(text),text!=element.html()&&ngModel.$render(),(onPurePaste||isMaxLen)&&(onPurePaste=!1,UtilsService.moveCursor2End(element[0]))}else{var html=element.html();ngModel.$setViewValue(html)}}function isExceedMaxLen(includeEqual){if(maxLength){var textlength=element.text().length;return textlength>maxLength||textlength>=maxLength&&includeEqual}return!1}if(ngModel&&!element.is("input")&&!element.is("textarea")){ngModel.$render=function(){element.html(ngModel.$viewValue||"")},element.on("blur keyup change",function(event){("blur"==event.type||!isPinyin||isPinyin&&"32"==event.which)&&(event.which<37||event.which>40)&&UtilsService.safeApply(scope,readViewText)});var isPinyin,onPurePaste=!1;element.on("keydown",function(event){if(isPinyin=229==event.which||197==event.which,isExceedMaxLen(!0)){var selection=window.getSelection();if(selection.isCollapsed&&8!=event.which&&46!=event.which&&(event.which<112||event.which>123)&&(event.which<37||event.which>40))return event.cancelable=!0,event.preventDefault(),!1}}).on("paste",function(event){""===element.text()&&(onPurePaste=!0)});var maxLength=attr.maxlength}}}}])}),define("sentence_evaluat/directive/sentence_evaluat.directive",["angularAMD","lifecycle.service","components/site-directive/assets-select/assets-select","components/site-directive/error-tip/error-tip","components/site-directive/edit-box/new-edit-box","components/site-directive/foot-tool/time-box/new-time-box","components/site-directive/foot-tool/foot-tool","sentence_evaluat/directive/select","sentence_evaluat/contenteditable"],function(angularAMD){var sentences1=[{id:"1",isUserAdd:!1,parentId:"001001",sentence:"Man's nature at birth is good.",audio_name:"1.mp3",audio_url:"interaction/sentence_evaluat/resouce/test/audio/1.mp3"},{id:"2",isUserAdd:!1,parentId:"001004",sentence:"Done is better than perfect.",audio_name:"2.mp3",audio_url:"interaction/sentence_evaluat/resouce/test/audio/2.mp3"}];angularAMD.service("sentenceService",["LifecycleService","$http",function(LifecycleService,$http){var sentences2=[{id:"3",isUserAdd:!1,parentId:"002001",sentence:"In every triumph, there's a lot of try.",audio_name:"3.mp3",audio_url:"interaction/sentence_evaluat/resouce/test/audio/3.mp3"}];return{getSentencesByUnit:function(id){var sentences=sentences1;return"002"===id&&(sentences=sentences2),sentences},getUnitsByChapter:function(id){return[{id:"001",title:"My name is Cool",name:"小学英语五年级上Unit1",count:2,parts:[{id:"001001",title:"",name:"part 1",count:2}]},{id:"002",title:"Unit 2:My name is Cool",name:"小学英语五年级上Unit2",count:1,parts:[{id:"002001",title:"",name:"part 1",count:1}]}]},createSentence:function(id,value,audio_url){return{id:id,isUserAdd:!0,sentence:value,audio_url:audio_url}}}}])}),define(["app","sentence_evaluat/utils","uuid","sentence_evaluat/directive/sentence_evaluat.directive"],function(app,utils,uuid){"use strict";app.controller("sentence_evaluat_ctrl",["$scope","$http","skin_service","$stateParams","CustomEditorService","$rootScope","$filter","sentenceService","$timeout",function($scope,$http,skin_service,$stateParams,CustomEditorService,$rootScope,$filter,sentenceService,$timeout){function savaAudioByBlob(blob){audioBlob=blob;var url=URL.createObjectURL(audioBlob);tempRecordAudio=document.createElement("audio"),tempRecordAudio.controls=!1,tempRecordAudio.src=url,$scope.closeWindow(),$scope.opts.recordWin3=!0,$scope.$apply()}function sentenceErrorStyle(index){var count=0,tempInterval=setInterval(function(){count&!0?$("#sentenceList"+index).css({border:"2px solid #e90706"}):$("#sentenceList"+index).css({border:"2px solid #8f5211"}),6===count&&($("#sentenceList"+index).css({border:"2px solid #8f5211"}),clearInterval(tempInterval)),count++},300)}function getDataFromLc(content){var units=sentenceService.getUnitsByChapter("1");content.current_unit||(content.current_unit=units[0].id);var sentences=sentenceService.getSentencesByUnit(content.current_unit);content.units=units;for(var i=0,l=sentences.length;i<l;i++)for(var j=0,jl=content.addSentences.length;j<jl;j++)if(sentences[i].id==content.addSentences[j].id){content.addSentences[j].isAdd;$.extend(content.addSentences[j],sentences[i]),sentences[i]=content.addSentences[j]}content.show_sentences=sentences}function sendForm(){}var iframe=document.getElementById("iframepage"),messenger=window.messageIframe.messenger;window.messageIframe.messenger.addTarget(iframe.contentWindow,"sentence_evaluat_children");var audioBlob,tempRecordAudio;messenger.listen(function(obj){obj&&("complete"===obj.oper?savaAudioByBlob(obj.blob):"start"===obj.oper&&(1!==obj.errorStatus&&2!==obj.errorStatus||($scope.errorModel.errorText=$filter("translate")("sentence_evaluat.error.state"),$scope.$apply())))}),$rootScope.moduleScope=$scope,$scope.errorModel={},$scope.model={id:"",module_code:"nd_sentence_evaluat",title:$filter("translate")("section_evaluating.placeholder.title"),skin:{code:"wood",css_url:"",name:$filter("translate")("app.skin.wood"),package_url:""},timer:{timer_type:"sequence",time_minute:"0",time_second:"0"},packages:[],properties:[{name:"question_id",display_name:"题目ID",type:"string",value:"",is_localized:!1},{name:"question_url",display_name:"题目内容",type:"jsonFile",value:"",is_localized:!1}],content:{sentences:[],units:[],current_unit:"001",show_sentences:[],addSentences:[]}},$scope.opts={recordWin1:!1,recordWin2:!1,recordWin3:!1,recordWin4:!1,recordWin5:!1,startRecord:!0,cleanSentenceFlag:!1},$scope.opts.recordUrl="/interaction/sentence_evaluat/record/record.html",$scope.resourceValidParam={},$scope.assetResult={text:"",asset_type:"",asset:"",image_extend:{rotate:"",resize:""}};var showContent=$scope.model.content;$scope.errorState=0,$scope.showContent=showContent,$scope.addSentence=function(item){item.isAdd||(item.isAdd=!0,showContent.addSentences.push(item))},$scope.addSentences=function(){for(var i=0,l=showContent.show_sentences.length;i<l;i++){var item=showContent.show_sentences[i];$scope.addSentence(item)}},$scope.editItem=function(item,index){item.isEditor=!0,$scope.opts.editorValue=item.sentence,angular.element("#inputSentenceItem"+index).focus(100)},$scope.sentencePaste=function(e){e.preventDefault();var text=null;text=window.clipboardData&&clipboardData.setData?window.clipboardData.getData("text"):(e.originalEvent||e).clipboardData.getData("text/plain")||prompt("在这里输入文本");var textRange;if(document.body.createTextRange){var sel;if(document.selection)textRange=document.selection.createRange();else if(window.getSelection){sel=window.getSelection();var range=sel.getRangeAt(0),tempEl=document.createElement("span");tempEl.innerHTML="&#FEFF;",range.deleteContents(),range.insertNode(tempEl),textRange=document.body.createTextRange(),textRange.moveToElementText(tempEl),tempEl.parentNode.removeChild(tempEl)}textRange.text=text,textRange.collapse(!1),textRange.select()}},$scope.editorSentenceItemBlur=function(item,index){var $span=$("#inputSentence_"+item.id+" span"),flag=!0;1===$span.length&&$("#inputSentence_"+item.id).html($span.html()),1===$("#inputSentence_"+item.id).length&&(item.sentence=$("#inputSentence_"+item.id).html()),item.sentence=item.sentence.trim();for(var enCharts=["。","，","？","“","”","‘","’","！","；","：","（","）"],cnCharts=[".",",","?",'"','"',"'","'","!",";",":","(",")"],i=0,l=enCharts.length;i<l;i++)item.sentence=item.sentence.replace(new RegExp(enCharts[i],"g"),cnCharts[i]);if(item.sentence=item.sentence.replace(/ *\n+ */g,""),item.isEditor=!1,""===item.sentence)$scope.errorModel.errorText=$filter("translate")("sentence_evaluat.format.error5"),item.isEditor=!0,flag=!1;else if(/^([a-zA-Z0-9]|[.?!';,\-_+*\\()&^%$#@\s])+$/.test(item.sentence)===!1)$scope.errorModel.errorText=$filter("translate")("sentence_evaluat.format.error"),item.isEditor=!0,flag=!1;else if(/.*[.?!]$/.test(item.sentence.trim())===!1)$scope.errorModel.errorText=$filter("translate")("sentence_evaluat.format.error1"),item.isEditor=!0,flag=!1;else{for(var tempArr=item.sentence.split(/[!?,.\s]/),length=tempArr.length,i=0,l=tempArr.length;i<l;i++)""===tempArr[i]&&length--;if(length<2||length>15)$scope.errorModel.errorText=$filter("translate")("sentence_evaluat.format.error2"),item.isEditor=!0,flag=!1;else{for(var same=0,i=0,l=showContent.addSentences.length;i<l&&item.sentence;i++)item.sentence===showContent.addSentences[i].sentence&&same++;item.sentence&&2===same&&($scope.errorModel.errorText=$filter("translate")("sentence_evaluat.format.error3"),item.sentence="",item.isEditor=!0,flag=!1)}}flag===!1&&sentenceErrorStyle(index)},$scope.dblclickSentence=function(item){item.isUserAdd&&(item.isEditor=!0)},$scope.deleteSentence=function(item){item.isAdd=!1,utils.removeItemByValue(showContent.addSentences,item)},$scope.addEmptySentence=function(){var item={id:uuid.v4(),isUserAdd:!0,sentence:"",audio_url:"",isEditor:!0};showContent.addSentences.push(item),angular.element("#inputSentence_"+item.id).focus(100)},$scope.deleteSentenceAudio=function(item,index){$("#audio"+index)[0].pause(),item.audio_url="",item.audio_name=""},$scope.openRecordWindow=function(){$scope.opts.recordWin1=!1,$scope.opts.recordWin2=!0,$scope.initIframe()},$scope.openCleanSentenceWindow=function(){0!==showContent.addSentences.length&&($scope.opts.cleanSentenceFlag=!0)},$scope.cleanSentences=function(){if(0!==showContent.addSentences.length){for(var i=0,l=showContent.addSentences.length;i<l;i++)1==showContent.addSentences[i].isAdd&&(showContent.addSentences[i].isAdd=!1);showContent.addSentences=[],$scope.closeWindow()}},$scope.closeWindow=function(){$scope.opts=$.extend({},$scope.opts,{recordWin1:!1,recordWin2:!1,recordWin3:!1,recordWin4:!1,recordWin5:!1,startRecord:!0,cleanSentenceFlag:!1}),$("#iframepage").attr("src","/interaction/sentence_evaluat/record/record.html")},$scope.openWindow1=function(item){$scope.opts.tempItem=item},$scope.initIframe=function(){messenger.targets.sentence_evaluat_children.send({type:"init",data:$scope.opts.tempItem.sentence})},$scope.playAudio=function(index){for(var i=0,l=showContent.addSentences.length;i<l;i++)index!==i&&1===$("#audio"+i).length&&$("#audio"+i)[0].pause();$("#audio"+index).attr("src",$filter("filterRefPath")(showContent.addSentences[index].audio_url)),$("#audio"+index)[0].play()},$scope.addAssets=function(type){if($scope.assetResult.asset){$scope.opts.tempItem.audio_url=$scope.assetResult.asset;var audioIndex=showContent.addSentences.indexOf($scope.opts.tempItem);$("#audio"+audioIndex)[0].pause();var title=($scope.assetResult.asset.lastIndexOf("/")+1,$scope.assetResult.title);$scope.opts.tempItem.title=title,title.length>30&&(title=title.substr(0,30)+"..."),$scope.opts.tempItem.audio_name=title;for(var url=$scope.opts.tempItem.audio_url,same=0,titleSame=0,i=0,l=showContent.addSentences.length;i<l;i++)url===showContent.addSentences[i].audio_url&&same++,title===showContent.addSentences[i].audio_name&&titleSame++;(same>=2||titleSame>=2)&&$timeout(function(){$scope.errorModel.errorText=$filter("translate")("sentence_evaluat.format.error4")},550),$scope.assetResult={}}},$scope.buttonCallback={previewBefore:function(){}},$scope.tempRecordAudio=function(){tempRecordAudio.play()},$scope.sendAudioData=sendForm;var loadingData=function(id){$scope.isloadingData=!0,CustomEditorService.getQuestionInfoById(id).then(function(rtnData){rtnData?(""!=rtnData.skin.code?$scope.model=$scope.decodeData(rtnData,!0):$scope.model.id=rtnData.id,skin_service.set_skin_by_code($scope.model.skin.code,"v1"),getDataFromLc($scope.model.content),$scope.errorModel.errorText="",$scope.isloadingData=!1):$scope.errorModel.errorText=$filter("translate")("app.unvalidno")},function(error){$scope.errorModel.errorText=$filter("translate")("app.question.get.error")})};$stateParams.id?loadingData($stateParams.id):(skin_service.set_skin_by_code($scope.model.skin.code,"v1"),getDataFromLc($scope.model.content)),$scope.$on("changgedSkin",function(){$rootScope.scaleHtml()}),$scope.validPostData=function(){function isResetSentenceInArray(sortSentences,propName){for(var i=0,l=sortSentences.length-1;i<l;i++)if(sortSentences[i][propName]&&sortSentences[i][propName]===sortSentences[i+1][propName])return $scope.errorModel.errorText=$filter("translate")("sentence_evaluat.format.error4"),sentenceErrorStyle(sortSentences[i].order),sentenceErrorStyle(sortSentences[i+1].order),!1;return!0}var modelData=$scope.model;""==$.trim(modelData.title)&&(modelData.title=$filter("translate")("section_evaluating.placeholder.title"));var sentences=modelData.content.addSentences;if(modelData.content.addSentences.length<=0)return $scope.errorModel.errorText=$filter("translate")("sentence_evaluat.sentences_empty"),!1;for(var i=0,l=sentences.length;i<l;i++){if(sentences[i].order=i,""===sentences[i].sentence)return $scope.errorModel.errorText=$filter("translate")("sentence_evaluat.format.error5"),sentenceErrorStyle(i),!1;if(/^([a-zA-Z0-9]|[.?!';,\-_+*\\()&^%$#@\s])+$/.test(sentences[i].sentence)===!1)return $scope.errorModel.errorText=$filter("translate")("sentence_evaluat.format.error"),sentenceErrorStyle(i),!1;if(/.*[.?!]$/.test(sentences[i].sentence.trim())===!1)return $scope.errorModel.errorText=$filter("translate")("sentence_evaluat.format.error1"),sentenceErrorStyle(i),!1;if(sentences[i].sentence.trim()){for(var tempArr=sentences[i].sentence.split(/[!?,.\s]/),length=tempArr.length,j=0,jl=tempArr.length;j<jl;j++)""===tempArr[j]&&length--;if(length<2||length>15)return $scope.errorModel.errorText=$filter("translate")("sentence_evaluat.format.error2"),sentenceErrorStyle(i),!1}}var sortSentences=sentences.slice(0).sort(function(a,b){return a.audio_url>b.audio_url?1:-1});return isResetSentenceInArray(sortSentences,"audio_url")!==!1&&(sortSentences=sentences.slice(0).sort(function(a,b){return a.audio_url>b.audio_url?1:-1}),isResetSentenceInArray(sortSentences,"audio_name")!==!1)},$scope.encodeData=function(model){for(var addSentences=model.content.addSentences,i=0,l=addSentences.length;i<l;i++)if(addSentences[i].isUserAdd===!0){var tempP={src:addSentences[i].audio_url,type:"file"};model.packages.push(tempP)}return model},$scope.decodeData=function(model,isInitLoad){return getDataFromLc(model.content),showContent=model.content,$scope.showContent=showContent,model}}])});