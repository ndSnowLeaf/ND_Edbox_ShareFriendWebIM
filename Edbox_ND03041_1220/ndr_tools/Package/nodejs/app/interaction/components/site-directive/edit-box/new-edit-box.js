define(["angularAMD","css!components/site-directive/edit-box/edit-box.css"],function(e){e.directive("newEditBox",["UtilsService",function(e){new Array;return{require:"?ngModel",restrict:"EA",scope:{maxSize:"=maxSize",minSize:"=minSize",maxLength:"=maxLength",title:"=",defaultTitleSetting:"=",defaultPlaceholder:"="},link:function(t,n,i,l){function a(e,t){for(var n="",i=e.length,l=0,a=0;a<=i-1;a++){if(l>=t)return n;l+=1,n+=e.charAt(a)}return n}function r(){setTimeout(function(){var e=n.val();e=e.replace(/<\/?.+?>/g,""),e=e.replace(/[\r\n]/g,""),n.val(e);var i=n.val();if(i.length>s){var l=a(i,s);t.title=l}o(i)},300)}function o(e){var t=n.val()||p,i=n.width(),l=n.parent(),a=v(t);(d+1)*a.chLength+parseInt(39*d*a.enLength/65)>i?(f=Math.floor(l.height()/2-3),n.css("fontSize",f),n.css("line-height",l.height()/2-2+"px"),n.css("font-weight","normal"),g=f):(n.css("fontSize",d),n.css("line-height",l.height()-2+"px"))}function c(){setTimeout(function(){o()},300)}function u(){clearTimeout(w),clearInterval(m),w=setTimeout(function(){clearInterval(m),n.css("border","1px solid transparent")},3e3),m=setInterval(h,300)}function h(){S?(n.css("border","1px solid transparent"),S=!1):(n.css("border","1px solid red"),S=!0)}n.removeAttr("title");var s=t.maxLength||70,d=t.maxSize,f=t.minSize,g=n.css("fontSize"),p=t.defaultPlaceholder?t.defaultPlaceholder:i.placeholder;s>100&&(s=100),n.attr("maxlength",s);var v=function(e){var t=0;if(void 0===e)return t;for(var n=e.length,i=0,l=0,a=-1,r=0;r<n;r++)a=e.charCodeAt(r),a>=0&&a<=128?(t+=1,i++):(t+=2,l++);return{l:t,enLength:i,chLength:l}};t.$watch("title",function(e,t){e!=t&&r()}),t.$on("changgedSkin",c),angular.element(window).resize(c),n.bind("input enterKey",r),n.bind("keydown",function(e){if(n.val().length>=s)if(8!=e.which&&46!=e.which&&e.which<37&&e.which>40){if(n[0].selectionStart==n[0].selectionEnd)return e.cancelable=!0,e.preventDefault(),!1}else u()}),!l||"true"!==i.escapseBlank&&!0!==i.escapseBlank||n.on("blur",function(e){""===$.trim(e.target.value)&&(e.target.value="",t.$apply(function(){l.$setViewValue("")}))}),t.showplaceholder=!0,t.$watch("defaultPlaceholder",function(){t.showplaceholder&&n.attr("placeholder",t.defaultPlaceholder)}),(i.placeholder||void 0!==i.defaultPlaceholder)&&(n.on("focus",function(e){t.showplaceholder=!1,n.attr("placeholder","")}),n.on("blur",function(e){t.showplaceholder=!0,n.attr("placeholder",p)})),t.defaultTitleSetting&&(n.on("focus",function(e){l.$viewValue==t.defaultTitleSetting.title&&setTimeout(function(){n[0].select()},100)}),n.on("blur",function(n){t.defaultTitleSetting.titleTarget||(t.defaultTitleSetting.titleTarget=n.target),e.safeApply(t,function(){l.$viewValue?t.defaultTitleSetting.isCleared=!1:(t.defaultTitleSetting.isCleared=!0,l.$setViewValue(t.defaultTitleSetting.title),l.$render())})}));var w=0,m=0,S=!1}}}])});