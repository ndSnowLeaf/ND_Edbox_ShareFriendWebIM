define(["angularAMD","components/site-services/utils.service","components/site-services/charset.service"],function(e){function t(e,t,i,n,r){if(t){var h=0;return(h=i?r.getTextBytes(e):e.length)>t||h>=t&&n}return!1}function i(e,t,i,n,r,h){if(i){if(r[0]<e.length){var c=e.substring(0,r[0]),s=e.substring(e.length-(n-r[0]-r[1])),l=e.substring(c.length,e.length-s.length),a=h.subTextByBytes(l,t-h.getTextBytes(c)-h.getTextBytes(s)),u=c+a+s;return[u,c,a,s]}var c=h.subTextByBytes(e,t);return[c,c,"",""]}if(r[0]<e.length){var c=e.substring(0,r[0]),s=e.substring(e.length-(n-r[0]-r[1])),l=e.substring(c.length,e.length-s.length),a=l.substr(0,t-c.length-s.length),u=c+a+s;return[u,c,a,s]}var c=e.substring(0,t);return[c,c,"",""]}e.directive("contenteditable",["UtilsService","CharsetService",function(e,n){return{require:"?ngModel",restrict:"A",link:function(r,h,c,s){function l(){if(p){var e=h.text();s.$setViewValue(e),e!=h.html()&&s.$render()}else{var t=h.html();s.$setViewValue(t)}}function a(t){e.safeApply(r,function(){var r=i(h.text(),w,v,g,f,n);h.text(r[0]),s.$setViewValue(r[0]),!t&&e.positionCaret(h[0].childNodes[0],r[1].length+r[2].length)})}if(s&&"true"===c.contenteditable&&!h.is("input")&&!h.is("textarea")){var u,o,f,g,w=c.maxlength||c.maxBytesLimit,v=!!c.maxBytesLimit,p="true"===c.escapseHtml||!0===c.escapseHtml;s.$render=function(){h.html(s.$viewValue||"")},p&&h.on("paste",function(t){e.removeStyleFromClipboard(t)}),h.on("keydown",function(i){if(u||o||(f=e.getCaretPosInfo(h[0]),g=h.text().length),u=!0,t(h.text(),w,v,!0,n)&&!o){if(window.getSelection().isCollapsed&&8!=i.which&&46!=i.which&&(i.which<112||i.which>123)&&(i.which<37||i.which>40))return i.cancelable=!0,i.preventDefault(),!1}o=229==i.which||197==i.which}).on("keyup",function(e){u=!1;var i=!1;o&&(e.which<65||e.which>90)&&(t(h.text(),w,v,!0,n)&&(a(),i=!0),o=!1),i||(!o||o&&"32"==e.which)&&(e.which<37||e.which>40)&&(t(h.text(),w,v,!0,n)?a():r.$apply(l))}).on("blur",function(i){t(h.text(),w,v,!0,n)?a(!0):e.safeApply(r,l)})}}}}]).directive("textBytesLimit",["UtilsService","CharsetService",function(e,n){return{require:"?ngModel",restrict:"A",link:function(r,h,c,s){function l(){s.$setViewValue(h.val())}function a(t){e.safeApply(r,function(){var r=i(h.val(),w,!0,f,g,n);h.val(r[0]),s.$setViewValue(r[0]),!t&&e.positionCaret(h[0],r[1].length+r[2].length)})}if(s&&(h.is("input")||h.is("textarea"))){var u,o,f,g,w=c.textBytesLimit;h.on("keydown",function(i){if(u||o||(g=e.getCaretPosInfo(h[0]),f=h.val().length),u=!0,t(h.val(),w,!0,!0,n)&&!o&&h[0].selectionStart===h[0].selectionEnd&&8!=i.which&&46!=i.which&&(i.which<112||i.which>123)&&(i.which<37||i.which>40))return i.cancelable=!0,i.preventDefault(),!1;o=229==i.which||197==i.which}).on("keyup",function(e){u=!1;var i=!1;o&&(e.which<65||e.which>90)&&(t(h.val(),w,!0,!0,n)&&(a(),i=!0),o=!1),i||(!o||o&&"32"==e.which)&&(e.which<37||e.which>40)&&(t(h.val(),w,!0,!0,n)?a():r.$apply(l))}).on("blur",function(i){t(h.val(),w,!0,!0,n)?a(!0):e.safeApply(r,l)})}}}}])});