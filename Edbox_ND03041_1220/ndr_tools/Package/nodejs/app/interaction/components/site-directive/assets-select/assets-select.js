define(["angularAMD"],function(e){e.directive("assetsSelect",["$rootScope","$stateParams","ngDialog","$filter","$q","$http",function(e,a,t,i,n,o){return{restrict:"EA",scope:{imageDataNew:"=imageData",imageColumn:"@",imageTitle:"@",imageSize:"@",afterAdd:"&",afterClose:"&",isCommonValid:"@",commonValidParam:"="},link:function(n,l,s){s.itemType=s.itemType?s.itemType:"image",s.selectType=s.selectType?s.selectType:"single",s.space=a.space?a.space:"personal",n.model={mediaTypeLabel:i("translate")(i("filterEnumCategory")(s.itemType)),item_type:s.itemType,href:[window.location.protocol+"//"+window.location.host+"/editor/basic-question/question.html#/select_asset","?sys=prepare&is_interaction=true","&category=",s.itemType,"&select_type=",s.selectType,"&space=",s.space,"&id=",a.id,"&question_base=",a.question_base||"","&chapter_id=",a.chapter_id||"","&token_info=",encodeURIComponent(a.token_info),"&chapter_name=",encodeURIComponent(a.chapter_name||""),"&_lang_=",a._lang_||"","&file_path=",encodeURIComponent(a.file_path||""),"&creator=",a.creator||""].join("")};var c=null,r=function(){n.assetSelectBodyStyle={width:"99%",margin:"10px 15px 5px 10px",border:"0 none"};var e=angular.element(window).height();e>=700?(n.assetSelectBodyStyle.height="618px",n.assetSelectHeadStyle={"margin-top":(e-700)/2-55+"px"}):(n.assetSelectBodyStyle.height="500px",n.assetSelectHeadStyle={"margin-top":-55+Math.max((e-582)/2,0)+"px"})},g=function(){if(e.ngDialogCache||(e.ngDialogCache={},e.ngDialogCache.dialogMap={}),e.ngDialogCache.dialogMap[s.itemType]){c=e.ngDialogCache.dialogMap[s.itemType],r();var a=angular.element("#"+c.id);a.find(".bk-dialog-head").css("margin-top",n.assetSelectHeadStyle["margin-top"]),a.find("iframe").css("height",n.assetSelectBodyStyle.height),t.reopen(c.id)}else r(),e.ngDialogCache.dialogMap[s.itemType]=t.open({templateUrl:"interaction/components/site-directive/assets-select/assets-select.html",scope:n,className:"bk-dialog",overlay:!1,preCloseCallback:function(){return angular.element("#"+c.id).hide(),n.afterClose(),!1}}),c=e.ngDialogCache.dialogMap[s.itemType];return c},m=function(){c&&t.close(c.id)};l.click(function(){var e=l.attr("cancelClick");"true"!==e&&!0!==e&&(g(),window.messageIframe&&(window.messageIframe.doMessage=function(e){"AssetsSelected"==e.message&&n.$apply(function(){if(1===e.data.length)if(-1===e.data[0].indexOf("${ref-path}")&&-1===e.data[0].indexOf("${ref-base}")){var a=e.titles[0],t=$("#"+c.id).find(".assets-select-loading").show();o.get(e.data[0]+"&is_interaction=true").success(function(e){t.hide(),n.imageDataNew[n.imageColumn]=e,!!n.imageTitle&&(n.imageDataNew[n.imageTitle]=a),m(),n.afterAdd()}).error(function(e){t.hide(),console.log(e),console.log("资源下载失败!")})}else n.imageDataNew[n.imageColumn]=e.data[0].replace("${ref-base}/_ref/","${ref-path}/"),!!n.imageTitle&&(n.imageDataNew[n.imageTitle]=e.titles[0]),m(),n.afterAdd();else n.imageDataNew[n.imageColumn]=e.data.replace("${ref-base}/_ref/","${ref-path}/"),!!n.imageTitle&&(n.imageDataNew[n.imageTitle]=e.title),m(),n.afterAdd()})}))})}}}])});