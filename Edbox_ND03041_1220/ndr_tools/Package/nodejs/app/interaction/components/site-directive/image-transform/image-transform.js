define(["angularAMD","components/jquery-plugin/jquery.mousewheel/3.1.13/jquery.mousewheel"],function(t){function i(t,i){this.options=$.extend(!0,{},this._defaultOptions,i),this._initProcessor(),this._initialize(t,i)}i.prototype={_defaultOptions:{processors:"css3|filter",mouseZoom:!0,onRemove:function(){},onDispose:function(){},triggerEvent:"dblclick",needCreateBtns:!0,actionSelectors:{right:"js-right",original:"js-original",vertical:"js-vertical",horizontal:"js-horizontal",remove:"js-remove",dispose:"js-dispose"}},_initialize:function(t,i){this._support=!1,this._editing=!1,this._radian=0,this._x=1,this._y=1,this._original=!1,this._img=$(t),this._wrap=this._img.parent(),this._originalWidth=0,this._originalHeight=0,this.getImageOriginalSize();var o=this;this.options.triggerSource?this._triggerSource=$(document.getElementById(this.options.triggerSource)):this._triggerSource=this._img,this._triggerSource[this.options.triggerEvent](function(){o._editing?o.dispose():(o.resetData(),o._createContainer(),"function"==typeof o._init&&o._init(),o._editing=!0,o.options.triggerEventHandler&&o.options.triggerEventHandler(o._editing),$(o._img).trigger("init",o))})},_initProcessor:function(){var t=this,o=i.processors;if($.each(t.options.processors.toLowerCase().split("|"),function(e,s){var r=o[s];if(r&&r.support())return $.extend(t,r),$.each(i.transforms,function(i,o){t[i]=function(){o.apply(t,[].slice.call(arguments)),this._radian=this._radian%(2*Math.PI),t.show(),t.setData()}}),t._support=!0,!1}),!this._support)throw new Error("not support")},_createContainer:function(){this.options.needCreateBtns?(this._wrap.prepend('<div>   <a class="js-right" translate="directive.image_tansform">90°翻转</a>   <a class="js-original " translate="directive.image_tansform1">原尺寸</a>   <a class="js-vertical" translate="directive.image_tansform2">垂直翻转</a>   <a class="js-horizontal" translate="directive.image_tansform3">水平翻转</a>   <a class="js-remove" translate="directive.image_tansform4">删除</a>   <a class="js-dispose" translate="directive.image_tansform5">退出编辑</a></div>'),$(".js-right",this._wrap).click($.proxy(this.right,this)),$(".js-original",this._wrap).click($.proxy(this.notZoon,this)),$(".js-vertical",this._wrap).click($.proxy(this.vertical,this)),$(".js-horizontal",this._wrap).click($.proxy(this.horizontal,this)),$(".js-remove",this._wrap).click($.proxy(this.remove,this)),$(".js-dispose",this._wrap).click($.proxy(this.dispose,this))):($(this.options.actionSelectors.right).unbind("click.imgTrans").bind("click.imgTrans",$.proxy(this.right,this)),$(this.options.actionSelectors.original).unbind("click.imgTrans").bind("click.imgTrans",$.proxy(this.notZoon,this)),$(this.options.actionSelectors.vertical).unbind("click.imgTrans").bind("click.imgTrans",$.proxy(this.vertical,this)),$(this.options.actionSelectors.horizontal).unbind("click.imgTrans").bind("click.imgTrans",$.proxy(this.horizontal,this)),$(this.options.actionSelectors.remove).unbind("click.imgTrans").bind("click.imgTrans",$.proxy(this.remove,this)),$(this.options.actionSelectors.dispose).unbind("click.imgTrans").bind("click.imgTrans",$.proxy(this.dispose,this)))},getImageOriginalSize:function(){},resetData:function(){var t=$(this._img);t.attr("radian")&&(this._radian=parseFloat(t.attr("radian"))),t.attr("x")&&(this._x=parseFloat(t.attr("x"))),t.attr("y")&&(this._y=parseFloat(t.attr("y")))},setData:function(){$(this._img).attr({radian:this._radian,x:this._x,y:this._y,zoom:Math.abs(this._x),original:1==Math.abs(this._x),vertical:this._y<0,horizontal:this._x<0})},remove:function(){confirm("确定要删除吗？")&&(this._wrap.remove(),"function"==typeof this.options.onRemove&&this.options.onRemove())},dispose:function(){this._editing=!1,this.options.triggerEventHandler&&this.options.triggerEventHandler(this._editing),"function"==typeof this.options.onExit&&this.options.onExit(),$(this._img).trigger("dispose",this)}},i.processors=function(){function t(t,i,o){var e=Math.cos(t),s=Math.sin(t);return{M11:e*i,M12:-s*o,M21:s*i,M22:e*o}}return{css3:{_css3Transform:null,support:function(){var t=this,i=document.createElement("div").style,o=!1;return $.each(["transform","MozTransform","webkitTransform","OTransform","msTransform"],function(e,s){if(s in i)return t._css3Transform=s,o=!0,!1}),o},_init:function(){},show:function(){var i=t(this._radian,this._y,this._x);"webkitTransform"!=this._css3Transform&&this._img.css("-webkit-transform")&&"none"!=this._img.css("-webkit-transform")?this._img.css(this._css3Transform,"matrix("+i.M11.toFixed(16)+","+i.M21.toFixed(16)+","+i.M12.toFixed(16)+","+i.M22.toFixed(16)+", 0, 0)").css("webkitTransform","matrix("+i.M11.toFixed(16)+","+i.M21.toFixed(16)+","+i.M12.toFixed(16)+","+i.M22.toFixed(16)+", 0, 0)"):this._img.css(this._css3Transform,"matrix("+i.M11.toFixed(16)+","+i.M21.toFixed(16)+","+i.M12.toFixed(16)+","+i.M22.toFixed(16)+", 0, 0)")}},filter:{support:function(){return"filters"in document.createElement("div")},init:function(){this._img.css({filter:'progid:DXImageTransform.Microsoft.Matrix(SizingMethod="auto expand")',visibility:"visible"})},show:function(){var i=(this._img[0],t(this._radian,this._y,this._x));this._img.css("filter","progid:DXImageTransform.Microsoft.Matrix(M11="+i.M11.toFixed(16)+",M12="+i.M12.toFixed(16)+",M21="+i.M21.toFixed(16)+",M22="+i.M22.toFixed(16)+",SizingMethod='auto expand')")}}}}(),i.transforms={vertical:function(){this._radian=Math.PI-this._radian,this._y*=-1},horizontal:function(){this._radian=Math.PI-this._radian,this._x*=-1},rotate:function(t){this._radian=t},left:function(){this._radian-=Math.PI/2},right:function(){this._radian+=Math.PI/2},rotatebydegress:function(t){this._radian=t*Math.PI/180},scale:function(){function t(t,i){return t>0&&t>-i?i:t<0&&t<i?-i:0}return function(i){if(i){var o=t(this._y,i),e=t(this._x,i);o&&e&&(this._y+=o,this._x+=e)}}}(),zoomin:function(){this.scale(.1)},zoomout:function(){this.scale(-.1)},changeWidth:function(){this._img.width()},notZoon:function(){this._y<0?this._y=-1:this._y=1,this._x<0?this._x=-1:this._x=1,this._img.css({width:"auto",height:"auto"}),this._img.attr({width:null,height:null}),this._img.find("img").css({width:"auto",height:"auto"}),this._original=!this._original}},i.prototype._initialize=function(){function t(t){this.scale(.1*t.deltaY),t.preventDefault()}var o=i.prototype._initialize,e={init:function(i,o){o._mzZoom=$.proxy(t,o),$(o._wrap).on("mousewheel",o._mzZoom)},dispose:function(t,i){$(i._wrap).off("mousewheel",i._mzZoom),i._mzZoom=null}};return function(t){this.options&&!1!==this.options.mouseZoom&&$.each(e,function(i,o){$(t).off(i,o).on(i,o)}),o.apply(this,arguments)}}(),i.prototype._initialize=function(){function t(t){var i=$(this._img).position();this._mdWidth=$(this._img).width(),this._mdHeight=$(this._img).height(),this._mdPageX=t.pageX,this._mdPageY=t.pageY,this._mdX=i.left+$(this._img).width()/2,this._mdY=i.top+$(this._img).height()/2,this.coldotTarget="";var o=$(t.target);o.hasClass("coldot_topleft")?this.coldotTarget="coldot_topleft":o.hasClass("coldot_topright")?this.coldotTarget="coldot_topright":o.hasClass("coldot_bottomright")&&(this.coldotTarget="coldot_bottomright"),$(window).on("mousemove",this._mdMOVE),$(window).on("mouseup",this._mdSTOP),"onlosecapture"in this._wrap[0]&&($(this._wrap).on("losecapture",this._mdSTOP),this._wrap[0].setCapture()),$(window).on("blur",this._mdSTOP),t.preventDefault()}function o(t){var i,o;switch(this.coldotTarget){case"coldot_topleft":i=this._mdWidth-(t.pageX-this._mdPageX),o=this._mdHeight-(t.pageY-this._mdPageY);break;case"coldot_topright":i=this._mdWidth+(t.pageX-this._mdPageX),o=this._mdHeight-(t.pageY-this._mdPageY);break;case"coldot_bottomright":i=this._mdWidth+(t.pageX-this._mdPageX),o=this._mdHeight+(t.pageY-this._mdPageY)}this._img.css({width:i,height:o}),this._img.find("img").css({width:i,height:o}),window.getSelection?window.getSelection().removeAllRanges():document.selection.empty()}function e(t){$(window).off("mousemove",this._mdMOVE),$(window).off("mouseup",this._mdSTOP),"onlosecapture"in this._wrap[0]&&($(this._wrap).off("losecapture",this._mdSTOP),this._wrap[0].releaseCapture()),$(window).off("blur",this._mdSTOP),this._editing}var s=i.prototype._initialize,r={init:function(i,s){s._mdX=s._mdY=s._mdRadian=0,s._mdSTART=$.proxy(t,s),s._mdMOVE=$.proxy(o,s),s._mdSTOP=$.proxy(e,s),$(".coldot_topleft,.coldot_topright,.coldot_bottomright",s._wrap).on("mousedown",s._mdSTART)},dispose:function(t,i){$(".coldot_topleft,.coldot_topright,.coldot_bottomright",i._wrap).off("mousedown",i._mdSTART),i._mdSTOP(),i._mdSTART=i._mdMOVE=i._mdSTOP=null}};return function(t){$.each(r,function(i,o){$(t).off(i,o).on(i,o)}),s.apply(this,arguments)}}(),i.prototype._initialize=function(){function t(t){var i=1,o=$(".exam_wood").css("transform");if(void 0!=o){var e=o.split("(");$.isArray(e)&&e.length>1&&(i=e[1].split(",")[0])}var s=$(this._wrap).offset();this._mrX=s.left+$(this._wrap).width()/2*i,this._mrY=s.top+$(this._img).height()/2,this._mrRadian=Math.atan2(t.clientY-this._mrY,t.clientX-this._mrX)-this._radian,$(window).on("mousemove",this._mrMOVE),$(window).on("mouseup",this._mrSTOP),"onlosecapture"in this._wrap[0]&&($(this._wrap).on("losecapture",this._mrSTOP),this._wrap[0].setCapture()),$(window).on("blur",this._mrSTOP),t.preventDefault()}function o(t){this.rotate(Math.atan2(t.clientY-this._mrY,t.clientX-this._mrX)-this._mrRadian),window.getSelection?window.getSelection().removeAllRanges():document.selection.empty()}function e(t){$(window).off("mousemove",this._mrMOVE),$(window).off("mouseup",this._mrSTOP),"onlosecapture"in this._wrap[0]&&($(this._wrap).off("losecapture",this._mrSTOP),this._wrap[0].releaseCapture()),$(window).off("blur",this._mrSTOP)}var s=i.prototype._initialize,r={init:function(i,s){s._mrX=s._mrY=s._mrRadian=0,s._mrSTART=$.proxy(t,s),s._mrMOVE=$.proxy(o,s),s._mrSTOP=$.proxy(e,s),$(".coldot_roll",s._wrap).on("mousedown",s._mrSTART)},dispose:function(t,i){$(".coldot_roll",i._wrap).off("mousedown",i._mrSTART),i._mrSTOP(),i._mrSTART=i._mrMOVE=i._mrSTOP=null}};return function(t){$.each(r,function(i,o){$(t).off(i,o).on(i,o)}),s.apply(this,arguments)}}();var o="0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",e=new RegExp("((\\d+[.\\d]*)[Ee]{1}([+-]?)(\\d+))","ig"),s=function(t){if(!t)return t;var i=t.toString();if(-1!=i.indexOf("E")||-1!=i.indexOf("e")){var e=new RegExp("^((\\d+[.\\d]*)[Ee]{1}([+-]?)(\\d+))$","ig").exec(t);if(null!=e){var s=e[2],r=e[3],n=e[4];if("+"===r){var a=Math.max(s.indexOf("."),0);return s=s.replace(".",""),s+=o.substring(0,Math.min(o.length,n)-(s.length-a)-1)}var a=s.indexOf(".");return s=s.replace(".",""),s=a<0?"0."+o.substring(0,Math.min(o.length,n)-s.length)+s:"0."+o.substring(0,Math.min(o.length,n)-a)+s}}return t};t.directive("imgTrans",[function(){return{restrict:"A",scope:{description:"=descriptionData",triggerEvent:"@triggerEvent",imgTransSelfPosition:"@imgTransSelfPosition"},controller:["$scope","$filter",function(t,i){t.imgSrc=i("filterRefPath")(t.description.asset)}],link:function(t,o,r){function n(){if(t.description.other={},o.attr("radian")&&(t.description.other.radian=o.attr("radian")),o.attr("x")&&(t.description.other.x=o.attr("x")),o.attr("y")&&(t.description.other.y=o.attr("y")),o.attr("zoom")&&(t.description.other.zoom=o.attr("zoom")),o.attr("original")&&(t.description.other.original=o.attr("original")),o.attr("vertical")&&(t.description.other.vertical=o.attr("vertical")),o.attr("horizontal")&&(t.description.other.horizontal=o.attr("horizontal")),o.attr("style")&&(t.description.other.style=o.clone(!1).css("top","").css("margin-top","").attr("style")),t.description.other.style&&t.description.other.style.indexOf("transform")>-1){if(-1===t.description.other.style.indexOf("-webkit-transform")){var i=t.description.other.style.replace("transform","-webkit-transform");t.description.other.style=t.description.other.style+";"+i}t.description.other.style=t.description.other.style.replace(e,function(t){return s(t)})}}angular.isObject(t.description.other)&&o.attr(t.description.other);var a={imgSrc:t.imgSrc,triggerEvent:t.triggerEvent||"dblclick",triggerSource:r.triggerSource,needCreateBtns:!1,actionSelectors:t.$eval(r.imgTransActionSelectors)};if("image"==t.description.asset_type&&(a.triggerEventHandler=function(t){t?o.parent().bind("mouseleave",function(){n()}):(n(),o.parent().unbind("mouseleave"))}),new i(o,a),t.imgTransSelfPosition&&"false"!=t.imgTransSelfPosition)window.setTimeout(function(){if(t.description.other){var i=t.description.other.style;i&&i.indexOf("width")>-1&&"auto"!=o[0].style.width&&o.find("img").css({width:o.width(),height:o.height()})}},10);else var h=window.setInterval(function(){o.outerHeight()>6&&(o.css("top","50%"),o.css("margin-top",-o.outerHeight()/2),o.find("img").css({width:o.width(),height:o.height()}),clearInterval(h))},10)}}}])});