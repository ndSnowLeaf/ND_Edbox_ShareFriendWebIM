define(["angularAMD","customeditor.service"],function(e){e.directive("cancelButton",[function(){return{restrict:"EA",templateUrl:"interaction/components/site-directive/save-buttons/cancel-button.html",controller:["$scope",function(e){var t=function(e){window.messageIframe.messenger.targets.parent.send({message:e})};e.cancel=function(){t("QuestionEditCancel")}}]}}]).directive("saveButtons",["ngDialog","CustomEditorService","$stateParams","$http","$timeout",function(e,t,a,i,n){return{restrict:"E",templateUrl:"interaction/components/site-directive/save-buttons/save-buttons.html",scope:{postData:"=postData",validData:"=",encodeData:"=",decodeData:"=",version:"@"},controller:["$scope","$q","$filter","diskpathService",function(s,o,r,c){i.get("/prepare/mapping").success(function(e){s.types=e.interact_question}),s.lang=a._lang_,s.isModify=a.isModify;var p=function(){if(s.validData&&(s.$parent.errorModel&&(s.$parent.errorModel.errorText=""),1!=s.validData())){var e=o.defer();return e.reject(),e.promise}var a=null;return a=s.postData.id?t.updateQuestion(s.encodeData(s.postData)):t.addQuestion(s.encodeData(s.postData)),a.then(function(e){angular.extend(s.postData,s.decodeData(e))},function(e){s.$parent.errorModel&&(console.error(e),e.data?s.$parent.errorModel.errorText="发生系统错误：["+e.data.message+"].":s.$parent.errorModel.errorText="发生系统错误：[status:"+e.status+", text:"+e.statusText+"].");var t=o.defer();return t.reject(),t.promise})},u=function(e){var t={message:e,id:s.postData.id,isCustom:!0,question_type:a.question_type};switch(a.question_type){case"linkup":case"nd_memorycard":t.skin=s.postData.skin.css_url,t.spirit_root=s.postData.skin.package_url,s.postData.timer&&(t.timer_type=s.postData.timer.timer_type,t.time_limit=60*parseInt(s.postData.timer.time_minute||0)+parseInt(s.postData.timer.time_second||0));break;default:t.skin=s.postData.skin.css_url,t.question_title=window.customHtmlEncode(s.postData.title),s.postData.timer&&(t.timer_type=s.postData.timer.timer_type,t.time_limit=60*parseInt(s.postData.timer.time_minute||0)+parseInt(s.postData.timer.time_second||0))}window.messageIframe.messenger.targets.parent.send(t)},d=function(){angular.element(".exam_wood .global_success_tip").hide().show(),n(function(){angular.element(".exam_wood .global_success_tip").hide()},3e3)};s.preview=function(){p().then(function(){u("QuestionPreview"),s.isModify&&console.log(JSON.stringify({message:"QuestionSaved",id:s.postData.id,question_type:a.question_type,question_code:l(a.question_type),action:"save",file_path:s.postData.physic_path})),t.getPreviewUrl().then(function(t){s.previewUrl=t.url+"&isPreview=true&_lang_="+a._lang_+"&sys="+a.sys+"&rnd="+(new Date).getTime()+"&embed=true",e.open({templateUrl:"interaction/components/site-directive/save-buttons/preview.html",scope:s,className:"bk-dialog bk-dialog-previewtask"})})})};var l=function(e){for(var t=s.types,a=0;a<t.length;a++)if(t[a].type==e)return t[a].code};s.save=function(){p().then(function(){d(),u("QuestionSaved"),console.log(JSON.stringify({message:"QuestionSaved",id:s.postData.id,question_type:a.question_type,question_code:l(a.question_type),action:"save",file_path:s.postData.physic_path}))})},s.add=function(){p().then(function(e){u("QuestionAdd"),console.log(JSON.stringify({message:"QuestionAdd",id:s.postData.id,question_type:a.question_type,question_code:l(a.question_type),action:"save",file_path:c.getFilepath()}))})}}]}}])});