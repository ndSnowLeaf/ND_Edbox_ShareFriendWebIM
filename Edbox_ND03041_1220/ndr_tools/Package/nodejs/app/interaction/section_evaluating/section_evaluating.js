define("section_evaluating/directive/section_evaluating.directive",["components/site-directive/assets-select/assets-select","components/site-directive/error-tip/error-tip","components/site-directive/edit-box/new-edit-box","components/site-directive/foot-tool/time-box/new-time-box","components/site-directive/foot-tool/foot-tool"],function(){}),define(["app","section_evaluating/directive/section_evaluating.directive"],function(app){"use strict";app.controller("section_evaluating_ctrl",["$scope","$http","skin_service","$stateParams","CustomEditorService","$rootScope","$filter",function($scope,$http,skin_service,$stateParams,CustomEditorService,$rootScope,$filter){function startUserMedia(stream){var input=audio_context.createMediaStreamSource(stream);console.log("Media stream created."),recorder=new Recorder(input)}function createDownloadLink(){recorder&&recorder.exportWAV(function(blob){audioBlob=blob;var url=URL.createObjectURL(blob);tempRecordAudio=document.createElement("audio"),tempRecordAudio.controls=!1,tempRecordAudio.src=url})}function init(){try{window.AudioContext=window.AudioContext||window.webkitAudioContext,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia,window.URL=window.URL||window.webkitURL,audio_context=new AudioContext,console.log("Audio context set up."),console.log("navigator.getUserMedia "+(navigator.getUserMedia?"available.":"not present!"))}catch(e){alert("No web audio support in this browser!")}navigator.getUserMedia({audio:!0},startUserMedia,function(e){console.log("No live audio input: "+e)})}function sendForm(){var oData=new FormData;$http({method:"GET",url:["http://esp-lifecycle.pre1.web.nd/v0.6/assets/none/uploadurl?uid=",USER_ID,"&coverage=User%2F",USER_ID,"%2FOWNER&chapter_id=",$stateParams.chapter_id].join("")}).then(function(response){function uploadProgress(evt){if(evt.lengthComputable){console.warn(evt.loaded);var percentComplete=Math.round(100*evt.loaded/evt.total);$("#upload_bar").css({width:percentComplete+"%"}),$("#upload_bar_time").html(percentComplete+"%"),100===percentComplete&&($scope.opts.recordWin5=!0,$scope.opts.recordWin4=!1)}}var time=(new Date).getTime();$scope.opts.audio_name=time+".mp3";var path=response.data.dist_path,audio_url=response.data.dist_path+"/"+time+".mp3";oData.append("access_method",response.data.access_method),oData.append("filePath",audio_url),oData.append("path",path.substr(0,path.lastIndexOf("/"))),oData.append("session",response.data.session_id),oData.append("uuid",response.data.uuid),oData.append("name",NaN),oData.append("scope",1),oData.append("size",audioBlob.size),oData.append("chunks",1),oData.append("chunk",1),oData.append("chunkSize",1),oData.append("pos",1),oData.append("expireDays",1),oData.append("boundary",audioBlob),oData.append("mime","audio/x-mpeg");var uuid=response.data.uuid,oReq=new XMLHttpRequest;response.data;oReq.open("POST",response.data.access_url,!0),oReq.upload.addEventListener("progress",uploadProgress,!1),oReq.onload=function(oEvent){if(200==oReq.status){var json={title:"test",description:"英语篇章评测",language:"zh_cn",preview:{},life_cycle:{version:"v1.0",status:"ONLINE",enable:!0,creator:USER_ID,publisher:null,provider:null,provider_source:null,create_time:"2015-12-10T03:38:46.556+0000",last_update:"2015-12-10T03:38:46.556+0000"},custom_properties:{key:"test"},tech_info:{href:{location:"${ref-path}"+audio_url,format:"audio/mp3",size:1024,requirements:[{type:"QUOTA",name:"duration",min_version:null,max_version:null,installation:null,install_file:null,value:"PT"},{type:"QUOTA",name:"code",min_version:null,max_version:null,installation:null,install_file:null,value:"MPEG Audio"}]}},categories:{assets_type:[{identifier:"edae0ad2-66d5-447f-a81f-798392874efd",taxonpath:null,taxoncode:"$RA0100",taxonname:"媒体素材"},{identifier:"a6985313-964b-43a7-bba9-f6ae8f48c69f",taxonpath:null,taxoncode:"$RA0102",taxonname:"音频"}],mediatype:[{identifier:"d00860ae-ed86-4db7-8cb0-e9d150f147e7",taxonpath:"",taxoncode:"$F020001",taxonname:"mp3音频文件"}]}};$http({method:"POST",url:"http://esp-lifecycle.pre1.web.nd/v0.6/assets/"+uuid,data:json}).then(function(result){result.data&&($scope.opts.recordWin4=!1,$scope.opts.recordWin5=!0,$scope.opts.audio_url=result.data.tech_info.href.location)},function(){})}},oReq.send(oData)},function(response){})}$rootScope.moduleScope=$scope,$scope.errorModel={},$scope.test="",$scope.model={id:"",module_code:"nd_section_evaluating",title:$filter("translate")("section_evaluating.placeholder.title"),skin:{code:"wood",css_url:"",name:$filter("translate")("app.skin.wood"),package_url:""},timer:{timer_type:"sequence",time_minute:"0",time_second:"0"},properties:[{name:"question_id",display_name:"题目ID",type:"string",value:"",is_localized:!1},{name:"question_url",display_name:"题目内容",type:"jsonFile",value:"",is_localized:!1}],content:{id:"1",parentId:"001001",article:{text:"",paragraph:[]},meaning:"你好世界",audio_url:"",audio_name:""}};var audioBlob,tempRecordAudio;$scope.assetResult={},$scope.content=$scope.model.content,$scope.opts={selectTypeWinFlag:!1,addWinFlag:!1,recordWin3:!1,recordWin4:!1,recordWin5:!1,cleanSectionFlag:!1},$scope.opts.recordUrl="/interaction/sentence_evaluat/record/record.html",$scope.resourceValidParam={},$scope.selectTypeWin=function(){$scope.opts.selectTypeWinFlag=!0},$scope.winColse=function(){$scope.opts=$.extend({},$scope.opts,{selectTypeWinFlag:!1,addWinFlag:!1,recordWin3:!1,recordWin4:!1,recordWin5:!1,cleanSectionFlag:!1})},$scope.addAssets=function(type){$("#section_audio")[0].pause(),$scope.content.audio_url=$scope.assetResult.asset,$scope.content.audio_name=$scope.assetResult.title,$scope.assetResult={}},$scope.clearAll=function(){$scope.content.article.text=""},$scope.record=function(oper){$scope.startRecording(oper),"start"===oper?$scope.opts.startRecord=!1:"reset"===oper||"complete"===oper&&($scope.opts.addWinFlag=!1,$scope.opts.recordWin3=!0,$scope.stopRecording())},$scope.playAudio=function(){$("#section_audio")[0].load(),$("#section_audio")[0].play()},$scope.deleteSectionAudio=function(){$("#section_audio")[0].pause(),$scope.content.audio_url=""},$scope.startRecording=function(oper){"start"===oper?($("record_time").html("00:00"),recorder&&recorder.record(),console.log("Recording...")):"reset"===oper&&(recorder&&recorder.stop(),recorder&&recorder.record())},$scope.stopRecording=function(){recorder&&recorder.stop(),console.log("Stopped recording."),createDownloadLink(),recorder.clear()},$scope.tempRecordAudio=function(){tempRecordAudio.play()},$scope.buttonCallback={previewBefore:function(){$("#section_audio").length>0&&$("#section_audio")[0].pause()}},$scope.saveRecordAudio=function(){$scope.winColse(),$scope.content.audio_url=$scope.opts.audio_url,$scope.content.audio_name=$scope.opts.audio_name},$scope.sendAudioData=sendForm;var recorder,tempRecordAudio,audioBlob,audio_context;init();var loadingData=function(id){$scope.isloadingData=!0,CustomEditorService.getQuestionInfoById(id).then(function(rtnData){rtnData?(""!=rtnData.skin.code?$scope.model=$scope.decodeData(rtnData,!0):$scope.model.id=rtnData.id,skin_service.set_skin_by_code($scope.model.skin.code,"v1"),$scope.errorModel.errorText="",$scope.isloadingData=!1):$scope.errorModel.errorText=$filter("translate")("app.unvalidno")},function(error){$scope.errorModel.errorText=$filter("translate")("app.question.get.error")})};$stateParams.id?loadingData($stateParams.id):skin_service.set_skin_by_code($scope.model.skin.code,"v1"),$scope.$on("changgedSkin",function(){$rootScope.scaleHtml()}),$scope.validPostData=function(){var modelData=$scope.model;""==$.trim(modelData.title)&&(modelData.title=$filter("translate")("section_evaluating.placeholder.title"));for(var tempText=modelData.content.article.text.trim(),enCharts=["。","，","？","“","”","‘","’","！","；","：","（","）"],cnCharts=[".",",","?",'"','"',"'","'","!",";",":","(",")"],i=0,l=enCharts.length;i<l;i++)tempText=tempText.replace(new RegExp(enCharts[i],"g"),cnCharts[i]);if(modelData.content.article.text=tempText,modelData.content.article.text.length<=0)return $scope.errorModel.errorText=$filter("translate")("section_evaluating.sentences_empty"),$("#section_textarea").focus(),!1;var text=modelData.content.article.text;if(/^([a-zA-Z0-9]|[.?!';,\-_+*\\()&^%$#@\s])+$/.test(text)===!1)return $scope.errorModel.errorText=$filter("translate")("section_evaluating.english_format"),$("#section_textarea").focus(),!1;if(text.trim()){for(var tempArr=text.split(/[!?,.\s]/),length=tempArr.length,i=0,l=tempArr.length;i<l;i++)""===tempArr[i]&&length--;if(length<15)return $scope.errorModel.errorText=$filter("translate")("section_evaluating.format.error2"),$("#section_textarea").focus(),!1;if(length>200)return $scope.errorModel.errorText=$filter("translate")("section_evaluating.format.error3"),$("#section_textarea").focus(),!1}return/.*[.?!]$/.test(text.trim())===!1?($scope.errorModel.errorText=$filter("translate")("section_evaluating.format.error1"),!1):($("#section_audio")[0].pause(),!0)},$scope.encodeData=function(model){return model.packages=[],model.packages.push({src:model.content.audio_url,type:"file"}),model},$scope.decodeData=function(model,isInitLoad){return $scope.content=model.content,model}}])});