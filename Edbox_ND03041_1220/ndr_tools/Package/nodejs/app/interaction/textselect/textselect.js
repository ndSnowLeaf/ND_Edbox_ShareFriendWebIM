define("textselect/directive/textselect.directive",["components/site-directive/assets-select/assets-select","components/site-directive/edit-box/new-edit-box","components/site-directive/time-setting-box/time-setting-box","components/site-directive/foot-tool/time-box/new-time-box","components/site-directive/foot-tool/foot-tool","components/site-directive/select-skin/select-skin","components/site-directive/error-tip/error-tip","components/site-services/charset.service"],function(){}),define(["app","textselect/directive/textselect.directive"],function(app){"use strict";app.controller("textselect_ctrl",["$scope","skin_service","$stateParams","CustomEditorService","CharsetService","$rootScope","$filter",function($scope,skin_service,$stateParams,CustomEditorService,CharsetService,$rootScope,$filter){function uuid(){for(var s=[],hexDigits="0123456789abcdef",i=0;i<36;i++)s[i]=hexDigits.substr(Math.floor(16*Math.random()),1);s[14]="4",s[19]=hexDigits.substr(3&s[19]|8,1),s[8]=s[13]=s[18]=s[23]="-";var uuid=s.join("");return uuid}function setOptions(m){var selection=$scope.view.selection,range=selection.getRangeAt(0),content="";if(!checkData(range))return void($scope.errorModel.errorText=$filter("translate")("textselect.body_error"));content=range.startContainer.textContent;var start=content.substring(0,range.startOffset),selected=content.substring(range.startOffset,range.endOffset),end=content.substring(range.endOffset);if(""==selected.trim())return void $scope.cancel();var str=escapeTarget(start)+'<span contenteditable="false" class="'+(m?"textselect_correct":"textselect_error")+'" id="'+uuid()+'"><em>'+escapeTarget(selected)+'</em><a class="delete_select"></a></span>'+escapeTarget($.trim(end));""==escapeTarget($.trim(end))&&(str+="&nbsp;");var result=complexReplace(escapeHtml(getContentByHtml()),escapeTarget(content),str,range.startContainer.previousSibling,range);$scope.view.content=result,$scope.cancel()}function setCursorPosition(pos){var selection=window.getSelection(),range=selection.getRangeAt(0),container=range.startContainer;if(3!=container.nodeType){var node=container.childNodes[range.startOffset];if(node){var newRange=document.createRange();newRange.setStart(node,pos),newRange.collapse(!0),selection.removeAllRanges(),selection.addRange(newRange)}}}function complexReplace(originContent,content,str,previousSibling,range){var id=previousSibling?previousSibling.id:"",index=0;if(id){index=originContent.indexOf(id);for(var i=index;i<originContent.length-7&&"</span>"!==originContent.substr(i,7);i++);return originContent.substring(0,i+7)+originContent.substr(i+7).replace(content,function(){return str})}return"children"==range.startContainer.parentElement.className?(id=range.startContainer.parentElement.id,index=originContent.indexOf(id),originContent.substring(0,index)+originContent.substr(index).replace(content,function(){return str})):originContent.replace(content,function(){return str})}function escapeHtml(text){return text.replace(/&nbsp;/g,String.fromCharCode(160)).replace(/&amp;/g,"&")}function escapeTarget(text){return text.replace(/</g,"&lt;").replace(/>/g,"&gt;")}function setOptionsWithSpan(m){$(currentTarget).removeClass("textselect_correct textselect_error").addClass(m?"textselect_correct":"textselect_error"),$scope.cancel()}function getContentByHtml(){return $(".textselect_edit").html()}function getContentByText(){return $(".textselect_edit").text()}function checkData(range){return range.startContainer===range.endContainer&&"DIV"==range.startContainer.parentElement.tagName}function getContent(){for(var q=$scope.model.prompt,result=q.content,i=0;i<q.candidates.length;i++){var c=q.candidates[i];result=c.correct?result.replace("{"+c.num+"}",function(){return'<span contenteditable="false" id="'+uuid()+'" class="textselect_correct" data-num="'+c.num+'"><em>'+c.value+'</em><a class="delete_select"></a></span>'}):result.replace("{"+c.num+"}",function(){return'<span contenteditable="false" id="'+uuid()+'" class="textselect_error" data-num="'+c.num+'"><em>'+c.value+'</em><a class="delete_select"></a></span>'})}return result}var isSpan=!1,currentTarget=null,ismousedown=!1;$scope.errorModel={},$scope.optionItems=[],$scope.model={id:"",title:"",skin:{code:"wood",css_url:"${ref-path}/edu/esp/preparecustomeditor/compare/wood/css/wood.css",name:$filter("translate")("linkup.muwen"),package_url:"${ref-path}/edu/esp/preparecustomeditor/compare/wood"},timer:{timer_type:"sequence",time_minute:"0",time_second:"0"},prompt:{content:"",candidates:[]}},$rootScope.moduleScope=$scope,$scope.defaultTitleSetting={isCleared:!1,title:$filter("translate")("textselect.default.title")},$scope.model.title=$scope.defaultTitleSetting.title,$scope.view={showButton:!1,left:0,top:0,selection:null,content:"",showHolder:!0,byteCount:0};var loadingData=function(id){CustomEditorService.getQuestionInfoById(id).then(function(rtnData){if(rtnData){if(""!=rtnData.skin.code){angular.extend($scope.model,rtnData),$scope.view.content=getContent(),$scope.view.showHolder=!1;var byteCount=CharsetService.getTextBytes($("<div>"+$scope.view.content+"</div>").text());$scope.view.byteCount=byteCount}else $scope.model.id=rtnData.id,$scope.view.showHolder=!0;$scope.errorModel.errorText="",skin_service.set_skin_by_code($scope.model.skin.code,"v1")}else $scope.errorModel.errorText=$filter("translate")("linkup.unvalidno")},function(){$scope.errorModel.errorText=$filter("translate")("linkup.get_title_error")})};$scope.$on("changgedSkin",function(){$rootScope.scaleHtml()}),$scope.encodeData=function(model1){for(var res,model=angular.copy(model1),content=getContentByHtml(),result=[],reg=/<span\scontenteditable="false".*?>.*?<em>.*?<\/em>.*?<\/span>/g,cacheContent=content.replace(/{/g,"&#123;").replace(/}/g,"&#125;"),content=cacheContent,index=0;res=reg.exec(content);)result.push(res[0]),cacheContent=cacheContent.replace(res[0],"{"+index+"}"),index++;model.prompt.content=cacheContent;for(var i=0;i<result.length;i++){model.prompt.content=model.prompt.content.replace(result[i],"{"+i+"}");var value=result[i].match(/<span.*?>.*?<em>(.*?)<\/em>.*?<\/span>/)[1];value=value.replace(/&#123;/g,"{").replace(/&#125;/g,"}"),model.prompt.candidates[i]={num:i,value:value,correct:result[i].indexOf("textselect_correct")>0}}return model},$scope.decodeData=function(data){$scope.model.id=data.id},$scope.validPostData=function(){var modelData=$scope.model;if(""==$.trim(modelData.title))return $scope.errorModel.errorText=$filter("translate")("textselect.no_title"),!1;var $span=$(".textselect_edit").find("span"),correctCount=0,errorCount=0;if($span.each(function(index,value){$(value).hasClass("textselect_correct")&&correctCount++,$(value).hasClass("textselect_error")&&errorCount++}),0==correctCount)return $scope.errorModel.errorText=$filter("translate")("textselect.invalidate"),!1;if(1==correctCount&&0==errorCount)return $scope.errorModel.errorText=$filter("translate")("textselect.invalidate1"),!1;for(var contentText=getContentByText();contentText&&contentText[contentText.length-1]==escapeHtml("&nbsp;");)contentText=contentText.substr(0,contentText.length-1);return!(CharsetService.getTextBytes(contentText)>800)||($scope.errorModel.errorText=$filter("translate")("textselect.words.exceed"),!1)},$stateParams.id?loadingData($stateParams.id):(skin_service.set_skin_by_code($scope.model.skin.code,"v1"),$scope.view.content=getContent(),$scope.view.showHolder=!0),$scope.blur=function(){getContentByText().length<=0&&($scope.view.showHolder=!0)},$scope.focus=function(){$scope.view.showHolder=!1},$scope.mousedown=function(){window.getSelection().removeAllRanges(),$scope.cancel(),ismousedown=!0,$scope.view.selection=null},$scope.mousemove=function(evt){ismousedown&&(isSpan=!1)},$scope.mouseup=function(evt){ismousedown=!1;var selection=window.getSelection();if(""!=selection.toString()){var offset=$(evt.currentTarget).offset(),maxLeft=$(".textselect_edit").width()-170,setLeft=evt.pageX-offset.left;$scope.view.selection=selection,$scope.view.left=setLeft>maxLeft?maxLeft:setLeft,$scope.view.top=evt.pageY-offset.top,$scope.view.showButton=!0}},$scope.correct=function(){isSpan?setOptionsWithSpan(1):setOptions(1)},$scope.error=function(){isSpan?setOptionsWithSpan(0):setOptions(0)},$scope.cancel=function(){isSpan=!1,currentTarget=null,$scope.view.left=0,$scope.view.top=0,$scope.view.showButton=!1};$scope.keydown=function(evt){8!=evt.keyCode&&46!=evt.keyCode||$scope.cancel()},$scope.keyup=function(evt){if(13==evt.keyCode&&$(".textselect_edit >div").each(function(index,value){$(value).attr("class","children"),$(value).attr("id","childrenId_"+index)}),8==evt.keyCode){$(".textselect_edit span").each(function(index,value){$(value).attr("class")||($scope.view.content=getContentByHtml().replace(value.outerHTML,function(){return $(value).text()}))});var selection=window.getSelection(),range=selection.getRangeAt(0),pos=range.startOffset;$(".textselect_edit").html($(".textselect_edit").html()),setCursorPosition(pos)}var byteCount=CharsetService.getTextBytes(getContentByText());$scope.view.byteCount=byteCount},$scope.dblclick=function(evt){evt.preventDefault(),window.getSelection().removeAllRanges(),$scope.cancel()};var timerId=0;$scope.paste=function(event){window.clearTimeout(timerId),timerId=setTimeout(function(){$(".textselect_edit div").each(function(index,value){$(value).attr("class","children"),$(value).attr("id","childrenId_"+index)})},200)},$scope.click=function(event){$scope.view.showHolder=!1,$(".textselect_edit").focus()},$(".textselect_edit").on("click","span a",function(evt){evt.stopPropagation(),evt.preventDefault();var $target=$(evt.currentTarget).parent(),text=$target.text();$target.before(text),$target.remove(),$(".textselect_edit").html($(".textselect_edit").html())}),$(".textselect_edit").on("click","span",function(evt){evt.stopPropagation(),evt.preventDefault(),isSpan=!0,currentTarget=evt.currentTarget;var offset=$(".textselect_edit").offset(),maxLeft=$(".textselect_edit").width()-170,setLeft=evt.pageX-offset.left;$scope.view.left=setLeft>maxLeft?maxLeft:setLeft,$scope.view.top=evt.pageY-offset.top,$scope.view.showButton=!0,$("#hidefocus").focus()})}])});