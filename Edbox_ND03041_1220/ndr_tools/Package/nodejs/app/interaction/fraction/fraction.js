define("fraction/directive/panel/translate-panel",["angularAMD"],function(angularAMD){angularAMD.directive("translatePanel",[function(){return{restrict:"E",templateUrl:"interaction/fraction/directive/panel/translate-panel.html",scope:{prompt:"=prompt",previousStep:"=previousStep",allowLcm:"=allowLcm",allowSampleResult:"=allowSampleResult"},link:function(scope,element,attrs){scope.checkNum=function(item){item.hide=!item.hide}}}}])}),define("fraction/directive/panel/count-panel",["angularAMD"],function(angularAMD){angularAMD.directive("countPanel",[function(){return{restrict:"E",templateUrl:"interaction/fraction/directive/panel/count-panel.html",scope:{inputData:"=countData",nextStep:"=nextStep"},replace:!0,link:function(scope,element,attrs){function focusNewVauleByIndex(value,Index){$("#f_inputText").val(value),$("#f_inputText")[0].focus(),$("#f_inputText")[0].setSelectionRange(Index,Index)}function isValidFraction(inputData,c){if(!inputData&&/(^0|[\/+-])/.test(c))return!1;var flag=/[+-]/.test(c);if(flag){if(/[+-]$/.test(inputData))return inputData=inputData.replace(/[+-]$/,c),!1;if(/[+-]/.test(inputData)||inputData&&/[0-9]$/.test(inputData)===!1)return!1}else{var l=inputData.length,strNum=l>=7?inputData.substring(l-6,l):inputData;if(l>=6&&/^\d{6}$/.test(strNum)&&/^\d$/.test(c))return!1;if(/[\/+-]$/.test(inputData)&&"0"===c)return!1;if(inputData&&/[0-9]$/.test(inputData)===!1&&"/"===c)return!1;if(/\/\d\d*$/.test(inputData)&&"/"===c)return!1}return!0}var isPinyin=!1,cArr=["0","1","2","3","4","5","6","7","8","9","","+","","-","","/"];scope.keybaord=function(e){var keyCode=e.keyCode,inputText=$("#f_inputText").val();if(keyCode>=96&&keyCode<108||109===keyCode||111===keyCode){var c=cArr[keyCode-96];if(isValidFraction(inputText.substr(0,$("#f_inputText")[0].selectionStart),c)===!1)return e.preventDefault(),!1}else if(keyCode>47&&keyCode<58&&event.shiftKey===!1||187===keyCode&&e.shiftKey===!0||189===keyCode&&e.shiftKey===!1||191===keyCode&&e.shiftKey===!1){keyCode>180&&(keyCode=58+(keyCode-186));var c=cArr[keyCode-48];isValidFraction(inputText.substr(0,$("#f_inputText")[0].selectionStart),c)===!1&&e.preventDefault()}else 229===keyCode?isPinyin=!0:8===keyCode||keyCode>36&&keyCode<41||e.preventDefault()},scope.keyup=function(e){var inputText=$("#f_inputText").val(),startIndex=$("#f_inputText")[0].selectionStart,endIndex=$("#f_inputText")[0].selectionEnd;startIndex===endIndex&&isValidFraction(inputText.substr(0,startIndex-1),inputText.substr(startIndex-1,1))===!1&&(inputText=inputText.substr(0,startIndex-1)+inputText.substr(startIndex),focusNewVauleByIndex(inputText,startIndex-1)),scope.inputData=inputText,/^\d{1,6}\/[1-9]\d{0,5}[+-]\d{1,6}\/[1-9]\d{0,5}$/.test(inputText)===!0?angular.element("#next_step").css({background:"rgb(69, 153, 249)",color:"#FFF"}):angular.element("#next_step").css({background:"#FFF",color:"#888"})},scope.getNum=function(c){var inputText=$("#f_inputText").val(),startIndex=$("#f_inputText")[0].selectionStart,endIndex=$("#f_inputText")[0].selectionEnd;if(scope.inputData.length===startIndex)isValidFraction(inputText,c)&&(inputText+=c,$("#f_inputText").val(inputText));else{if(startIndex<endIndex)inputText=inputText.substr(0,startIndex)+c+inputText.substr(endIndex);else{var tempStr=inputText.substr(0,startIndex);isValidFraction(tempStr,c)?inputText=tempStr+c+inputText.substr(startIndex):startIndex>0&&startIndex--}focusNewVauleByIndex(inputText,startIndex+1)}scope.inputData=inputText,inputText&&scope.keyup()},scope.deleteNum=function(){var inputText=scope.inputData;if(inputText.length===$("#f_inputText")[0].selectionStart)scope.inputData=inputText.replace(/.$/,""),$("#f_inputText").val(scope.inputData);else{var startIndex=$("#f_inputText")[0].selectionStart,endIndex=$("#f_inputText")[0].selectionEnd;startIndex<endIndex?inputText=inputText.substr(0,startIndex)+inputText.substr(endIndex):(inputText=inputText.substr(0,startIndex-1)+inputText.substr(startIndex),startIndex--),focusNewVauleByIndex(inputText,startIndex),scope.inputData=inputText}scope.keyup()}}}}])}),define("fraction/directive/fraction.directive",["components/site-directive/assets-select/assets-select","components/site-directive/error-tip/error-tip","components/site-directive/edit-box/new-edit-box","components/site-directive/foot-tool/time-box/new-time-box","components/site-directive/foot-tool/foot-tool","components/site-directive/select-skin/select-skin","fraction/directive/panel/translate-panel","fraction/directive/panel/count-panel"],function(){}),define(["app","fraction/directive/fraction.directive"],function(app){"use strict";app.controller("fraction_ctrl",["$scope","skin_service","$stateParams","CustomEditorService","UserDataService","$rootScope","$filter","$timeout",function($scope,skin_service,$stateParams,CustomEditorService,UserDataService,$rootScope,$filter,$timeout){function getResultByLcm(result){var gNum=gcd(result.numerator.num,result.denominator.num);return result.numerator.num=result.numerator.num/gNum,result.denominator.num=result.denominator.num/gNum,result}function gcd(a,b){if(a<b){var temp=a;a=b,b=temp}for(;0!=b;){var temp=a%b;a=b,b=temp}return a}$scope.fractions={placeholder:{title:"请输入标题"},inputValue:"",flag:!0,calError:!1},$scope.model={id:"",title:"",skin:{code:"wood",css_url:"",name:$filter("translate")("linkup.muwen"),package_url:""},timer:{timer_type:"sequence",time_minute:"0",time_second:"0"},prompt:{first:{},second:{},operator:{},procedure:[],result:{denominator:{hide:!1},numerator:{hide:!1}},allow_lcm:!0}},$rootScope.moduleScope=$scope,$scope.defaultTitleSetting={isCleared:!1,title:$filter("translate")("fraction.default.title")},$scope.model.title=$scope.defaultTitleSetting.title;var loadingData=function(id){CustomEditorService.getQuestionInfoById(id).then(function(rtnData){rtnData?(""!=rtnData.skin.code?(angular.extend($scope.model,$scope.decodeOrder(rtnData)),$scope.prompt=$scope.model.prompt):$scope.model.id=rtnData.id,skin_service.set_skin_by_code($scope.model.skin.code,"v1")):$scope.errorModel.errorText=$filter("translate")("fraction.unvalidno")},function(){$scope.errorModel.errorText=$filter("translate")("fraction.get_title_error")})};$stateParams.id?loadingData($stateParams.id):skin_service.set_skin_by_code($scope.model.skin.code,"v1"),$scope.$on("changgedSkin",function(){$rootScope.scaleHtml()}),$scope.prompt=$scope.model.prompt,$scope.nextStep=function(input){function getFractions(num){var index=num.search(/\//),n1=parseInt(num.substring(0,index)),n2=parseInt(num.substring(index+1));return{numerator:n1,denominator:n2}}var prompt=$scope.model.prompt;if(/^[1-9]\d{0,5}\/[1-9]\d{0,5}[+-][1-9]\d{0,5}\/[1-9]\d{0,5}$/.test(input)===!1)return void($scope.errorModel.errorText=$filter("translate")("fraction.formula.error"));if(input&&$scope.fractions.originNum===input)return void($scope.fractions.flag=!1);var n=input.search(/[+-]/),operator=input.substring(n,n+1),num1=input.substring(0,n),num2=input.substring(n+1);if(prompt.first=getFractions(num1),prompt.second=getFractions(num2),prompt.operator=operator,"+"===operator?prompt.result.numerator.num=prompt.first.numerator*prompt.second.denominator+prompt.second.numerator*prompt.first.denominator:prompt.result.numerator.num=prompt.first.numerator*prompt.second.denominator-prompt.second.numerator*prompt.first.denominator,prompt.result.numerator.num<0)prompt.result.numerator.num=-prompt.result.numerator.num,prompt.result.symbol="-";else{if(0===prompt.result.numerator.num)return void($scope.errorModel.errorText=$filter("translate")("fraction.diff.fractional"));prompt.result.symbol="+"}prompt.result.denominator.num=prompt.first.denominator*prompt.second.denominator,prompt.allow_lcm=!0,prompt.allow_sample_result=!1;var lcmNum=prompt.first.denominator*prompt.second.denominator/gcd(prompt.first.denominator,prompt.second.denominator);prompt.lcm=lcmNum,prompt.procedure=[{numerator:{first:{num:prompt.first.numerator,hide:!1},second:{num:lcmNum/prompt.first.denominator,hide:!1}},denominator:{first:{num:prompt.first.denominator,hide:!1},second:{num:lcmNum/prompt.first.denominator,hide:!1}}},{numerator:{first:{num:prompt.second.numerator,hide:!1},second:{num:lcmNum/prompt.second.denominator,hide:!1}},denominator:{first:{num:prompt.second.denominator,hide:!1},second:{num:lcmNum/prompt.second.denominator,hide:!1}}}],$scope.allowLcm(),$scope.fractions.originNum=input,$scope.fractions.flag=!1},$scope.allowLcm=function(){var prompt=$scope.model.prompt;prompt.allow_lcm===!0?(prompt.procedure[0].numerator.second.num=prompt.second.denominator,prompt.procedure[0].denominator.second.num=prompt.second.denominator,prompt.procedure[1].numerator.second.num=prompt.first.denominator,prompt.procedure[1].denominator.second.num=prompt.first.denominator):(prompt.procedure[0].numerator.second.num=prompt.lcm/prompt.first.denominator,prompt.procedure[0].denominator.second.num=prompt.lcm/prompt.first.denominator,prompt.procedure[1].numerator.second.num=prompt.lcm/prompt.second.denominator,prompt.procedure[1].denominator.second.num=prompt.lcm/prompt.second.denominator),prompt.allow_sample_result===!1&&("+"===prompt.operator?prompt.result.numerator.num=prompt.procedure[0].numerator.first.num*prompt.procedure[0].numerator.second.num+prompt.procedure[1].numerator.first.num*prompt.procedure[1].numerator.second.num:prompt.result.numerator.num=prompt.procedure[0].numerator.first.num*prompt.procedure[0].numerator.second.num-prompt.procedure[1].numerator.first.num*prompt.procedure[1].numerator.second.num,prompt.result.numerator.num=Math.abs(prompt.result.numerator.num),prompt.result.denominator.num=prompt.procedure[1].denominator.second.num*prompt.procedure[1].denominator.first.num),prompt.allow_lcm=!prompt.allow_lcm,window.event.preventDefault()},$scope.allowSampleResult=function(){var prompt=$scope.prompt;prompt.allow_sample_result===!0?("+"===prompt.operator?prompt.result.numerator.num=prompt.procedure[0].numerator.first.num*prompt.procedure[0].numerator.second.num+prompt.procedure[1].numerator.first.num*prompt.procedure[1].numerator.second.num:prompt.result.numerator.num=prompt.procedure[0].numerator.first.num*prompt.procedure[0].numerator.second.num-prompt.procedure[1].numerator.first.num*prompt.procedure[1].numerator.second.num,prompt.result.numerator.num=Math.abs(prompt.result.numerator.num),prompt.result.denominator.num=prompt.procedure[1].denominator.second.num*prompt.procedure[1].denominator.first.num):prompt.result=getResultByLcm(prompt.result),prompt.allow_sample_result=!prompt.allow_sample_result},$scope.previousStep=function(){$scope.fractions.flag=!0},$scope.validPostData=function(){var modelData=$scope.model;if(""==$.trim(modelData.title))return $scope.errorModel.errorText=$filter("translate")("fraction.notnull.title"),!1;if($scope.fractions.flag===!0)return $scope.errorModel.errorText=$filter("translate")("fraction.next.step.go"),!1;for(var allItems=[],i=2;i--;)allItems=allItems.concat(modelData.prompt.procedure[i].numerator.first),allItems=allItems.concat(modelData.prompt.procedure[i].numerator.second),allItems=allItems.concat(modelData.prompt.procedure[i].denominator.first),allItems=allItems.concat(modelData.prompt.procedure[i].denominator.second);allItems=allItems.concat(modelData.prompt.result.numerator),allItems=allItems.concat(modelData.prompt.result.denominator);for(var flag=!1,i=0,l=allItems.length;i<l;i++)if(allItems[i].hide===!0){flag=!0;break}return flag!==!1||($scope.errorModel.errorText=$filter("translate")("fraction.no_content"),!1)},$scope.encodeOrder=function(model){var newModel=angular.copy(model);return newModel},$scope.decodeOrder=function(model){return model.prompt.screen="",model.prompt.screen+=model.prompt.first.numerator+"/"+model.prompt.first.denominator,model.prompt.screen+=model.prompt.operator,model.prompt.screen+=model.prompt.second.numerator+"/"+model.prompt.second.denominator,$scope.fractions.inputValue=model.prompt.screen,$scope.fractions.originNum=model.prompt.screen,$scope.model.prompt=model.prompt,$scope.prompt=$scope.model.prompt,model}}])});