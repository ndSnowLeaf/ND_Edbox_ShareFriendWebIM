define("memorycard/directive/memorycard.directive",["components/site-directive/assets-select/assets-select","components/site-directive/error-tip/error-tip","components/site-directive/edit-box/new-edit-box","components/site-directive/foot-tool/time-box/new-time-box","components/site-directive/foot-tool/foot-tool","components/site-directive/match-item/match-item"],function(){}),define(["app","memorycard/directive/memorycard.directive"],function(app){"use strict";app.controller("memorycard_ctrl",["$scope","skin_service","$stateParams","CustomEditorService","$rootScope","$filter",function($scope,skin_service,$stateParams,CustomEditorService,$rootScope,$filter){function setDefaultTitle(module_subtype){switch(module_subtype){case"image2image":$scope.defaultTitleSetting.title=$filter("translate")("memorycard.title.image2image");break;case"image2text":$scope.defaultTitleSetting.title=$filter("translate")("memorycard.title.image2text");break;case"text2text":$scope.defaultTitleSetting.title=$filter("translate")("memorycard.title.text2text")}}function isSameImageCard(source,target,indexI,indexJ){return""!=source.href&&""!=target.href&&source.href==target.href&&(indexJ?$scope.errorModel.errorText=$filter("translate")("memorycard.duplicate_imagecard_between",{indexI:indexI,indexJ:indexJ}):indexI&&($scope.errorModel.errorText=$filter("translate")("memorycard.duplicate_imagecard",{index:indexI})),!0)}function isSameTextCard(source,target,indexI,indexJ){return""!=source.text&&""!=target.text&&source.text==target.text&&(indexJ?$scope.errorModel.errorText=$filter("translate")("memorycard.duplicate_textcard_between",{indexI:indexI,indexJ:indexJ}):indexI&&($scope.errorModel.errorText=$filter("translate")("memorycard.duplicate_textcard",{index:indexI})),!0)}function checkDuplication(modelData){var isValid=!0;if("image2image"==modelData.module_subtype)for(var itemI,itemJ,i=0;i<modelData.items.length;i++){itemI=modelData.items[i];for(var j=i+1;j<modelData.items.length;j++){if(itemJ=modelData.items[j],isSameImageCard(itemI.source,itemJ.source,i+1,j+1)||isSameImageCard(itemI.source,itemJ.target,i+1,j+1))return isValid=!1,!1;if(isSameImageCard(itemI.target,itemJ.source,i+1,j+1)||isSameImageCard(itemI.target,itemJ.target,i+1,j+1))return isValid=!1,!1}}else if("image2text"==modelData.module_subtype)for(var i=0;i<modelData.items.length;i++){itemI=modelData.items[i];for(var j=i+1;j<modelData.items.length;j++){if(itemJ=modelData.items[j],isSameImageCard(itemI.source,itemJ.source,i+1,j+1))return isValid=!1,!1;if(isSameTextCard(itemI.target,itemJ.target,i+1,j+1))return isValid=!1,!1}}else for(var i=0;i<modelData.items.length;i++){itemI=modelData.items[i];for(var j=i+1;j<modelData.items.length;j++){if(itemJ=modelData.items[j],isSameTextCard(itemI.source,itemJ.source,i+1,j+1)||isSameTextCard(itemI.source,itemJ.target,i+1,j+1))return isValid=!1,!1;if(isSameTextCard(itemI.target,itemJ.source,i+1,j+1)||isSameTextCard(itemI.target,itemJ.target,i+1,j+1))return isValid=!1,!1}}return isValid}$rootScope.moduleScope=$scope,$scope.errorModel={},$scope.delData={data:{}},$scope.model={module_subtype:"",title:"",skin:{code:"wood",css_url:"${ref-path}/edu/esp/preparecustomeditor/memorycard/wood/css/wood.css",name:$filter("translate")("memorycard.muwen"),package_url:"${ref-path}/edu/esp/preparecustomeditor/memorycard/wood"},timer:{timer_type:"sequence",time_minute:"0",time_second:"0"}};var initModel={module_subtype:"image2text",title:"",skin:{code:"wood",css_url:"${ref-path}/edu/esp/preparecustomeditor/memorycard/wood/css/wood.css",name:$filter("translate")("memorycard.muwen"),package_url:"${ref-path}/edu/esp/preparecustomeditor/memorycard/wood"},timer:{timer_type:"sequence",time_minute:"0",time_second:"0"},items:[{},{},{}]},loadingData=function(id){$scope.isloadingData=!0,CustomEditorService.getQuestionInfoById(id).then(function(rtnData){rtnData?(""!=rtnData.skin.code?($scope.model=$scope.decodeOrder(rtnData),setDefaultTitle($scope.model.module_subtype),skin_service.set_skin_by_code($scope.model.skin.code,"v1")):($scope.showGuide=!0,initModel.id=rtnData.id,skin_service.set_skin_by_code($scope.model.skin.code,"v1")),$scope.errorModel.errorText="",$scope.isloadingData=!1):$scope.errorModel.errorText=$filter("translate")("memorycard.unvalidno")},function(error){$scope.errorModel.errorText=$filter("translate")("memorycard.get_title_error")})};$stateParams.id?($scope.showGuide=!1,loadingData($stateParams.id)):($scope.showGuide=!0,skin_service.set_skin_by_code(initModel.skin.code,"v1")),$scope.defaultTitleSetting={isCleared:!1},$scope.setModuleSubtype=function(module_subtype){$scope.showGuide=!1,initModel.module_subtype=module_subtype,$scope.model.items=[{},{},{}],$scope.model.module_subtype=module_subtype,$scope.model.id=initModel.id,setDefaultTitle($scope.model.module_subtype),$scope.model.title||($scope.model.title=$scope.defaultTitleSetting.title),$rootScope.scaleHtml()},$scope.$on("changgedSkin",function(){$rootScope.scaleHtml()}),$scope.addMatchItem=function(){$scope.model.items.push(angular.copy($scope.delData.data)),$scope.delData={data:{}}},$scope.validPostData=function(){var modelData=$scope.model;if(""!=$.trim(modelData.title)){for(var itemsCount=0,i=0;i<modelData.items.length;i++){if(!modelData.items[i].source.href&&!modelData.items[i].source.text||!modelData.items[i].target.href&&!modelData.items[i].target.text)return void($scope.errorModel.errorText=$filter("translate")("memorycard.no_content"));itemsCount++}return itemsCount<3&&($scope.errorModel.errorText=$filter("translate")("memorycard.content_min")),checkDuplication(modelData)}$scope.errorModel.errorText=$filter("translate")("memorycard.no_title")},$scope.addImagePost=function(matchItem,$index){var isValid=!0;return angular.forEach($scope.model.items,function(item,index){if(item!=matchItem)if("image2image"==$scope.model.module_subtype){if(isSameImageCard(matchItem.source,item.source,index+1)||isSameImageCard(matchItem.source,item.target,index+1))return isValid=!1,!1;if(isSameImageCard(matchItem.target,item.source,index+1)||isSameImageCard(matchItem.target,item.target,index+1))return isValid=!1,!1}else if("image2text"==$scope.model.module_subtype&&isSameImageCard(matchItem.source,item.source,index+1))return isValid=!1,!1}),isValid},$scope.addTextPost=function(matchItem,$index){var isValid=!0;return angular.forEach($scope.model.items,function(item,index){if(item!=matchItem)if("text2text"==$scope.model.module_subtype){if(isSameTextCard(matchItem.source,item.source,index+1)||isSameTextCard(matchItem.source,item.target,index+1))return isValid=!1,!1;if(isSameTextCard(matchItem.target,item.source,index+1)||isSameTextCard(matchItem.target,item.target,index+1))return isValid=!1,!1}else if("image2text"==$scope.model.module_subtype&&isSameTextCard(matchItem.target,item.target,index+1))return isValid=!1,!1}),isValid},$scope.encodeOrder=function(model){var newModel=angular.copy(model);newModel.title=window.customHtmlEncode(newModel.title);for(var i=0;i<newModel.items.length;i++)"text"==newModel.items[i].source.item_type&&(newModel.items[i].source.text=window.customHtmlEncode(newModel.items[i].source.text)),"text"==newModel.items[i].target.item_type&&(newModel.items[i].target.text=window.customHtmlEncode(newModel.items[i].target.text));return newModel},$scope.encodeData=function(model){var newModel=angular.copy(model);newModel.title=window.customHtmlEncode(newModel.title);for(var i=0;i<newModel.items.length;i++)"text"==newModel.items[i].source.item_type&&(newModel.items[i].source.text=window.customHtmlEncode(newModel.items[i].source.text)),"text"==newModel.items[i].target.item_type&&(newModel.items[i].target.text=window.customHtmlEncode(newModel.items[i].target.text));return newModel},$scope.decodeOrder=function(model){var newModel=angular.copy(model);newModel.title=window.customHtmlDecode(newModel.title);for(var i=0;i<newModel.items.length;i++)"text"==newModel.items[i].source.item_type&&(newModel.items[i].source.text=window.customHtmlDecode(newModel.items[i].source.text)),"text"==newModel.items[i].target.item_type&&(newModel.items[i].target.text=window.customHtmlDecode(newModel.items[i].target.text));return newModel},$scope.decodeData=function(model){var newModel=angular.copy(model);newModel.title=window.customHtmlDecode(newModel.title);for(var i=0;i<newModel.items.length;i++)"text"==newModel.items[i].source.item_type&&(newModel.items[i].source.text=window.customHtmlDecode(newModel.items[i].source.text)),"text"==newModel.items[i].target.item_type&&(newModel.items[i].target.text=window.customHtmlDecode(newModel.items[i].target.text));return newModel},$scope.resourceValidParam={imageType:["image/jpg","image/jpeg","image/webp","image/gif","image/png","image/bmp"],imageSize:1048576},$scope.closeImagePreview=function(){$scope.isImagePreview=!1}}])});