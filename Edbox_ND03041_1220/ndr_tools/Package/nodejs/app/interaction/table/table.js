define("table/directive/description/description",["angularAMD","components/site-directive/jq-media/jq.media","components/site-directive/event-load/event-load"],function(angularAMD){angularAMD.directive("description",["$stateParams","ngDialog","$timeout",function($stateParams,ngDialog,$timeout){return{restrict:"EA",templateUrl:"interaction/table/directive/description/description.html",scope:{description:"=descriptionData",defaultTitleSetting:"=",imageSize:"@",audioSize:"@",videoSize:"@"},replace:!0,controller:function($scope){$scope.deleteDescription=function(){$scope.description.asset_type="",$scope.description.asset="",$scope.description.other={}};var jqMedia=function(mediaType){$timeout(function(){"video"===mediaType?angular.element("#my_media_video").videoplayer():"audio"===mediaType&&angular.element("#my_media_audio").audioplayer()},800)};$scope.$watch("description.asset_type",function(newVal,oldVal){if(newVal){var asset_type=$scope.description.asset_type;"image"===asset_type?$scope.imageLoadedFlag=!1:jqMedia(asset_type)}}),$scope.imageLoadedFlag=!1,$scope.addAssets=function(asset_type){$scope.description.asset_type=asset_type},$scope.imageLoad=function(){$scope.imageLoadedFlag||($scope.imageLoadedFlag=!0,$(".insert_mvp .insert_pic_box .piccon").css("height","auto"))},$scope.resourceValidParam={imageType:["image/jpg","image/jpeg","image/webp","image/gif","image/png","image/bmp"],imageSize:1048576,videoType:"video/mp4",videoSize:5242880,audioType:["audio/mp3","audio/mpeg"],audioSize:1048576},$scope.onFocusTitle=function(event){$scope.description.text==$scope.defaultTitleSetting.title&&setTimeout(function(){event.target.select()},100)},$scope.onBlurTitle=function(event){$scope.defaultTitleSetting.titleTarget||($scope.defaultTitleSetting.titleTarget=event.target),$scope.description.text?$scope.defaultTitleSetting.isCleared=!1:($scope.defaultTitleSetting.isCleared=!0,$scope.description.text=$scope.defaultTitleSetting.title)}}}}])}),define("table/directive/options/options",["angularAMD","uuid","angular.drag.drop"],function(angularAMD,uuid){angularAMD.directive("tableOptions",[function(){return{restrict:"E",templateUrl:"interaction/table/directive/options/options.html",scope:{itemsData:"=",pageSize:"@"},replace:!0,controller:["$scope",function($scope){function getLength(str){var realLength=0;if(void 0===str)return realLength;for(var len=str.length,charCode=-1,i=0;i<len;i++)charCode=str.charCodeAt(i),realLength+=charCode>=0&&charCode<=128?1.25:2;return realLength}$scope.pageSize?$scope.pageSize=parseInt($scope.pageSize):$scope.pageSize=5,$scope.pageIndex=0,$scope.delItem=function(index){$scope.itemsData.splice(index,1),$scope.pageIndex>0&&($scope.pageIndex=$scope.pageIndex-1)},$scope.addItem=function(){$scope.itemsData.push(angular.extend({content_type:"text",content:"",horizontal_index:"",vertical_index:"",other:'style="width:300px;"',id:uuid.v4()})),$scope.itemsData.length>$scope.pageSize&&($scope.pageIndex=$scope.pageIndex+1)},$scope.addImage=function(opt){opt.content_type="image"},$scope.resourceValidParam={imageType:["image/jpg","image/jpeg","image/webp","image/gif","image/png","image/bmp"],imageSize:1048576},$scope.getStrLeng=getLength}]}}])}),define("table/directive/setting/setting",["angularAMD"],function(angularAMD){angularAMD.directive("tableSetting",[function(){return{restrict:"E",templateUrl:"interaction/table/directive/setting/setting.html",scope:{horizontalItems:"=",verticalItems:"=",tableItems:"=",dragItems:"="},controller:["$scope",function($scope){$scope.delItem=function(items){items.pop();var hl=$scope.horizontalItems.length,vl=$scope.verticalItems.length;_.remove($scope.tableItems,function(item){var del=item.horizontal_index>=hl||item.vertical_index>=vl;return del&&$scope.dragItems.push(item),del})},$scope.addItem=function(items){items.push("")}}]}}])}),define("table/directive/table.directive",["angularAMD","components/site-directive/assets-select/assets-select","components/site-directive/error-tip/error-tip","components/site-directive/edit-box/new-edit-box","components/site-directive/foot-tool/time-box/new-time-box","components/site-directive/foot-tool/foot-tool","components/site-directive/select-skin/select-skin","components/site-directive/contenteditable/contenteditable","components/site-directive/image-transform/image-transform","table/directive/description/description","table/directive/options/options","table/directive/setting/setting"],function(angularAMD){}),define(["app","table/directive/table.directive"],function(app){"use strict";app.controller("table_ctrl",["$scope","skin_service","$stateParams","CustomEditorService","$rootScope","$filter","$timeout",function($scope,skin_service,$stateParams,CustomEditorService,$rootScope,$filter,$timeout){function isDroppable(vindex,hindex,isOverflow){for(var item,countNow=0,capacity=countMax[(10*($scope.model.vertical_items.length<=2?2:5)+$scope.model.horizontal_items.length).toString()],i=0;i<$scope.model.items.length;i++)item=$scope.model.items[i],vindex==item.vertical_index&&hindex==item.horizontal_index&&(countNow++,countNow>capacity&&(item.vertical_index="",item.horizontal_index="",$scope.model.items.splice(i--,1),$scope.optionItems.push(item)));return isOverflow?countNow>capacity:countNow<capacity}function highlightBox(vindex,hindex){var tableBox=$(".table_lie_box:eq("+vindex+") .table_img_box:eq("+hindex+")");tableBox.removeClass("table_highlight"),$timeout(function(){tableBox.addClass("table_highlight")},10)}function checkOverflow(){for(var rows=$scope.model.vertical_items.length,cols=$scope.model.horizontal_items.length,i=0;i<rows;i++)for(var j=0;j<cols;j++){var isOverflow=isDroppable(i,j,!0);isOverflow&&highlightBox(i,j)}}$scope.errorModel={},$scope.optionItems=[],$scope.model={description:{text:"",asset_type:"",asset:"",image_extend:{rotate:"",resize:""}},title:$filter("translate")("table.tabletype"),skin:{code:"wood",css_url:"${ref-path}/edu/esp/preparecustomeditor/table/wood/css/wood.css",name:$filter("translate")("linkup.muwen"),package_url:"${ref-path}/edu/esp/preparecustomeditor/table/wood"},timer:{timer_type:"sequence",time_minute:"0",time_second:"0"},horizontal_items:[""],vertical_items:["",""],items:[]},$rootScope.moduleScope=$scope,$scope.defaultTitleSetting={isCleared:!1,title:$filter("translate")("table.default.title")},$scope.model.description.text=$scope.defaultTitleSetting.title;var loadingData=function(id){CustomEditorService.getQuestionInfoById(id).then(function(rtnData){rtnData?(""!=rtnData.skin.code?angular.extend($scope.model,$scope.decodeTable(rtnData)):$scope.model.id=rtnData.id,$scope.errorModel.errorText="",skin_service.set_skin_by_code($scope.model.skin.code,"v1")):$scope.errorModel.errorText=$filter("translate")("linkup.unvalidno")},function(){$scope.errorModel.errorText=$filter("translate")("linkup.get_title_error")})};$stateParams.id?loadingData($stateParams.id):skin_service.set_skin_by_code($scope.model.skin.code,"v1"),$scope.$on("changgedSkin",function(){$rootScope.scaleHtml()}),$scope.validPostData=function(){var modelData=$scope.model;if(""!=$.trim(modelData.description.text)){if($scope.optionItems.length>0)return $scope.errorModel.errorText=$filter("translate")("table.options_unclassified_existed"),!1;for(var i=0;i<modelData.horizontal_items.length;i++)if(""==$.trim(modelData.horizontal_items[i]))return $scope.errorModel.errorText=$filter("translate")("table.notnull.head"),!1;for(var i=0;i<modelData.vertical_items.length;i++)if(""==$.trim(modelData.vertical_items[i]))return $scope.errorModel.errorText=$filter("translate")("table.notnull.head"),!1;return 0!=modelData.items.length||($scope.errorModel.errorText=$filter("translate")("table.notnull.content"),!1)}$scope.errorModel.errorText=$filter("translate")("table.notnull.desc")},$scope.dropCallback=function(item,vindex,hindex){return item.horizontal_index=hindex,item.vertical_index=vindex,item};var countMax={51:5,52:2,53:1,54:1,55:1,21:10,22:4,23:2,24:2,25:2};$scope.disableMove=function(items,vcount,hcount,vindex,hindex){return!isDroppable(vindex,hindex)},$scope.delItem=function(items,index,direction){items.splice(index,1);$scope.model.horizontal_items.length,$scope.model.vertical_items.length;_.remove($scope.model.items,function(item){var del=!1;return"horizontal"===direction?index===item.horizontal_index?del=!0:index<item.horizontal_index&&item.horizontal_index--:"vertical"===direction&&(index===item.vertical_index?del=!0:index<item.vertical_index&&item.vertical_index--),del&&$scope.optionItems.push(item),del})},$scope.addItem=function(items){items.push(""),checkOverflow()},$scope.encodeTable=function(model){var newModel=angular.copy(model),new_horizontal_items=[],new_vertical_items=[],new_items=[];return angular.forEach(newModel.horizontal_items,function(value,index){""!==$.trim(value)&&new_horizontal_items.push(window.customHtmlEncode(value))}),angular.forEach(newModel.vertical_items,function(value,index){""!==$.trim(value)&&new_vertical_items.push(window.customHtmlEncode(value))}),angular.forEach(newModel.items,function(value,index){if(""!==$.trim(value.content)){var new_item={};new_item.id=value.id,new_item.content_type=value.content_type,new_item.content=window.customHtmlEncode(value.content),new_item.horizontal_index=value.horizontal_index,new_item.vertical_index=value.vertical_index,new_items.push(new_item)}}),newModel.horizontal_items=new_horizontal_items,newModel.vertical_items=new_vertical_items,newModel.items=new_items,newModel.description.text=window.customHtmlEncode(newModel.description.text),newModel},$scope.decodeTable=function(model){var newModel=angular.copy(model),new_horizontal_items=[],new_vertical_items=[],new_items=[];return angular.forEach(newModel.horizontal_items,function(value,index){""!==$.trim(value)&&new_horizontal_items.push(window.customHtmlDecode(value))}),angular.forEach(newModel.vertical_items,function(value,index){""!==$.trim(value)&&new_vertical_items.push(window.customHtmlDecode(value))}),angular.forEach(newModel.items,function(value,index){if(""!==$.trim(value.content)){var new_item={};new_item.id=value.id,new_item.content_type=value.content_type,new_item.content=window.customHtmlDecode(value.content),new_item.horizontal_index=value.horizontal_index,new_item.vertical_index=value.vertical_index,new_items.push(new_item)}}),newModel.horizontal_items=new_horizontal_items,newModel.vertical_items=new_vertical_items,newModel.items=new_items,newModel.description.text=window.customHtmlDecode(newModel.description.text),newModel}}])});