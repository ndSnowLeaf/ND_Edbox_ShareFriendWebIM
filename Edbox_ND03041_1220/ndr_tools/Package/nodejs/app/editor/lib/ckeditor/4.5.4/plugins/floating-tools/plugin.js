!function(){var floatingtools=function(){this.dom=null,this.toolbars=[],this.is_visible=!0,this.hide_on_blur=!1,this.toolbarsize=!1,this.editoroffset=!1,this.mousepos={x:0,y:0}};CKEDITOR.plugins.add("floating-tools",{requires:"toolbar",init:function(editor){editor.on("uiSpace",function(event){function addItem(item){var itemObj=item.render(editor,output);index=toolbarObj.items.push(itemObj)-1,index>0&&(itemObj.previous=toolbarObj.items[index-1],itemObj.previous.next=itemObj),itemObj.toolbar=toolbarObj}event.removeListener(),editor.floatingtools=new floatingtools;for(var groupStarted,pendingSeparator,labelId=CKEDITOR.tools.getNextId(),output=["<style>",".pos-relative {position:relative}",".cke_floatingtools{","position:absolute;","left:0;","top:-500px;","padding: 5px 0 0 6px;","border:1px solid #b1b1b1;","border-radius:3px;","box-shadow: 0 1px 10px rgba(0,0,0,0.3);","transition:opacity .1s;-o-transition:opacity .1s;-moz-transition:opacity .1s;-webkit-transition:opacity .1s;","}","</style>",'<span id="',labelId,'" class="cke_voice_label">',editor.lang.toolbar.toolbars,"</span>",'<span id="'+editor.ui.spaceId("floatingtools")+'" class="cke_floatingtools cke_top" role="group" aria-labelledby="',labelId,'" onmousedown="return false;">'],toolbars=editor.floatingtools.toolbars,toolbar=getFloatingToolbarConfig(editor),r=0;r<toolbar.length;r++){var toolbarId,toolbarName,items,toolbarObj=0,row=toolbar[r];if(row)if(groupStarted&&(output.push("</span>"),groupStarted=0,pendingSeparator=0),"/"!==row){items=row.items||row;for(var i=0;i<items.length;i++){var canGroup,item=items[i];if(item){if(item.type==CKEDITOR.UI_SEPARATOR){pendingSeparator=groupStarted&&item;continue}if(canGroup=!1!==item.canGroup,!toolbarObj){toolbarId=CKEDITOR.tools.getNextId(),toolbarObj={id:toolbarId,items:[]},toolbarName=row.name&&(editor.lang.toolbar.toolbarGroups[row.name]||row.name),output.push('<span id="',toolbarId,'" class="cke_toolbar"',toolbarName?' aria-labelledby="'+toolbarId+'_label"':"",' role="toolbar">'),toolbarName&&output.push('<span id="',toolbarId,'_label" class="cke_voice_label">',toolbarName,"</span>"),output.push('<span class="cke_toolbar_start"></span>');var index=toolbars.push(toolbarObj)-1;index>0&&(toolbarObj.previous=toolbars[index-1],toolbarObj.previous.next=toolbarObj)}canGroup?groupStarted||(output.push('<span class="cke_toolgroup" role="presentation">'),groupStarted=1):groupStarted&&(output.push("</span>"),groupStarted=0),pendingSeparator&&(addItem(pendingSeparator),pendingSeparator=0),addItem(item)}}groupStarted&&(output.push("</span>"),groupStarted=0,pendingSeparator=0),toolbarObj&&output.push('<span class="cke_toolbar_end"></span></span>')}else output.push('<span class="cke_toolbar_break"></span>')}output.push("</span>"),event.data.html+=output.join("")}),editor.on("contentDom",function(event){unfocus_toolbar(),editor.document.on("mouseup",function(mouse_event){if(data=mouse_event.data.$,0!==data.button||data.ctrlKey||data.altKey||data.shiftKey)return!0;setTimeout(function(){is_text_selected()?(set_mousepos(mouse_event.data.$),editor.execCommand("showFloatingTools")):editor.execCommand("hideFloatingTools")},100)}),editor.document.on("keyup",function(key_event){editor.execCommand("hideFloatingTools")}),editor.on("blur",function(e){editor.floatingtools.hide_on_blur&&hide_toolbar()}),toolbar=get_element(),toolbar.on("mouseover",function(mouse_event){focus_toolbar()}),toolbar.on("mouseout",function(mouse_event){unfocus_toolbar()}),editor.container.addClass("pos-relative"),console.log(editor.container)}),editor.addCommand("showFloatingTools",{exec:function(editor){is_text_selected()&&(toolbar=get_element(),unfocus_toolbar(),toolbar.show(),size=get_toolbar_size(),offset=get_editor_offset(),pos=get_mousepos(),toolpos=calculate_position(pos,size,offset),toolbar.setStyles({left:toolpos.x+"px",top:toolpos.y+"px"}),editor.floatingtools.is_visible=!0)}}),editor.addCommand("hideFloatingTools",{exec:function(editor){hide_toolbar()}}),hide_toolbar=function(){0!=editor.floatingtools.is_visible&&(toolbar=get_element(),toolbar.hide(),editor.floatingtools.is_visible=!1)},set_mousepos=function(data){editor.floatingtools.mousepos={left:data.clientX,top:data.clientY}},get_mousepos=function(){return editor.floatingtools.mousepos},get_element=function(){if(!editor.floatingtools.dom){var dom_id=editor.ui.spaceId("floatingtools");editor.floatingtools.dom=CKEDITOR.document.getById(dom_id)}return editor.floatingtools.dom},get_editor_offset=function(){if(!editor.floatingtools.editoroffset){var editor_id=editor.ui.spaceId("contents"),obj=editor.document.getById(editor_id);obj||(obj=editor.container,console.log(obj,obj.$)),editor.floatingtools.editoroffset={left:obj.$.offsetLeft,top:obj.$.offsetTop,width:obj.$.offsetWidth,height:obj.$.offsetHeight}}return editor.floatingtools.editoroffset},calculate_position=function(pos,toolbar_size,offset){return toolpos={x:pos.left+offset.left-toolbar_size.width/2,y:pos.top+offset.top-(toolbar_size.height+20)},toolpos.x<offset.left+2&&(toolpos.x=offset.left+2),pos.left+toolbar_size.width/2>=offset.left+offset.width-2&&(toolpos.x=offset.left+offset.width-toolbar_size.width-2),toolpos.y<offset.top&&(toolpos.y=offset.top),offset.top+pos.top>toolpos.y&&offset.top+pos.top<toolpos.y+toolbar_size.height&&(toolpos.y=offset.top+pos.top+24),toolpos},get_toolbar_size=function(){if(!editor.floatingtools.toolbarsize){var obj=get_element();editor.floatingtools.toolbarsize={width:obj.$.offsetWidth,height:obj.$.offsetHeight}}return editor.floatingtools.toolbarsize},is_text_selected=function(){return""!=editor.getSelection().getSelectedText()},focus_toolbar=function(){obj=get_element(),obj.setOpacity(1)},unfocus_toolbar=function(){obj=get_element(),obj.setOpacity(.25)},getFloatingToolbarConfig=function(editor){function fillGroup(toolbarGroup,uiItems){if(uiItems.length){toolbarGroup.items?toolbarGroup.items.push(editor.ui.create("-")):toolbarGroup.items=[];for(var item,name;item=uiItems.shift();)if(name="string"==typeof item?item:item.name,!removeButtons||-1==CKEDITOR.tools.indexOf(removeButtons,name)){if(!(item=editor.ui.create(name)))continue;if(!editor.addFeature(item))continue;toolbarGroup.items.push(item)}}}function populateToolbarConfig(config){var i,group,newGroup,toolbar=[];for(i=0;i<config.length;++i)group=config[i],newGroup={},"/"==group?toolbar.push(group):CKEDITOR.tools.isArray(group)?(fillGroup(newGroup,CKEDITOR.tools.clone(group)),toolbar.push(newGroup)):group.items&&(fillGroup(newGroup,CKEDITOR.tools.clone(group.items)),newGroup.name=group.name,toolbar.push(newGroup));return toolbar}var removeButtons=editor.config.removeButtons;removeButtons=removeButtons&&removeButtons.split(",");var toolbar=editor.config.floatingtools;return"string"==typeof toolbar&&(toolbar=editor.config["floatingtools_"+toolbar]),editor.toolbar=toolbar?populateToolbarConfig(toolbar):function(){return populateToolbarConfig(getPrivateFloatingToolbarGroups(editor))}()},getPrivateFloatingToolbarGroups=function(editor){return editor._.floatingToolsGroups||(editor._.floatingToolsGroups=[{name:"styles",items:["Font","FontSize"]},{name:"format",items:["Bold","Italic"]},{name:"paragraph",items:["JustifyCenter","Outdent","Indent","NumberedList","BulletedList"]}])}}})}();