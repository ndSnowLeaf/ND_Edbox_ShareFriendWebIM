"use strict";!function(){function Repository(editor){this.editor=editor,this.registered={},this.instances={},this.selected=[],this.focused=null,this.widgetHoldingFocusedEditable=null,this._={nextId:0,upcasts:[],upcastCallbacks:[],filters:{}},setupWidgetsLifecycle(this),setupSelectionObserver(this),setupMouseObserver(this),setupKeyboardObserver(this),setupDragAndDrop(this),setupNativeCutAndCopy(this)}function Widget(widgetsRepo,id,element,widgetDef,startupData){var editor=widgetsRepo.editor;CKEDITOR.tools.extend(this,widgetDef,{editor:editor,id:id,inline:"span"==element.getParent().getName(),element:element,data:CKEDITOR.tools.extend({},"function"==typeof widgetDef.defaults?widgetDef.defaults():widgetDef.defaults),dataReady:!1,inited:!1,ready:!1,edit:Widget.prototype.edit,focusedEditable:null,definition:widgetDef,repository:widgetsRepo,draggable:!1!==widgetDef.draggable,_:{downcastFn:widgetDef.downcast&&"string"==typeof widgetDef.downcast?widgetDef.downcasts[widgetDef.downcast]:widgetDef.downcast}},!0),widgetsRepo.fire("instanceCreated",this),setupWidget(this,widgetDef),this.init&&this.init(),this.inited=!0,setupWidgetData(this,startupData),this.isInited()&&editor.editable().contains(this.wrapper)&&(this.ready=!0,this.fire("ready"))}function NestedEditable(editor,element,config){CKEDITOR.dom.element.call(this,element.$),this.editor=editor,this._={};var filter=this.filter=config.filter;CKEDITOR.dtd[this.getName()].p?(this.enterMode=filter?filter.getAllowedEnterMode(editor.enterMode):editor.enterMode,this.shiftEnterMode=filter?filter.getAllowedEnterMode(editor.shiftEnterMode,!0):editor.shiftEnterMode):this.enterMode=this.shiftEnterMode=CKEDITOR.ENTER_BR}function addWidgetButtons(editor){var widget,widgetName,widgetButton,widgets=editor.widgets.registered;for(widgetName in widgets)widget=widgets[widgetName],(widgetButton=widget.button)&&editor.ui.addButton&&editor.ui.addButton(CKEDITOR.tools.capitalize(widget.name,!0),{label:widgetButton,command:widget.name,toolbar:"insert,10"})}function addWidgetCommand(editor,widgetDef){editor.addCommand(widgetDef.name,{exec:function(editor,commandData){function finalizeCreation(){editor.widgets.finalizeCreation(temp)}var focused=editor.widgets.focused;if(focused&&focused.name==widgetDef.name)focused.edit();else if(widgetDef.insert)widgetDef.insert();else if(widgetDef.template){var instance,defaults="function"==typeof widgetDef.defaults?widgetDef.defaults():widgetDef.defaults,element=CKEDITOR.dom.element.createFromHtml(widgetDef.template.output(defaults)),wrapper=editor.widgets.wrapElement(element,widgetDef.name),temp=new CKEDITOR.dom.documentFragment(wrapper.getDocument());if(temp.append(wrapper),!(instance=editor.widgets.initOn(element,widgetDef,commandData&&commandData.startupData)))return void finalizeCreation();var editListener=instance.once("edit",function(evt){evt.data.dialog?instance.once("dialog",function(evt){var okListener,cancelListener,dialog=evt.data;okListener=dialog.once("ok",finalizeCreation,null,null,20),cancelListener=dialog.once("cancel",function(evt){evt.data&&!1===evt.data.hide||editor.widgets.destroy(instance,!0)}),dialog.once("hide",function(){okListener.removeListener(),cancelListener.removeListener()})}):finalizeCreation()},null,null,999);instance.edit(),editListener.removeListener()}},allowedContent:widgetDef.allowedContent,requiredContent:widgetDef.requiredContent,contentForms:widgetDef.contentForms,contentTransformations:widgetDef.contentTransformations})}function addWidgetProcessors(widgetsRepo,widgetDef){function addUpcast(upcast,name,priority){var index=CKEDITOR.tools.getIndex(widgetsRepo._.upcasts,function(element){return element[2]>priority});index<0&&(index=widgetsRepo._.upcasts.length),widgetsRepo._.upcasts.splice(index,0,[upcast,name,priority])}var upcasts,upcast=widgetDef.upcast,priority=widgetDef.upcastPriority||10;if(upcast)if("string"==typeof upcast)for(upcasts=upcast.split(",");upcasts.length;)addUpcast(widgetDef.upcasts[upcasts.pop()],widgetDef.name,priority);else addUpcast(upcast,widgetDef.name,priority)}function blurWidget(widgetsRepo,widget){if(widgetsRepo.focused=null,widget.isInited()){var isDirty=widget.editor.checkDirty();widgetsRepo.fire("widgetBlurred",{widget:widget}),widget.setFocused(!1),!isDirty&&widget.editor.resetDirty()}}function checkWidgets(evt){var options=evt.data;if("wysiwyg"==this.editor.mode){var newInstances,i,count,wrapper,editable=this.editor.editable(),instances=this.instances;if(editable){for(i in instances)instances[i].isReady()&&!editable.contains(instances[i].wrapper)&&this.destroy(instances[i],!0);if(options&&options.initOnlyNew)newInstances=this.initOnAll();else{var wrappers=editable.find(".cke_widget_wrapper");for(newInstances=[],i=0,count=wrappers.count();i<count;i++)wrapper=wrappers.getItem(i),!this.getByElement(wrapper,!0)&&!findParent(wrapper,isDomTemp)&&editable.contains(wrapper)&&(wrapper.addClass("cke_widget_new"),newInstances.push(this.initOn(wrapper.getFirst(Widget.isDomWidgetElement))))}options&&options.focusInited&&1==newInstances.length&&newInstances[0].focus()}}}function cleanUpWidgetElement(el){var parent=el.parent;parent.type==CKEDITOR.NODE_ELEMENT&&parent.attributes["data-cke-widget-wrapper"]&&parent.replaceWith(el)}function cleanUpAllWidgetElements(widgetsRepo,container){for(var wrapper,element,wrappers=container.find(".cke_widget_wrapper"),i=0,l=wrappers.count();i<l;++i)wrapper=wrappers.getItem(i),element=wrapper.getFirst(Widget.isDomWidgetElement),element.type==CKEDITOR.NODE_ELEMENT&&element.data("widget")?(element.replace(wrapper),widgetsRepo.wrapElement(element)):wrapper.remove()}function createEditableFilter(widgetName,editableName,editableDefinition){if(!editableDefinition.allowedContent)return null;var editables=this._.filters[widgetName];editables||(this._.filters[widgetName]=editables={});var filter=editables[editableName];return filter||(editables[editableName]=filter=new CKEDITOR.filter(editableDefinition.allowedContent)),filter}function createUpcastIterator(widgetsRepo){var toBeWrapped=[],upcasts=widgetsRepo._.upcasts,upcastCallbacks=widgetsRepo._.upcastCallbacks;return{toBeWrapped:toBeWrapped,iterator:function(element){var upcast,upcasted,data,i,upcastsLength,upcastCallbacksLength;if("data-cke-widget-wrapper"in element.attributes)return element=element.getFirst(Widget.isParserWidgetElement),element&&toBeWrapped.push([element]),!1;if("data-widget"in element.attributes)return toBeWrapped.push([element]),!1;if(upcastsLength=upcasts.length){if(element.attributes["data-cke-widget-upcasted"])return!1;for(i=0,upcastCallbacksLength=upcastCallbacks.length;i<upcastCallbacksLength;++i)if(!1===upcastCallbacks[i](element))return;for(i=0;i<upcastsLength;++i)if(upcast=upcasts[i],data={},upcasted=upcast[0](element,data))return upcasted instanceof CKEDITOR.htmlParser.element&&(element=upcasted),element.attributes["data-cke-widget-data"]=encodeURIComponent(JSON.stringify(data)),element.attributes["data-cke-widget-upcasted"]=1,toBeWrapped.push([element,upcast[1]]),!1}}}}function findParent(element,query){for(var parent=element;parent=parent.getParent();)if(query(parent))return!0;return!1}function getWrapperAttributes(inlineWidget){return{tabindex:-1,contenteditable:"false","data-cke-widget-wrapper":1,"data-cke-filter":"off",class:"cke_widget_wrapper cke_widget_new cke_widget_"+(inlineWidget?"inline":"block")}}function insertElement(parent,index,element){if(parent.type==CKEDITOR.NODE_ELEMENT){var parentAllows=CKEDITOR.dtd[parent.name];if(parentAllows&&!parentAllows[element.name]){var parent2=parent.split(index),parentParent=parent.parent;return index=parent2.getIndex(),parent.children.length||(index-=1,parent.remove()),parent2.children.length||parent2.remove(),insertElement(parentParent,index,element)}}parent.add(element,index)}function isWidgetInline(widgetDef,elementName){return"boolean"==typeof widgetDef.inline?widgetDef.inline:!!CKEDITOR.dtd.$inline[elementName]}function isDomTemp(element){return element.hasAttribute("data-cke-temp")}function onEditableKey(widget,keyCode){var range,focusedEditable=widget.focusedEditable;if(keyCode==CKEDITOR.CTRL+65){var bogus=focusedEditable.getBogus();return range=widget.editor.createRange(),range.selectNodeContents(focusedEditable),bogus&&range.setEndAt(bogus,CKEDITOR.POSITION_BEFORE_START),range.select(),!1}if(8==keyCode||46==keyCode){var ranges=widget.editor.getSelection().getRanges();return range=ranges[0],!(1==ranges.length&&range.collapsed&&range.checkBoundaryOfElement(focusedEditable,CKEDITOR[8==keyCode?"START":"END"]))}}function setFocusedEditable(widgetsRepo,widget,editableElement,offline){var editor=widgetsRepo.editor;if(editor.fire("lockSnapshot"),editableElement){var editableName=editableElement.data("cke-widget-editable"),editableInstance=widget.editables[editableName];widgetsRepo.widgetHoldingFocusedEditable=widget,widget.focusedEditable=editableInstance,editableElement.addClass("cke_widget_editable_focused"),editableInstance.filter&&editor.setActiveFilter(editableInstance.filter),editor.setActiveEnterMode(editableInstance.enterMode,editableInstance.shiftEnterMode)}else offline||widget.focusedEditable.removeClass("cke_widget_editable_focused"),widget.focusedEditable=null,widgetsRepo.widgetHoldingFocusedEditable=null,editor.setActiveFilter(null),editor.setActiveEnterMode(null,null);editor.fire("unlockSnapshot")}function setupContextMenu(editor){editor.contextMenu&&editor.contextMenu.addListener(function(element){var widget=editor.widgets.getByElement(element,!0);if(widget)return widget.fire("contextMenu",{})})}function pasteReplaceFn(match,wrapperHtml){return CKEDITOR.tools.trim(wrapperHtml)}function setupDragAndDrop(widgetsRepo){var editor=widgetsRepo.editor,lineutils=CKEDITOR.plugins.lineutils;editor.on("dragstart",function(evt){var target=evt.data.target;if(Widget.isDomDragHandler(target)){var widget=widgetsRepo.getByElement(target);evt.data.dataTransfer.setData("cke/widget-id",widget.id),editor.focus(),widget.focus()}}),editor.on("drop",function(evt){var sourceWidget,dataTransfer=evt.data.dataTransfer,id=dataTransfer.getData("cke/widget-id"),transferType=dataTransfer.getTransferType(editor),dragRange=editor.createRange();if(""!==id&&transferType===CKEDITOR.DATA_TRANSFER_CROSS_EDITORS)return void evt.cancel();""!==id&&transferType==CKEDITOR.DATA_TRANSFER_INTERNAL&&(sourceWidget=widgetsRepo.instances[id])&&(dragRange.setStartBefore(sourceWidget.wrapper),dragRange.setEndAfter(sourceWidget.wrapper),evt.data.dragRange=dragRange,delete CKEDITOR.plugins.clipboard.dragStartContainerChildCount,delete CKEDITOR.plugins.clipboard.dragEndContainerChildCount,evt.data.dataTransfer.setData("text/html",editor.editable().getHtmlFromRange(dragRange).getHtml()),editor.widgets.destroy(sourceWidget,!0))}),editor.on("contentDom",function(){var editable=editor.editable();CKEDITOR.tools.extend(widgetsRepo,{finder:new lineutils.finder(editor,{lookups:{default:function(el){if(!el.is(CKEDITOR.dtd.$listItem)&&el.is(CKEDITOR.dtd.$block)&&!Widget.isDomNestedEditable(el)&&!widgetsRepo._.draggedWidget.wrapper.contains(el)){var nestedEditable=Widget.getNestedEditable(editable,el);if(nestedEditable){var draggedWidget=widgetsRepo._.draggedWidget;if(widgetsRepo.getByElement(nestedEditable)==draggedWidget)return;var filter=CKEDITOR.filter.instances[nestedEditable.data("cke-filter")],draggedRequiredContent=draggedWidget.requiredContent;if(filter&&draggedRequiredContent&&!filter.check(draggedRequiredContent))return}return CKEDITOR.LINEUTILS_BEFORE|CKEDITOR.LINEUTILS_AFTER}}}}),locator:new lineutils.locator(editor),liner:new lineutils.liner(editor,{lineStyle:{cursor:"move !important","border-top-color":"#666"},tipLeftStyle:{"border-left-color":"#666"},tipRightStyle:{"border-right-color":"#666"}})},!0)})}function setupMouseObserver(widgetsRepo){var editor=widgetsRepo.editor;editor.on("contentDom",function(){var widget,mouseDownOnDragHandler,editable=editor.editable(),evtRoot=editable.isInline()?editable:editor.document;editable.attachListener(evtRoot,"mousedown",function(evt){var target=evt.data.getTarget();if(!target.type)return!1;if(widget=widgetsRepo.getByElement(target),mouseDownOnDragHandler=0,widget){if(widget.inline&&target.type==CKEDITOR.NODE_ELEMENT&&target.hasAttribute("data-cke-widget-drag-handler"))return mouseDownOnDragHandler=1,void(widgetsRepo.focused!=widget&&editor.getSelection().removeAllRanges());Widget.getNestedEditable(widget.wrapper,target)?widget=null:(evt.data.preventDefault(),CKEDITOR.env.ie||widget.focus())}}),editable.attachListener(evtRoot,"mouseup",function(){mouseDownOnDragHandler&&widget&&widget.wrapper&&(mouseDownOnDragHandler=0,widget.focus())}),CKEDITOR.env.ie&&editable.attachListener(evtRoot,"mouseup",function(){setTimeout(function(){widget&&widget.wrapper&&editable.contains(widget.wrapper)&&(widget.focus(),widget=null)})})}),editor.on("doubleclick",function(evt){var widget=widgetsRepo.getByElement(evt.data.element);if(widget&&!Widget.getNestedEditable(widget.wrapper,evt.data.element))return widget.fire("doubleclick",{element:evt.data.element})},null,null,1)}function setupKeyboardObserver(widgetsRepo){widgetsRepo.editor.on("key",function(evt){var ret,focused=widgetsRepo.focused,widgetHoldingFocusedEditable=widgetsRepo.widgetHoldingFocusedEditable;return focused?ret=focused.fire("key",{keyCode:evt.data.keyCode}):widgetHoldingFocusedEditable&&(ret=onEditableKey(widgetHoldingFocusedEditable,evt.data.keyCode)),ret},null,null,1)}function setupNativeCutAndCopy(widgetsRepo){function eventListener(evt){widgetsRepo.focused&&copySingleWidget(widgetsRepo.focused,"cut"==evt.name)}var editor=widgetsRepo.editor;editor.on("contentDom",function(){var editable=editor.editable();editable.attachListener(editable,"copy",eventListener),editable.attachListener(editable,"cut",eventListener)})}function setupSelectionObserver(widgetsRepo){var editor=widgetsRepo.editor;editor.on("selectionCheck",function(){widgetsRepo.fire("checkSelection")}),widgetsRepo.on("checkSelection",widgetsRepo.checkSelection,widgetsRepo),editor.on("selectionChange",function(evt){var nestedEditable=Widget.getNestedEditable(editor.editable(),evt.data.selection.getStartElement()),newWidget=nestedEditable&&widgetsRepo.getByElement(nestedEditable),oldWidget=widgetsRepo.widgetHoldingFocusedEditable;oldWidget?oldWidget===newWidget&&oldWidget.focusedEditable.equals(nestedEditable)||(setFocusedEditable(widgetsRepo,oldWidget,null),newWidget&&nestedEditable&&setFocusedEditable(widgetsRepo,newWidget,nestedEditable)):newWidget&&nestedEditable&&setFocusedEditable(widgetsRepo,newWidget,nestedEditable)}),editor.on("dataReady",function(){stateUpdater(widgetsRepo).commit()}),editor.on("blur",function(){var widget;(widget=widgetsRepo.focused)&&blurWidget(widgetsRepo,widget),(widget=widgetsRepo.widgetHoldingFocusedEditable)&&setFocusedEditable(widgetsRepo,widget,null)})}function setupWidgetsLifecycle(widgetsRepo){setupWidgetsLifecycleStart(widgetsRepo),setupWidgetsLifecycleEnd(widgetsRepo),widgetsRepo.on("checkWidgets",checkWidgets),widgetsRepo.editor.on("contentDomInvalidated",widgetsRepo.checkWidgets,widgetsRepo)}function setupWidgetsLifecycleEnd(widgetsRepo){var editor=widgetsRepo.editor,downcastingSessions={};editor.on("toDataFormat",function(evt){var id=CKEDITOR.tools.getNextNumber(),toBeDowncasted=[];evt.data.downcastingSessionId=id,downcastingSessions[id]=toBeDowncasted,evt.data.dataValue.forEach(function(element){var widget,widgetElement,attrs=element.attributes;if("data-cke-widget-id"in attrs)(widget=widgetsRepo.instances[attrs["data-cke-widget-id"]])&&(widgetElement=element.getFirst(Widget.isParserWidgetElement),toBeDowncasted.push({wrapper:element,element:widgetElement,widget:widget,editables:{}}),"1"!=widgetElement.attributes["data-cke-widget-keep-attr"]&&delete widgetElement.attributes["data-widget"]);else if("data-cke-widget-editable"in attrs)return toBeDowncasted[toBeDowncasted.length-1].editables[attrs["data-cke-widget-editable"]]=element,!1},CKEDITOR.NODE_ELEMENT,!0)},null,null,8),editor.on("toDataFormat",function(evt){if(evt.data.downcastingSessionId)for(var toBe,widget,widgetElement,retElement,editableElement,e,toBeDowncasted=downcastingSessions[evt.data.downcastingSessionId];toBe=toBeDowncasted.shift();){widget=toBe.widget,widgetElement=toBe.element,retElement=widget._.downcastFn&&widget._.downcastFn.call(widget,widgetElement);for(e in toBe.editables)editableElement=toBe.editables[e],delete editableElement.attributes.contenteditable,editableElement.setHtml(widget.editables[e].getData());retElement||(retElement=widgetElement),toBe.wrapper.replaceWith(retElement)}},null,null,13),editor.on("contentDomUnload",function(){widgetsRepo.destroyAll(!0)})}function setupWidgetsLifecycleStart(widgetsRepo){var processedWidgetOnly,snapshotLoaded,editor=widgetsRepo.editor;editor.on("toHtml",function(evt){var toBeWrapped,upcastIterator=createUpcastIterator(widgetsRepo);for(evt.data.dataValue.forEach(upcastIterator.iterator,CKEDITOR.NODE_ELEMENT,!0);toBeWrapped=upcastIterator.toBeWrapped.pop();)cleanUpWidgetElement(toBeWrapped[0]),widgetsRepo.wrapElement(toBeWrapped[0],toBeWrapped[1]);processedWidgetOnly=evt.data.protectedWhitespaces?3==evt.data.dataValue.children.length&&Widget.isParserWidgetWrapper(evt.data.dataValue.children[1]):1==evt.data.dataValue.children.length&&Widget.isParserWidgetWrapper(evt.data.dataValue.children[0])},null,null,8),editor.on("dataReady",function(){snapshotLoaded&&cleanUpAllWidgetElements(widgetsRepo,editor.editable()),snapshotLoaded=0,widgetsRepo.destroyAll(!0),widgetsRepo.initOnAll()}),editor.on("loadSnapshot",function(evt){/data-cke-widget/.test(evt.data)&&(snapshotLoaded=1),widgetsRepo.destroyAll(!0)},null,null,9),editor.on("paste",function(evt){var data=evt.data;if(data.dataValue=data.dataValue.replace(pasteReplaceRegex,pasteReplaceFn),data.range){var nestedEditable=Widget.getNestedEditable(editor.editable(),data.range.startContainer);if(nestedEditable){var filter=CKEDITOR.filter.instances[nestedEditable.data("cke-filter")];filter&&editor.setActiveFilter(filter)}}}),editor.on("afterInsertHtml",function(evt){evt.data.intoRange?widgetsRepo.checkWidgets({initOnlyNew:!0}):(editor.fire("lockSnapshot"),widgetsRepo.checkWidgets({initOnlyNew:!0,focusInited:processedWidgetOnly}),editor.fire("unlockSnapshot"))})}function stateUpdater(widgetsRepo){var currentlySelected=widgetsRepo.selected,toBeSelected=[],toBeDeselected=currentlySelected.slice(0),focused=null;return{select:function(widget){CKEDITOR.tools.indexOf(currentlySelected,widget)<0&&toBeSelected.push(widget);var index=CKEDITOR.tools.indexOf(toBeDeselected,widget);return index>=0&&toBeDeselected.splice(index,1),this},focus:function(widget){return focused=widget,this},commit:function(){var widget,isDirty,focusedChanged=widgetsRepo.focused!==focused;for(widgetsRepo.editor.fire("lockSnapshot"),focusedChanged&&(widget=widgetsRepo.focused)&&blurWidget(widgetsRepo,widget);widget=toBeDeselected.pop();)currentlySelected.splice(CKEDITOR.tools.indexOf(currentlySelected,widget),1),widget.isInited()&&(isDirty=widget.editor.checkDirty(),widget.setSelected(!1),!isDirty&&widget.editor.resetDirty());for(focusedChanged&&focused&&(isDirty=widgetsRepo.editor.checkDirty(),widgetsRepo.focused=focused,widgetsRepo.fire("widgetFocused",{widget:focused}),focused.setFocused(!0),!isDirty&&widgetsRepo.editor.resetDirty());widget=toBeSelected.pop();)currentlySelected.push(widget),widget.setSelected(!0);widgetsRepo.editor.fire("unlockSnapshot")}}}function applyRemoveStyle(widget,style,apply){var cl,changed=0,classes=getStyleClasses(style),updatedClasses=widget.data.classes||{};if(classes){for(updatedClasses=CKEDITOR.tools.clone(updatedClasses);cl=classes.pop();)apply?updatedClasses[cl]||(changed=updatedClasses[cl]=1):updatedClasses[cl]&&(delete updatedClasses[cl],changed=1);changed&&widget.setData("classes",updatedClasses)}}function cancel(evt){evt.cancel()}function copySingleWidget(widget,isCut){var editor=widget.editor,doc=editor.document;if(!doc.getById("cke_copybin")){var copybinName=editor.blockless||CKEDITOR.env.ie?"span":"div",copybin=doc.createElement(copybinName),copybinContainer=doc.createElement(copybinName),needsScrollHack=CKEDITOR.env.ie&&CKEDITOR.env.version<9;copybinContainer.setAttributes({id:"cke_copybin","data-cke-temp":"1"}),copybin.setStyles({position:"absolute",width:"1px",height:"1px",overflow:"hidden"}),copybin.setStyle("ltr"==editor.config.contentsLangDirection?"left":"right","-5000px");var range=editor.createRange();range.setStartBefore(widget.wrapper),range.setEndAfter(widget.wrapper),copybin.setHtml('<span data-cke-copybin-start="1">​</span>'+editor.editable().getHtmlFromRange(range).getHtml()+'<span data-cke-copybin-end="1">​</span>'),editor.fire("saveSnapshot"),editor.fire("lockSnapshot"),copybinContainer.append(copybin),editor.editable().append(copybinContainer);var listener1=editor.on("selectionChange",cancel,null,null,0),listener2=widget.repository.on("checkSelection",cancel,null,null,0);if(needsScrollHack)var docElement=doc.getDocumentElement().$,scrollTop=docElement.scrollTop;range=editor.createRange(),range.selectNodeContents(copybin),range.select(),needsScrollHack&&(docElement.scrollTop=scrollTop),setTimeout(function(){isCut||widget.focus(),copybinContainer.remove(),listener1.removeListener(),listener2.removeListener(),editor.fire("unlockSnapshot"),isCut&&(widget.repository.del(widget),editor.fire("saveSnapshot"))},100)}}function getStyleClasses(style){var attrs=style.getDefinition().attributes,classes=attrs&&attrs.class;return classes?classes.split(/\s+/):null}function onEditableBlur(){var active=CKEDITOR.document.getActive(),editor=this.editor,editable=editor.editable();(editable.isInline()?editable:editor.document.getWindow().getFrame()).equals(active)&&editor.focusManager.focus(editable)}function onEditableFocus(){CKEDITOR.env.gecko&&this.editor.unlockSelection(),CKEDITOR.env.webkit||(this.editor.forceNextSelectionCheck(),this.editor.selectionChange(1))}function setupDataClassesListener(widget){var previousClasses=null;widget.on("data",function(){var cl,newClasses=this.data.classes;if(previousClasses!=newClasses){for(cl in previousClasses)newClasses&&newClasses[cl]||this.removeClass(cl);for(cl in newClasses)this.addClass(cl);previousClasses=newClasses}})}function setupDragHandler(widget){if(widget.draggable){var img,editor=widget.editor,container=widget.wrapper.getLast(Widget.isDomDragHandlerContainer);container?img=container.findOne("img"):(container=new CKEDITOR.dom.element("span",editor.document),container.setAttributes({class:"cke_reset cke_widget_drag_handler_container",style:"background:rgba(220,220,220,0.5);background-image:url("+editor.plugins.widget.path+"images/handle.png)"}),img=new CKEDITOR.dom.element("img",editor.document),img.setAttributes({class:"cke_reset cke_widget_drag_handler","data-cke-widget-drag-handler":"1",src:CKEDITOR.tools.transparentImageData,width:DRAG_HANDLER_SIZE,title:editor.lang.widget.move,height:DRAG_HANDLER_SIZE}),widget.inline&&img.setAttribute("draggable","true"),container.append(img),widget.wrapper.append(container)),widget.wrapper.on("dragover",function(evt){evt.data.preventDefault()}),widget.wrapper.on("mouseenter",widget.updateDragHandlerPosition,widget),setTimeout(function(){widget.on("data",widget.updateDragHandlerPosition,widget)},50),widget.inline||(img.on("mousedown",onBlockWidgetDrag,widget),CKEDITOR.env.ie&&CKEDITOR.env.version<9&&img.on("dragstart",function(evt){evt.data.preventDefault(!0)})),widget.dragHandlerContainer=container}}function onBlockWidgetDrag(evt){function onMouseUp(){var l;for(buffer.reset();l=listeners.pop();)l.removeListener();onBlockWidgetDrop.call(this,sorted,evt.sender)}var finder=this.repository.finder,locator=this.repository.locator,liner=this.repository.liner,editor=this.editor,editable=editor.editable(),listeners=[],sorted=[];this.repository._.draggedWidget=this;var locations,y,relations=finder.greedySearch(),buffer=CKEDITOR.tools.eventsBuffer(50,function(){locations=locator.locate(relations),sorted=locator.sort(y,1),sorted.length&&(liner.prepare(relations,locations),liner.placeLine(sorted[0]),liner.cleanup())});editable.addClass("cke_widget_dragging"),listeners.push(editable.on("mousemove",function(evt){y=evt.data.$.clientY,buffer.input()})),editor.fire("dragstart",{target:evt.sender}),listeners.push(editor.document.once("mouseup",onMouseUp,this)),editable.isInline()||listeners.push(CKEDITOR.document.once("mouseup",onMouseUp,this))}function onBlockWidgetDrop(sorted,dragTarget){var finder=this.repository.finder,liner=this.repository.liner,editor=this.editor,editable=this.editor.editable();if(!CKEDITOR.tools.isEmpty(liner.visible)){var dropRange=finder.getRange(sorted[0]);this.focus(),editor.fire("drop",{dropRange:dropRange,target:dropRange.startContainer})}editable.removeClass("cke_widget_dragging"),liner.hideVisible(),editor.fire("dragend",{target:dragTarget})}function setupEditables(widget){var editableName,editableDef,definedEditables=widget.editables;if(widget.editables={},widget.editables)for(editableName in definedEditables)editableDef=definedEditables[editableName],widget.initEditable(editableName,"string"==typeof editableDef?{selector:editableDef}:editableDef)}function setupMask(widget){if(widget.mask){var img=widget.wrapper.findOne(".cke_widget_mask");img||(img=new CKEDITOR.dom.element("img",widget.editor.document),img.setAttributes({src:CKEDITOR.tools.transparentImageData,class:"cke_reset cke_widget_mask"}),widget.wrapper.append(img)),widget.mask=img}}function setupParts(widget){if(widget.parts){var el,partName,parts={};for(partName in widget.parts)el=widget.wrapper.findOne(widget.parts[partName]),parts[partName]=el;widget.parts=parts}}function setupWidget(widget,widgetDef){setupWrapper(widget),setupParts(widget),setupEditables(widget),setupMask(widget),setupDragHandler(widget),setupDataClassesListener(widget),CKEDITOR.env.ie&&CKEDITOR.env.version<9&&widget.wrapper.on("dragstart",function(evt){var target=evt.data.getTarget();Widget.getNestedEditable(widget,target)||widget.inline&&Widget.isDomDragHandler(target)||evt.data.preventDefault()}),widget.wrapper.removeClass("cke_widget_new"),widget.element.addClass("cke_widget_element"),widget.on("key",function(evt){var keyCode=evt.data.keyCode;if(13==keyCode)widget.edit();else{if(keyCode==CKEDITOR.CTRL+67||keyCode==CKEDITOR.CTRL+88)return void copySingleWidget(widget,keyCode==CKEDITOR.CTRL+88);if(keyCode in keystrokesNotBlockedByWidget||CKEDITOR.CTRL&keyCode||CKEDITOR.ALT&keyCode)return}return!1},null,null,999),widget.on("doubleclick",function(evt){widget.edit()&&evt.cancel()}),widgetDef.data&&widget.on("data",widgetDef.data),widgetDef.edit&&widget.on("edit",widgetDef.edit)}function setupWidgetData(widget,startupData){var widgetDataAttr=widget.element.data("cke-widget-data");widgetDataAttr&&widget.setData(JSON.parse(decodeURIComponent(widgetDataAttr))),startupData&&widget.setData(startupData),widget.data.classes||widget.setData("classes",widget.getClasses()),widget.dataReady=!0,writeDataToElement(widget),widget.fire("data",widget.data)}function setupWrapper(widget){(widget.wrapper=widget.element.getParent()).setAttribute("data-cke-widget-id",widget.id)}function writeDataToElement(widget){widget.element.data("cke-widget-data",encodeURIComponent(JSON.stringify(widget.data)))}var DRAG_HANDLER_SIZE=15;CKEDITOR.plugins.add("widget",{lang:"af,ar,bg,ca,cs,cy,da,de,el,en,en-gb,eo,es,fa,fi,fr,gl,he,hr,hu,it,ja,km,ko,ku,lv,nb,nl,no,pl,pt,pt-br,ru,sk,sl,sq,sv,tr,tt,ug,uk,vi,zh,zh-cn",requires:"lineutils,clipboard",onLoad:function(){CKEDITOR.addCss(".cke_widget_wrapper{position:relative;outline:none}.cke_widget_inline{display:inline-block}.cke_widget_wrapper:hover>.cke_widget_element{outline:2px solid yellow;cursor:default}.cke_widget_wrapper:hover .cke_widget_editable{outline:2px solid yellow}.cke_widget_wrapper.cke_widget_focused>.cke_widget_element,.cke_widget_wrapper .cke_widget_editable.cke_widget_editable_focused{outline:2px solid #ace}.cke_widget_editable{cursor:text}.cke_widget_drag_handler_container{position:absolute;width:"+DRAG_HANDLER_SIZE+"px;height:0;display:none;opacity:0.75;transition:height 0s 0.2s;line-height:0}.cke_widget_wrapper:hover>.cke_widget_drag_handler_container{height:"+DRAG_HANDLER_SIZE+"px;transition:none}.cke_widget_drag_handler_container:hover{opacity:1}img.cke_widget_drag_handler{cursor:move;width:"+DRAG_HANDLER_SIZE+"px;height:"+DRAG_HANDLER_SIZE+"px;display:inline-block}.cke_widget_mask{position:absolute;top:0;left:0;width:100%;height:100%;display:block}.cke_editable.cke_widget_dragging, .cke_editable.cke_widget_dragging *{cursor:move !important}")},beforeInit:function(editor){editor.widgets=new Repository(editor)},afterInit:function(editor){addWidgetButtons(editor),setupContextMenu(editor)}}),Repository.prototype={MIN_SELECTION_CHECK_INTERVAL:500,add:function(name,widgetDef){return widgetDef=CKEDITOR.tools.prototypedCopy(widgetDef),widgetDef.name=name,widgetDef._=widgetDef._||{},this.editor.fire("widgetDefinition",widgetDef),widgetDef.template&&(widgetDef.template=new CKEDITOR.template(widgetDef.template)),addWidgetCommand(this.editor,widgetDef),addWidgetProcessors(this,widgetDef),this.registered[name]=widgetDef,widgetDef},addUpcastCallback:function(callback){this._.upcastCallbacks.push(callback)},checkSelection:function(){var widget,sel=this.editor.getSelection(),selectedElement=sel.getSelectedElement(),updater=stateUpdater(this);if(selectedElement&&(widget=this.getByElement(selectedElement,!0)))return updater.focus(widget).select(widget).commit();var range=sel.getRanges()[0];if(!range||range.collapsed)return updater.commit();var wrapper,walker=new CKEDITOR.dom.walker(range);for(walker.evaluator=Widget.isDomWidgetWrapper;wrapper=walker.next();)updater.select(this.getByElement(wrapper));updater.commit()},checkWidgets:function(options){this.fire("checkWidgets",CKEDITOR.tools.copy(options||{}))},del:function(widget){if(this.focused===widget){var found,editor=widget.editor,range=editor.createRange();(found=range.moveToClosestEditablePosition(widget.wrapper,!0))||(found=range.moveToClosestEditablePosition(widget.wrapper,!1)),found&&editor.getSelection().selectRanges([range])}widget.wrapper.remove(),this.destroy(widget,!0)},destroy:function(widget,offline){this.widgetHoldingFocusedEditable===widget&&setFocusedEditable(this,widget,null,offline),widget.destroy(offline),delete this.instances[widget.id],this.fire("instanceDestroyed",widget)},destroyAll:function(offline,container){var widget,id,instances=this.instances;if(!container||offline)for(id in instances)widget=instances[id],this.destroy(widget,offline);else for(var wrappers=container.find(".cke_widget_wrapper"),l=wrappers.count(),i=0;i<l;++i)(widget=this.getByElement(wrappers.getItem(i),!0))&&this.destroy(widget)},finalizeCreation:function(container){var wrapper=container.getFirst();if(wrapper&&Widget.isDomWidgetWrapper(wrapper)){this.editor.insertElement(wrapper);var widget=this.getByElement(wrapper);widget.ready=!0,widget.fire("ready"),widget.focus()}},getByElement:function(){function getWidgetId(element){return element.is(validWrapperElements)&&element.data("cke-widget-id")}var validWrapperElements={div:1,span:1};return function(element,checkWrapperOnly){if(!element)return null;var id=getWidgetId(element);if(!checkWrapperOnly&&!id){var limit=this.editor.editable();do{element=element.getParent()}while(element&&!element.equals(limit)&&!(id=getWidgetId(element)))}return this.instances[id]||null}}(),initOn:function(element,widgetDef,startupData){if(widgetDef?"string"==typeof widgetDef&&(widgetDef=this.registered[widgetDef]):widgetDef=this.registered[element.data("widget")],!widgetDef)return null;var wrapper=this.wrapElement(element,widgetDef.name);if(wrapper){if(wrapper.hasClass("cke_widget_new")){var widget=new Widget(this,this._.nextId++,element,widgetDef,startupData);return widget.isInited()?(this.instances[widget.id]=widget,widget):null}return this.getByElement(element)}return null},
initOnAll:function(container){for(var instance,newWidgets=(container||this.editor.editable()).find(".cke_widget_new"),newInstances=[],i=newWidgets.count();i--;)(instance=this.initOn(newWidgets.getItem(i).getFirst(Widget.isDomWidgetElement)))&&newInstances.push(instance);return newInstances},onWidget:function(widgetName){var args=Array.prototype.slice.call(arguments);args.shift();for(var i in this.instances){var instance=this.instances[i];instance.name==widgetName&&instance.on.apply(instance,args)}this.on("instanceCreated",function(evt){var widget=evt.data;widget.name==widgetName&&widget.on.apply(widget,args)})},parseElementClasses:function(classes){if(!classes)return null;classes=CKEDITOR.tools.trim(classes).split(/\s+/);for(var cl,obj={},hasClasses=0;cl=classes.pop();)-1==cl.indexOf("cke_")&&(obj[cl]=hasClasses=1);return hasClasses?obj:null},wrapElement:function(element,widgetName){var widgetDef,isInline,wrapper=null;if(element instanceof CKEDITOR.dom.element){if(!(widgetDef=this.registered[widgetName||element.data("widget")]))return null;if((wrapper=element.getParent())&&wrapper.type==CKEDITOR.NODE_ELEMENT&&wrapper.data("cke-widget-wrapper"))return wrapper;element.hasAttribute("data-cke-widget-keep-attr")||element.data("cke-widget-keep-attr",element.data("widget")?1:0),widgetName&&element.data("widget",widgetName),isInline=isWidgetInline(widgetDef,element.getName()),wrapper=new CKEDITOR.dom.element(isInline?"span":"div"),wrapper.setAttributes(getWrapperAttributes(isInline)),wrapper.data("cke-display-name",widgetDef.pathName?widgetDef.pathName:element.getName()),element.getParent(!0)&&wrapper.replace(element),element.appendTo(wrapper)}else if(element instanceof CKEDITOR.htmlParser.element){if(!(widgetDef=this.registered[widgetName||element.attributes["data-widget"]]))return null;if((wrapper=element.parent)&&wrapper.type==CKEDITOR.NODE_ELEMENT&&wrapper.attributes["data-cke-widget-wrapper"])return wrapper;"data-cke-widget-keep-attr"in element.attributes||(element.attributes["data-cke-widget-keep-attr"]=element.attributes["data-widget"]?1:0),widgetName&&(element.attributes["data-widget"]=widgetName),isInline=isWidgetInline(widgetDef,element.name),wrapper=new CKEDITOR.htmlParser.element(isInline?"span":"div",getWrapperAttributes(isInline)),wrapper.attributes["data-cke-display-name"]=widgetDef.pathName?widgetDef.pathName:element.name;var index,parent=element.parent;parent&&(index=element.getIndex(),element.remove()),wrapper.add(element),parent&&insertElement(parent,index,wrapper)}return wrapper},_tests_createEditableFilter:createEditableFilter},CKEDITOR.event.implementOn(Repository.prototype),Widget.prototype={addClass:function(className){this.element.addClass(className)},applyStyle:function(style){applyRemoveStyle(this,style,1)},checkStyleActive:function(style){var cl,classes=getStyleClasses(style);if(!classes)return!1;for(;cl=classes.pop();)if(!this.hasClass(cl))return!1;return!0},destroy:function(offline){if(this.fire("destroy"),this.editables)for(var name in this.editables)this.destroyEditable(name,offline);offline||("0"==this.element.data("cke-widget-keep-attr")&&this.element.removeAttribute("data-widget"),this.element.removeAttributes(["data-cke-widget-data","data-cke-widget-keep-attr"]),this.element.removeClass("cke_widget_element"),this.element.replace(this.wrapper)),this.wrapper=null},destroyEditable:function(editableName,offline){var editable=this.editables[editableName];editable.removeListener("focus",onEditableFocus),editable.removeListener("blur",onEditableBlur),this.editor.focusManager.remove(editable),offline||(this.repository.destroyAll(!1,editable),editable.removeClass("cke_widget_editable"),editable.removeClass("cke_widget_editable_focused"),editable.removeAttributes(["contenteditable","data-cke-widget-editable","data-cke-enter-mode"])),delete this.editables[editableName]},edit:function(){var evtData={dialog:this.dialog},that=this;return!(!1===this.fire("edit",evtData)||!evtData.dialog)&&(this.editor.openDialog(evtData.dialog,function(dialog){var showListener,okListener;!1!==that.fire("dialog",dialog)&&(showListener=dialog.on("show",function(){dialog.setupContent(that)}),okListener=dialog.on("ok",function(){var dataChanged,dataListener=that.on("data",function(evt){dataChanged=1,evt.cancel()},null,null,0);that.editor.fire("saveSnapshot"),dialog.commitContent(that),dataListener.removeListener(),dataChanged&&(that.fire("data",that.data),that.editor.fire("saveSnapshot"))}),dialog.once("hide",function(){showListener.removeListener(),okListener.removeListener()}))}),!0)},getClasses:function(){return this.repository.parseElementClasses(this.element.getAttribute("class"))},hasClass:function(className){return this.element.hasClass(className)},initEditable:function(editableName,definition){var editable=this._findOneNotNested(definition.selector);return!(!editable||!editable.is(CKEDITOR.dtd.$editable))&&(editable=new NestedEditable(this.editor,editable,{filter:createEditableFilter.call(this.repository,this.name,editableName,definition)}),this.editables[editableName]=editable,editable.setAttributes({contenteditable:"true","data-cke-widget-editable":editableName,"data-cke-enter-mode":editable.enterMode}),editable.filter&&editable.data("cke-filter",editable.filter.id),editable.addClass("cke_widget_editable"),editable.removeClass("cke_widget_editable_focused"),definition.pathName&&editable.data("cke-display-name",definition.pathName),this.editor.focusManager.add(editable),editable.on("focus",onEditableFocus,this),CKEDITOR.env.ie&&editable.on("blur",onEditableBlur,this),editable._.initialSetData=!0,editable.setData(editable.getHtml()),!0)},_findOneNotNested:function(selector){for(var match,closestWrapper,matchedElements=this.wrapper.find(selector),i=0;i<matchedElements.count();i++)if(match=matchedElements.getItem(i),closestWrapper=match.getAscendant(Widget.isDomWidgetWrapper),this.wrapper.equals(closestWrapper))return match;return null},isInited:function(){return!(!this.wrapper||!this.inited)},isReady:function(){return this.isInited()&&this.ready},focus:function(){var sel=this.editor.getSelection();if(sel){var isDirty=this.editor.checkDirty();sel.fake(this.wrapper),!isDirty&&this.editor.resetDirty()}this.editor.focus()},removeClass:function(className){this.element.removeClass(className)},removeStyle:function(style){applyRemoveStyle(this,style,0)},setData:function(key,value){var data=this.data,modified=0;if("string"==typeof key)data[key]!==value&&(data[key]=value,modified=1);else{var newData=key;for(key in newData)data[key]!==newData[key]&&(modified=1,data[key]=newData[key])}return modified&&this.dataReady&&(writeDataToElement(this),this.fire("data",data)),this},setFocused:function(focused){return this.wrapper[focused?"addClass":"removeClass"]("cke_widget_focused"),this.fire(focused?"focus":"blur"),this},setSelected:function(selected){return this.wrapper[selected?"addClass":"removeClass"]("cke_widget_selected"),this.fire(selected?"select":"deselect"),this},updateDragHandlerPosition:function(){var editor=this.editor,domElement=this.element.$,oldPos=this._.dragHandlerOffset,newPos={x:domElement.offsetLeft,y:domElement.offsetTop-DRAG_HANDLER_SIZE};if(!oldPos||newPos.x!=oldPos.x||newPos.y!=oldPos.y){var initialDirty=editor.checkDirty();editor.fire("lockSnapshot"),this.dragHandlerContainer.setStyles({top:newPos.y+"px",left:newPos.x+"px",display:"block"}),editor.fire("unlockSnapshot"),!initialDirty&&editor.resetDirty(),this._.dragHandlerOffset=newPos}}},CKEDITOR.event.implementOn(Widget.prototype),Widget.getNestedEditable=function(guard,node){return!node||node.equals(guard)?null:Widget.isDomNestedEditable(node)?node:Widget.getNestedEditable(guard,node.getParent())},Widget.isDomDragHandler=function(node){return node.type==CKEDITOR.NODE_ELEMENT&&node.hasAttribute("data-cke-widget-drag-handler")},Widget.isDomDragHandlerContainer=function(node){return node.type==CKEDITOR.NODE_ELEMENT&&node.hasClass("cke_widget_drag_handler_container")},Widget.isDomNestedEditable=function(node){return node.type==CKEDITOR.NODE_ELEMENT&&node.hasAttribute("data-cke-widget-editable")},Widget.isDomWidgetElement=function(node){return node.type==CKEDITOR.NODE_ELEMENT&&node.hasAttribute("data-widget")},Widget.isDomWidgetWrapper=function(node){return node.type==CKEDITOR.NODE_ELEMENT&&node.hasAttribute("data-cke-widget-wrapper")},Widget.isParserWidgetElement=function(node){return node.type==CKEDITOR.NODE_ELEMENT&&!!node.attributes["data-widget"]},Widget.isParserWidgetWrapper=function(node){return node.type==CKEDITOR.NODE_ELEMENT&&!!node.attributes["data-cke-widget-wrapper"]},NestedEditable.prototype=CKEDITOR.tools.extend(CKEDITOR.tools.prototypedCopy(CKEDITOR.dom.element.prototype),{setData:function(data){this._.initialSetData||this.editor.widgets.destroyAll(!1,this),this._.initialSetData=!1,data=this.editor.dataProcessor.toHtml(data,{context:this.getName(),filter:this.filter,enterMode:this.enterMode}),this.setHtml(data),this.editor.widgets.initOnAll(this)},getData:function(){return this.editor.dataProcessor.toDataFormat(this.getHtml(),{context:this.getName(),filter:this.filter,enterMode:this.enterMode})}});var pasteReplaceRegex=new RegExp('^(?:<(?:div|span)(?: data-cke-temp="1")?(?: id="cke_copybin")?(?: data-cke-temp="1")?>)?(?:<(?:div|span)(?: style="[^"]+")?>)?<span [^>]*data-cke-copybin-start="1"[^>]*>.?</span>([\\s\\S]+)<span [^>]*data-cke-copybin-end="1"[^>]*>.?</span>(?:</(?:div|span)>)?(?:</(?:div|span)>)?$',"i"),keystrokesNotBlockedByWidget={37:1,38:1,39:1,40:1,8:1,46:1};!function(){function notImplemented(){}function checkElementMatch(element,fullMatch,editor){if(!editor)return!1;if(!this.checkElement(element))return!1;var widget=editor.widgets.getByElement(element,!0);return widget&&widget.checkStyleActive(this)}CKEDITOR.style.addCustomHandler({type:"widget",setup:function(styleDefinition){this.widget=styleDefinition.widget},apply:function(editor){editor instanceof CKEDITOR.editor&&this.checkApplicable(editor.elementPath(),editor)&&editor.widgets.focused.applyStyle(this)},remove:function(editor){editor instanceof CKEDITOR.editor&&this.checkApplicable(editor.elementPath(),editor)&&editor.widgets.focused.removeStyle(this)},checkActive:function(elementPath,editor){return this.checkElementMatch(elementPath.lastElement,0,editor)},checkApplicable:function(elementPath,editor){return editor instanceof CKEDITOR.editor&&this.checkElement(elementPath.lastElement)},checkElementMatch:checkElementMatch,checkElementRemovable:checkElementMatch,checkElement:function(element){if(!Widget.isDomWidgetWrapper(element))return!1;var widgetElement=element.getFirst(Widget.isDomWidgetElement);return widgetElement&&widgetElement.data("widget")==this.widget},buildPreview:function(label){return label||this._.definition.name},toAllowedContentRules:function(editor){if(!editor)return null;var classes,widgetDef=editor.widgets.registered[this.widget],rule={};return widgetDef?widgetDef.styleableElements?(classes=this.getClassesArray())?(rule[widgetDef.styleableElements]={classes:classes,propertiesOnly:!0},rule):null:widgetDef.styleToAllowedContentRules?widgetDef.styleToAllowedContentRules(this):null:null},getClassesArray:function(){var classes=this._.definition.attributes&&this._.definition.attributes.class;return classes?CKEDITOR.tools.trim(classes).split(/\s+/):null},applyToRange:notImplemented,removeFromRange:notImplemented,applyToObject:notImplemented})}(),CKEDITOR.plugins.widget=Widget,Widget.repository=Repository,Widget.nestedEditable=NestedEditable}();