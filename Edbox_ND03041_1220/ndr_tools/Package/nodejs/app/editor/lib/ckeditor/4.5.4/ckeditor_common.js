function create_media_dialog(type){var placeholder=CKEDITOR.BASE_PATH+"/plugins/"+type+"/images/placeholder.png";return function(editor){function commitValue(mediaNode,extraStyles){var value=this.getValue();if(value||"id"!=this.id||(value=generateId()),mediaNode.setAttribute(this.id,value),value)switch(this.id){case"poster":extraStyles.backgroundImage="url('"+placeholder+"')";break;case"width":extraStyles.width=value+"px";break;case"height":extraStyles.height=value+"px"}}function commitSrc(mediaNode,extraStyles,medias){var value=this.getValue();mediaNode.setAttribute("src",value)}function loadValue(mediaNode){mediaNode?this.setValue(mediaNode.getAttribute(this.id)):"id"==this.id&&this.setValue(generateId())}function loadSrc(mediaNode,medias){mediaNode&&this.setValue(mediaNode.getAttribute("src"))}function generateId(){var now=new Date;return"media"+now.getFullYear()+now.getMonth()+now.getDate()+now.getHours()+now.getMinutes()+now.getSeconds()}function loadImageLib(query,dialog){$.ajax({url:CKEDITOR.config.assetServer+"/v0.2/assets?words="+(query.keyword||"")+"&type="+type+"&page="+query.pageIndex+"&size="+query.pageSize,type:"get",contentType:"application/json; charset=utf-8",dataType:"json",success:function(data){var div=dialog.getContentElement("imageLib","selectImageLib").getElement().$;$(div).html("");for(var items=data.items,i=0;i<items.length;i++)render_item(items[i],div,dialog)}})}function render_item(item,parent,dialog){item.preview||(item.preview={});var src=append_server_prefix(item.preview.image||src_default),el=$("<div class='imageItem' style='float:left;height:160px;width:160px;padding:0 20px 20px 20px;'><img src='"+src+"' style='width:160px'/><p>"+item.title+"</p></div>");el.appendTo($(parent)),$(el).find("img").click(function(){$(parent).find("img").removeClass("focus"),$(this).addClass("focus");var preview=this.src;select_item(item.href,preview,dialog)})}function append_server_prefix(url){return url!=src_default&&-1==url.indexOf("http:")&&(url=CKEDITOR.config.assetServer+url),url}function select_item(href,preview,dialog){var href=append_server_prefix(href);preview||(preview=src_default),dialog.setValueOf("info","poster",preview),dialog.setValueOf("info","src",href)}var lang=editor.lang[type],onImgLoadEvent=function(){var preview=this.previewImage;preview.removeListener("load",onImgLoadEvent),preview.removeListener("error",onImgLoadErrorEvent),preview.removeListener("abort",onImgLoadErrorEvent),this.setValueOf("info","width",preview.$.width),this.setValueOf("info","height",preview.$.height)},onImgLoadErrorEvent=function(){var preview=this.previewImage;preview.removeListener("load",onImgLoadEvent),preview.removeListener("error",onImgLoadErrorEvent),preview.removeListener("abort",onImgLoadErrorEvent)},src_default="video"==type?"/resources/asset/video/video-image.jpg":"/resources/asset/audio/3.jpg";return{title:lang.dialogTitle,minWidth:860,minHeight:360,onShow:function(){this.fakeImage=this.mediaNode=null,this.previewImage=editor.document.createElement("img");var fakeImage=this.getSelectedElement();if(fakeImage&&fakeImage.data("cke-real-element-type")&&fakeImage.data("cke-real-element-type")==type){this.fakeImage=fakeImage;var mediaNode=editor.restoreRealElement(fakeImage);this.mediaNode=mediaNode,this.setupContent(mediaNode,[])}else this.setupContent(null,[])},onOk:function(){var mediaNode=null;this.fakeImage?mediaNode=this.mediaNode:(mediaNode=CKEDITOR.dom.element.createFromHtml("<cke:"+type+"></cke:"+type+">",editor.document),mediaNode.setAttributes({controls:"controls"}));var extraStyles={},medias=[];this.commitContent(mediaNode,extraStyles,medias);var fallbackTemplate=(lang.linkTemplate,lang.fallbackTemplate||"");mediaNode.setHtml(""+fallbackTemplate.replace("%links%",""));var newFakeImage=editor.createFakeElement(mediaNode,"cke_"+type,type,!1);if(newFakeImage.setStyles(extraStyles),this.fakeImage)newFakeImage.replace(this.fakeImage),editor.getSelection().selectElement(newFakeImage);else{var div=new CKEDITOR.dom.element("DIV",editor.document);editor.insertElement(div),div.append(newFakeImage)}},onHide:function(){this.previewImage&&(this.previewImage.removeListener("load",onImgLoadEvent),this.previewImage.removeListener("error",onImgLoadErrorEvent),this.previewImage.removeListener("abort",onImgLoadErrorEvent),this.previewImage.remove(),this.previewImage=null)},contents:[{id:"imageLib",label:lang.imagelib,elements:[{type:"hbox",widths:["280px","110px"],align:"right",children:[{id:"imageLibSearchText",type:"text"},{type:"button",id:"imageLibSearchButton",align:"center",label:lang.searchlib,onClick:function(){var dialog=this.getDialog(),keyword=dialog.getValueOf("imageLib","imageLibSearchText");keyword||(keyword=""),loadImageLib({type:type,pageIndex:1,pageSize:100,keyword:keyword},dialog)}}]},{type:"html",id:"selectImageLib",style:"width:95%;",onLoad:function(){var dialog=this.getDialog(),keyword=dialog.getValueOf("imageLib","imageLibSearchText");keyword||(keyword=""),loadImageLib({type:type,pageIndex:1,pageSize:100,keyword:keyword},dialog)},html:'<div style="height:350px;float:left;"></div>'}]},{id:"info",label:lang.infoTab,accessKey:"I",elements:[{type:"hbox",widths:["","100px"],children:[{type:"text",id:"poster",label:lang.poster,commit:commitValue,setup:loadValue,onChange:function(){var dialog=this.getDialog(),newUrl=this.getValue();if(newUrl.length>0){dialog=this.getDialog();var preview=dialog.previewImage;preview.on("load",onImgLoadEvent,dialog),preview.on("error",onImgLoadErrorEvent,dialog),preview.on("abort",onImgLoadErrorEvent,dialog),preview.setAttribute("src",newUrl)}}},{type:"button",id:"browse",hidden:"true",style:"display:inline-block;margin-top:10px;",filebrowser:{action:"Browse",target:"info:poster",url:editor.config.filebrowserImageBrowseUrl||editor.config.filebrowserBrowseUrl},label:editor.lang.common.browseServer}]},{type:"hbox",widths:["33%","33%","33%"],children:[{type:"text",id:"width",label:editor.lang.common.width,default:400,validate:CKEDITOR.dialog.validate.notEmpty(lang.widthRequired),commit:commitValue,setup:loadValue},{type:"text",id:"height",label:editor.lang.common.height,default:300,validate:CKEDITOR.dialog.validate.notEmpty(lang.heightRequired),commit:commitValue,setup:loadValue}]},{type:"hbox",widths:["","100px","75px"],children:[{type:"text",id:"src",label:lang.sourceMedia,commit:commitSrc,setup:loadSrc}]}]},{id:"Upload",hidden:!1,filebrowser:"uploadButton",label:lang.upload,elements:[{type:"file",id:"uploadInput",style:"height:40px",size:38},{type:"text",id:"uploadFileNameInput",label:lang.filename,style:"height:40px",size:38},{type:"text",id:"uploadTitleInput",label:lang.title,style:"height:40px",size:38},{type:"textarea",id:"uploadDescriptionInput",label:lang.description,style:"height:40px",size:38},{type:"button",id:"uploadButton",filebrowser:"info:txtUrl",label:lang.btnUpload,onLoad:function(){this.getDialog().getContentElement("Upload","uploadDescriptionInput").getElement().setStyle("height","auto")},onClick:function(){var dialog=this.getDialog(),reader=new FileReader,title=dialog.getValueOf("Upload","uploadTitleInput"),description=dialog.getValueOf("Upload","uploadDescriptionInput"),fileName=dialog.getValueOf("Upload","uploadFileNameInput");if(""==title)return void alert("请输入"+lang.title);""==fileName&&(fileName=title);var fileInput=dialog.getContentElement("Upload","uploadInput").getInputElement().$,file=fileInput.files[0];reader.onloadend=function(){reader.error?alert(reader.error):upload(title,description,fileName,file,reader,dialog,function(url,uuid,size){var param=JSON.stringify({title:title,identifier:uuid,description:description,href:url,format:type,size:parseInt(size)}),xhr=new XMLHttpRequest;xhr.open("POST",CKEDITOR.config.assetServer+"/v0.2/assets/"),xhr.setRequestHeader("Content-type","application/json"),xhr.send(param),select_item(url,"",dialog),dialog.selectPage("info")})},reader.readAsBinaryString(file)}},{type:"html",id:"uploadProgress",style:"width:95%;",onLoad:function(){var dialog=this.getDialog(),div=dialog.getContentElement("Upload","uploadProgress").getElement(),p=$(div.$).find("p");p.css("width","480px"),p.css("padding","20px 5px"),p.css("margin","2px 0"),p.css("border","1px inset #446"),p.css("border-radius","5px"),p.css("background-image","url('"+CKEDITOR.basePath+"/progress.png')"),p.hide()},html:"<div><p></p></div>"}]}]}}}function create_plugin_config(type){return{lang:["zh"],getPlaceholderCss:function(){return"img.cke_"+type+"{background-image: url('"+CKEDITOR.getUrl(this.path+"images/placeholder.png")+"');background-position: center center;background-repeat: no-repeat;}"},onLoad:function(){CKEDITOR.addCss&&CKEDITOR.addCss(this.getPlaceholderCss())},init:function(editor){var lang=editor.lang[type];if(void 0===editor.element.data)return void alert('The "media" plugin requires CKEditor 3.5 or newer');CKEDITOR.dialog.add(type,this.path+"dialogs/"+type+".js"),editor.addCommand(type,new CKEDITOR.dialogCommand(type,{allowedContent:"video[*];audio[*]"})),editor.ui.addButton(type,{label:lang.toolbar,command:type,icon:this.path+"images/icon.png"}),editor.addCss&&editor.addCss(this.getPlaceholderCss()),editor.addMenuItems&&editor.addMenuItems({type:{label:lang.properties,command:type,group:"flash"}}),editor.on("doubleclick",function(evt){var element=evt.data.element;if(element.is("img")&&element.data("cke-real-element-type")==type){var realElement=editor.restoreRealElement(element),src=realElement.getAttribute("src"),width=realElement.getAttribute("width"),height=realElement.getAttribute("height");video_audio_preview(editor,src,type,width,height)}}),editor.contextMenu&&editor.contextMenu.addListener(function(element,selection){if(element&&element.is("img")&&!element.isReadOnly()&&element.data("cke-real-element-type")==type){var config={};return config[type]=CKEDITOR.TRISTATE_OFF,config}}),CKEDITOR.dtd.$empty["cke:source"]=1,CKEDITOR.dtd.$empty.source=1,editor.lang.fakeobjects[type]=lang.fakeObject},afterInit:function(editor){var dataProcessor=editor.dataProcessor;dataProcessor&&dataProcessor.htmlFilter;(dataProcessor&&dataProcessor.dataFilter).addRules({elements:{$:function(realElement){if(realElement.name==type){realElement.name="cke:"+type;for(var i=0;i<realElement.children.length;i++)"source"==realElement.children[i].name&&(realElement.children[i].name="cke:source");var fakeElement=editor.createFakeParserElement(realElement,"cke_"+type,type,!1),fakeStyle=fakeElement.attributes.style||"",width=realElement.attributes.width,height=realElement.attributes.height,poster=realElement.attributes.poster;return void 0!==width&&(fakeStyle=fakeElement.attributes.style=fakeStyle+"width:"+CKEDITOR.tools.cssLength(width)+";"),void 0!==height&&(fakeStyle=fakeElement.attributes.style=fakeStyle+"height:"+CKEDITOR.tools.cssLength(height)+";"),poster&&(fakeStyle=fakeElement.attributes.style=fakeStyle+"background-image:url('"+poster+"');"),fakeElement}}}})}}}function upload(title,description,fileName,file,reader,dialog,callback){function on_progress(index,loaded,total,progress,title){return function(e){loaded[index]=e.loaded;for(var sum=0,i=0;i<loaded.length;i++)sum+=loaded[i];var pc=parseInt(100-sum/total*100);pc<0&&(pc=0),$(progress).html(title+",已完成 "+(100-pc)+"%"),progress.css("backgroundPosition",pc+"% 0")}}$.ajax({url:CKEDITOR.config.assetServer+"/v0.2/assets/blob_upload_dir",type:"get",contentType:"application/json; charset=utf-8",dataType:"json",success:function(data){var uuid=data.uuid,blocks=Math.ceil(file.size/10485760),div=dialog.getContentElement("Upload","uploadProgress").getElement(),progress=$(div.$).find("p");progress.show(),progress.css("background-position","100% 0");for(var loaded=[],i=0;i<blocks;i++){loaded[i]=0;var xhr=new XMLHttpRequest;xhr.open("POST",data.access_url+"?session="+data.session_id),xhr.overrideMimeType("application/octet-stream");var formData=new FormData;formData.append("name",file.name),formData.append("file_title",title),formData.append("file_description",description),formData.append("file_type",file.type),formData.append("path","/edu/lifecycle/dev"),formData.append("scope","1"),formData.append("chunks",blocks),formData.append("chunk",i),formData.append("pos",10485760*i),formData.append("size",file.size);var filedata=null;filedata=i==blocks-1?file.slice(10485760*i,file.size):file.slice(10485760*i,10485760*(i+1)),formData.append("file",filedata),xhr.onreadystatechange=function(){if(4==xhr.readyState&&200==xhr.status){var result=xhr.responseText,json=new Function("return "+result+";")();json.dentry_id&&callback("/v0.2/assets/"+uuid+"/original/"+json.dentry_id,uuid,json.inode.size)}},xhr.upload.addEventListener("progress",on_progress(i,loaded,file.size,progress,"上传文件 "+file.name),!1),xhr.send(formData)}}})}function auto_id(){return"s-"+guid()}function guid(){function s4(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return s4()+s4()+"_"+s4()+"_"+s4()+"_"+s4()+"_"+s4()+s4()+s4()}function create_uploader(container,setUrl,buttons,userId){function getUploadConfig(callback){$.ajax({url:CKEDITOR.config.assetServer+"/v0.2/assets/blob_upload_dir",type:"get",contentType:"application/json; charset=utf-8",dataType:"json",success:function(data){data.uuid;callback(data)}})}function finish_upload(url,uuid,size,file){var param=JSON.stringify({title:file.name,identifier:uuid,description:"",href:url,format:file.type,creator:userId,size:parseInt(size)}),xhr=new XMLHttpRequest;xhr.open("POST",CKEDITOR.config.assetServer+"/v0.2/assets"),xhr.setRequestHeader("Content-type","application/json"),xhr.send(param),setUrl(file.id,CKEDITOR.config.assetServer+url)}function add_file(file){container.find("#filelist")[0].innerHTML+='<div id="'+file.id+'">'+file.name+" ("+plupload.formatSize(file.size)+") <b> </b></div>"}function show_error(up,err){container.find("#console").innerHTML+="\nError #"+err.code+": "+err.message}var cache={},uploadbutton=buttons||container.find("#pickfiles"),upload_config={runtimes:"flash,html5,silverlight,html4",browse_button:uploadbutton[0],container:container[0],url:"#",flash_swf_url:UPLOAD_BASE+"Moxie.swf",silverlight_xap_url:UPLOAD_BASE+"Moxie.xap",chunk_size:CHUNK_SIZE,filters:{max_file_size:"1000mb",mime_types:[{title:"图片文件",extensions:"jpg,gif,png"},{title:"压缩文件",extensions:"zip"},{title:"视频文件",extensions:"mp4,ogg,avi"},{title:"音频文件",extensions:"mp3,ogg"}]},init:{PostInit:function(){},FilesAdded:function(up,files){plupload.each(files,function(file){add_file(file),getUploadConfig(function(data){var uuid=data.uuid,uploadUrl=data.access_url+"?session="+data.session_id;uploader.setOption("url",uploadUrl),uploader.setOption("multipart_params",{name:file.name,file_title:file.name,file_description:"",file_type:file.type,path:"/edu/lifecycle/dev",scope:1,size:file.size}),cache[file.id]=uuid,uploader.start()})})},UploadProgress:function(up,file){},FileUploaded:function(up,file,data){var result=data.response,json=new Function("return "+result+";")();if(json.dentry_id){var uuid=cache[file.id];finish_upload("/v0.2/assets/"+uuid+"/original/"+json.dentry_id,uuid,json.inode.size,file)}},Error:function(up,err){show_error(up,err)}}},uploader=new plupload.Uploader(upload_config);return uploader.init(),uploader}function insert_image(editor,params){if(window.ckeditorHandlers&&window.ckeditorHandlers[editor.name])return void window.ckeditorHandlers[editor.name].insertResource("image",params.url,params.width,params.height,"");var image='<img src="'+params.url+'" ';image+='width="'+params.width+'" ',params.height>0&&(image+=' height="'+params.height+'" '),image+=" > </img>";try{editor.insertHtml(image)}catch(ex){}}function insert_video_or_audio(editor,params){var default_poster=CKEDITOR.basePath+"plugins/"+params.type+"/images/placeholder.png",type=params.type,width=params.width?params.width:200,height=params.height?params.height:150,poster=params.poster?params.poster:default_poster;console.log(CKEDITOR.basePath+":"+poster);var url=params.url;if(window.ckeditorHandlers&&window.ckeditorHandlers[editor.name])return void window.ckeditorHandlers[editor.name].insertResource(type,url,width,height,poster);var mediaNode=null;mediaNode=CKEDITOR.dom.element.createFromHtml("<cke:"+type+"></cke:"+type+">",editor.document),mediaNode.setAttributes({controls:"controls"});var extraStyles={};extraStyles.backgroundImage="url('"+poster+"')",extraStyles.width=width+"px",extraStyles.height=height+"px",mediaNode.setAttribute("poster",poster),mediaNode.setAttribute("width",width),mediaNode.setAttribute("height",height),mediaNode.setAttribute("src",url),mediaNode.setAttribute("preload","none");mediaNode.setHtml("");var newFakeImage=editor.createFakeElement(mediaNode,"cke_"+type,type,!1);newFakeImage.setStyles(extraStyles),newFakeImage.setAttribute("title",params.filename);try{if("audio"==type||"video"==type){var div=new CKEDITOR.dom.element("div",editor.document);div.append(newFakeImage),editor.insertElement(div)}else editor.insertElement(newFakeImage)}catch(ex){}}function image_preview(editor,src,element){$.fancybox([src],{padding:0,transitionIn:"none",transitionOut:"none",type:"image",changeFade:0})}function translate(key){return window.$i18n?window.$i18n(key):key}function video_audio_preview(editor,src,type,width,height){var scope=angular.element($(".qti-ed")[0]).scope();if(scope){var dialog=scope.videoPreviewDialog,title=translate("video"==type?"resource.asset.video.preview":"resource.asset.audio.preview"),suffix="video"==type?"mp4":"mp3",dg=dialog.open({title:title});dg.openPromise.then(function(d){src=-1==src.indexOf("?")?src+"?."+suffix:src+"&."+suffix;var iframe=$(d.element.find("iframe"));iframe.attr("src","/editor/basic-question/player.html?mediaUrl="+encodeURIComponent(src)),iframe.attr("allowfullscreen","true"),iframe.attr("webkitallowfullscreen","true"),iframe.attr("mozallowfullscreen","true")}),dg.closePromise.then(function(d){d.element.find("iframe").attr("src","about:blank")})}else requirejs&&requirejs(["prompter","i18n!"],function(prompter,i18n){var title="video"==type?i18n.translate("resource.asset.video.preview"):i18n.translate("resource.asset.audio.preview"),suffix="video"==type?"mp4":"mp3";src=-1==src.indexOf("?")?src+"?."+suffix:src+"&."+suffix,prompter.as("basic").dialog({title:title,width:670,height:510,src:"/editor/basic-question/player.html?mediaUrl="+encodeURIComponent(src)})})}var progressimage="progress.png",UPLOAD_BASE="/lib/plu/",CHUNK_SIZE="20kb";