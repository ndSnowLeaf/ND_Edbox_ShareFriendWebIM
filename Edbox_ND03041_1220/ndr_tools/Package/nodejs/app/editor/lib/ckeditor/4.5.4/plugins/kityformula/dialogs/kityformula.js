function getIFrame(fid){return document.frames?document.frames[fid]:document.getElementById(fid)}function getSelectionHtml(editor){for(var sel=editor.getSelection(),ranges=sel.getRanges(),el=new CKEDITOR.dom.element("div"),i=0,len=ranges.length;i<len;++i)el.append(ranges[i].cloneContents());return el.getHtml()}CKEDITOR.dialog.add("kityformulaDialog",function(editor){var fid="kityformula-editor";return{title:editor.lang.kityformula.title,minWidth:832,minHeight:385,contents:[{id:"tab-basic",label:"Editor",elements:[{type:"html",html:'<div style="width:500px;height:300px;"><iframe id="'+fid+'" style="width:782px;height:382px;" frameborder="no" scrolling="no" src="'+CKEDITOR.basePath+'plugins/kityformula/dialogs/kityformula.html"></iframe></div>'}]}],onOk:function(){getIFrame(fid).contentWindow.getImageData(function(imageData){editor.insertHtml(imageData)})},onShow:function(){var selectedHtml=getSelectionHtml(editor);console.log("select math data:"+selectedHtml);var iframeWindow=getIFrame(fid).contentWindow;if(selectedHtml&&0!=selectedHtml.length){if(iframeWindow.reload){var latex=iframeWindow.getLatexData(selectedHtml);console.log("select latex data:"+selectedHtml),iframeWindow.reload(latex)}}else iframeWindow.init&&iframeWindow.init()}}});