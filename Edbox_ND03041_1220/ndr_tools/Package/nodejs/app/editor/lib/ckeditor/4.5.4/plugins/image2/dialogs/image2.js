"use strict";CKEDITOR.dialog.add("image2",function(editor){function validateDimension(){var match=this.getValue().match(regexGetSizeOrEmpty),isValid=!(!match||0===parseInt(match[1],10));return isValid||alert(commonLang["invalid"+CKEDITOR.tools.capitalize(this.id)]),isValid}function createPreLoader(){function addListener(event,callback){listeners.push(image.once(event,function(evt){removeListeners(),callback(evt)}))}function removeListeners(){for(var l;l=listeners.pop();)l.removeListener()}var image=doc.createElement("img"),listeners=[];return function(src,callback,scope){addListener("load",function(){var dimensions=getNatural(image);callback.call(scope,image,dimensions.width,dimensions.height)}),addListener("error",function(){callback(null)}),addListener("abort",function(){callback(null)}),image.setAttribute("src",(config.baseHref||"")+src+"?"+Math.random().toString(16).substring(2))}}function onChangeSrc(){var value=this.getValue();toggleDimensions(!1),value!==widget.data.src?(preLoader(value,function(image,width,height){if(toggleDimensions(!0),!image)return toggleLockRatio(!1);widthField.setValue(width),heightField.setValue(height),preLoadedWidth=width,preLoadedHeight=height,toggleLockRatio(helpers.checkHasNaturalRatio(image))}),srcChanged=!0):srcChanged?(toggleDimensions(!0),widthField.setValue(domWidth),heightField.setValue(domHeight),srcChanged=!1):toggleDimensions(!0)}function onChangeDimension(){if(lockRatio){var value=this.getValue();if(value&&(value.match(regexGetSizeOrEmpty)||toggleLockRatio(!1),"0"!==value)){var isWidth="width"==this.id,width=domWidth||preLoadedWidth,height=domHeight||preLoadedHeight;value=isWidth?Math.round(height*(value/width)):Math.round(width*(value/height)),isNaN(value)||(isWidth?heightField:widthField).setValue(value)}}}function onLoadLockReset(){function setupMouseClasses(el){el.on("mouseover",function(){this.addClass("cke_btn_over")},el),el.on("mouseout",function(){this.removeClass("cke_btn_over")},el)}var dialog=this.getDialog();lockButton=doc.getById(lockButtonId),resetButton=doc.getById(resetButtonId),lockButton&&(dialog.addFocusable(lockButton,4+hasFileBrowser),lockButton.on("click",function(evt){toggleLockRatio(),evt.data&&evt.data.preventDefault()},this.getDialog()),setupMouseClasses(lockButton)),resetButton&&(dialog.addFocusable(resetButton,5+hasFileBrowser),resetButton.on("click",function(evt){srcChanged?(widthField.setValue(preLoadedWidth),heightField.setValue(preLoadedHeight)):(widthField.setValue(domWidth),heightField.setValue(domHeight)),evt.data&&evt.data.preventDefault()},this),setupMouseClasses(resetButton))}function toggleLockRatio(enable){if(lockButton){if("boolean"==typeof enable){if(userDefinedLock)return;lockRatio=enable}else{var height,width=widthField.getValue();userDefinedLock=!0,lockRatio=!lockRatio,lockRatio&&width&&(height=domHeight/domWidth*width,isNaN(height)||heightField.setValue(Math.round(height)))}if(lockButton[lockRatio?"removeClass":"addClass"]("cke_btn_unlocked"),lockButton.setAttribute("aria-checked",lockRatio),CKEDITOR.env.hc){lockButton.getChild(0).setHtml(lockRatio?CKEDITOR.env.ie?"■":"▣":CKEDITOR.env.ie?"□":"▢")}}}function toggleDimensions(enable){var method=enable?"enable":"disable";widthField[method](),heightField[method]()}var doc,widget,image,preLoader,domWidth,domHeight,preLoadedWidth,preLoadedHeight,srcChanged,lockRatio,userDefinedLock,lockButton,resetButton,widthField,heightField,natural,regexGetSizeOrEmpty=/(^\s*(\d+)(px)?\s*$)|^$/i,lockButtonId=CKEDITOR.tools.getNextId(),resetButtonId=CKEDITOR.tools.getNextId(),lang=editor.lang.image2,commonLang=editor.lang.common,lockResetHtml=new CKEDITOR.template('<div><a href="javascript:void(0)" tabindex="-1" title="'+lang.lockRatio+'" class="cke_btn_locked" id="{lockButtonId}" role="checkbox"><span class="cke_icon"></span><span class="cke_label">'+lang.lockRatio+'</span></a><a href="javascript:void(0)" tabindex="-1" title="'+lang.resetSize+'" class="cke_btn_reset" id="{resetButtonId}" role="button"><span class="cke_label">'+lang.resetSize+"</span></a></div>").output({lockButtonId:lockButtonId,resetButtonId:resetButtonId}),helpers=CKEDITOR.plugins.image2,config=editor.config,features=editor.widgets.registered.image.features,getNatural=helpers.getNatural,hasFileBrowser=!(!config.filebrowserImageBrowseUrl&&!config.filebrowserBrowseUrl),srcBoxChildren=[{id:"src",type:"text",label:commonLang.url,onKeyup:onChangeSrc,onChange:onChangeSrc,setup:function(widget){this.setValue(widget.data.src)},commit:function(widget){widget.setData("src",this.getValue())},validate:CKEDITOR.dialog.validate.notEmpty(lang.urlMissing)}];return hasFileBrowser&&srcBoxChildren.push({type:"button",id:"browse",style:"display:inline-block;margin-top:14px;",align:"center",label:editor.lang.common.browseServer,hidden:!0,filebrowser:"info:src"}),{title:lang.title,minWidth:400,minHeight:200,onLoad:function(){doc=this._.element.getDocument(),preLoader=createPreLoader()},onShow:function(){widget=this.widget,image=widget.parts.image,srcChanged=userDefinedLock=lockRatio=!1,natural=getNatural(image),preLoadedWidth=domWidth=natural.width,preLoadedHeight=domHeight=natural.height},contents:[{id:"info",label:lang.infoTab,elements:[{type:"vbox",padding:0,children:[{type:"hbox",widths:["100%"],children:srcBoxChildren}]},{id:"alt",type:"text",label:lang.alt,setup:function(widget){this.setValue(widget.data.alt)},commit:function(widget){widget.setData("alt",this.getValue())}},{type:"hbox",widths:["25%","25%","50%"],requiredContent:features.dimension.requiredContent,children:[{type:"text",width:"45px",id:"width",label:commonLang.width,validate:validateDimension,onKeyUp:onChangeDimension,onLoad:function(){widthField=this},setup:function(widget){this.setValue(widget.data.width)},commit:function(widget){widget.setData("width",this.getValue())}},{type:"text",id:"height",width:"45px",label:commonLang.height,validate:validateDimension,onKeyUp:onChangeDimension,onLoad:function(){heightField=this},setup:function(widget){this.setValue(widget.data.height)},commit:function(widget){widget.setData("height",this.getValue())}},{id:"lock",type:"html",style:"margin-top:18px;width:40px;height:20px;",onLoad:onLoadLockReset,setup:function(widget){toggleLockRatio(widget.data.lock)},commit:function(widget){widget.setData("lock",lockRatio)},html:lockResetHtml}]},{type:"hbox",id:"alignment",requiredContent:features.align.requiredContent,children:[{id:"align",type:"radio",items:[[commonLang.alignNone,"none"],[commonLang.alignLeft,"left"],[commonLang.alignCenter,"center"],[commonLang.alignRight,"right"]],label:commonLang.align,setup:function(widget){this.setValue(widget.data.align)},commit:function(widget){widget.setData("align",this.getValue())}}]},{id:"hasCaption",type:"checkbox",label:lang.captioned,requiredContent:features.caption.requiredContent,setup:function(widget){this.setValue(widget.data.hasCaption)},commit:function(widget){widget.setData("hasCaption",this.getValue())}}]}]}});