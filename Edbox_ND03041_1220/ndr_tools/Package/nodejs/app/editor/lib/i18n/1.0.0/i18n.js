define(["i18nConfig"],function(config){function I18n(lang,data){this._lang=lang,this._data=data||{}}Object.defineProperties(I18n.prototype,{language:{get:function(){return this._lang}},lang:{get:function(){return this._lang}},data:{get:function(){return this._data}}}),I18n.prototype.translate=function(key){if(!key)return key;var v=this._data[key];if(!v)return key;for(var params=[],i=1;i<arguments.length;i++)params.push(arguments[i]);return v.replace(/{([^}]+)}/g,function(text,key){var index=parseInt(key);return isNaN(index)?"":params[index]||""})},I18n.prototype.translateTemplate=function(template){if(!template)return template;var self=this;return template.replace(/\$i{([^}]+)}/g,function(text,key){return self.translate(key)})};var language,supportLanguages=config.supportLanguages||[],defaultLanguage=config.defaultLanguage||"zh-CN";if(supportLanguages.length>1){var navigatorLanguages=navigator.languages||[navigator.language],urlLang=function(name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)","i"),r=window.location.search.substr(1).match(reg);return null!=r?r[2]:null}(config.languageParamName||"_lang_");urlLang&&(urlLang=urlLang.replace("_","-"));for(var exceptLanguages=(urlLang?[urlLang,urlLang.replace(/-.+/,"")]:[]).concat(navigatorLanguages),i=0;i<navigatorLanguages.length;i++){var nl=navigatorLanguages[i];nl&&-1!=nl.indexOf("-")&&exceptLanguages.push(nl.substring(0,nl.indexOf("-")))}outer:for(var i=0;i<exceptLanguages.length;i++)for(var j=0;j<supportLanguages.length;j++)if(exceptLanguages[i]==supportLanguages[j]){language=supportLanguages[j];break outer}}else 1==supportLanguages.length&&(language=supportLanguages[0]);language||(language=defaultLanguage);var globalLanguagePack=config.globalLanguagePack;return{get language(){return language},get globalLanguagePack(){return globalLanguagePack},load:function(name,req,onLoad,config){if(!language)return console.log("no lan"),void onLoad(new I18n(null,{}));name||(console.log(name),name=globalLanguagePack);var index=name.indexOf("?");name=-1!=index?name.substring(0,index)+"/"+language+".json"+name.substring(index):name+"/"+language+".json",req(["json!"+name],function(data){onLoad(new I18n(language,data))},function(e){console.debug("语言包不存在："+name),onLoad(new I18n(language,{}))})}}});