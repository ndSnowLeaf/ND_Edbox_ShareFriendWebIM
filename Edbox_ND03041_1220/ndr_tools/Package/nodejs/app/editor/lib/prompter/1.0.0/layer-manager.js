define(["jquery"],function($){function getTopLayer(){for(var layer,i=0;i<layers.length;i++)layers[i]._opened&&(!layer||layers[i]._index>layer.$$index)&&(layer=layers[i]);return layer}function resetBackdrop(){for(var topBackdropIndex=-1,i=0;i<layers.length;i++){var layer=layers[i];layer._options.backdrop&&"float"!=layer._options.backdrop&&layer._opened&&(topBackdropIndex=Math.max(topBackdropIndex,layer._index))}topBackdropIndex>0?(backdropEl||(backdropEl=$(templates.backdrop).appendTo(document.body),backdropEl.on("click",function(event){var layer=getTopLayer();layer&&layer._options.backdrop&&"static"!=layer._options.backdrop&&event.target===event.currentTarget&&(event.preventDefault(),event.stopPropagation(),layer.close("backdrop"))})),backdropEl.show(),backdropEl.css("zIndex",1040+(topBackdropIndex&&1||0)+10*topBackdropIndex)):backdropEl&&backdropEl.hide(!1)}function Layer(options){this._options=$.extend({backdrop:!0,closeByEscape:!1,autoClose:!0,autoDestroy:!0,render:$.noop,onOpen:$.noop,onClose:$.noop,onKeydown:$.noop,check:$.noop,defaultSuccess:!1},options),this._opened=!1,this._destroyed=!1;var wrapEl=$(templates.layerWrap),content=this._options.content;$.isFunction(content)&&(content=content.apply(this._options,[wrapEl,this])),content&&wrapEl.append(content),this._options.backdrop&&"float"!=this._options.backdrop&&(wrapEl.addClass("_backdrop"),"static"!==this._options.backdrop&&wrapEl.click($.proxy(function(){this.close()},this))),wrapEl.on({keydown:$.proxy(function(event){this._options.onKeydown.apply(this,event)},this)});this._options.moveBy,this._wrapEl=wrapEl,this._autoTransform=function(){var contentEl=wrapEl.children();if(1==contentEl.length){var width=wrapEl.width(),height=wrapEl.height(),contentWidth=contentEl.width(),contentHeight=contentEl.height(),scale=Math.min(width/contentWidth,height/contentHeight)-.1;scale>=1?contentEl.css("transform",""):contentEl.css({"transform-origin":"center",transform:"scale("+scale+")"})}}}var backdropEl,templates={backdrop:'<div class="prompter-layer-backdrop"></div>',layerWrap:'<div class="prompter-layer-wrap" tabindex="-1"></div>'},layers=[],layerIndex=1;return $(document.body).on({keydown:function(event){if(27===event.which){var layer=getTopLayer();layer&&layer._options.closeByEscape&&(event.preventDefault(),$rootScope.$apply(function(){layer.close("key")}))}},mousedown:function(event){for(var i=0;i<layers.length;i++){var layer=layers[i];"float"==layer._options.backdrop&&layer._opened&&layer.close("document")}}}),Layer.prototype.open=function(){if(this._destroyed)throw"the layer is destroyed, can not open again.";if(this._resultDeferred=$.Deferred(),this._openDeferred=$.Deferred(),this._closeDeferred=$.Deferred(),this._checks=[this._options.check],this._opened)this._openDeferred.reject();else{this._index=layerIndex++,this._opened=!0;(this._options.parent?$(this._options.parent):$("body",document)).append(this._wrapEl),this._wrapEl.show(),this._wrapEl.css("zIndex",1050+10*this._index),setTimeout(this._autoTransform(),0),$(window).on("resize",this._autoTransform),this._openDeferred.resolve()}resetBackdrop();var layer=this,ctrl=function(result,success){return layer.close(result,success),ctrl};return ctrl.then=function(done,fail){return layer._resultDeferred.then(done,fail),ctrl},ctrl.thenOpen=function(fn){return layer._openDeferred.then(fn),ctrl},ctrl.thenClose=function(fn){return layer._closeDeferred.then(fn),ctrl},ctrl.autoClose=function(timeout,success){if(timeout&&$.isFunction(timeout.then))timeout.then(function(){layer.close("timeout",success)});else{var t=parseInt(timeout);isNaN(t)||setTimeout($.proxy(layer,"close","timeout",success),t)}return ctrl},ctrl.close=function(result,success){return layer.close(result,success),ctrl},ctrl.bindClose=function(result,success){return function(){layer.close(result,success)}},ctrl.thenOpen(this._options.onOpen).thenClose(this._options.onClose),ctrl.promise=function(){return layer._resultDeferred.promise()},ctrl.check=function(fn){return $.isFunction(fn)&&layer._checks.push(fn),ctrl},ctrl},Layer.prototype.close=function(result,success){if(this._opened){var checkResults=[];$.each(this._checks,$.proxy(function(i,check){checkResults.push(check(result,success,this.data))},this)),$.when.apply($,checkResults).done($.proxy(function(){for(var i=0;i<arguments.length;i++){var v=arguments[i];if(!1===v||"string"==typeof v)return}success="boolean"==typeof success?success:this._options.defaultSuccess,this._resultDeferred[success?"resolve":"reject"](this.data),this._opened=!1,this._options.autoDestroy?this.destroy():this._wrapEl.hide(!1),this._closeDeferred&&this._closeDeferred.resolve(result),resetBackdrop(),$(window).off("resize",this._autoTransform)},this)).fail(function(v){})}},Layer.prototype.destroy=function(result){this._wrapEl.remove(),this._destroyed=!0},Object.defineProperties(Layer.prototype,{data:{get:function(){return this._data},set:function(val){this._data=val}},destroyed:{get:function(){return this._destroyed}},opened:{get:function(){return this._opened}}}),{create:function(options){var layer=new Layer(options);return layers.push(layer),layer}}});