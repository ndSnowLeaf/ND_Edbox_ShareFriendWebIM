define(["jquery","angular","slides","prompter","plupload","ckeditor","i18n!angular-slides/../i18n","require"],function($,angular,slides,prompter,plupload,CKEDITOR,i18n,requirejs){function disallow(disallowedContent,value){for(var items=disallowedContent.split(","),i=0,len=items.length;i<len;i++){var rule=disallowRules[items[i]];if(rule&&rule.test(value))return!0}return!1}var module=angular.module("slides",[]);module.factory("slidesIdentifier",function(){var S4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},slidesIdentifier={guid:function(flat){return!0===flat?S4()+S4()+S4()+S4()+S4()+S4()+S4()+S4():S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()},objectKey:function(obj){return angular.isObject(obj)?obj.$$$object_identifier?obj.$$$object_identifier:obj.$$$object_identifier=slidesIdentifier.guid():obj}};return slidesIdentifier}),module.filter("encodeURI",function(){return function(value){return value?encodeURI(value):""}}),module.filter("encodeURIComponent",function(){return function(value){return value?encodeURIComponent(value):""}}),module.filter("escape",function(){return function(value){return value?escape(value):""}}),module.filter("csSize",function(){return function(value){return value?"string"!=typeof value||-1!=value.indexOf("%")?value:value+"px":""}}),module.filter("trust",["$sceDelegate",function($sceDelegate){return function(value,type){return $sceDelegate.trustAs(type||"html",value)}}]);var dict=function(value,items,valueKey,labelKey,defaultValue){if(!items||items.length<1)return"";valueKey=valueKey||"identifier",labelKey=labelKey||"title";for(var i=0;i<items.length;i++)if(items[i][valueKey]==value)return items[i][labelKey]||defaultValue||"";return defaultValue||""};module.filter("dict",function(){return dict}),module.filter("fileName",[function(){return function(value){if(!value)return"";var split=value.lastIndexOf("/");return-1!=split&&(value=value.substring(split+1)),value}}]),module.filter("fileSize",[function(){return function(value){return value?isNaN(value)?"":value<1024?value+" B":(value/=1024)<1024?value.toFixed(0)+" KB":(value/=1024)<1024?value.toFixed(1)+" MB":(value/=1024,value<1024?value.toFixed(2)+" GB":void 0):""}}]),module.filter("duration",[function(){return function(value){if(!value)return"";var s=parseInt(value),m=0,h=0;return s>60&&(m=parseInt(s/60),s=parseInt(s%60),m>60&&(h=parseInt(m/60),m=parseInt(m%60))),(h<10?"0"+h:h)+":"+(m<10?"0"+m:m)+":"+(s<10?"0"+s:s)}}]),module.filter("durationToIso",[function(){return function(value){return secondToDuration(value)||""}}]),module.filter("durationFromIso",[function(){return function(value){return durationToSecond(value)||""}}]);var secondToDuration=function(value){if(value){if(!/^\d+$/.test(value))return!1;if(value=parseInt(value),isNaN(value)||value<=0)return!1;var s=value,m=0,h=0;return s>=60&&(m=parseInt(s/60),s=parseInt(s%60),m>=60&&(h=parseInt(m/60),m=parseInt(m%60))),"PT"+(h<=0?"":h+"H")+(m<=0?"":m+"M")+s+"S"}},durationToSecond=function(value){if(!value)return null;for(var s=0,num="",isMonth=!0,setValue=function(times){var n=parseInt(num);n&&(s+=n*times),num=""},i=0;i<value.length;i++){var c=value.charAt(i);switch(c){case"P":break;case"Y":setValue(31536e3);break;case"M":setValue(isMonth?2592e3:60);break;case"D":setValue(86400);break;case"T":isMonth=!1;break;case"H":setValue(3600);break;case"S":setValue(1);break;default:num+=c}}return s};module.directive("ngLoad",["$parse",function($parse){return function($scope,$element,$attrs){var fn=$parse($attrs.ngLoad);$element.on("load",function(event){$scope.$apply(function(){fn($scope,{$event:event})})})}}]),module.directive("duration",["$timeout",function($timeout){return{restrict:"A",require:"ngModel",link:function(scope,element,attr,ctrl){var parse=function(viewValue){var result=secondToDuration(viewValue);return!1===result?void ctrl.$setValidity("integer",!1):(ctrl.$setValidity("integer",!0),result)},formatter=function(value){return durationToSecond(value)};ctrl.$parsers.push(parse),ctrl.$formatters.push(formatter)}}}]);var toggleContext={};module.directive("slidesToggle",["slidesIdentifier",function(slidesIdentifier){return{restrict:"A",scope:!1,require:"slidesToggle",controller:["$scope",function(){}],link:function($scope,$element,$attrs,ctrl){var key=slidesIdentifier.objectKey($scope.$eval($attrs.slidesToggle));key||(key=slidesIdentifier.guid()),ctrl.toggleKey=key,$element.addClass("slides-toggle"),"true"===$attrs.toggleDefault&&(toggleContext[key]=!0);var toggleKeep=$attrs.toggleKeep;$element.on("click keydown",function(event){if("keydown"==event.type)return void(13!=event.keyCode&&27!=event.keyCode||$scope.$apply(function(){toggleContext[key]=!1}));(!$attrs.toggleSelector||$element.is($attrs.toggleSelector)&&!angular.element(event.target).hasClass("slides-toggle-disabled"))&&($scope.$apply(function(){!toggleContext[key]||"all"==toggleKeep||"true"==toggleKeep&&!event.originalEvent.targetClick?toggleContext[key]=!0:delete toggleContext[key]}),event.originalEvent.stopToggle=key)}),$scope.$watch(function(){return toggleContext[key]},function(b){$element.toggleClass("slides-toggle-on",!0===b),$element.toggleClass("_on",!0===b)})}}}]),module.directive("slidesToggleTarget",["slidesIdentifier","$document",function(slidesIdentifier,$document){return{restrict:"A",scope:!1,require:"?^slidesToggle",link:function($scope,$element,$attrs,ctrl){function getKey(){return key||ctrl.toggleKey}var key=slidesIdentifier.objectKey($scope.$eval($attrs.slidesToggleTarget));if(key||ctrl){var toggleOnDocument=$attrs.toggleOnDocument,documentEventHandler=function(event){event.originalEvent.stopToggle!==getKey()&&$scope.$apply(function(){delete toggleContext[getKey()]})};$element.on("click",function(event){event.originalEvent.targetClick=!0,"true"==toggleOnDocument&&event.stopPropagation()}),$scope.$watch(function(){return toggleContext[getKey()]},function(b){$($element)[b?"show":"hide"](),"true"!=toggleOnDocument&&"all"!=toggleOnDocument||(b?$document.on("click",documentEventHandler):$document.off("click",documentEventHandler))})}}}}]);var hoverContext={};module.directive("slidesHover",["slidesIdentifier",function(slidesIdentifier){return{restrict:"A",scope:!1,require:"slidesHover",controller:["$scope",function(){}],link:function($scope,$element,$attrs,ctrl){var key=slidesIdentifier.objectKey($scope.$eval($attrs.slidesHover));key||(key=slidesIdentifier.guid()),ctrl.toggleKey=key,$element.addClass("slides-toggle"),"true"===$attrs.hoverDefault&&(hoverContext[key]=!0),$element.on("mouseover",function(event){$attrs.hoverSelector&&!$element.is($attrs.hoverSelector)||$scope.$apply(function(){hoverContext[key]=!0})}),$element.on("mouseout",function(event){$scope.$apply(function(){delete hoverContext[key]})}),$scope.$watch(function(){return hoverContext[key]},function(b){$element.toggleClass("_on",!0===b)})}}}]),module.directive("slidesHoverTarget",["slidesIdentifier","$document",function(slidesIdentifier,$document){return{restrict:"A",scope:!1,require:"?^slidesHover",link:function($scope,$element,$attrs,ctrl){function getKey(){return key||ctrl.toggleKey}var key=slidesIdentifier.objectKey($scope.$eval($attrs.slidesHoverTarget));(key||ctrl)&&($scope.$watch(function(){return hoverContext[getKey()]},function(b){$($element)[b?"show":"hide"]()}),$element.on("mouseover",function(event){$scope.$apply(function(){hoverContext[getKey()]=!0})}),$element.on("mouseout",function(event){$scope.$apply(function(){delete hoverContext[getKey()]})}))}}}]),module.factory("$stage",function(){return{setStage:function(stage){this.stage=stage},getStage:function(){return this.stage},transform:function(value,isX){return this.stage?isX?this.stage.transformScaleX(value):this.stage.transformScaleY(value):value},fixScale:function(event){event.clientX=this.transform(event.clientX,!0),event.clientY=this.transform(event.clientY,!1)}}}),module.directive("slidesDrag",["$parse","$document","$stage",function($parse,$document,$stage){return{restrict:"A",scope:!1,link:function($scope,$element,$attrs){function handleEvent(event,dragType){event.startX=startX,event.startY=startY,event.moveX=event.clientX-startX,event.moveY=event.clientY-startY,event.incrementX=event.clientX-x,event.incrementY=event.clientY-y,event.dragType=dragType,$scope.$apply(function(){handle($scope,{$event:event})})}var x,y,startX,startY,handle=$parse($attrs.slidesDrag);$stage.getStage();$element.on("mousedown",function(event){$stage.fixScale(event),0==event.button&&(x=startX=event.clientX,y=startY=event.clientY,handleEvent(event,0),$($document).on("mousemove.move",function(event){if($stage.fixScale(event),0!=event.button)return $document.off(".move"),void handleEvent(event,-1);handleEvent(event,1),x=event.clientX,y=event.clientY,event.preventDefault(),event.stopPropagation()}).on("mouseup.move",function(event){$stage.fixScale(event),$($document).off(".move"),handleEvent(event,2),event.preventDefault(),event.stopPropagation()}).on("keydown.move",function(event){$stage.fixScale(event),27==event.keyCode&&($($document).off(".move"),handleEvent(event,-1),event.preventDefault(),event.stopPropagation())}),event.preventDefault(),event.stopPropagation())})}}}]),module.directive("slidesPagination",[function(){return{restrict:"EA",replace:!0,template:'<div class="slides-pagination"><div class="_summary"><span>共 {{totalSize}} 条数据，每页显示 <select ng-model="size" ng-change="changeSize()" ng-options="value for value in sizeEnum"></select> 条</span></div><div class="_nav"><a href="javascript:void(0)" class="_previous" ng-class="{_disabled:!hasPreviousPage}" ng-click="previousPage()"></a><a href="javascript:void(0)" ng-class="{_on:page==1}" ng-click="gotoPage(1)">1</a><span class="_omission" ng-show="hasPreviousOmit">...</span><a href="javascript:void(0)" ng-repeat="p in pages" ng-class="{_on:page==p}" ng-click="gotoPage(p)">{{p}}</a><span class="_omission" ng-show="hasNextOmit">...</span><a href="javascript:void(0)" ng-class="{_on:page==totalPage}" ng-click="gotoPage(totalPage)" ng-show="totalPage>1">{{totalPage}}</a><a href="javascript:void(0)" class="_next" ng-class="{_disabled:!hasNextPage}" ng-click="nextPage()"></a></div></div>',scope:{pagination:"=slidesPagination",onChange:"&"},link:function($scope,$element,$attrs){function fireChange(){$scope.onChange({pagination:$scope.pagination})}$scope.pagination||($scope.pagination={page:1,size:20,totalSize:0}),$scope.changeSize=function(){$scope.pagination.size=$scope.size,fireChange()},$scope.$watchGroup(["pagination.page","pagination.size","pagination.totalSize"],function(newValues){$scope.page=Math.max(1,newValues[0]||1),$scope.size=Math.max(1,newValues[1]||20),$scope.totalSize=Math.max(0,newValues[2]||0),$scope.totalPage=Math.ceil($scope.totalSize/$scope.size),$scope.hasPreviousPage=$scope.page>1,$scope.hasNextPage=$scope.page<$scope.totalPage,$scope.pages=[];for(var i=Math.max(2,$scope.page-3),j=Math.min($scope.totalPage-1,$scope.page+3);i<=j;i++)$scope.pages.push(i);$scope.hasPreviousOmit=0!=$scope.pages.length&&$scope.pages[0]>2,$scope.hasNextOmit=0!=$scope.pages.length&&$scope.pages[$scope.pages.length-1]<$scope.totalPage-1;for(var step=5,i=step;i<10;i++)if($scope.size%i==0){step=i;break}$scope.sizeEnum=[];for(var i=1;i<10;i++)$scope.sizeEnum.push(i*step)}),$scope.previousPage=function(){if(!$scope.hasPreviousPage)return!1;$scope.pagination.page--,fireChange()},$scope.nextPage=function(){if(!$scope.hasNextPage)return!1;$scope.pagination.page++,fireChange()},$scope.gotoPage=function(page){if(page<1||page>$scope.totalPage)return!1;$scope.pagination.page=page,fireChange()}}}}]),module.directive("slidesPaginationSimple",[function(){return{restrict:"EA",replace:!0,template:'<div class="slides-pagination-simple"><a href="javascript:void(0)" class="_previous" ng-class="{_disabled:!hasPreviousPage}" ng-click="previousPage()"></a><a href="javascript:void(0)" class="_on">{{page}}</a><span class="_limit">/</span><a href="javascript:void(0)">{{totalPage}}</a><a href="javascript:void(0)" class="_next" ng-class="{_disabled:!hasNextPage}" ng-click="nextPage()"></a></div>',scope:{pagination:"=slidesPaginationSimple",onChange:"&"},link:function($scope,$element,$attrs){function fireChange(){$scope.onChange({pagination:$scope.pagination})}$scope.pagination||($scope.pagination={page:1,size:20,totalSize:0}),$scope.$watchGroup(["pagination.page","pagination.size","pagination.totalSize"],function(newValues){$scope.page=Math.max(1,newValues[0]||1),$scope.size=Math.max(1,newValues[1]||20),$scope.totalSize=Math.max(0,newValues[2]||0),$scope.totalPage=Math.ceil($scope.totalSize/$scope.size),$scope.hasPreviousPage=$scope.page>1,$scope.hasNextPage=$scope.page<$scope.totalPage}),$scope.previousPage=function(){if(!$scope.hasPreviousPage)return!1;$scope.pagination.page--,fireChange()},$scope.nextPage=function(){if(!$scope.hasNextPage)return!1;$scope.pagination.page++,fireChange()}}}}]),module.directive("slidesPaginationTransclude",["$parse",function($parse){return{restrict:"EA",priority:500,scope:!0,link:function($scope,$element,$attrs){function fireChange(){onChange&&onChange($scope.$parent,{pagination:$scope.pagination})}$scope.pagination=$attrs.slidesPaginationTransclude?$parse($attrs.slidesPaginationTransclude)($scope.$parent):null,$scope.pagination||($scope.pagination={page:1,size:20,totalSize:0});var onChange=$attrs.onChange?$parse($attrs.onChange):null;$scope.$watchGroup(["pagination.page","pagination.size","pagination.totalSize"],function(newValues){$scope.page=Math.max(1,newValues[0]||1),$scope.size=Math.max(1,newValues[1]||20),$scope.totalSize=Math.max(0,newValues[2]||0),$scope.totalPage=Math.ceil($scope.totalSize/$scope.size),$scope.hasPreviousPage=$scope.page>1,$scope.hasNextPage=$scope.page<$scope.totalPage,$scope.pages=[];for(var i=Math.max(2,$scope.page-2),j=Math.min($scope.totalPage-1,$scope.page+2);i<=j;i++)$scope.pages.push(i);$scope.hasPreviousOmit=0!=$scope.pages.length&&$scope.pages[0]>2,$scope.hasNextOmit=0!=$scope.pages.length&&$scope.pages[$scope.pages.length-1]<$scope.totalPage-1,$scope.inputPage=$scope.page}),$scope.previousPage=function(){if(!$scope.hasPreviousPage)return!1;$scope.pagination.page--,fireChange()},$scope.nextPage=function(){if(!$scope.hasNextPage)return!1;$scope.pagination.page++,fireChange()},$scope.gotoPage=function(page){if(page<1||page>$scope.totalPage)return!1;$scope.pagination.page=page,fireChange()},$scope.gotoInputPage=function(){var page=parseInt($scope.inputPage);if(isNaN(page)||page<1||page>$scope.totalPage)return void($scope.inputPage=$scope.page);$scope.gotoPage(page)}}}}]),module.directive("slidesUpload",["$parse","$timeout","$q",function($parse,$timeout,$q){return{restrict:"A",controller:["$scope",function($scope){this.setConfig=function(config){this.config=config}}],require:"slidesUpload",link:function($scope,$element,$attrs,ctrl){function nextUpload(){uploader.stop();var file=uploader.files[uploader.total.uploaded+uploader.total.failed];if(file){var item=fileItemMapping[file.id];(item&&item.promise||$q.when()).then(function(){if(angular.isFunction(item.writer)){var p=item.writer(item,file.getNative());p&&angular.isFunction(p.then)||(p=$q.when(p)),p.then(function(data){uploader.removeFile(item.fileId),fileUploaded(file,{response:data})},function(err){uploader.removeFile(item.fileId),error({file:file,message:err})})}else $timeout(function(){uploader.start()})},function(errorMessage){item.remove(),item.status=4,item.errorMessage=errorMessage,nextUpload()})}}function filesAdded(files){$scope.$applyAsync(function(){for(var i=0;i<files.length;i++){var file=files[i],item={progress:0,size:0,fileName:file.name,fullsize:file.size,fileId:file.id,status:0,remove:function(){uploader.removeFile(this.fileId),onRemove($scope,{item:this}),angular.isFunction(onRemoveFn)&&onRemoveFn(this),delete fileItemMapping[this.fileId]}};$scope.items.push(item),onAdded($scope,{item:item}),angular.isFunction(onAddedFn)&&onAddedFn(item),fileItemMapping[file.id]=item}uploader.state!=plupload.STARTED&&nextUpload()})}function beforeUpload(file){var item=fileItemMapping[file.id];if(item&&item.options)for(var key in item.options)uploader.setOption(key,item.options[key])}function uploadProgress(file){$scope.$applyAsync(function(){var item=fileItemMapping[file.id];item?(item.status=1,item.progress=file.percent,item.size=file.loaded,onProgress($scope,{item:item}),angular.isFunction(onProgressFn)&&onProgressFn(item)):prompter.error(file.name+" : 失败")})}function fileUploaded(file,data){nextUpload(),$scope.$applyAsync(function(){var item=fileItemMapping[file.id];if(item)try{var response=angular.isString(data.response)?angular.fromJson(data.response):data.response;item.status=2,item.response=response,onUploaded($scope,{item:item}),angular.isFunction(onUploadedFn)&&onUploadedFn(item),delete fileItemMapping[file.id]}catch(e){item.error=!0,item.status=4,item.errorMessage="上传失败",onError($scope,{item:item}),angular.isFunction(onErrorFn)&&onErrorFn(item);for(var i=0;i<$scope.items.length;i++)if(item==$scope.items[i]){$scope.items.splice(i,1);break}delete fileItemMapping[file.id]}else prompter.error(file.name+" : 失败")})}function error(err){$scope.$applyAsync(function(){var item=fileItemMapping[err.file.id];if(item){item.error=!0,item.status=4;var message=err.message;err.response&&err.response.match(/^.*"message":"([^"]+)".*$/gi)&&(message=err.response.replace(/^.*"message":"([^"]+)".*$/gi,"$1")),item.errorMessage=message,onError($scope,{item:item}),angular.isFunction(onErrorFn)&&onErrorFn(item),delete fileItemMapping[err.file.id]}else{var message=err.message;-600==err.code&&(message+=uploader.settings.filters.max_file_size),prompter.message(err.file.name+" : "+message)}})}function init(){var uploadConfig=angular.extend({runtimes:"html5",browse_button:$element[0],url:"#",container:$element.parent()[0],init:{PostInit:function(up){},FilesAdded:function(up,files){filesAdded(files)},BeforeUpload:function(up,file){beforeUpload(file)},UploadProgress:function(up,file){uploadProgress(file)},FileUploaded:function(up,file,data){fileUploaded(file,data)},Error:function(up,err){error(err)}}},config);uploader=new plupload.Uploader(uploadConfig),uploader.init(),$timeout(function(){$scope.$watch(function(){var disabled=$attrs.disabled;return angular.isDefined(disabled)&&"false"!==disabled&&!1!==disabled},function(b){$element.parent().find(".moxie-shim > input").prop("disabled",!0===b)})})}$scope.items=[];var uploader,onAdded=$parse($attrs.onAdded),onProgress=$parse($attrs.onProgress),onUploaded=$parse($attrs.onUploaded),onError=$parse($attrs.onError),onRemove=$parse($attrs.onRemove),fileItemMapping={},config=angular.extend({},$scope.$eval($attrs.slidesUpload));angular.extend(config,ctrl.config);var onAddedFn=config.onAdded,onProgressFn=config.onProgress,onUploadedFn=config.onUploaded,onErrorFn=config.onError,onRemoveFn=config.onRemove;delete config.onAdded,delete config.onProgress,delete config.onUploaded,delete config.onError,delete config.onRemove,delete config.init,delete config.browse_button,delete config.container,delete config.init,delete config.runtimes,$timeout(init)}}}]),CKEDITOR.config.extraAllowedContent="textentryinteraction[*];video[*];audio[*];span{*}[*];div[*]{*}; p span[*];p{*}",CKEDITOR.config.extraPlugins="insertpre,background,sharedspace,image2,video,audio,textEntryInteraction,mathjax,clearfloat,linebreakbefore,linebreakafter,jme,confighelper",CKEDITOR.config.disallowedContent="pre",CKEDITOR.disableAutoInline=!0,CKEDITOR.config.sharedSpaces={top:"topSpace",bottom:"bottomSpace"},CKEDITOR.config.toolbar=[["Source","Cut","Copy","Paste","PasteText","PasteFromWord","-","Undo","Redo"],["Find","Replace","-","SelectAll","SpellChecker"],["Link","Unlink","Anchor"],["Image","video","audio","Table","HorizontalRule","Smiley","SpecialChar","PageBreak","Mathjax","clearFloat","Simplebox","InsertPre"],"/",["Bold","Italic","Subscript","Superscript","Strike","TextShadow","-","RemoveFormat","Underline","Background"],["NumberedList","BulletedList","-","Outdent","Indent","-","JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock","linebreakbefore","linebreakafter"],["Styles","Format","Font","FontSize"],["TextColor","BGColor"]];var disallowRules={image:/<\s*img/i,video:/<\s*video/i,audio:/<\s*audio/i,table:/<\s*table/i};module.factory("$htmlEditorFactory",["$timeout",function($timeout){function HtmlEditor(ckeditor){this.ckeditor=ckeditor,this.styleStates={},this.commandStates={},this.styleValues={}}function checkEditorSelection(ckeditor){try{var selection=ckeditor.getSelection();if(selection&&selection.getType()==CKEDITOR.SELECTION_TEXT){var startElement=selection.getStartElement();if(startElement){var selectText=selection.getSelectedText()||"",elementText=startElement.getText()||"";selectText.trim()==elementText.trim()&&ckeditor.getSelection().selectElement(startElement)}}}catch(ex){}}function applyStyle(ckeditor,style){checkEditorSelection(ckeditor),ckeditor.applyStyle(style),ckeditor.fire("change")}return HtmlEditor.prototype.commands={image:function(options){options=angular.extend({width:200},options);var html='<img src="'+options.src+'" width="'+options.width+'px"/>';this.ckeditor.insertHtml(html)},video:function(options){options=angular.extend({width:200,height:150,poster:CKEDITOR.basePath+"plugins/video/images/placeholder.png"},options);var mediaNode=CKEDITOR.dom.element.createFromHtml("<cke:video></cke:video>",this.ckeditor.document);mediaNode.setAttributes({controls:"controls"}),mediaNode.setAttribute("poster",options.poster),mediaNode.setAttribute("width",options.width),mediaNode.setAttribute("height",options.height),mediaNode.setAttribute("src",options.src),mediaNode.setAttribute("preload","none"),mediaNode.setHtml("");var newFakeImage=this.ckeditor.createFakeElement(mediaNode,"cke_video","video",!1);newFakeImage.setStyles({backgroundImage:"url("+options.poster+")",width:options.width+"px",height:options.height+"px"}),newFakeImage.setAttribute("title",options.filename);var div=new CKEDITOR.dom.element("div",this.ckeditor.document);div.append(newFakeImage);try{this.ckeditor.insertElement(div)}catch(e){}},audio:function(options){options=angular.extend({width:200,height:150,poster:CKEDITOR.basePath+"plugins/audio/images/placeholder.png"},options);var mediaNode=CKEDITOR.dom.element.createFromHtml("<cke:audio></cke:audio>",this.ckeditor.document);mediaNode.setAttributes({controls:"controls"}),mediaNode.setAttribute("poster",options.poster),mediaNode.setAttribute("width",options.width),mediaNode.setAttribute("height",options.height),mediaNode.setAttribute("src",options.src),mediaNode.setAttribute("preload","none"),mediaNode.setHtml("");var newFakeImage=this.ckeditor.createFakeElement(mediaNode,"cke_audio","audio",!1);newFakeImage.setStyles({backgroundImage:"url('"+options.poster+"')",width:options.width+"px",height:options.height+"px"}),newFakeImage.setAttribute("title",options.filename);var div=new CKEDITOR.dom.element("div",this.ckeditor.document);div.append(newFakeImage);try{this.ckeditor.insertElement(div)}catch(e){}},table:function(options){options=angular.extend({row:3,col:3},options);for(var html='<table border="1" cellspacing="1" cellpadding="1" style="width:100%;"><tbody>',i=0;i<options.row;i++){html+="<tr>";for(var j=0;j<options.col;j++)html+="<td><br></td>";html+="</tr>"}html+="</tbody></table>",this.ckeditor.insertHtml(html)},fontfamily:function(value){var style=new CKEDITOR.style(CKEDITOR.config.font_forestyle,{family:value});applyStyle(this.ckeditor,style)},fontsize:function(value){var style=new CKEDITOR.style({element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]},{size:value+"px"});applyStyle(this.ckeditor,style)},specialchar:function(value){var html="<span>"+value+"</span>";this.ckeditor.insertHtml(html)},color:function(value){var style=new CKEDITOR.style(CKEDITOR.config.colorButton_foreStyle,{color:value});applyStyle(this.ckeditor,style)},backgroundcolor:function(value){var style=new CKEDITOR.style(CKEDITOR.config.colorButton_backStyle,{color:value});applyStyle(this.ckeditor,style)},shadow:function(){var style=new CKEDITOR.style({element:"span",styles:{"text-shadow":"3px 3px 3px #000000"}});style.checkActive(this.ckeditor.elementPath(),this.ckeditor)?(this.ckeditor.removeStyle(style),this.ckeditor.fire("change")):applyStyle(this.ckeditor,style)}},HtmlEditor.prototype.execCommand=function(commandName,params){if(this.getCommandState(commandName)){var fn=this.commands[commandName];fn?fn.call(this,params):(checkEditorSelection(this.ckeditor),this.ckeditor.execCommand(commandName))}},HtmlEditor.prototype.getCommandState=function(commandName){return!1!==this.commandStates[commandName]},HtmlEditor.prototype.setCommandState=function(commandName,state){var commandStates;angular.isString(commandName)?(commandStates={},commandStates[commandName]=state):commandStates=commandName||{},this.commandStates=commandStates},HtmlEditor.prototype.getStyleState=function(styleName){if(0==styleName.indexOf("justify")){var align="left",styleValue=this.getStyleValue("textalign");return styleValue&&styleValue[0]&&(align=styleValue[0]),"justify"==align&&(align="block"),styleName.substring("justify".length)==align?1:0}return this.styleStates[styleName]||0},HtmlEditor.prototype.setStyleState=function(styleName,state){this.styleStates[styleName]=state},HtmlEditor.prototype.getStyleValue=function(styleName){return this.styleValues[styleName]},HtmlEditor.prototype.setStyleValue=function(styleName,value){this.styleValues[styleName]=value},function(ckeditor){return new HtmlEditor(ckeditor)}}]),module.directive("slidesHtmlEditor",["$htmlEditorFactory","$timeout","$parse",function($htmlEditorFactory,$timeout,$parse){return{restrict:"AE",require:"?ngModel",scope:{onEditorCreated:"&",disableCommand:"@",disallowedContent:"@?",maxLength:"@?",onMouseDown:"&"},link:function($scope,$element,$attr,ngModel){function setEditorValue(){var value=ngModel.$viewValue||ngModel.$modelValue||"";setData(value)}function getEditorData(){var data;try{data=ckeditor.getData()}catch(e){data=ckeditor.getData()}return data||""}function setModelValue(){var data=getEditorData();data!=ngModel.$viewValue&&ngModel.$setViewValue(data)}function textLength(){for(var text=ckeditor.element.getText().replace(/(^\s*)|(\s*$)/g,""),len=0,i=0;i<text.length;i++)8203!=text.charCodeAt(i)&&len++;return len}$scope.maxLength&&($scope.maxLength=parseInt($scope.maxLength));var config={};config.language=i18n.language,config.removePlugins="tabletools,contextmenu,liststyle",$attr.pasteType&&(config.pasteFilter=$attr.pasteType);var ckeditor=CKEDITOR.inline($element[0],config),htmlEditor=$htmlEditorFactory(ckeditor);$attr.slidesHtmlEditor&&$parse($attr.slidesHtmlEditor).assign($scope.$parent,htmlEditor),"true"==$attr.oneline&&(ckeditor.on("key",function(evt){13==evt.data.keyCode&&evt.cancel()}),ckeditor.on("paste",function(evt){var value=$("<div></div>").html(evt.data.dataValue).text();evt.data.dataValue=value,evt.data.type="text"})),$scope.$watch("disableCommand",function(value){var commandStates={flash:!1};if(value)for(var commandNames=value.split(","),i=0;i<commandNames.length;i++)commandStates[commandNames[i]]=!1;htmlEditor.setCommandState(commandStates)}),$element.addClass("slides-html-editor"),ckeditor.on("focus",function(){$scope.$emit("htmlEditorFocus",htmlEditor),$($element).parents(".html-editor-scope").trigger("htmlEditorFocus",[htmlEditor])}),ckeditor.on("blur",function(){$scope.$emit("htmlEditorBlur",htmlEditor),$($element).parents(".html-editor-scope").trigger("htmlEditorBlur",[htmlEditor])});var styles={bold:CKEDITOR.config.coreStyles_bold,italic:CKEDITOR.config.coreStyles_italic,subscript:CKEDITOR.config.coreStyles_subscript,superscript:CKEDITOR.config.coreStyles_superscript,underline:CKEDITOR.config.coreStyles_underline,strike:CKEDITOR.config.coreStyles_strike,fontfamily:CKEDITOR.config.font_style,fontsize:CKEDITOR.config.fontSize_style,shadow:{element:"span",styles:{"text-shadow":"3px 3px 3px #000000"}},numberedlist:{element:"ol"},bulletedlist:{element:"ul"}};for(var styleName in styles)ckeditor.attachStyleStateChange(new CKEDITOR.style(styles[styleName]),angular.bind(null,function(styleName,state){htmlEditor.getStyleState(styleName)!=state&&("$apply"!=$scope.$root.$$phase&&"$digest"!=$scope.$root.$$phase?$scope.$apply(function(){htmlEditor.setStyleState(styleName,1==state?1:0)}):htmlEditor.setStyleState(styleName,1==state?1:0))},styleName));var styleNames={fontsize:"font-size",fontfamily:"font-family",color:"color",backgroundcolor:"background-color",textalign:"text-align"};if(ckeditor.on("selectionChange",function(ev){var elementPath=ev.data.path,elements=elementPath.elements;for(var styleName in styleNames){for(var element,values=[],i=0;i<elements.length;i++){element=elements[i];var value=element.getComputedStyle(styleNames[styleName]);values.push(value)}"$apply"!=$scope.$root.$$phase&&"$digest"!=$scope.$root.$$phase?$scope.$apply(function(){htmlEditor.setStyleValue(styleName,values)}):htmlEditor.setStyleValue(styleName,values)}}),$scope.onMouseDown&&ckeditor.on("focus",function(ev){$scope.onMouseDown()}),ngModel){var setData=function(data){if(""==data){if(""==getData())return}try{ckeditor.setData(data)}catch(e){ckeditor.setData(data)}},getData=function(){try{return ckeditor.getData()}catch(e){return ckeditor.getData()}};if(ckeditor.on("instanceReady",function(event){setEditorValue(),$scope.onEditorCreated({editor:htmlEditor}),$scope.$emit("htmlEditorCreator",htmlEditor)}),ckeditor.on("change",function(){ckeditor.checkDirty()&&("$apply"!=$scope.$root.$$phase&&"$digest"!=$scope.$root.$$phase?$scope.$apply(setModelValue):setModelValue())}),ckeditor.on("keydown",function(obj){if(8===obj.data.keyCode||46===obj.data.keyCode)return!0}),ckeditor.on("paste",function(evt){if($scope.disallowedContent=$scope.disallowedContent||"image,video,audio,table",void 0!==$scope.disallowedContent){var value=evt.data.dataValue;disallow($scope.disallowedContent,value)&&evt.cancel();try{var json=JSON.parse(value);json&&"copymodule"==json.type&&evt.cancel()}catch(ex){}}}),ngModel.$render=function(){setEditorValue()},ngModel.$isEmpty=function(value){return!(!angular.isUndefined(value)&&""!==value&&null!==value&&value===value)||("<p></p>"==(value=value.replace(/(&nbsp;)|\s|(<div class=\"background_image\"[^>]*>)/g,""))||"<p></p></div>"==value||"</div>"==value)},$attr.textMaxlength){var maxlength=parseInt($attr.textMaxlength),maxLengthValidator=function(value){return!isNaN(maxlength)&&!ngModel.$isEmpty(value)&&textLength()>maxlength?void ngModel.$setValidity("maxlength",!1):(ngModel.$setValidity("maxlength",!0),value)};ngModel.$parsers.push(maxLengthValidator),ngModel.$formatters.push(maxLengthValidator)}}}}}]),module.directive("slidesViewer",[function(){return{restrict:"EA",replace:!0,template:'<div class="slides-viewer"><div class="_screen">   <span class="_previous" ng-click="previous()" ng-class="{\'_disabled\':index<1}"></span>   <div class="_media _image"><img ng-src="{{currentItem.href}}"/></div>   <span class="_next" ng-click="next()" ng-class="{\'_disabled\':index>items.length-2}"></span></div><div class="_navigator"><div class="_bar">   <span class="_previous" ng-click="previous()" ng-class="{\'_disabled\':index<1}"></span>   <ul>       <li ng-repeat="item in navigatorItems" ng-class="{\'_selected\':item==currentItem}" ng-click="select(item)">           <div class="_thumb"><p><img ng-src="{{item.thumbHref}}" alt="无预览图"/></p></div>           <p class="_title"><span ng-bind="item.title"></span></p>       </li>   </ul>   <span class="_next" ng-click="next()" ng-class="{\'_disabled\':index>items.length-2}"></span></div></div></div>',scope:{items:"=slidesViewer",selectedIndex:"@",dataReader:"&"},link:function($scope,$element,$attrs){function readerItem(item){return $scope.dataReader({item:item})||item}function reset(){var ulWidth=$element.find("._navigator > ._bar > ul").width(),count=Math.floor(ulWidth/196)
;startIndex=Math.max(0,$scope.index-Math.floor(count/2)),endIndex=startIndex+count,$scope.navigatorItems.length=0;for(var i=startIndex;i<endIndex&&$scope.items&&i<$scope.items.length;i++){var item=readerItem($scope.items[i]);$scope.navigatorItems.push(item),i==$scope.index&&($scope.currentItem=item)}}$scope.navigatorItems=[],$scope.currentItem=null,$scope.index=parseInt($scope.selectedIndex)||0;var startIndex=0,endIndex=0;$scope.$watch("items",reset),$scope.select=function(item){for(var i=0;i<$scope.items.length;i++)if(item==$scope.items[i]){$scope.index=i,reset();break}},$scope.next=function(){$scope.index>$scope.items.length-2||($scope.index++,reset())},$scope.previous=function(){$scope.index<1||($scope.index--,reset())}}}}])});