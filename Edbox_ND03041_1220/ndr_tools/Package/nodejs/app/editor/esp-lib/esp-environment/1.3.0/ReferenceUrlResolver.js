define(["jquery","espEnvironment/../UrlHelper"],function($,UrlHelper){function Resolver(rootPath,relativeRootPath,relativePath,rootPathAlias){this._rootPath=UrlHelper.cleanPathLimit(UrlHelper.cleanSearch(rootPath),!1,!0),this._rootPathAlias=UrlHelper.cleanPathLimit(UrlHelper.cleanSearch(rootPathAlias),!1,!0),this._relativeRootPath=UrlHelper.cleanPathLimit(UrlHelper.cleanSearch(relativeRootPath),!1,!0),this._relativePath=UrlHelper.cleanPathLimit(UrlHelper.cleanSearch(relativePath),!0,!0),this._relativeFullPath=this._relativeRootPath+"/"+this._relativePath,this._relativePathLevel=this._relativePath?this._relativePath.split("/").length:0,this._config={rootPath:this._rootPath,rootPathAlias:this._rootPathAlias,relativeRootPath:this._relativeRootPath,relativePath:this._relativePath,relativeFullPath:this._relativeFullPath,relativePathLevel:this._relativePathLevel},this._customResolvers=[]}function _formatRoot(absoluteUrl){var result;return this._rootPath&&0===absoluteUrl.indexOf(this._rootPath)?result=SYMBOL_REF_PATH+absoluteUrl.substring(this._rootPath.length):this._rootPathAlias&&0===absoluteUrl.indexOf(this._rootPathAlias)&&(result=SYMBOL_REF_PATH+absoluteUrl.substring(this._rootPathAlias.length)),result}function _formatRelative(absoluteUrl){var result;if(this._relativeFullPath&&0===absoluteUrl.indexOf(this._relativeFullPath))result=SYMBOL_REF_RELATIVE+absoluteUrl.substring(this._relativeFullPath.length);else if(this._relativeRootPath&&0===absoluteUrl.indexOf(this._relativeRootPath)){result=SYMBOL_REF_RELATIVE;for(var i=0;i<this._relativePathLevel;i++)result+="/..";result+=absoluteUrl.substring(this._relativeRootPath.length)}return result}function htmlEncode(html){var temp=document.createElement("div");null!=temp.textContent?temp.textContent=html:temp.innerText=html;var output=temp.innerHTML;return temp=null,output}function htmlDecode(text){var temp=document.createElement("div");temp.innerHTML=text;var output=temp.innerText||temp.textContent;return temp=null,output}var SYMBOL_REF_PATH="${ref-path}",SYMBOL_REF_RELATIVE="${ref-base}";return Resolver.prototype.format=function(absoluteUrl){if(!absoluteUrl||"string"!=typeof absoluteUrl)return absoluteUrl;var _this=this;$.each(this._customResolvers,function(i,cr){var t=$.isFunction(cr.format)&&cr.format(absoluteUrl,_this._config);if("string"==typeof t)return absoluteUrl=t,!1});var result,relativeFirst=!1;return this._relativeRootPath&&this._rootPath&&this._relativeRootPath.length>this._rootPath.length&&(relativeFirst=!0),$.each(relativeFirst?[_formatRelative,_formatRoot]:[_formatRoot,_formatRelative],$.proxy(function(i,fn){if(result=fn.apply(this,[absoluteUrl]))return!1},this)),result||absoluteUrl},Resolver.prototype.parse=function(referenceUrl){if(!referenceUrl||"string"!=typeof referenceUrl)return referenceUrl;return 0===referenceUrl.indexOf(SYMBOL_REF_RELATIVE)?UrlHelper.fixPath(this._relativeFullPath+referenceUrl.substring(SYMBOL_REF_RELATIVE.length)):0===referenceUrl.indexOf(SYMBOL_REF_PATH)?this._rootPath+referenceUrl.substring(SYMBOL_REF_PATH.length):referenceUrl},Resolver.prototype.parseHtml=function(html){if(!html)return html;var _this=this;return html=html.replace(/(<(img|video|audio) [^>]*src=['"])([^'"]+)([^>]*>)/gim,function(match,$1,$2,$3,$4){return $1+_this.parse($3)+$4}),html=html.replace(/(<(img|video|audio) [^>]*poster=['"])([^'"]+)([^>]*>)/gim,function(match,$1,$2,$3,$4){return $1+_this.parse($3)+$4})},Resolver.prototype.formatHtml=function(html){if(!html)return html;var _this=this;return html=html.replace(/(<(img|video|audio) [^>]*src=['"])([^'"]+)([^>]*>)/gim,function(match,$1,$2,$3,$4){return $1+htmlEncode(_this.format(htmlDecode($3)))+$4}),html=html.replace(/(<(img|video|audio) [^>]*poster=['"])([^'"]+)([^>]*>)/gim,function(match,$1,$2,$3,$4){return $1+htmlEncode(_this.format(htmlDecode($3)))+$4})},Resolver.prototype.test=function(url){if(!url)return!1;var customMatch=!1;return $.each(this._customResolvers,function(i,cr){if($.isFunction(cr.test)&&cr.test(url))return customMatch=!0,!1}),!!customMatch||(this._relativeFullPath&&0===url.indexOf(this._relativeFullPath)||this._relativeRootPath&&0===url.indexOf(this._relativeRootPath)||this._rootPath&&0===url.indexOf(this._rootPath)||this._rootPathAlias&&0===url.indexOf(this._rootPathAlias)||0===url.indexOf(SYMBOL_REF_RELATIVE)||0===url.indexOf(SYMBOL_REF_PATH))},Resolver.prototype.addCustomResolver=function(r){if($.isArray(r)){var _this=this;$.each(r,function(i,cr){_this._customResolvers.push(cr)})}else this._customResolvers.push(cr)},function(rootPath,relativeRootPath,relativePath,rootPathAlias){return new Resolver(rootPath,relativeRootPath,relativePath,rootPathAlias)}});