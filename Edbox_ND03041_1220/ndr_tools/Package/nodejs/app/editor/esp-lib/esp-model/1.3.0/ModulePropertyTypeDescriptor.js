define(["jquery","espEnvironment","espService","exception","i18n!"],function($,espEnvironment,espService,Exception,i18n){function Descriptor(options){if("string"==typeof options){var descriptor=descriptors[options];if(!descriptor)throw"no descriptor with: "+options;return descriptor}this._options=$.extend({},options)}function htmlEncode(html){var temp=document.createElement("div");null!=temp.textContent?temp.textContent=html:temp.innerText=html;var output=temp.innerHTML;return temp=null,output}function htmlDecode(text){var temp=document.createElement("div");temp.innerHTML=text;var output=temp.innerText||temp.textContent;return temp=null,output}function resolveJsonValue(obj,fn){var result;if("string"==typeof obj)result=fn(obj);else if($.isArray(obj)){result=[];for(var i=0;i<obj.length;i++)result[i]=resolveJsonValue(obj[i],fn)}else if($.isPlainObject(obj)){result={};for(var key in obj)result[key]=resolveJsonValue(obj[key],fn)}else result=obj;return result}var descriptors={};return Descriptor.prototype.read=function(element,referenceUrlResolver){return this._options.read?this._options.read(element,referenceUrlResolver):null},Descriptor.prototype.write=function(element,value,referenceUrlResolver,resourceRegister){var validateResult=this.validate(value);if(!0!==validateResult)throw validateResult;this._options.write&&this._options.write(element,value,referenceUrlResolver,resourceRegister)},Descriptor.prototype.validate=function(value){return null===value||void 0===value||(!this._options.validate||this._options.validate(value))},Descriptor.define=function(type,descriptor){descriptors[type]=new Descriptor(descriptor)},Descriptor.define("string",{read:function(element,referenceUrlResolver){return $(element).attr("value")},write:function(element,value,referenceUrlResolver,resourceRegister){$(element).attr("value",value||"")},validate:function(value){return"string"==typeof value||i18n.translate("server.error.value.isnot")+"String"}}),Descriptor.define("number",{read:function(element,referenceUrlResolver){return Number($(element).attr("value"))},write:function(element,value,referenceUrlResolver,resourceRegister){$(element).attr("value",value||"")},validate:function(value){return"number"==typeof value||i18n.translate("server.error.value.isnot")+"Number"}}),Descriptor.define("url",{read:function(element,referenceUrlResolver){return referenceUrlResolver.parse($(element).attr("value"))},write:function(element,value,referenceUrlResolver,resourceRegister){var newValue=referenceUrlResolver.format(value);$(element).attr("value",newValue||""),resourceRegister.register(newValue,null,value)},validate:function(value){return"string"==typeof value||i18n.translate("server.error.value.isnotvalid")+" URL"}}),Descriptor.define("boolean",{read:function(element,referenceUrlResolver){return"true"===$(element).attr("value")},write:function(element,value,referenceUrlResolver,resourceRegister){$(element).attr("value",value?"true":"false")},validate:function(value){return"boolean"==typeof value||i18n.translate("server.error.value.isnot")+" Boolean"}}),Descriptor.define("html",{read:function(element,referenceUrlResolver){var html=$(element).text().trim();return html?(html=html.replace(/(<(img|video|audio) [^>]*src=['"])([^'"]+)([^>]*>)/gim,function(match,$1,$2,$3,$4){return $1+referenceUrlResolver.parse($3)+$4}),html=html.replace(/(<(img|video|audio) [^>]*poster=['"])([^'"]+)([^>]*>)/gim,function(match,$1,$2,$3,$4){return $1+referenceUrlResolver.parse($3)+$4})):""},write:function(element,value,referenceUrlResolver,resourceRegister){value&&(value=value.replace(/(<(img|video|audio) [^>]*src=['"])([^'"]+)([^>]*>)/gim,function(match,$1,$2,$3,$4){var url=htmlDecode($3),newValue=referenceUrlResolver.format(url);return resourceRegister.register(newValue,null,url),$1+htmlEncode(newValue)+$4}),value=value.replace(/(<(img|video|audio) [^>]*poster=['"])([^'"]+)([^>]*>)/gim,function(match,$1,$2,$3,$4){var url=htmlDecode($3),newValue=referenceUrlResolver.format(url);return resourceRegister.register(newValue,null,url),$1+htmlEncode(newValue)+$4}));var cdata=element.context.createCDATASection(value||"");$(element).append(cdata)},validate:function(value){return"string"==typeof value||i18n.translate("server.error.value.isnotvalid")+" HTML"}}),Descriptor.define("json",{read:function(element,referenceUrlResolver){var text=$(element).text();if(!text)return null;var value=JSON.parse(text);return value=resolveJsonValue(value,function(text){return referenceUrlResolver.parseHtml(referenceUrlResolver.parse(text))})},write:function(element,value,referenceUrlResolver,resourceRegister){value=resolveJsonValue(value,function(text){var newText=text;return referenceUrlResolver.test(text)?(newText=referenceUrlResolver.format(text),resourceRegister.register(newText,null,text)):newText&&(newText=newText.replace(/(<(img|video|audio) [^>]*src=['"])([^'"]+)([^>]*>)/gim,function(match,$1,$2,$3,$4){var url=htmlDecode($3),newValue=referenceUrlResolver.format(url);return resourceRegister.register(newValue,null,url),$1+htmlEncode(newValue)+$4}),newText=newText.replace(/(<(img|video|audio) [^>]*poster=['"])([^'"]+)([^>]*>)/gim,function(match,$1,$2,$3,$4){var url=htmlDecode($3),newValue=referenceUrlResolver.format(url);return resourceRegister.register(newValue,null,url),$1+htmlEncode(newValue)+$4})),newText});var cdata=element.context.createCDATASection(value?JSON.stringify(value):"");$(element).append(cdata)},validate:function(value){return!(!$.isPlainObject(value)&&!$.isArray(value))||i18n.translate("server.error.value.isnotvalid")+" JSON "+i18n.translate("server.error.value.object")}}),Descriptor.define("list",{read:function(element,referenceUrlResolver){var list=[],itemType=$(element).attr("itemType");return $(element).find(">items>item").each(function(){list.push(Descriptor(itemType).read(this))}),list},write:function(element,value,referenceUrlResolver,resourceRegister){throw"no supported"},validate:function(value){return!!$.isArray(value)||i18n.translate("server.error.value.isnot")}}),Descriptor.define("ref-module",{read:function(element,referenceUrlResolver){return $(element).attr("value")},write:function(element,value,referenceUrlResolver,resourceRegister){$(element).attr("value",value||"")},validate:function(value){return"string"==typeof value||i18n.translate("server.error.value.isnot")}}),function(type){return Descriptor(type)}});