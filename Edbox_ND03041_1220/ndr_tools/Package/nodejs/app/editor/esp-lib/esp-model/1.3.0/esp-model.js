define(["jquery","espEnvironment","espService","espModel/../ModulePropertyTypeDescriptor","exception","i18n!"],function($,espEnvironment,espService,TypeDescriptor,Exception,i18n){function resolveTypeByUrl(url){if(!url)return null;var path=url,sIndex=-1;-1!==(sIndex=url.indexOf("?"))&&(path=url.substring(0,sIndex));var type;for(var key in resourceTypeMapping){for(var matchs=resourceTypeMapping[key],i=0;i<matchs.length;i++){var match=matchs[i];if("string"==typeof match&&path.lastIndexOf("."+match)===path.length-match.length-1||"function"==typeof match.test&&match.test(url)||"function"==typeof match&&!0===match(url,path)){type=key;break}}if(type)break}return type||"file"}function Coursewareobject(id,pages){this._id=id,this._pages=pages||[]}function PageReference(pageId,href,reportable){this._id=pageId,this._href=href,this._reportable=reportable}function Page(id,modules){this._id=id,this._modules=modules||[],this._layout="pixels",this._width="0",this._height="0",this._isReportable=!0,this._scoring="percentage"}function Module(instanceId,moduleId,properties,events,presenters){this._id=instanceId,this._moduleId=moduleId,this._editorId=null,this._presenterId=null,this._properties=properties||[],this._events=events||[],this._presenters=presenters||[],this._visible=!0,this._locked=!1,this._style="",this._position={left:"0",top:"0"},this._size={width:"0",height:"0"},this._rotate=0,this.lazyInit=!1,this._repository=espModel.repository.module(this._moduleId)}function Property(name,type,displayName){this._name=name,this._type=type,this._displayName=displayName}function ModuleDefinition(moduleId,properties,events,presenters){this._moduleId=moduleId,this._properties=properties||[],this._events=events||[],this._presenters=presenters||[]}function parseXML(xml){return"string"==typeof xml?$.parseXML(xml):xml}function formatXML(xml){return(new XMLSerializer).serializeToString(xml)}function ResourceRegister(){this._resources=[]}function CoursewareobjectTemplateRepository(identifier){this._identifier=identifier,this._urlRoot=espEnvironment.url.coursewareobjectTemplateRoot(identifier),this._urlRoot||(this._invalid_=!0)}function CoursewareobjectRepository(identifier){this._identifier=identifier,this._orginalIdentifier=null,this._urlRoot=espEnvironment.url.coursewareobjectRoot(identifier)}function ModuleRepository(moduleId){if(this._moduleId=moduleId,this._urlRoot=espEnvironment.url.moduleEditorRoot(moduleId),moduleId&&!this._urlRoot)throw i18n.translate("server.error.editor.missing")+moduleId}function ModuleEditorRepository(editorId){this._editorId=editorId,this._urlRoot=espEnvironment.url.moduleEditorRoot(editorId),this._urlRoot||(this._invalid_=!0)}var ModelExceptions={GET_MODULE_DEFINITION:new Exception("ESP-MODEL-00001",i18n.translate("server.error.module.undefined")),GET_EDITOR_TEMPLATE_FOR_PAGE:new Exception("ESP-MODEL-00001",i18n.translate("server.error.page.missing")),PARSE_COURSEWAREOBJECT_MAIN:new Exception("ESP-MODEL-00002",i18n.translate("server.error.main.parse")),PARSE_COURSEWAREOBJECT_PAGE:new Exception("ESP-MODEL-00003",i18n.translate("server.error.page.parse")),PARSE_COURSEWAREOBJECT_PAGE_MODULE:new Exception("00003",i18n.translate("server.error.module.parse")),PARSE_MODULE_DEFINITION:new Exception("ESP-MODEL-00003",i18n.translate("server.error.module.definition"))},resourceTypeMapping={image:["jpg","png","gif"],audio:["mp3"],video:["mp4"],flash:["swf"],question:[/\/question\/.+\.pkg\/item\.xml/],ppt:[/\/coursewares\/.+\.pkg\/.+\/Slide\d*\.xml/]};Object.defineProperties(Coursewareobject.prototype,{id:{get:function(){return this._id}},scoreType:{get:function(){return this._scoreType},set:function(val){this._scoreType=val}},pageReferences:{get:function(){return this._pages}}}),Coursewareobject.prototype.getPageReferenceAt=function(index){return this._pages[index]},Coursewareobject.prototype.addPageReference=function(page){return this._pages.push(page),page},Coursewareobject.prototype.removePageReference=function(pageOrId){for(var removedPage=!1,i=0;i<this._pages.length;i++){var page=this._pages[i];if(page==pageOrId||"string"==typeof pageOrId&&page.id==pageOrId){removedPage=page,this._pages.splice(i,1);break}}return removedPage},Object.defineProperties(PageReference.prototype,{id:{get:function(){return this._id}},href:{get:function(){return this._href}},reportable:{get:function(){return this._reportable}}}),Object.defineProperties(Page.prototype,{id:{get:function(){return this._id}},modules:{get:function(){return this._modules}},layout:{get:function(){return this._layout},set:function(val){this._layout=val}},width:{get:function(){return this._width},set:function(val){this._width=val}},height:{get:function(){return this._height},set:function(val){this._height=val}},isReportable:{get:function(){return this._isReportable},set:function(val){this._isReportable=!!val}},scoring:{get:function(){return this._scoring},set:function(val){this._scoring=val}}}),Page.prototype.getModule=function(id){for(var i=0;i<this._modules.length;i++)if(this._modules[i].id==id)return this._modules[i]},Page.prototype.getModuleAt=function(index){return this._modules[index]},Page.prototype.getModuleByPresenterId=function(presenterId,single){for(var modules=[],i=0;i<this._modules.length;i++)this._modules[i].presenterId==presenterId&&modules.push(this._modules[i]);return!0===single?modules[0]:modules},Page.prototype.addModule=function(module){this._modules.push(module)},Page.prototype.removeModule=function(moduleOrId){for(var removedModule=!1,i=0;i<this._modules.length;i++){var module=this._modules[i];if(module==moduleOrId||"string"==typeof moduleOrId&&module.id==moduleOrId){removedModule=module,this._modules.splice(i,1);break}}return removedModule},Object.defineProperties(Module.prototype,{id:{get:function(){return this._id}},moduleId:{get:function(){return this._moduleId}},editorId:{get:function(){return this._editorId},set:function(val){this._editorId=val}},presenterId:{get:function(){return this._presenterId},set:function(val){this._presenterId=val}},presenters:{get:function(){return this._presenters}},position:{get:function(){return $.extend({},this._position)},set:function(val){this._position.top=val&&val.top&&val.top+""||this._position.top,this._position.left=val&&val.left&&val.left+""||this._position.left}},size:{get:function(){return $.extend({},this._size)},set:function(val){this._size.width=val&&val.width&&val.width+""||this._size.width,this._size.height=val&&val.height&&val.height+""||this._size.height}},rotate:{get:function(){return this._rotate},set:function(val){val=parseInt(val),isNaN(val)||(this._rotate=val)}},visible:{get:function(){return this._visible},set:function(val){this._visible=!!val}},locked:{get:function(){return this._locked},set:function(val){this._locked=!!val}},style:{get:function(){return this._style},set:function(val){this._style=val||""}},lazyInit:{get:function(){return this._lazyInit},set:function(val){this._lazyInit=!!val}},properties:{get:function(){return this._properties}},events:{get:function(){return this._events}},repository:{get:function(){return this._repository}},editorRepository:{get:function(){return espModel.repository.moduleEditor(this.editorId)}}}),Module.prototype.getProperty=function(name){for(var i=0;i<this._properties.length;i++){var p=this._properties[i];if(p.name==name)return p}return null},Module.prototype.getPropertyValue=function(name){var property=this.getProperty(name);return property&&property.value},Module.prototype.setPropertyValue=function(name,value,type){var property=this.getProperty(name);if(null==property&&type&&(property=new Property(name,type),this._properties.push(property)),!property)throw"no property for name: "+name+", you must be specify type for the property";property.value=value},Module.prototype.addEvent=function(name,handlers){this._events.push({name:name,handlers:handlers||[]})},Object.defineProperties(Property.prototype,{name:{get:function(){return this._name}},type:{get:function(){return this._type}},displayName:{get:function(){return this._displayName}},value:{get:function(){return this._value},set:function(val){var validateResult=TypeDescriptor(this.type).validate(val);if(!0!==validateResult)throw validateResult;this._value=val}}}),ModuleDefinition.prototype.newModule=function(instanceId){var properties=[],events=[],presenters=this._presenters;return $.each(this._properties,function(i,p){var property=new Property(p.name,p.type,p.displayName);properties.push(property)}),new Module(instanceId,this._moduleId,properties,events,presenters)};var espModel={};ResourceRegister.prototype.register=function(url,type,originalUrl){url&&this._resources.push({url:url,type:type||resolveTypeByUrl(url),originalUrl:originalUrl})},espModel.xmlConverter={toCoursewareobject:function(identifier,xml){try{xml=parseXML(xml);var root=$("coursewareObject",xml);root.length||(root=$("interactiveContent",xml));var pageReferences=[];root.find("pages>page").each(function(i){var pr=new PageReference($(this).attr("id"),$(this).attr("href"),"true"===$(this).attr("reportable"));pageReferences.push(pr)});var coursewareobject=new Coursewareobject(identifier,pageReferences);return coursewareobject.scoreType=root.attr("scoreType"),coursewareobject}catch(e){throw ModelExceptions.PARSE_COURSEWAREOBJECT_MAIN.as(identifier,e)}},fromCoursewareobject:function(coursewareobject){var doc=parseXML('<?xml version="1.0" encoding="UTF-8" ?><interactiveContent></interactiveContent>'),root=$(doc).find("interactiveContent");root.attr({name:"main",scoreType:coursewareobject.scoreType});var pagesEl=root.append("<pages></pages>").children("pages");return $.each(coursewareobject.pageReferences,function(i,page){var pageEl=pagesEl.append("<page></page>").children("page").last();pageEl.attr({id:page.id,name:page.id,href:page.href}),page.reportable&&pageEl.attr("reportable","true")}),formatXML(doc)},toPage:function(pageId,xml,referenceUrlResolver){try{xml=parseXML(xml)}catch(e){throw ModelExceptions.PARSE_COURSEWAREOBJECT_PAGE.as(pageId,e)}var root=$("page",xml),modulePromises=[];return root.find("modules>addonModule").each(function(i){var promise=espModel.repository.module($(this).attr("editorId")).getDefinition().then($.proxy(function(moduleDefinition){try{var el=$(this),module=moduleDefinition.newModule(el.attr("id"));return module.editorId=el.attr("editorId"),module.presenterId=el.attr("addonId"),module.position={left:el.attr("left"),top:el.attr("top")},module.size={width:el.attr("width"),height:el.attr("height")},module.rotate=el.attr("rotate"),module.visible="false"!==el.attr("isVisible"),module.locked="true"===el.attr("isLocked"),module.style=el.attr("style"),module.lazyInit="true"===el.attr("lazy-init"),el.find("properties>property").each(function(){var name=$(this).attr("name"),type=$(this).attr("type");if(!type)throw"no type for property: "+name;var value=TypeDescriptor(type).read(this,referenceUrlResolver);module.setPropertyValue(name,value,type)}),el.find("events>event").each(function(){var name=$(this).attr("name"),handlers=[];$(this).children("handler").each(function(){handlers.push({presenterId:$(this).attr("addonId"),targetId:$(this).attr("targetId"),handlerName:$(this).attr("handlerName")})}),module.addEvent(name,handlers)}),module}catch(e){return ModelExceptions.PARSE_COURSEWAREOBJECT_PAGE_MODULE.reject($(this).attr("id"),e)}},this));modulePromises.push(promise)}),$.when.apply(null,modulePromises).then(function(){for(var modules=[],i=0;i<arguments.length;i++)modules.push(arguments[i]);var page=new Page(pageId,modules);return page.layout=root.attr("layout"),page.width=root.attr("width"),page.height=root.attr("height"),page.isReportable="true"===root.attr("isReportable"),page.scoring=root.attr("scoring"),page},Exception.fail(ModelExceptions.PARSE_COURSEWAREOBJECT_PAGE,pageId))},fromPage:function(page,referenceUrlResolver){var doc=parseXML('<?xml version="1.0" encoding="UTF-8" ?><page></page>'),root=$(doc).find("page");root.attr({name:page.id,layout:"pixels",isReportable:page.isReportable,scoring:page.scoring,width:page.width,height:page.height});var presentersEl=root.append("<addons></addons>").children("addons"),modulesEl=root.append("<modules></modules>").children("modules"),modules=page.modules;return $.each(modules,function(i,module){presentersEl.append("<addon-descriptor></addon-descriptor>").children("addon-descriptor").last().attr("addonId",module.presenterId);var moduleEl=modulesEl.append("<addonModule></addonModule>").children("addonModule").last(),resourceRegister=new ResourceRegister;moduleEl.attr({id:module.id,editorId:module.editorId,addonId:module.presenterId,left:module.position.left,top:module.position.top,width:module.size.width,height:module.size.height,rotate:module.rotate,isVisible:module.visible,isLocked:module.locked,style:module.style,"lazy-init":module.lazyInit});var properties=module.properties;if(properties.length){var propertiesEl=moduleEl.append("<properties></properties>").children("properties");$.each(properties,function(ii,property){var propertyEl=propertiesEl.append("<property></property>").children("property").last();propertyEl.attr({name:property.name,type:property.type}),TypeDescriptor(property.type).write(propertyEl,property.value,referenceUrlResolver,resourceRegister)})}var events=module.events;if(events.length){var eventsEl=moduleEl.append("<events></events>").children("events");$.each(events,function(ii,event){var eventEl=eventsEl.append("<event></event>").children("event").last();eventEl.attr({name:event.name}),$.each(event.handlers,function(iii,handle){eventEl.append("<handler></handler>").children("handler").last().attr({addonId:handle.presenterId,targetId:handle.targetId,handlerName:handle.handlerName})})})}if(resourceRegister._resources.length){var resourcesEl=moduleEl.append("<resources></resources>").children("resources");$.each(resourceRegister._resources,function(ii,resource){resourcesEl.append("<resource></resource>").children("resource").last().attr({type:resource.type,href:resource.url,originalHref:resource.originalUrl})})}}),formatXML(doc)},toModuleDefinition:function(moduleId,xml){try{var root=$("module",parseXML(xml)),properties=[],events=[],presenters=[];return root.find("properties>property").each(function(i){var el=$(this);properties.push({name:el.attr("name"),type:el.attr("type"),displayName:el.attr("displayName")})}),root.find("presenters>presenter").each(function(i){var el=$(this);presenters.push({id:el.attr("id")})}),new ModuleDefinition(moduleId,properties,events,presenters)}catch(e){return ModelExceptions.PARSE_MODULE_DEFINITION.reject(moduleId,e)}}},CoursewareobjectTemplateRepository.prototype.getResourceUrl=function(path,v1,v2,v3){return this._urlRoot(path,v1,v2,v3)},CoursewareobjectTemplateRepository.prototype.getEditorTemplateXmlForPage=function(pageIndex){return $.ajax({type:"GET",url:this._urlRoot("pages/editor.xml"),dataType:"xml"}).then(null,Exception.fail(ModelExceptions.GET_EDITOR_TEMPLATE_FOR_PAGE,pageIndex))},CoursewareobjectTemplateRepository.prototype.getEditorTemplateForPage=function(coursewareobjectId,pageId,pageIndex){return this.getEditorTemplateXmlForPage(pageIndex).then($.proxy(function(xml){try{return espModel.xmlConverter.toPage(pageId,xml,espModel.repository.coursewareobject(coursewareobjectId).getReferenceUrlResolver())}catch(e){return $.Deferred().reject(e)}},this))};CoursewareobjectRepository.prototype.getResourceUrl=function(path,v1,v2,v3){return this._urlRoot(path,v1,v2,v3)},CoursewareobjectRepository.prototype.getResourceWriter=function(path,v1,v2,v3){var filePath=espEnvironment.url.makeRoot()(path,v1,v2,v3);return $.proxy(function(data){return espService.coursewareobject.updateTextResource(this._identifier,filePath,"string"==typeof data?data:"")},this)},CoursewareobjectRepository.prototype.getReferenceUrlResolver=function(){return espEnvironment.createCoursewareobjectReferenceUrlResolver(this._identifier,this._urlRoot(),"pages")},CoursewareobjectRepository.prototype.getAssetUploadUrl=function(){return $.isFunction(espService.coursewareobject.getAssetUploadUrl)?espService.coursewareobject.getAssetUploadUrl(this._identifier):null},CoursewareobjectRepository.prototype.getAssetFileWriter=function(){return $.isFunction(espService.coursewareobject.getAssetFileWriter)?espService.coursewareobject.getAssetFileWriter(this._identifier):null},CoursewareobjectRepository.prototype.getFileWriter=function(){return $.isFunction(espService.coursewareobject.getFileWriter)?espService.coursewareobject.getFileWriter(this._identifier):null},CoursewareobjectRepository.prototype.listAssets=function(params){return espService.coursewareobject.listAssets(this._identifier,params)},CoursewareobjectRepository.prototype.getMainXml=function(){return espService.coursewareobject.getMainXml(this._identifier)},CoursewareobjectRepository.prototype.updateMainXml=function(xml){return espService.coursewareobject.updateMainXml(this._identifier,xml)},CoursewareobjectRepository.prototype.getPageXml=function(pageId){return espService.coursewareobject.getPageXml(this._identifier,pageId)},CoursewareobjectRepository.prototype.updatePageXml=function(pageId,xml){return espService.coursewareobject.updatePageXml(this._identifier,pageId,xml)},CoursewareobjectRepository.prototype.get=function(){return this.getMainXml().then($.proxy(function(xml){try{return espModel.xmlConverter.toCoursewareobject(this._identifier,xml)}catch(e){return $.Deferred().reject(e)}},this))},CoursewareobjectRepository.prototype.update=function(coursewareobject){try{var xml=espModel.xmlConverter.fromCoursewareobject(coursewareobject);return console.log(xml),this.updateMainXml(xml)}catch(e){return $.Deferred().reject(e)}},CoursewareobjectRepository.prototype.getPage=function(pageId){return this.getPageXml(pageId).then($.proxy(function(xml){try{return espModel.xmlConverter.toPage(pageId,xml,this.getReferenceUrlResolver())}catch(e){return $.Deferred().reject(e)}},this))},CoursewareobjectRepository.prototype.updatePage=function(page){try{var xml=espModel.xmlConverter.fromPage(page,this.getReferenceUrlResolver());return this.updatePageXml(page.id,xml)}catch(e){return $.Deferred().reject(e)}},CoursewareobjectRepository.prototype.copyAs=function(newIdentifier){return newIdentifier=newIdentifier&&newIdentifier.replace("{id}",this._orginalIdentifier||this._identifier),this._identifier===newIdentifier?$.when(newIdentifier):espService.coursewareobject.copyAs(this._identifier,newIdentifier).then($.proxy(function(){return this._orginalIdentifier=this._identifier,this._identifier=newIdentifier,this._urlRoot=espEnvironment.url.coursewareobjectRoot(this._identifier),this._identifier},this))},ModuleRepository.prototype.getDefinitionXml=function(){return $.ajax({type:"GET",url:this._urlRoot("module.xml"),dataType:"xml"}).then(null,Exception.fail(ModelExceptions.GET_MODULE_DEFINITION,this._moduleId))},ModuleRepository.prototype.getDefinition=function(){return this._moduleId?$.when(this.getDefinitionXml().then($.proxy(function(xml){try{return espModel.xmlConverter.toModuleDefinition(this._moduleId,xml)}catch(e){return $.Deferred().reject(e)}},this))):$.when(new ModuleDefinition)},ModuleEditorRepository.prototype.getResourceUrl=function(path,v1,v2,v3){return this._urlRoot(path,v1,v2,v3)},ModuleEditorRepository.prototype.getResource=function(path,v1,v2,v3,type){var dataType;return"string"==typeof type?dataType=type:"string"==typeof v3?(dataType=v3,v3=null):"string"==typeof v2?(dataType=v2,v2=v3=null):"string"==typeof v1&&(dataType=v1,v1=v2=v3=null),$.get(this._urlRoot(path,v1,v2,v3),dataType)};var repositories={coursewareobject:{},coursewareobjectTemplate:{},module:{},moduleEditor:{}};return espModel.repository={coursewareobjectTemplate:function(identifier){if(repositories.coursewareobjectTemplate[identifier])return repositories.coursewareobjectTemplate[identifier];var repository=new CoursewareobjectTemplateRepository(identifier);return repository._invalid_?null:repositories.coursewareobjectTemplate[identifier]=repository},coursewareobject:function(identifier){return repositories.coursewareobject[identifier]?repositories.coursewareobject[identifier]:repositories.coursewareobject[identifier]=new CoursewareobjectRepository(identifier)},module:function(moduleId){return repositories.module[moduleId]?repositories.module[moduleId]:repositories.module[moduleId]=new ModuleRepository(moduleId)},moduleEditor:function(editorId){if(repositories.moduleEditor[editorId])return repositories.moduleEditor[editorId];var repository=new ModuleEditorRepository(editorId);return repository._invalid_?null:repositories.moduleEditor[editorId]=repository}},espModel});