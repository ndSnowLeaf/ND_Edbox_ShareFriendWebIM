define(["jquery","jlang","espEnvironment","espSecurity/../esp-security-uc","cryptojs"],function($,jlang,espEnvironment,uc,CryptoJS){function setAuthInfo(a){if(authInfo=a)espEnvironment.encryptedLoginInfo=security.encryptedLoginInfo,document.cookie=authInfoStoreKey+"="+encodeURIComponent(JSON.stringify(authInfo))+";path="+location.href;else{espEnvironment.encryptedLoginInfo=null;var exp=new Date;exp.setTime(exp.getTime()-1),document.cookie=authInfoStoreKey+"=xxx;expires="+exp.toGMTString()}}var authServices={uc:uc},authServiceKey=espEnvironment.security;authServiceKey||(authServiceKey="uc");var authService=authServices[authServiceKey]||authServices.uc;$.isFunction(authService)&&(authService=new authService(espEnvironment.securityConfig||{}));var authInfo,encryptKey="13465c85caab4dfd8b1cb5093131c6d0",security={login:function(username,password){var loginResp,userResp,roleResp,permissionResp;return authService.login(username,password).then(function(response){return loginResp=response,authService.loadUser(loginResp)}).then(function(response){return userResp=response,authService.loadRoles(loginResp)}).then(function(response){return roleResp=response,authService.loadPermissions(loginResp)}).then(function(response){return permissionResp=response,setAuthInfo({loginInfo:loginResp,userInfo:userResp,roleInfo:roleResp,permissionInfo:permissionResp}),setTimeout(function(){em.trigger("login",authInfo)},0),authInfo})},logout:function(){return setAuthInfo(),setTimeout(function(){em.trigger("logout")},0),$.when()},hasPermission:function(p){if(!p)return!0;if(!authInfo||!authInfo.permissionInfo)return!1;for(var i=0;i<authInfo.permissionInfo.length;i++)if(p==authInfo.permissionInfo[i].authority_key)return!0;return!1},get authInfo(){return authInfo},get authenticated(){return!!authInfo},get encryptedLoginInfo(){return authInfo.loginInfo?CryptoJS.TripleDES.encrypt(JSON.stringify(authInfo.loginInfo),encryptKey).toString():null}},em=jlang.EventManager(security,["login","logout"]),authInfoStoreKey="authinfo";try{var a,tokenEncrypt=espEnvironment.location.params.token_info,userEncrypt=espEnvironment.location.params.user_info;if(tokenEncrypt){var userInfo,tokenDecrypt=CryptoJS.TripleDES.decrypt(tokenEncrypt,encryptKey).toString(CryptoJS.enc.Utf8),tokenInfo=$.parseJSON(tokenDecrypt);if(userEncrypt){var userDecrypt=CryptoJS.TripleDES.decrypt(userEncrypt,encryptKey).toString(CryptoJS.enc.Utf8);userInfo=$.parseJSON(userDecrypt)}tokenInfo.adjust_time||(tokenInfo.adjust_time=new Date(tokenInfo.server_time).getTime()-new Date(tokenInfo.local_time).getTime()),a={loginInfo:tokenInfo,userInfo:userInfo,roleInfo:{}}}else for(var cookieArray=(document.cookie||"").split("; "),i=0;i<cookieArray.length;i++){var cookie=cookieArray[i],index=cookie.indexOf("=");if(index>0){var name=decodeURIComponent(cookie.substring(0,index));if(name==authInfoStoreKey){a=JSON.parse(decodeURIComponent(cookie.substring(index+1)));break}}}a&&setAuthInfo(a)}catch(e){console.error(e)}return security});