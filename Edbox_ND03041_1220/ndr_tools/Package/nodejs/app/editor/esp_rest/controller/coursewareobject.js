function formatDate(e){return e.toISOString()}function promise4Replace(e,t){var r=Q.defer();return Q.nfcall(fs.readFile,e,"utf-8").then(function(e){return e=replaceContent(e,t)}).then(function(a){Q.nfcall(fs.writeFile,e,a).then(function(){Q.nfcall(fs.rename,e,replaceContent(e,t)).then(function(){r.resolve()}).fail(function(e){r.reject(e)})}).fail(function(e){r.reject(e)})}).catch(function(e){r.reject(e)}),r.promise}function replaceContent(e,t){var r=e;for(var a in t)for(var n=t[a],i=r.replace("${"+a+"}",n);i!=r;)r=i,i=r.replace("${"+a+"}",n);return r}function doGenerateSdpPackage(e,t,r){return CoursewareObjectContextCreator.getContext(r).then(function(e){for(var r=(e.id,new Manager(e.basepath)),a=(new DOMParser).parseFromString(t),n=xpath.select("/*/pages/page",a),i={version:"v0.1",targets:[{name:"default",adds:[{src:"*"}],groups:[]}]},o={name:"main.xml",adds:[]},c=[],u=[],s=[],l=0;l<n.length;l++)!function(e){var t=n[e].getAttribute("id");s.push(t),u.push(Q.nfcall(fs.readFile,r.pagePath(t),"utf-8"))}(l);return Q.all(u).then(function(t){for(var a=[],n=0;n<t.length;n++){var u=s[n];o.adds.push({type:"file",src:r.relativePagePath(u)});for(var l={name:s[n],adds:[]},f=t[n],p=(new DOMParser).parseFromString(f),h=xpath.select("/*/*/*/resources/resource",p),d=[],m=0;m<h.length;m++)!function(t){var r=h[t].getAttribute("type"),n=h[t].getAttribute("href"),i=h[t].getAttribute("originalHref"),o=espUtil.pack.resourceDependency(r,n,i,e,a);if(o&&l.adds.push(o),-1!=n.indexOf("?")){var c=n.substring(0,n.indexOf("?"));d.push({source:n,target:c})}}(m);if(c.push(l),d.length>0){for(var g=0;g<d.length;g++){var v=d[g];f=replaceAll(f,v.source,v.target)}a.push(Q.nfcall(fs.writeFile,r.pagePath(u),f))}}return c.push(o),i.targets[0].groups=c,Q.all(a).then(function(){return i})}).then(function(e){var t=espUtil.pack.generateSdpPackage(e);return Q.nfcall(fs.writeFile,r.sdpPackagePath(),t).then(function(){console.log("sdp-package-success")})})})}function autoMkdir(e,t){Q.nfcall(fs.stat,e).then(t,function(r){Q.nfcall(fs.mkdir,e,777,t)})}function convertResourceFileInfo(e,t){var r=t.path,a=espUtil.util.pathSlice(r,e.resourceDir),n=Path.basename(a,Path.extname(a)),i=n,o={identifier:n,title:i,tech_info:{href:{format:mime.lookup(a),location:a,size:t.size,requirements:[]}}};return t.width&&o.tech_info.href.requirements.push({type:"QUOTA",name:"resolution",value:t.width?util.format("%s*%s",t.width,t.height):""}),o}var fs=require("fs"),Q=require("q"),uuid=require("node-uuid"),ncp=require("ncp").ncp,DOMParser=require("xmldom").DOMParser,xpath=require("xpath"),util=require("util"),Form=require("multiparty").Form,Path=require("path"),mime=require("mime"),Manager=require("./../support/manager").Manager,TemplateCreator=require("./../support/template"),espUtil=require("./../support/esp-utils").espUtil,fsExtend=require("./../support/fs-ext"),assetSup=require("./../support/asset-sup"),pathVar=require("./../support/path-var").PathVar,FileUtils=require("../support/FileUtils"),dom=require("xmldom").DOMParser,$i18n=require("../support/i18n").i18n,CoursewareObjectContextCreator=require("../support/CoursewareObjectContext"),logError=function(e){e&&e.stack?console.error(e.stack.split("\n")):console.log(e)},ASSET_DIR="assets",fail=function(e,t){if(t)return logError(t),util.isArray(t)?e.status(500).send(t[0]):e.status(500).send(t)},ok=function(e,t,r){return t?"json"===r?e.json(t):void("xml"===r?(e.set("Content-Type","application/xml"),e.send(t)):e.send(t)):e.send()},create=function(e,t){var r=e.body||{},a=uuid.v4(),n=new Manager(a),i=new Template("empty",!0);ncp.limit=1,Q.nfcall(ncp,i.templateDir,n.resourceDir).then(function(){r.identifier=a,Q.nfcall(fs.writeFile,n.metadataJsonPath(),JSON.stringify(r)).then(function(){ok(t,r)}).catch(function(e){fail(t,e)})}).catch(function(e){fail(t,e)})},createFromTemplate=function(e,t){var r=e.query.template_code||"blank";CoursewareObjectContextCreator.createContext(e,r).then(function(a){TemplateCreator.createTemplate(r).then(function(n){if(!n)return void fail(t,{message:$i18n("server.error.template.missing")});var i=e.query||{},o=a.id,c=new Manager(a.basepath);return ncp.limit=1,FileUtils.mkdir(a.basepath).then(function(){return Q.nfcall(ncp,n.templateDir,c.resourceDir,{filter:function(e){return Path.join(n.templateDir,"editor-config.js")!==e&&(Path.join(n.templateDir,"icon.png")!==e&&(Path.join(n.templateDir,"meta.json")!==e&&(Path.join(n.templateDir,"editor.xml")!==e&&-1==e.indexOf(Path.join(n.templateDir,"$")))))}}).then(function(){var e=o,n={page_id:e,coursewareobject_id:e};return FileUtils.eachFile(c.rootPath(),function(e){return e?promise4Replace(e,n):Q.when()}).then(function(){return Q.nfcall(fs.readFile,c.metadataJsonPath(),"utf-8").then(function(e){var t=JSON.parse(e);if(t.identifier=o,t.custom_properties.template_code=r,t.life_cycle.status="CREATED",t.life_cycle.create_time=formatDate(new Date),t.tech_info||(t.tech_info={}),t.tech_info.href={},t.tech_info.href.format="xml",t.tech_info.href.size=0,t.tech_info.href.location=espUtil.util.pathProcess(c.mainPath().replace(CoursewareObjectContextCreator.root,pathVar.refPath+"/edu/esp")).replace("interaction","coursewareobjects"),t.preview||(t.preview={}),i.creator&&(t.life_cycle.creator=i.creator),t.relations||(t.relations=[]),i.chapter_id){var a={};a.source=i.chapter_id,a.source_title=i.chapter_name,a.source_type="chapters",a.relation_type="ASSOCIATE",t.relations.push(a)}return t}).then(function(e){return e.physic_path=a.basepath,e.isBasic=a.isBasic,Q.nfcall(fs.writeFile,c.metadataJsonPath(),JSON.stringify(e)).then(function(){ok(t,e)})})})})})})}).catch(function(e){fail(t,e)})},get=function(e,t){CoursewareObjectContextCreator.getContext(e).then(function(e){var r=(e.id,new Manager(e.basepath));FileUtils.readFile(r.metadataJsonPath()).then(function(a){var n=JSON.parse(a);n.physic_path=r.resourceDir,n.isBasic=e.isBasic,ok(t,n)},function(e){fail(t,e)})}).catch(function(e){fail(t,e)})},getMain=function(e,t){CoursewareObjectContextCreator.getContext(e).then(function(r){var a=(e.body,r.id,new Manager(r.basepath));FileUtils.readFile(a.mainPath()).then(function(e){ok(t,e,"xml")},function(e){fail(t,e)})}).catch(function(e){fail(t,e)})},replaceAll=function(e,t,r){if(t!=r){for(var a=e.replace(t,r);a!=e;)e=a,a=e.replace(t,r);return e}},updateMain=function(e,t){var r=e.body;CoursewareObjectContextCreator.getContext(e).then(function(a){var n=a.id,i=new Manager(a.basepath);return Q.nfcall(fs.writeFile,i.mainPath(),r).then(function(){return doGenerateSdpPackage(n,r,e).then(function(){return ok(t)})})}).catch(function(e){fail(t,e)})},getPage=function(e,t){var r=e.params.pageId;CoursewareObjectContextCreator.getContext(e).then(function(e){var a=(e.id,new Manager(e.basepath));FileUtils.readFile(a.pagePath(r)).then(function(e){ok(t,e,"xml")},function(e){fail(t,e)})}).catch(function(e){fail(t,e)})},createPage=function(e,t){var r=uuid.v4(),a=e.body;CoursewareObjectContextCreator.getContext(e).then(function(e){var n=(e.id,new Manager(e.basepath));Q.nfcall(fs.writeFile,n.pagePath(r),a).then(function(){ok(t,r)},function(e){fail(t,e)})}).catch(function(e){fail(t,e)})},updatePage=function(e,t){var r=e.params.pageId,a=e.body;CoursewareObjectContextCreator.getContext(e).then(function(e){var n=(e.id,new Manager(e.basepath));Q.nfcall(fs.writeFile,n.pagePath(r),a).then(function(e){ok(t)},function(e){fail(t,e)})}).catch(function(e){fail(t,e)})},uploadResourceFile=function(e,t){CoursewareObjectContextCreator.getContext(e).then(function(r){var a=(r.id,new Manager(r.basepath)),n=Path.join(a.resourcePath(),ASSET_DIR);FileUtils.mkdir(n).then(function(){new Form({uploadDir:n}).parse(e,function(e,n,i){logError(e);var o=i.file[0],c=(new Date).getTime()+""+Math.floor(100*Math.random()),u=o.originalFilename.substring(o.originalFilename.lastIndexOf(".")),s=Path.join(r.basepath,"resources",ASSET_DIR,c+u);return FileUtils.copy(o.path,s,!1,!1).then(function(e){assetSup.parseAsset(e).then(function(e){ok(t,convertResourceFileInfo(a,e))}).fail(function(e){fail(t,e)})})})})}).catch(function(e){fail(t,e)})},copy=function(e,t){},searchResourceFiles=function(e,t){CoursewareObjectContextCreator.getContext(e).then(function(r){var a=(r.id,new Manager(r.basepath)),n=e.query.type||"",i=Path.join(a.resourcePath(),ASSET_DIR);Q.nfcall(fsExtend.walk,i).then(function(e){e=e||[];for(var r=[],i=0;i<e.length;i++)if(""===n)r.push(assetSup.parseAsset(e[i]));else{var o=assetSup.getNdCode(e[i]);o===n&&r.push(assetSup.parseAsset(e[i]))}Q.all(r).then(function(e){var r=[];e=e||[];for(var n=0;n<e.length;n++){var i=convertResourceFileInfo(a,e[n]);r.push(i)}ok(t,r)}).fail(function(e){fail(t,e)})},function(e){fail(t,e)})}).catch(function(e){fail(t,e)})};module.exports.create=create,module.exports.createFromTemplate=createFromTemplate,module.exports.get=get,module.exports.getMain=getMain,module.exports.updateMain=updateMain,module.exports.getPage=getPage,module.exports.updatePage=updatePage,module.exports.createPage=createPage,module.exports.uploadResourceFile=uploadResourceFile,module.exports.copy=copy,module.exports.searchResourceFiles=searchResourceFiles;