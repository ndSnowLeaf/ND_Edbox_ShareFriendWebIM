function store_one_question(e,t,r,n,i){var a=new ZipWrapper;return appendItem(e,t,a,[]).then(function(e){var t=Path.join(r,e.id+".pkg.zip");return store_zip_file(a,t).then(function(){n.files[i]={pagename:e.id,path:t}})})}function store_zip_file(e,t){var r=Q.defer(),n=archiver.create("zip",{statConcurrency:1});e.transferTo(n);var i=Fs.createWriteStream(t);return n.pipe(i),n.finalize(),i.on("finish",function(){r.resolve(t)}),r.promise}function parseBody(e){return"string"==typeof e?JSON.parse(e):e}var Client=require("node-rest-client").Client,CoursewareObjectContextCreator=require("../support/CoursewareObjectContext"),FileUtils=require("../support/FileUtils"),Path=require("path"),xpath=require("xpath"),dom=require("xmldom").DOMParser,XMLSerializer=require("xmldom").XMLSerializer,Q=require("q"),Fs=require("fs"),TemplateUtils=require("../support/TemplateUtils"),archiver=require("archiver"),Uploader=require("../support/Uploader").Uploader,unzip=require("unzip"),http=require("http"),RefPathHandler=require("./../support/RefPathHandler"),network=require("../support/network"),$i18n=require("../support/i18n").i18n,logError=function(e){e&&e.stack?console.error(e.stack.split("\n")):console.log(e)},fix=function(e){var t=Path.join(e.basepath,"main.xml.jpg"),r=Path.join(e.basepath,"mainbig.xml.jpg"),n=Fs.existsSync(t),i=Fs.existsSync(r);return FileUtils.readFile(Path.join(e.basepath,"main.xml")).then(function(t){var r=(new dom).parseFromString(t.toString()),i=r.getElementsByTagName("page");if(i&&1==i.length){var a=i[0],o=a.getAttribute("id"),s=a.getAttribute("name"),u=a.getAttribute("href");-1!=u.indexOf("?")&&(u=u.substring(0,u.indexOf("?")));var p="pages/"+e.id+".xml";if(o!=e.id||s!=e.id||u!=p||n&&!a.getAttribute("preview")){a.setAttribute("id",e.id),a.setAttribute("name",e.id),a.setAttribute("href",p+"?v="+(new Date).getTime()),n&&a.setAttribute("preview","main.xml.jpg?v="+(new Date).getTime());return(u==p?Q.when():FileUtils.copy(Path.join(e.basepath,u),Path.join(e.basepath,p),!0)).then(function(){return FileUtils.saveToFile(Path.join(e.basepath,"main.xml"),(new XMLSerializer).serializeToString(r)).then(function(){return u!=p&&Fs.unlinkSync(Path.join(e.basepath,u)),!0})}).catch(function(e){return logError(e),!1})}return!0}return!1}).then(function(t){return t&&(n||i)?FileUtils.readFile(Path.join(e.basepath,"metadata.json")).then(function(t){var r="${ref-path}/edu/esp/"+(e.isBasic?"questions":"coursewareobjects")+"/"+e.id+".pkg/",a=JSON.parse(t);return!(!a.preview.small||!a.preview.big)||(n&&(a.preview.small=r+"main.xml.jpg?v="+(new Date).getTime()),i&&(a.preview.big=r+"mainbig.xml.jpg?v="+(new Date).getTime()),FileUtils.saveToFile(Path.join(e.basepath,"metadata.json"),JSON.stringify(a)).then(function(){return!0}))}):t}).catch(function(e){return logError(e),!1})},fixItem=function(e,t,r,n){return CoursewareObjectContextCreator.getContext({query:{file_path:e}}).then(function(i){return fix(i).then(function(a){if(a){if(r)return syncItem(i,n)}else t.push(e)})}).catch(function(r){logError(r),t.push(e)})},syncItem=function(e,t){console.log("upload question ",e.id);var r=new Uploader(e,t);return r.initUploadConfig().then(function(){return r.syncFiles().then(function(){return r.syncMetadata()})})},fixAll=function(e,t,r){for(var n=[],i=[],a=0;a<e.length;a++)i.push(fixItem(e[a],n,t,r));return Q.all(i).then(function(){return n})},appendItem=function(e,t,r,n){return CoursewareObjectContextCreator.getContext({query:{file_path:e}}).then(function(e){return FileUtils.eachFile(e.basepath,function(t){t=Path.normalize(t);var i=Path.normalize(e.basepath);if(-1==t.indexOf("mainbig.xml.jpg")&&-1==t.indexOf("main.xml.jpg")&&-1==t.indexOf("metadata.json"))if(-1!=t.indexOf(Path.normalize(Path.join(e.basepath,"_ref")))){var a=t.replace(i,"");if(-1!=n.indexOf(a))return;n.push(a),r.file(t,{name:a})}else{var a=t.replace(i,"resources\\"+e.id+".pkg");if(-1!=n.indexOf(a))return;n.push(a),r.file(t,{name:a})}},function(){return!0}).then(function(){return FileUtils.readFile(Path.join(e.basepath,"main.xml")).then(function(r){var n=(new dom).parseFromString(r.toString()),i=n.getElementsByTagName("page"),a=i[0],o="resources/"+e.id+".pkg/";return t.setAttribute("id",a.getAttribute("id")),t.setAttribute("name",a.getAttribute("id")),t.setAttribute("href",o+a.getAttribute("href")),""!=a.getAttribute("preivew")&&t.setAttribute("preview",o+a.getAttribute("preivew")),t.setAttribute("reportable","true"),e})})})},ZipWrapper=function(){this.items=[]};ZipWrapper.prototype.transferTo=function(e){this.items.sort(function(e,t){return e.filepath>t.filepath?1:e.filepath<t.filepath?-1:0});for(var t=0;t<this.items.length;t++){var r=this.items[t];"file"==r.type?e.file(r.filepath,r.options):e.append(r.filepath,r.options)}},ZipWrapper.prototype.file=function(e,t){this.items.push({filepath:e,options:t,type:"file"})},ZipWrapper.prototype.append=function(e,t){this.items.push({filepath:e,options:t,type:"append"})},exports.pptpackage=function(e,t,r){var n=[],i=parseBody(e.body);fixAll(i.file_path).then(function(e){return e.length>0?t.send({message:"PPTPackage",result_code:-1,id:i.id}):TemplateUtils.loadTemplate("empty_main.xml").then(function(e){for(var r=[],a=(new dom).parseFromString(e.toString()),o=a.getElementsByTagName("pages")[0],s=archiver.create("zip",{statConcurrency:1}),u=new ZipWrapper,p=0;p<i.file_path.length;p++){var l=a.createElement("page");o.appendChild(l),r.push(appendItem(i.file_path[p],l,u,n))}return Q.all(r).then(function(){return FileUtils.mkdir(Path.join(CoursewareObjectContextCreator.root,"coursewares")).then(function(){var e=(new XMLSerializer).serializeToString(a);u.append(e,{name:"main-student.xml",date:"2016-03-30"}),u.transferTo(s);var r=Path.normalize(Path.join(CoursewareObjectContextCreator.root,"coursewares",i.id+".zip")),n=Fs.createWriteStream(r);s.pipe(n),s.finalize(),n.on("finish",function(){t.send({message:"PPTPackage",result_code:0,id:i.id,file_path:r})})})})})}).catch(function(e){return logError(e),!1})},exports.pptpackageex=function(e,t,r){var n=parseBody(e.body);fixAll(n.file_path).then(function(e){if(e.length>0)return t.send({message:"PPTPackage",result_code:-1,id:n.id});var r=Path.join(CoursewareObjectContextCreator.root,"coursewares",n.id);return FileUtils.mkdir(r).then(function(){return TemplateUtils.loadTemplate("empty_main.xml").then(function(e){for(var i=[],a={message:"PPTPackageEx",id:n.id,action:"package",result_code:"0",base:{path:r},files:[]},o=(new dom).parseFromString(e.toString()),s=o.getElementsByTagName("pages")[0],u=0;u<n.file_path.length;u++){var p=o.createElement("page");s.appendChild(p),i.push(store_one_question(n.file_path[u],p,r,a,u))}return Q.all(i).then(function(){var e=new ZipWrapper,n=(new XMLSerializer).serializeToString(o);e.append(n,{name:"main-student.xml",date:"2016-03-30"}),store_zip_file(e,Path.normalize(Path.join(r,"base.zip"))).then(function(){t.send(a)})})})})}).catch(function(e){logError(e),t.send({message:"打包错误："+e,result_code:-1,id:n.id})})},exports.generation=function(e,t,r){var n=parseBody(e.body);return fixAll(n.file_path).then(function(e){var r=0==e.length?0:-1;return t.send({message:" generation ",result_code:r,error_data:e})})},exports.sync=function(e,t,r){return network.isOnline().then(function(r){if(!r)return t.send({message:" synchrony",result_code:1});var n=parseBody(e.body),i=n.auth;return i.adjust_time||(i.adjust_time=new Date(i.server_time).getTime()-new Date(i.local_time).getTime()),fixAll(n.file_path,!0,i).then(function(e){var r=0==e.length?0:-1;return t.send({message:" synchrony",result_code:r,error_data:e})})})};var endsWith=function(e,t){return e.lastIndexOf(t)==e.length-t.length},endsWithXmlOrJson=function(e){var t=e.toLowerCase();return endsWith(t,"xml")||endsWith(t,"json")},replaceFileContent=function(e,t){for(var r=0;r<t.length;r++){var n={};n[t[r][0]]=t[r][1],e=TemplateUtils.replaceByParams(e,n,!0)}return e},copyQuestion=function(e){return CoursewareObjectContextCreator.getContext({query:{file_path:e}}).then(function(e){console.log("is public ",e.isPublic);return CoursewareObjectContextCreator.createEmptyContext(null,e.isBasic).then(function(t){var r=Path.normalize(e.basepath),n=Path.normalize(t.basepath);if(r==n)return{identifier:t.id,file_path:t.basepath,action:"copy"};console.log("start copy ....");var i=[[e.basepath,t.basepath],[r,n],[e.id,t.id],["${ref-path}/edu_product/esp/coursewareobjects","${ref-path}/edu/esp/coursewareobjects"],["${ref-path}/edu_product/esp/questions","${ref-path}/edu/esp/questions"]];return FileUtils.eachFile(e.basepath,function(a){var o=a.replace(r,n).replace(e.id,t.id).replace(Path.normalize("/edu_product/esp/coursewareobjects"),Path.normalize("/edu/esp/coursewareobjects")).replace(Path.normalize("/edu_product/esp/questions"),Path.normalize("/edu/esp/questions"));return endsWithXmlOrJson(a)?FileUtils.readFile(a).then(function(e){if(e=replaceFileContent(e,i),-1!=a.indexOf("metadata.json")){e=replaceFileContent(e,[]);var r=JSON.parse(e);r.physic_path=t.basepath,r.tech_info&&delete r.tech_info.offline,e=JSON.stringify(r)}return FileUtils.saveToFile(o,e)}):FileUtils.copy(a,o,!0)},function(){return!0}).then(function(){return{identifier:t.id,file_path:t.basepath,message:"copy",result_code:"0"}})})}).catch(function(e){return logError(e),{message:"copy",result_code:"1"}})};exports.copy=function(e,t,r){var n=parseBody(e.body);copyQuestion(n.file_path).then(function(e){return t.send(e)})};var headers=function(e){return{"Content-Type":"application/json;charset=utf-8"}},download_question=function(e,t){var r=Q.defer(),n=new Client;return n.get(t+"/v0.6/questions/"+e+"/archiveinfo?icplayer=false&target=default&uid=619973",{headers:headers()},function(i,a){if("ready"==i.archive_state){var o=i.access_url,s=Path.join(CoursewareObjectContextCreator.root,"zip",e+".pkg");http.get(o,function(e){e.pipe(unzip.Extract({path:s})).on("close",function(){r.resolve(s)}).on("error",function(e){r.reject($i18n("question.data.unpack.fail")+e)})})}else"unpack"==i.archive_state&&n.post(t+"/v0.6/questions/"+e+"/archive?icplayer=false&target=default&uid=619973",{data:{},headers:headers()},function(){}),r.reject($i18n("question.data.waitpack"))}),r.promise},download_coursewareobjects=function(e,t){var r=Q.defer(),n=new Client;return n.get(t+"/v0.6/coursewareobjects/"+e+"/archiveinfo?icplayer=false&target=default&uid=619973",{headers:headers()},function(i,a){if("ready"==i.archive_state){var o=i.access_url,s=Path.join(CoursewareObjectContextCreator.root,"zip",e+".pkg");http.get(o,function(e){e.pipe(unzip.Extract({path:s})).on("close",function(){r.resolve(s)}).on("error",function(e){r.reject($i18n("question.data.unpack.fail")+e)})})}else"unpack"==i.archive_state&&n.post(t+"/v0.6/coursewareobjects/"+e+"/archive?icplayer=false&target=default&uid=619973",{data:{},headers:headers()},function(){}),r.reject($i18n("question.data.waitpack"))}),r.promise},DEFAULT_BACKGROUND={url:"",type:2,left:0,top:0,right:0,bottom:0},parseHandwrite=function(e){var t=require("xpath"),r=require("xmldom").DOMParser,n=(new r).parseFromString(e.toString()),i=t.select("//page/modules/addonModule[@addonId='Panel']/*/property[@name='text']",n),a=t.select("//page/modules/addonModule[@addonId='Write']/*/property[@name='writer_background']",n);a=0==a.length?null:a[0].textContent;var o={content:i[0].textContent,background:a?JSON.parse(a):DEFAULT_BACKGROUND},s=JSON.stringify(o);return s=s.replace(/\$\{ref-base\}\/\.\./gi,"${ref-base}"),o=JSON.parse(s),{responses:[{identifier:"RESPONSE_1-1",cardinality:"single",base_type:"file",sequence:"1-1",corrects:[]}],items:[{identifier:null,type:"handwrite",raw:!1,response_identifier:"RESPONSE_1-1",prompt:o.content,object:{type:"image/png",width:"1000",height:"600",data:JSON.stringify(o.background),text:"",params:{}}}],feedbacks:[]}};exports.merge_questions=function(e,t,r){var n=parseBody(e.body),i=null;i=n.source_file_path?Q.when(n.source_file_path):n.newhandwrite?download_coursewareobjects(n.source_identifier,n.lifecycleServer):download_question(n.source_identifier,n.lifecycleServer);var a=null;return i.then(function(e){return CoursewareObjectContextCreator.getContext({query:{file_path:e}}).then(function(e){return CoursewareObjectContextCreator.getContext({query:{file_path:n.target_file_path}}).then(function(r){var i=Path.normalize(e.basepath),o=Path.normalize(r.basepath),s=[[e.basepath,r.basepath],[i,o],[e.id,r.id],["${ref-path}/edu_product/esp/coursewareobjects","${ref-path}/edu/esp/coursewareobjects"],["${ref-path}/edu_product/esp/questions","${ref-path}/edu/esp/questions"]];return FileUtils.eachFile(e.basepath,function(t){t=Path.normalize(t);var n=t.replace(i,o).replace(e.id,r.id).replace(Path.normalize("/edu_product/esp/coursewareobjects"),Path.normalize("/edu/esp/coursewareobjects")).replace(Path.normalize("/edu_product/esp/questions"),Path.normalize("/edu/esp/questions"));return-1!=t.indexOf("item.json")||-1!=t.indexOf(".xml")?FileUtils.readFile(t).then(function(e){return e=replaceFileContent(e,s),-1!=t.indexOf(".xml")&&-1!=t.indexOf("pages")&&(a=e),FileUtils.saveToFile(t,e)}):FileUtils.copy(t,n,!0)},function(e){return-1!=e.indexOf("item.json")||-1!=e.indexOf("resources")||-1!=e.indexOf("_ref")||-1!=e.indexOf(".xml")}).then(function(){if(n.newhandwrite){if(""!=a){var i=parseHandwrite(a);return RefPathHandler.refToUrl(JSON.stringify(i),r).then(function(e){var r=JSON.parse(e);return t.send(r)})}return t.status(500).send({message:"新手写题缺少page文件",result:1})}return FileUtils.readFile(Path.join(e.basepath,"item.json")).then(function(e){return RefPathHandler.refToUrl(e,r).then(function(e){var r=JSON.parse(e);return t.send(r)})})})})})},function(e){throw e}).catch(function(e){logError(e);var r=e&&e.stack?"服务故障":e;return t.status(500).send({message:r,result:1})})},exports.download_and_copy=function(e,t,r){var n=parseBody(e.body),i=n.id;return(n.isBasic?download_question(i,n.lifecycleServer):download_coursewareobjects(i,n.lifecycleServer)).then(function(e){return copyQuestion(e).then(function(e){return t.send(e)})})};