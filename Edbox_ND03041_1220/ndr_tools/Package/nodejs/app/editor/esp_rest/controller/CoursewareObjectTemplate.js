function loadMapping(){FileUtils.readFile(Path.join(CourseareObjectContext.serverRoot,"prepare/mapping")).then(function(e){var t=JSON.parse(e);for(var n in t)for(var a=t[n],r=0;r<a.length;r++){var o=a[r].template||a[r].type,i=a[r].code;mappings[o]||(mappings[o]={code:i,isBasic:"basic_question"==n,i18n:a[r].i18n})}},function(e){console.log(e)})}function loadUnsupportedLanguageQuestions(){FileUtils.readFile(Path.join(CourseareObjectContext.serverRoot,"prepare/unsupport_language_questions.json")).then(function(e){unsupportedLanguageQs=JSON.parse(e)},function(e){console.log(e)})}var Q=require("q"),BASE_FOLDER="../../../templates",FileUtils=require("../support/FileUtils"),Fs=require("fs"),Path=require("path"),CourseareObjectContext=require("../support/CoursewareObjectContext"),i18n=require("i18n"),mappings={};loadMapping();var unsupportedLanguageQs={};loadUnsupportedLanguageQuestions();var templates=function(e,t,n){var a=e.param("categoryCode"),r=e.param("_lang_");return findTemplates(a,r).then(function(e){return t.send({items:e})})},template=function(e,t,n){var a=e.param("code");return findTemplates("basic_question").then(function(e){for(var n=0;n<e.length;n++)if(e[n].code==a)return t.send(e[n]);return findTemplates("interaction_question").then(function(e){for(var n=0;n<e.length;n++)if(e[n].code==a)return t.send(e[n])})})},i18n=require("i18n"),findTemplates=function(e,t){var n=i18n.getLocale();return FileUtils.readFile(Path.join(CourseareObjectContext.serverRoot,"configuration/config.json")).then(function(a){var r=JSON.parse(a),o=[],i=unsupportedLanguageQs[t]||{};for(var s in r.templates)if(!i.hasOwnProperty(s)&&r.templates[s].categoryCode==e&&"true"==r.templates[s].show){var p=Path.join(CourseareObjectContext.serverRoot,r.templates[s].href.replace("${ref-path-addon}","")),u=Path.join(p,"icon_image_only.png");Fs.existsSync(u)||(u=Path.join(p,"icon_"+i18n.getLocale()+".png")),Fs.existsSync(u)||(u=Path.join(p,"icon.png")),r.templates[s].iconurl=CourseareObjectContext.toUrl(u),r.templates[s].code=s,mappings[s]&&(r.templates[s].lccode=mappings[s].code,r.templates[s].isBasic=mappings[s].isBasic,n&&mappings[s].i18n&&mappings[s].i18n[n]&&(r.templates[s].name=mappings[s].i18n[n])),o.push(r.templates[s])}return o.sort(function(e,t){return e.sort-t.sort}),o})};exports._findTemplates=findTemplates,exports.templates=templates,exports.template=template;