function findQuestionItem(e){if(e&&e.categories&&e.categories.res_type)for(var t=e.categories.res_type,n=0;n<t.length;n++)if(t[n].taxoncode&&"$RE0200"!=t[n].taxoncode)return t[n];return null}function findQuestionCode(e){var t=findQuestionItem(e);return t?t.taxoncode:""}function addProperty(e,t,n,r,i){var o=e.ownerDocument.createElement("property");o.setAttribute("name",t),o.setAttribute("displayName",n),o.setAttribute("type",r),o.setAttribute("value",i),e.appendChild(o)}function deleteAllChildElement(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function toPageRefBase(e){return TemplateUtils.replaceByParams(e,{"${ref-base}":"${ref-base}/.."},!0)}function saveCompositeQuestionContent(e,t){return TemplateUtils.loadTemplate("new_compound_question_page.xml").then(function(n){var r=(new dom).parseFromString(n.toString()),i=xpath.select("//page/modules/addonModule[@addonId='CompoundQuestion']/*/property[@name='MainStem']",r),o=t.items.length>0?t.items[0].prompt:"";if(i.length>0){o=toPageRefBase(o);var a=r.createCDATASection(o);i[0].appendChild(a)}var s=xpath.select("//page/modules/addonModule[@addonId='CompoundQuestion']/*/property[@name='QuestionId']",r);s.length>0&&s[0].setAttribute("value",e.id);for(var u=[],l=1;l<t.items.length;l++)u.push(saveCompositeQuestionItem(e,t,t.items[l],l));return Q.all(u).then(function(t){var n=xpath.select("//page/modules/addonModule[@addonId='CompoundQuestion']/*/property[@name='Questions']",r);if(n.length>0){var i=n[0],o=r.createCDATASection(JSON.stringify(t));return i.appendChild(o),FileUtils.saveToFile(FileUtils.join(e.basepath,"pages/"+e.id+".xml"),(new XMLSerializer).serializeToString(r))}return Q.when()})})}function saveCompositeQuestionItem(e,t,n,r){var i=n.identifier||"subquestion_"+r,o=formatQuestionItem(t,n);return"handwrite"==n.type?Q.when({SubQuestionId:i,SubQuestionType:"newhandwrite",SubQuestionData:o}):FileUtils.saveToFile(FileUtils.join(e.basepath,i+".json"),JSON.stringify(o)).then(function(){return{SubQuestionId:i,SubQuestionType:n.type,SubQuestionData:{QuestionUrl:"${ref-base}/../"+i+".json"}}})}function findFeedbacks(e,t){for(var n=-1!=t.indexOf("-")?parseInt(t.substring(0,t.indexOf("-"))):parseInt(t),r=[],i=0;i<e.length;i++){var o=e[i];if(o.sequence==n){var a=copy(o);a.sequence=1,r.push(a)}}return r}function findResponse(e,t){for(var n=0;n<e.length;n++)if(e[n].identifier==t)return copy(e[n]);return{}}function copy(e){return JSON.parse(JSON.stringify(e))}function formatQuestionItem(e,t){if("handwrite"==t.type){var n=null;try{n=JSON.parse(t.object.data)}catch(e){n={url:toPageRefBase(t.object.data||""),type:1,top:0,left:0,right:0,bottom:0,width:t.object.width,height:t.object.height}}return n.url=toPageRefBase(n.url||""),{stem:toPageRefBase(t.prompt||""),background:n}}var r=copy(t),i=r.response_identifier,o=findResponse(e.responses,i),a=o.sequence;return r.response_identifier="RESPONSE_1-1",o.identifier="RESPONSE_1-1",o.sequence="1-1",{identifier:"",title:"",label:null,lang:null,adaptive:!1,time_dependent:!1,responses:[o],items:[r],feedbacks:findFeedbacks(e.feedbacks,a)}}function saveMetadata(e,t){var n=JSON.stringify(t);return FileUtils.saveToFile(FileUtils.join(e.basepath,"metadata.json"),n)}var Path=require("path"),Q=require("q"),xpath=require("xpath"),dom=require("xmldom").DOMParser,XMLSerializer=require("xmldom").XMLSerializer,CoursewareObjectContextCreator=require("./../support/CoursewareObjectContext"),FileUtils=require("./../support/FileUtils"),RefPathHandler=require("./../support/RefPathHandler"),GraphicGapMatchHandler=require("../support/GraphicGapMatchHandler"),TemplateUtils=require("./../support/TemplateUtils"),logError=function(e){e.stack?console.error(e.stack.split("\n")):console.log(e)},fail=function(e,t){if(t)return logError(t),util.isArray(t)?e.status(500).send(t[0]):e.status(500).send(t)};exports.getItem=function(e,t,n){return CoursewareObjectContextCreator.getContext(e).then(function(e){return FileUtils.existsAll(FileUtils.join(e.basepath,"resources"),["default_audio.png","background.jpg","papertype_7.png"]).then(function(n){var r=FileUtils.join(CoursewareObjectContextCreator.serverRoot,"editor/basic-question/template/",e.isBasic?"question_resource":"interaction_resource");return(n?Q.when():FileUtils.copyFolder(r,FileUtils.join(e.basepath,"resources"))).then(function(){return FileUtils.readFile(FileUtils.join(e.basepath,"item.json")).then(function(n){return RefPathHandler.refToUrl(n,e).then(function(e){var n=JSON.parse(e);return t.send(n)})})})})}).catch(function(e){fail(t,e)})};var dealData=function(e,t){var n=[];return e.items&&e.items.forEach(function(r,i){r.sequence=i,n.push(GraphicGapMatchHandler.handleItem(e,r,t))}),Q.all(n).then(function(){return e})};exports.saveItem=function(e,t,n){var r=e.body,i=JSON.stringify(e.body);return CoursewareObjectContextCreator.getContext(e).then(function(e){return RefPathHandler.urlToRef(i,e).then(function(n){return dealData(JSON.parse(n),e).then(function(n){return FileUtils.saveToFile(FileUtils.join(e.basepath,"item.json"),JSON.stringify(n)).then(function(){return FileUtils.readFile(FileUtils.join(e.basepath,"metadata.json")).then(function(i){var o=JSON.parse(i),a=findQuestionCode(o);return("$RE0208"==a||"$RE0234"==a?saveCompositeQuestionContent(e,n):Q.when()).then(function(){var i="$RE0234"==a||"$RE0208"==a,s=Q.when();return i&&(r&&r.items&&r.items[0]&&(o.description=r.items[0].prompt||o.description),findQuestionItem(o).taxoncode="$RE0234",s=saveMetadata(e,o)),s.then(function(){return RefPathHandler.refToUrl(JSON.stringify(n),e).then(function(e){var n=JSON.parse(e);return t.send(n)})})})})})})})}).catch(function(e){fail(t,e)})},exports.qtiplayer=function(e,t,n){return CoursewareObjectContextCreator.getContext(e).then(function(e){var n=encodeURIComponent(e.fileToUrl(FileUtils.join(e.basepath,"main.xml"),!1));return t.send({url:"/player/index.html?main="+n+"&hidePage=toolbar&_lang_=zh_CN&hidePage=footer"})})};