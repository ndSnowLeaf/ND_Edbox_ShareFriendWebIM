var http=require("http"),util=require("util"),Path=require("path"),sizeOf=require("image-size"),CoursewareObjectContextCreator=require("../support/CoursewareObjectContext"),FileUtils=require("../support/FileUtils"),$i18n=require("../support/i18n").i18n,logError=function(e){e.stack?console.error(e.stack.split("\n")):console.log(e)},fail=function(e,t){if(t)return logError(t),util.isArray(t)?e.status(500).send(t[0]):e.status(500).send(t)},convertBaiduImageToLocalImage=function(e,t){for(var r=[],n="bd_"+(new Date).getTime(),i=0;i<t.length;i++){var o=n+""+i,a=t[i],s="/resources/"+o+"."+a.Pictype,u=remoteToProxy(e,s,a.ObjUrl);r.push({identifier:o,title:a.Desc,tech_info:{href:{format:"",location:u,requirements:[{type:"QUOTA",name:"resolution",value:a.Width+"*"+a.Height}]}},preview:{240:"/v1.3/assets/proxy2?url="+encodeURIComponent(a.ObjUrl)},type:"$RA0101"})}return r},getLocalFileList=function(e,t){var r={jpg:{code:"$RA0101",minetype:""},jpeg:{code:"$RA0101",minetype:""},gif:{code:"$RA0101",minetype:""},png:{code:"$RA0101",minetype:""},bmp:{code:"$RA0101",minetype:""},mp4:{code:"$RA0103",minetype:""},mp3:{code:"$RA0102",minetype:""}},n=[];return FileUtils.eachFile(FileUtils.join(e.basepath,"resources"),function(i){if(-1!=i.indexOf(".")){var o=-1==i.lastIndexOf(".")?i:i.substring(0,i.lastIndexOf("."));o=Path.basename(o);var a=Path.basename(i),s=i.substring(i.lastIndexOf(".")+1),u=r[s.toLowerCase()];if(-1==["audio.png","background.jpg","default_audio.png","default_video.png","image.png","papertype_1.png","papertype_2.png","papertype_3.png","papertype_4.png","papertype_5.png","papertype_6.png","papertype_7.png","video.png"].indexOf(a)&&0!=a.indexOf("sf-")&&u&&u.code==t){var p=e.fileToUrl(i,!0),c={identifier:o,title:o+"."+s,tech_info:{href:{format:u.mimetype,location:p,requirements:[{type:"QUOTA",name:"resolution"}]}},type:u.code};if("$RA0101"==u.code)try{var f=sizeOf(i);c.tech_info.href.requirements[0].value=f.width+"*"+f.height}catch(e){logError(e)}n.push(c)}}},function(){return!0}).then(function(){return n})};exports._getLocalFileList=getLocalFileList;var localToProxy=function(e,t){return"/v2.0/assets/get?file_path="+encodeURIComponent(e.basepath)+"&file_name="+encodeURIComponent(t)},remoteToProxy=function(e,t,r){return"/v2.0/assets/get?file_path="+encodeURIComponent(e.basepath)+"&file_name="+encodeURIComponent(t)+"&remote_path="+encodeURIComponent(r)};exports.search=function(e,t,r){CoursewareObjectContextCreator.getContext(e).then(function(r){var n=e.query.coverage,i=e.query.type;if(-1!=n.indexOf("local"))getLocalFileList(r,i).then(function(e){t.send({items:e})}).catch(function(e){logError(e)});else if(-1!=n.indexOf("User")||-1!=n.indexOf("Org/nd")){-1!=n.indexOf("Org/nd")&&(n="Org/nd/OWNER");var o=e.query.slideServer,a=e.query.csserver;o&&-1!=o.indexOf("//")&&(o=o.substring(o.indexOf("//")+2)),o&&-1!=o.lastIndexOf("/")&&(o=o.substring(0,o.lastIndexOf("/")));var s="/v1.3/assets?type="+encodeURIComponent(e.query.type)+"&coverage="+encodeURIComponent(n)+"&page="+(e.query.page||1)+"&size="+(e.query.size||24)+"&chapter_id="+(e.query.chapter_id||"")+"&words="+encodeURIComponent(e.query.words||"")+"&max_size="+(e.query.max_size||"");http.get({host:o,path:s,headers:{}},function(e){var n="";e.on("data",function(e){n+=e}),e.on("end",function(){try{var e=JSON.parse(n);if(e.code)return t.status(500).send({code:e.code,message:e.message});for(var i=e.items,o="nd_"+(new Date).getTime(),s=0;s<i.length;s++){var u=i[s],p=u.tech_info.href.location;p=p.replace("${ref-path}",a);var c=u.preview,f=o+""+s,l=p.substring(p.lastIndexOf(".")+1),d="/resources/"+f+"."+l;if(c&&0!=c.length&&""!=u.preview[240])for(var g in c)c[g]=c[g].replace("${ref-path}",a);else u.preview={240:p+"?size=240",media:p+"?size=240"};u.tech_info.href.location=remoteToProxy(r,d,p+"?size=1200")}return t.send(e)}catch(e){t.status(500).send({code:"LS/JSON_PARSE_FAIL",message:$i18n("server.error.response.format")})}})}).on("error",function(e){t.status(500).send({code:"LS/JSON_PARSE_FAIL",message:$i18n("server.error")})})}else{if(-1==n.indexOf("Baidu/bd/")||"$RA0101"!=i)return t.send({items:[]});if(""==e.query.words)return t.send({items:[]});var u=e.query.size||24,p=((e.query.page||1)-1)*u,c="/image_search/search/search?word="+encodeURIComponent(e.query.words||"")+"&pn="+p+"&rn="+u+"&assetType=$RA0101&ie=utf-8";http.get({host:"apis.baidu.com",path:c,headers:{apikey:"de4eb4b4a1ae4e1c529b0774f931d1f8"}},function(e){var n="";e.on("data",function(e){n+=e}),e.on("end",function(){var e=JSON.parse(n),i=e.status.code;if("0"!=i)return t.status(500).send({code:i,message:e.status.msg});var o=e.data.ReturnNumber,a=e.data.TotalNumber,s=convertBaiduImageToLocalImage(r,e.data.ResultArray);return t.send({item_count:o,total_count:a,items:s})})}).on("error",function(e){t.status(500).send({code:"LS/JSON_PARSE_FAIL",message:$i18n("server.error")})})}})},exports.get=function(e,t,r){CoursewareObjectContextCreator.getContext(e).then(function(r){var n=e.query.file_path,i=e.query.file_name,o=e.query.remote_path,a=o&&-1==o.indexOf("101.com");if(n&&-1!=n.indexOf("http://"))if(-1!=i.indexOf("_ref")&&(i=i.replace("_ref","")+"?size=1200",n=n.substring(0,n.indexOf("/static/")+"/static/".length-1)),a){http.get(FileUtils.join(n,i),function(e){e.pipe(t)}).end()}else t.redirect(FileUtils.join(n,i));else FileUtils.exists(FileUtils.join(n,i)).then(function(e){if(e)return t.sendFile(Path.resolve(FileUtils.join(n,i)));if(!o)return t.status(404).send({code:"LS/FILE_NOT_EXIST",message:$i18n("server.error.file.missing")});if(a){http.get(o,function(e){e.pipe(t)}).end()}else t.redirect(o)})})},exports.proxy3=function(e,t,r){var n=e.params[0],i=e.params.base;i=i.replace(/-/gi,"+"),i=i.replace(/_/gi,"/"),i=new Buffer(i,"base64").toString("utf-8"),-1!=i.indexOf("?")&&(i=i.substring(0,i.indexOf("?")));var o=FileUtils.join(i,n);-1===o.indexOf("http://")?t.sendFile(o):t.redirect(o)},exports.upload=function(e,t,r){CoursewareObjectContextCreator.getContext(e).then(function(r){var n=e.file,i=e.query.asset_type,o=(new Date).getTime()+""+Math.floor(100*Math.random()),a=n.originalname.substring(n.originalname.lastIndexOf(".")),s=(n.originalname.substring(0,n.originalname.lastIndexOf(".")),FileUtils.join(r.basepath,"resources",o+a));return FileUtils.copy(n.path,s).then(function(){var e={identifier:o,title:n.originalname,tech_info:{href:{format:n.mimetype,location:r.fileToUrl(s,!0),requirements:[{type:"QUOTA",name:"resolution"}]}},type:i};if("$RA0101"==i)try{var a=sizeOf(s);e.tech_info.href.requirements[0].value=a.width+"*"+a.height}catch(e){logError(e)}t.send(e)})}).catch(function(e){logError(e),fail(t,e)})};