function saveLocalFile(e,t,i,n,r,a,o){var s=InteractionUtils.getInteractionBase(n,t),l=s+"/resources",c=s+"/pages";!FileSys.existsSync(s)&&FileSys.mkdirSync(s),!FileSys.existsSync(c)&&FileSys.mkdirSync(c),!FileSys.existsSync(l)&&FileSys.mkdirSync(l);var d;if(e){var u=t.params.module_type;d=SubjectToolParser.parser(u,n,r,o)}else d=Json2XmlParser.parser(i,n,r);if(FileSys.writeFileSync(s+"/main.xml",d.main),FileSys.writeFileSync(c+"/"+n+".xml",d.page),FileSys.writeFileSync(s+"/sdp-package.xml",d.sdp_package),d.extend_files.length>0)for(var p=0;p<d.extend_files.length;p++)FileSys.writeFileSync(l+"/"+d.extend_files[p].name,d.extend_files[p].content);"mindjet"==i||e||FileSys.writeFileSync(l+"/editor.json",JSON.stringify(r)),!!a&&FileSys.writeFileSync(s+"/metadata.json",JSON.stringify(a))}function loadTemplate(){var e=PathSys.join(__dirname,"../template/handwrite/page.xml");return FileSys.readFileSync(e,"utf-8")}function replaceByParams(e,t){for(var i in t)for(var n=t[i],r=e.replace("{{"+i+"}}",n);r!=e;)e=r,r=e.replace("{{"+i+"}}",n);return e}function headers(){return{"Content-Type":"application/json;charset=utf-8"}}function isSubjectToolFn(e,t){return"true"===e.param("is_subject_tool")}function handleSubjectToolCode(e,t){return isSubjectToolFn(e,t)&&!t.startsWith("nd_")?"nd_"+t.toLowerCase():t}function getEditorJsonFromLocale(e,t){var i={},n=e+"/editor.json";if(FileSys.existsSync(n)){var r=FileSys.readFileSync(n);if(r&&(i=JSON.parse(r.toString()),!i.interaction_hints))try{var a=e+"/hint.json";if(FileSys.existsSync(a)){var o=FileSys.readFileSync(a);if(o){var s=JSON.parse(o);i.interaction_hints=s.hints}}}catch(e){}}else if(!InteractionUtils.isUnsupportedReedit(t.module_type)){var l=FileSys.readdirSync(e);l.forEach(function(t){if(InteractionUtils.isEditorDataFile(t)&&(n=e+"/"+t,FileSys.existsSync(n))){var r=FileSys.readFileSync(n);r&&(i=JSON.parse(r.toString()))}})}return i}function getEditorJsonFromRemote(e,t){var i=Q.defer(),n=e+"/editor.json";return InteractionUtils.sendHttpGet(n,function(t){var n=t.toString();if(n.indexOf("${ref-path}")<0)i.resolve(JSON.parse(n));else{var r=function(t){"CS/DOWNLOAD_DENTRY_NOT_FOUND"===JSON.parse(t).code?i.resolve(JSON.parse(n.replace(/\$\{ref-path\}/g,CS_STATIC_URL))):i.resolve(JSON.parse(n.replace(/\$\{ref-path\}/g,e)))};InteractionUtils.sendHttpGet(e+"/_ref",r,r)}}),i.promise}var nodeUuid=require("node-uuid"),FileSys=require("fs"),PathSys=require("path"),Q=require("q"),Client=require("node-rest-client").Client,FileUtils=require("../support/FileUtils"),CoursewareObjectContextCreator=require("../support/CoursewareObjectContext"),$i18n=require("../support/i18n").i18n,InteractionUtils=require("./bundles/InteractionUtils"),Json2XmlParser=require("./bundles/json2XmlParser"),SubjectToolParser=require("./bundles/SubjectToolParser"),CS_STATIC_URL="http://cs.101.com/v0.1/static";console.log("init interactoin");var beforeSaveData=function(e,t,i){if("nd_imagemark"==t.module_type){i.background="<img src='"+i.image_item.asset+"' ";for(var n in i.image_item.other)i.background+=n+"='"+i.image_item.other[n]+"' ";i.background+="/>"}var r=InteractionUtils.readMetaData(t.module_instance_id,e),a=i.title;return"nd_mindjet"===t.module_type&&i.root&&i.root.data&&i.root.data.text&&(a=i.root.data.text),InteractionUtils.updateMetaData(r,a),r};exports.create=function(e,t,i){InteractionUtils.createInteractionBase();var n={module_type:"compare"==e.params.module_type?"nd_compare":e.params.module_type,isEditable:e.param("isEditable")};n.module_type=handleSubjectToolCode(e,n.module_type);var r=isSubjectToolFn(e,n.module_type),a=nodeUuid.v4(),o=InteractionUtils.createMetaData(n.module_type,a,e.body,r),s=InteractionUtils.getModuleCode(n.module_type);if(r){var l=e.params.module_type,c=InteractionUtils.instanceSubjectToolData(l,a);return saveLocalFile(!0,e,s,a,c,o),c.physic_path=PathSys.normalize(InteractionUtils.getInteractionBase(c.id,e)),c.isEditable=n.isEditable||!1,t.send(c)}var c;return e.body.nonQuestionData?c=InteractionUtils.instanceModuleData(n.module_type,a):(c=e.body,c.id=a,InteractionUtils.updateMetaData(o,c.title)),""!=s&&(saveLocalFile(!1,e,s,a,c,o),"linkup"!=n.module_type&&"nd_memorycard"!=n.module_type||InteractionUtils.copySpiritResource(n.module_type,a,e)),InteractionUtils.isGeneralTool(n.module_type)&&(c={id:a}),c.physic_path=PathSys.normalize(InteractionUtils.getInteractionBase(c.id,e)),t.send(c)},exports.get=function(e,t,i){var n,r={module_type:e.params.module_type,module_instance_id:e.params.module_instance_id},a=InteractionUtils.getInteractionBase(r.module_instance_id,e)+"/resources";return a.indexOf("http://")<0?(n=getEditorJsonFromLocale(a,r),n.physic_path=PathSys.normalize(InteractionUtils.getInteractionBase(e.params.module_instance_id,e)),t.send(n)):void getEditorJsonFromRemote(a,r).then(function(i){i.physic_path=PathSys.normalize(InteractionUtils.getInteractionBase(e.params.module_instance_id,e)),t.send(i)})},exports.modify=function(e,t,i){var n={module_type:e.params.module_type,module_instance_id:e.params.module_instance_id},r=e.body,a=InteractionUtils.getModuleCode(n.module_type);if(""!=a){saveLocalFile(!1,e,a,n.module_instance_id,r,beforeSaveData(e,n,r)),"linkup"!=n.module_type&&"nd_memorycard"!=n.module_type||InteractionUtils.copySpiritResource(n.module_type,n.module_instance_id,e)}return InteractionUtils.isGeneralTool(n.module_type)?InteractionUtils.returnCommder(e,t,n):t.send(r)},exports.modifySubjectTool=function(e,t,i){var n=e.body,r={module_type:e.params.module_type,module_instance_id:e.params.module_instance_id},a=InteractionUtils.readMetaData(r.module_instance_id,e);return InteractionUtils.updateMetaData(a,n.title),saveLocalFile(!0,e,null,r.module_instance_id,n,a,!0),InteractionUtils.returnCommder(e,t,r,!0)},exports.dynamicCreateQuestion=function(e,t){var i=null,n=null,r=e.body.questionCode,a=e.body.imgUrl,o=e.body.imgWidth,s=e.body.imgHeight,l=e.body.chapterId,c=e.body.chapterName,d=e.body.creator,u="http://"+e.headers.host,p=new Client,m=u+"/v2.0/courseware_objects/actions/from_template?template_code="+r;l&&(m=m+"&chapter_id="+l),c&&(m=m+"&chapter_name="+encodeURIComponent(c)),d&&(m=m+"&creator="+d),p.post(m,{headers:headers()},function(e){i=e.physic_path,CoursewareObjectContextCreator.getContext({query:{file_path:i}}).then(function(l){var c=a.substring(a.lastIndexOf(".")+1),d=(new Date).getTime()+"."+c,y=i+"\\resources\\";FileUtils.copy(a,y+d,!0).then(function(a){var c=l.fileToRefUrl(a);if("nd_handwritequestion"==r){n=l.id;var d=loadTemplate(),y={content:"<p></p>",isWhole:1,background:{url:c,type:3,left:0,top:0,right:0,bottom:0,width:o,height:s}},_={question_id:l.id,question_prompt:y.content,background_content:JSON.stringify(y.background),is_whole:y.isWhole};return void FileUtils.saveToFile(PathSys.join(l.basepath,"pages/"+l.id+".xml"),replaceByParams(d,_)).then(function(){t.send({physicPath:i,questionId:n})}).catch(function(e){t.status(500).send({physicPath:null,questionId:null,errorMsg:"保存题目失败"})})}n=e.identifier,m=u+"/v1.3/questions/"+e.identifier+"/item?file_path="+encodeURIComponent(e.physic_path),p.get(m,{headers:headers()},function(e){switch(r){case"choice":e.responses=[],e.items[0].prompt='<p><img src="'+c+'"/></p>';for(var a=e.items[0].choices.length;a<6;a++)e.items[0].choices.push({identifier:String.fromCharCode(65+a),fixed:!0,text:"<p></p>\n",group_id:"",correct:!1,match_max:1});break;case"judge":e.responses=[],e.items[0].prompt='<p><img src="'+c+'"/></p>';for(var a=0,o=e.items[0].choices.length;a<o;a++)"YES"==e.items[0].choices[a].identifier?e.items[0].choices[a].text=$i18n("interaction.dynamic.create.question.yes"):e.items[0].choices[a].text=$i18n("interaction.dynamic.create.question.no");break;case"subjectivebase":e.responses=[],e.items[0].prompt='<div class="subjectivebase_text"><p><img src="'+c+'"/></p></div><div class="subjectivebase_asset"></div>';break;default:return void t.send({physicPath:null,questionId:null,errorMsg:"不支持的该题型:"+r})}p.put(m,{data:e,headers:headers()},function(e){t.send({physicPath:i,questionId:n})})})}).catch(function(e){t.send({physicPath:null,questionId:null,errorMsg:"复制图片失败"})})})})},exports.moduleMeasureGravityUserGuide=function(e,t){FileUtils.readFile(PathSys.join(__dirname,"MeasureGravity.json")).then(function(e){var t=null;try{t=JSON.parse(e)}catch(e){t={}}return!!t.opened||(t.opened=!0,FileUtils.saveToFile(PathSys.join(__dirname,"MeasureGravity.json"),JSON.stringify(t)).then(function(){return!1}))}).then(function(e){t.send({opened:e})})};