function ForEach(e,t){if(Array.isArray(e))for(var n=0;n<e.length;n++){var o=t(e[n],n);if(!0===o)break}}function removeTailDiagonal(e){return e&&e.lastIndexOf("/")!=e.length-1&&(e+="/"),e}function getModulePackage(e){return e+".pkg"}var http=require("http"),Q=require("q"),FileSys=require("fs"),PathSys=require("path"),CoursewareObjectContextCreator=require("../../support/CoursewareObjectContext"),INTERACTION_BASE=CoursewareObjectContextCreator.root+"/interaction/",SUBJECT_TOOL_CONFIG=CoursewareObjectContextCreator.serverRoot+"/prepare/tool.json",EDITABLE_SUBJECT_TOOL_TEMPLATE="EditableSubjectTool",interationInfoList=[{code:"$RE0401",label:"连连看",module_type:"linkup",module_code:"linkup"},{code:"$RE0402",label:"排序题",module_type:"nd_order",module_code:"order"},{code:"$RE0403",label:"表格题",module_type:"nd_table",module_code:"table"},{code:"$RE0406",label:"字谜游戏",module_type:"nd_wordpuzzle",module_code:"word-puzzle"},{code:"$RE0407",label:"记忆卡片",module_type:"nd_memorycard",module_code:"memory-card"},{code:"$RE0408",label:"竖式计算",module_type:"nd_arithmetic",module_code:"arithmetic"},{code:"$RE0409",label:"比较大小",module_type:"nd_compare",module_code:"compare"},{code:"$RE0410",label:"猜词游戏",module_type:"nd_guessword",module_code:"guess-word"},{code:"$RE0411",label:"魔方盒游戏",module_type:"nd_magicbox",module_code:"magic-box"},{code:"$RE0414",label:"文本选择题",module_type:"nd_textselect",module_code:"text-select"},{code:"$RE0415",label:"分类题",module_type:"nd_classified",module_code:"classified"},{code:"$RE0416",label:"分式加减",module_type:"nd_fraction",module_code:"fraction"},{code:"$RE0418",label:"点排序",module_type:"nd_pointsequencing",module_code:"point-sequencing"},{code:"$RE0421",label:"选词填空题",module_type:"nd_fillblank",module_code:"fill-blank"},{code:"$RE0423",label:"连环填空",module_type:"nd_sequencefill",module_code:"sequence-fill"},{code:"$RE0424",label:"标签题",module_type:"nd_imagemark",module_code:"image-mark"},{code:"$RE0425",label:"划词标记",module_type:"nd_highlightmark",module_code:"highlight-mark"},{code:"$RE0426",label:"抽卡牌",module_type:"nd_probabilitycard",module_code:"probabilitycard"},{code:"$RE0427",label:"摸球",module_type:"nd_catchball",module_code:"catchball"},{code:"$RE0429",label:"天平",module_type:"nd_balance",module_code:"balance"},{code:"$RE0430",label:"植树",module_type:"nd_planting",module_code:"planting"},{code:"$RE0431",label:"模拟时钟",module_type:"nd_clock",module_code:"clock"},{code:"$RE0432",label:"方块塔",module_type:"nd_lego",module_code:"lego"},{code:"$RE0442",label:"拼图工具",module_type:"nd_puzzle",module_code:"puzzle"},{code:"$RE0446",label:"四格漫画",module_type:"nd_comicdialogue",module_code:"comicdialogue"},{code:"$RE0447",label:"数轴题",module_type:"nd_mathaxis",module_code:"mathaxis"},{code:"$RE0451",label:"连字拼诗",module_type:"nd_spellpoem",module_code:"spellpoem"},{code:"$RE0452",label:"区间题",module_type:"nd_intervalproblem",module_code:"intervalproblem"},{code:"$RE0448",label:"计数器",module_type:"nd_counter",module_code:"counter"},{code:"$RE0434",label:"英语句子发音评测",module_type:"nd_sentence_evaluat",module_code:"sentence_evaluat"},{code:"$RE0443",label:"英语句子发音评测",module_type:"nd_section_evaluating",module_code:"section_evaluating"},{code:"$RE0444",label:"算盘",module_type:"nd_abacus",module_code:"abacus"},{code:"$RE0449",label:"组词题",module_type:"nd_makeword",module_code:"makeword"},{code:"$RE0453",label:"思维导图",module_type:"nd_mindjet",module_code:"mindjet"},{code:"$RE0428",label:"英语单词发音评测",module_type:"nd_speechevaluating",module_code:"speechevaluating"},{code:"$RE0435",label:"图形切割",module_type:"nd_graphicscutting",module_code:"graphicscutting"},{code:"$RE0454",label:"立体展开还原",module_type:"nd_openshapetool",module_code:"openshapetool"}],generalToolsList=["nd_mindjet"],isGeneralTool=function(e){return generalToolsList.indexOf(e)>-1},unReeditableModuleTypes=["linkup","nd_memorycard","nd_order","nd_table","nd_arithmetic","nd_compare"],isUnsupportedReedit=function(e){return unReeditableModuleTypes.indexOf(e)>-1},getInteractionInfo=function(e){for(var t=0;t<interationInfoList.length;t++)if(interationInfoList[t].module_type==e)return interationInfoList[t];return{code:"",label:"学科工具",module_type:e,module_code:e}},getModuleCode=function(e){return getInteractionInfo(e).module_code},instanceSubjectToolData=function(e,t){var n={id:t,title:"学科工具"};if(FileSys.existsSync(SUBJECT_TOOL_CONFIG)){var o=FileSys.readFileSync(SUBJECT_TOOL_CONFIG);if(o){var a=JSON.parse(o.toString()),i=a[e];if(i){n.title=i.title;var l=i.init_model;if(l)for(var r in l)l.hasOwnProperty(r)&&(n[r]=l[r])}}}return n},instanceModuleData=function(e,t){var n;switch(e){case"nd_textselect":case"nd_arithmetic":case"nd_fraction":n={id:t,title:"",skin:{code:"",css_url:"",package_url:"",name:""},timer:{timer_type:"sequence",time_minute:null,time_second:null},prompt:null};break;case"nd_magicbox":n={id:t,title:"",skin:{code:"",css_url:"",package_url:"",name:""},timer:{timer_type:"sequence",time_minute:null,time_second:null},chars:[],border:{width:0,height:0},words:[]};break;case"nd_wordpuzzle":n={id:t,title:"",skin:{code:"",css_url:"",package_url:"",name:""},timer:{timer_type:"sequence",time_minute:null,time_second:null},border:{width:7,height:7},words:[],chars:[]};break;case"nd_fillblank":n={id:t,title:"",skin:{code:"",css_url:"",package_url:"",name:""},timer:{timer_type:"sequence",time_minute:null,time_second:null},candidates:[],article:""};break;case"nd_guessword":n={id:t,title:"",skin:{code:"",css_url:"",package_url:"",name:""},timer:{timer_type:"sequence",time_minute:null,time_second:null},items:null};break;case"nd_compare":n={id:t,title:"",skin:{code:"",css_url:"",package_url:"",name:""},items:null};break;case"nd_pointsequencing":n={id:t,title:"",skin:{code:"",css_url:"",package_url:"",name:""},timer:{timer_type:"sequence",time_minute:null,time_second:null},points:null,background:null};break;case"nd_classified":n={id:t,title:"",skin:{code:"",css_url:"",package_url:"",name:""},timer:{timer_type:"sequence",time_minute:null,time_second:null},categories:[{id:"",name:"",items:[]},{id:"",name:"",items:[]}],classified_options:[]};break;case"nd_imagemark":n={id:t,title:"",skin:{code:"",css_url:"",package_url:"",name:""},timer:{timer_type:"sequence",time_minute:null,time_second:null},background:"",image_item:{text:"",asset_type:"",asset:"",other:{}},mark_type:null,tags:null};break;case"nd_order":n={id:t,title:"",skin:{code:"",css_url:"",package_url:"",name:""},timer:{timer_type:"sequence",time_minute:null,time_second:null},items:[],description:{text:"",asset_type:"",asset:"",image_extend:{asset:"",image_extend:{resize:""}}}};break;case"nd_table":n={id:t,title:"",skin:{code:"",css_url:"",package_url:"",name:""},timer:{timer_type:"sequence",time_minute:null,time_second:null},horizontal_items:[""],vertical_items:["",""],items:[],description:{text:"",asset:"",image_extend:{rotate:"",resize:""}}};break;case"linkup":case"nd_memorycard":n={id:t,title:"",skin:{code:"",css_url:"",package_url:"",name:""},timer:{timer_type:"sequence",time_minute:null,time_second:null},module_subtype:"",items:[]};break;case"nd_puzzle":case"nd_mathaxis":case"nd_intervalproblem":n={id:t,title:"",skin:{code:"",css_url:"",package_url:"",name:""},timer:{timer_type:"sequence",time_minute:null,time_second:null},properties:[{name:"question_id",display_name:"题目ID",type:"string",value:"",is_localized:!1},{name:"question_url",display_name:"题目内容",type:"jsonFile",value:"",is_localized:!1}],content:{}};break;case"nd_comicdialogue":n={id:t,title:"",skin:{code:"",css_url:"",package_url:"",name:""},timer:{timer_type:"sequence",time_minute:null,time_second:null},content:{allow_addtip:!1,title:"",desc:"",background:{url:"",scale:1},dialogues:[]}};break;case"nd_spellpoem":n={id:t,module_code:"nd_spellpoem",title:"",skin:{code:"",css_url:"",package_url:"",name:""},timer:{timer_type:"sequence",time_minute:null,time_second:null},content:{title:"",author:"",dynasty:"",sentences:[{words:""},{words:""},{words:""},{words:""}]}};break;case"nd_mindjet":case"nd_graphicscutting":n={};break;default:n={id:t,title:"",skin:{code:"",css_url:"",package_url:"",name:""},timer:{timer_type:"sequence",time_minute:null,time_second:null},properties:[{name:"question_id",display_name:"题目ID",type:"string",value:"",is_localized:!1},{name:"question_url",display_name:"题目内容",type:"jsonFile",value:"",is_localized:!1}],content:{}}}return n},returnCommder=function(e,t,n,o){var a=getInteractionInfo(n.module_type),i={message:"QuestionAdd",id:n.module_instance_id,question_type:a.module_type,question_code:a.code,action:"save",file_path:PathSys.normalize(getInteractionBase(n.module_instance_id,e))},l="";return o||"true"===e.param("is_modify")?(i.message="QuestionSaved",l="PCInterface.questionEdit('"+JSON.stringify(i).replace(/\\/g,"\\\\")+"')"):l="PCInterface.questionInsert('"+JSON.stringify(i).replace(/\\/g,"\\\\")+"')",t.send({isInterface:!0,text:l})},isEditorDataFile=function(e){return"hint.json"!=e&&e.indexOf(".json")>-1},getInteractionBase=function(e,t){var n=t.param("file_path");if(n)return removeTailDiagonal(n);var o=t.param("question_base");return o?removeTailDiagonal(o)+getModulePackage(e)+"/":o=PathSys.join(INTERACTION_BASE,getModulePackage(e))+"/"},mkdirsSync=function(e,t){if(e&&!FileSys.existsSync(e)){e=PathSys.normalize(e);var n;e.split(PathSys.sep).forEach(function(e){if((n=n?PathSys.join(n,e):e)&&!FileSys.existsSync(n)&&!FileSys.mkdirSync(n,t))return!1})}return!0},copyDirectory=function(e,t){mkdirsSync(e),FileSys.readdirSync(t).forEach(function(n){var o=t+"/"+n;FileSys.lstatSync(o).isDirectory()?copyDirectory(e+"/"+n,o):copyFile(e+"/"+n,o)})},copyFile=function(e,t){var n=FileSys.createReadStream(t),o=FileSys.createWriteStream(e);n.pipe(o)},createInteractionBase=function(){mkdirsSync(INTERACTION_BASE)},copySpiritResource=function(e,t,n){var o,a=PathSys.join(__dirname,"../skins");o="linkup"==e?getInteractionBase(t,n)+"/_ref/linkup/spirit_root/":getInteractionBase(t,n)+"/_ref/memorycard/spirit_root/",FileSys.existsSync(o)||(mkdirsSync(o),"linkup"==e?(copyFile(o+"/default_img.jpg",a+"/linkup/wood/default_img.jpg"),copyFile(o+"/game_canvas_bg.png",a+"/linkup/wood/game_canvas_bg.png"),copyFile(o+"/skin.json",a+"/linkup/wood/skin.json"),copyDirectory(o+"/effects",a+"/linkup/wood/effects")):"nd_memorycard"==e&&(copyFile(o+"/default_img.jpg",a+"/memorycard/wood/default_img.jpg"),copyFile(o+"/game_canvas_bg.png",a+"/memorycard/wood/game_canvas_bg.png"),copyFile(o+"/game_canvas_ft.png",a+"/memorycard/wood/game_canvas_ft.png"),copyFile(o+"/skin.json",a+"/memorycard/wood/skin.json"),copyDirectory(o+"/effects",a+"/memorycard/wood/effects")))},createMetaData=function(e,t,n,o){n=n||{};var a=getInteractionInfo(e);if(a){var i={identifier:t,title:a.label,description:"<p>"+a.label+"</p>",language:"zh_CN",preview:{},tags:[],keywords:[],question_type:a.module_type,custom_properties:{question_type:a.module_type},categories:{res_type:[{identifier:"c2397920-3bb5-4269-9231-a5fade63ab0b",taxonpath:null,taxonname:"游戏化习题",taxoncode:"$RE0400"},{identifier:t,taxonpath:null,taxonname:a.label,taxoncode:a.code},{identifier:"55c21f2f-8715-4a96-bc45-7cd269bbd1ab",taxonpath:null,taxonname:"课件颗粒",taxoncode:"$RT0204"}],mediatype:[{identifier:null,taxonpath:"",taxonname:"其他媒体类型",taxoncode:"$F990000"}]},life_cycle:{version:"v1.0",status:"CREATED",enable:!0,creator:n.creator,publisher:null,provider:null,provider_source:null,create_time:(new Date).toISOString(),last_update:null},education_info:{interactivity:0,interactivity_level:0,end_user_type:null,semantic_density:null,context:null,age_range:null,difficulty:null,learning_time:null,description:null,language:null},relations:[{source:n.chapter_id,source_title:n.chapter_name,source_type:"chapters",relation_type:"ASSOCIATE"}],tech_info:{href:{format:"xml",size:0,location:"${ref-path}/edu/esp/coursewareobjects/"+getModulePackage(t)+"/main.xml",requirements:[],md5:null,entry:null}},copyright:{right:null,description:null,author:null}};return o&&(i.custom_properties.template_code=EDITABLE_SUBJECT_TOOL_TEMPLATE),i}return{}},readMetaData=function(e,t){var n=getInteractionBase(e,t)+"/metadata.json";if(FileSys.existsSync(n)){var o=FileSys.readFileSync(n);if(o)return JSON.parse(o.toString())}return null},updateMetaData=function(e,t){t&&(e.title=t,e.description="<p>"+t+"</p>"),e.life_cycle&&(e.life_cycle.last_update=(new Date).toISOString())},sendHttpGet=function(e,t,n){http.get(e,function(e){var o="",a=e.statusCode;e.on("data",function(e){o+=e}),e.on("end",function(){a>=200&&a<300?t&&t(o):n&&n(o)})}).on("error",function(){n&&n()}).end()};exports.forEach=ForEach,exports.instanceSubjectToolData=instanceSubjectToolData,exports.instanceModuleData=instanceModuleData,exports.getInteractionInfo=getInteractionInfo,exports.getModuleCode=getModuleCode,exports.isGeneralTool=isGeneralTool,exports.returnCommder=returnCommder,exports.isUnsupportedReedit=isUnsupportedReedit,exports.isEditorDataFile=isEditorDataFile,exports.getInteractionBase=getInteractionBase,exports.createInteractionBase=createInteractionBase,exports.mkdirsSync=mkdirsSync,exports.copyDirectory=copyDirectory,exports.copyFile=copyFile,exports.createMetaData=createMetaData,exports.readMetaData=readMetaData,exports.updateMetaData=updateMetaData,exports.copySpiritResource=copySpiritResource,exports.sendHttpGet=sendHttpGet;