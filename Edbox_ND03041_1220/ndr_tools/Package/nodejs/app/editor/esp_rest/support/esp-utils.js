function appendAdds(e,t,r){r=r||[];for(var a=0;a<r.length;a++)!function(a){var n=e.createElement("add");"*"===r[a].src?n.setAttribute("src",r[a].src):(n.setAttribute("type",r[a].type||"file"),n.setAttribute("src",r[a].src||"")),t.appendChild(n)}(a);return t}var path=require("path"),DOMParser=require("xmldom").DOMParser,pathVar=require("./path-var").PathVar;require("./js-ext");var FileUtils=require("./FileUtils"),resourceDependency=function(e,t,r,a,n){return"file"==e||"image"==e||"audio"==e||"video"==e||"flash"==e?0==t.indexOf("${ref-path}")||0==t.indexOf("${ref-base}")?(n.push(FileUtils.download(t,encodeURI(r),a)),0==t.indexOf("${ref-base}")?null:pathDependency(t)):null:"question"==e||"ppt"==e?{type:"package",src:path.dirname(t)}:void 0},pathDependency=function(e,t){var r=t||"pages",a=e.indexOf("?");-1!=a&&(e=e.substring(0,a));var n=path.extname(e);if(void 0==n||""==n||"pkg"==n)return{type:"package",src:e};var i="";return i=e.startsWith(pathVar.refPath)||e.startsWith(pathVar.refPathAddon)?e:e.startsWith(pathVar.refRelative)?e.replace(pathVar.refRelative,r):e.startsWith("../")?e.substring("../".length):e.startsWith("./")?path.join(r,e.substring("../".length)):path.join(r,e),{type:"file",src:i+"?size=1200"}},generateSdpPackage=function(e){var t=(new DOMParser).parseFromString('<?xml version="1.0" encoding="UTF-8"?>',"application/xml"),r=e.version||{},a=e.targets||[],n=t.createElement("package");n.setAttribute("version",r);for(var i=0;i<a.length;i++)!function(e){var r=a[e],i=t.createElement("target");i.setAttribute("name",r.name||"default"),i=appendAdds(t,i,r.adds);for(var p=r.groups||[],s=0;s<p.length;s++)!function(e){var r=t.createElement("group");r.setAttribute("name",p[e].name||""),r=appendAdds(t,r,p[e].adds),i.appendChild(r)}(s);n.appendChild(i)}(i);return t.appendChild(n),t.toString()},pathSlice=function(e,t){return e.substring(t.length,e.length).replace(new RegExp(/\\/g),"/")},pathProcess=function(e){return e.replace(new RegExp(/\\/g),"/")},isImage=function(e){if(e){return["bmp","gif","jpeg","jpg","png","psd","tiff","webp","svg"].contains(path.extname(e).toLowerCase())}return!1};module.exports.espUtil=function(){return{pack:{resourceDependency:resourceDependency,pathDependency:pathDependency,generateSdpPackage:generateSdpPackage},util:{pathSlice:pathSlice,pathProcess:pathProcess,isImage:isImage}}}();