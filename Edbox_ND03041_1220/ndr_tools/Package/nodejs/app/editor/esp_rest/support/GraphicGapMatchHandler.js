var Path=require("path"),uuid=require("node-uuid"),fs=require("fs"),Q=require("q"),ncp=require("ncp").ncp,sizeOf=require("image-size"),CoursewareObjectContextCreator=require("./CoursewareObjectContext"),FileUtils=require("./FileUtils"),RefPathHandler=require("./RefPathHandler"),imageSplitter=require("../common/ImageSplitter"),dealUrl=function(e,r){var t=r.refToFilePath(e);return Path.resolve(t)},readChunk=require("read-chunk"),fileType=require("file-type"),isNotJpg=function(e,r){if("gif"==e||"bmp"==e)return!0;var t=readChunk.sync(r,0,262),i=fileType(t);return i&&("gif"==i.ext||"bmp"==i.ext)},getTempPath=function(e,r){var t=Path.basename(r)+".jpg";return Path.join(e,"_temp",t)};exports.handleItem=function(e,r,t){if("graphicgapmatch"!=r.type)return Q.when();if(!r.graphchange)return Q.when();var i=Path.join(t.basepath,"resources"),a=r.object.params.blankImage||t.fileToRefUrl(Path.join(i,"background.jpg")),n={rows:r.rows,columns:r.columns,blankImage:a,originalImage:r.object.data};r.object.params=n;var o=Path.resolve(t.refToFilePath(r.object.data)),s=FileUtils.getSuffix(o),h=FileUtils.getPrefix(o)+".jpg";return(isNotJpg(s,o)?FileUtils.copy(o,h,!0,!0):Q.when(o)).then(function(a){var n=sizeOf(a);return r.object.width=n.width,r.object.height=n.height,imageSplitter.split(a,r.rows,r.columns,i,r.sequence).then(function(a){for(var n=[],o=[],s=[],h=0;h<r.rows;h++)for(var u=a[h],p=0;p<r.columns;p++){var l=u[p],f=t.fileToRefUrl(Path.join(i,l.fileName)),c="GAP_"+(h+1)+"_"+(p+1),g="HOTSPOT_"+(h+1)+"_"+(p+1);n.push({type:"",width:Math.round(l.width),height:Math.round(l.height),data:f,identifier:c,text:c}),o.push({identifier:g,shape:"rect",coords:Math.round(l.left)+","+Math.round(l.top)+","+Math.round(l.right)+","+Math.round(l.bottom)}),s.push(c+" "+g)}if(r.gap_imgs=n,r.associable_hotspots=o,e.responses)for(var d=0;d<e.responses.length;d++)if(r.response_identifier===e.responses[d].identifier){e.responses[d].corrects=s;break}})})};