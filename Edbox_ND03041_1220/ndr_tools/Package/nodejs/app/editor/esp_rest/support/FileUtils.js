function NormalizeURL(e){if(e&&/.*[\u4e00-\u9fa5]+.*$/.test(e)){var t=e.indexOf("?");return t>-1?encodeURI(e.substring(0,t))+e.substring(t):encodeURI(e)}return e}var Path=require("path"),Fs=require("fs"),Q=require("q"),mkdirp=require("mkdirp"),ncp=require("ncp").ncp,http=require("http"),imageSize=require("image-size"),sizeOf=function(e){try{return imageSize(e)}catch(e){return{width:0,height:0}}};try{convertImage=require("./convertImage.node")}catch(e){console.log(e),convertImage=function(e,t,r,n,i){if(e==t)return void setTimeout(function(){i(!0,"")});var o=Q.defer();e.lastIndexOf("\\")!=e.length-1&&e.lastIndexOf("//")!=e.length-1||(e=e.substring(0,e.length-1)),storeFile(e,t,!0,o),o.promise.then(function(){setTimeout(function(){i(!0,"")})})}}var csServer="http://cs.101.com/v0.1/static",$i18n=require("../support/i18n").i18n,uuid=require("node-uuid"),CoursewareObjectContextCreator=require("../support/CoursewareObjectContext"),FileUtils=this,join=function(){var e=arguments;if(e[0]&&-1!=e[0].indexOf("http://")){for(var t="",r=0;r<arguments.length;r++)if(0!=r){var n=e[r];0==n.indexOf("/")&&(n=n.substring(1)),t+="/"+n}else t=e[r];return t}return Path.join.apply(null,e)};exports.join=join;var saveToFile=function(e,t){var r=Path.dirname(e);return(t.then?t:Q.when(t)).then(function(t){return mkdir(r).then(function(){return Q.nfcall(Fs.writeFile,e,t)})})},readFile=function(e,t){return-1!=e.indexOf("http://")?readFromNetwork(e):t?Q.nfcall(Fs.readFile,e):Q.nfcall(Fs.readFile,e,"utf-8")},readFromNetwork=function(e){var t=Q.defer();http.get(e,function(e){var r="";e.on("data",function(e){r+=e}),e.on("end",function(){t.resolve(r)})}).end();return t.promise},endsWith=function(e,t){return e.lastIndexOf(t)==e.length-t.length},eachFile=function(e,t,r){return r||(r=function(e){return endsWith(e,"json")||endsWith(e,"xml")}),Q.nfcall(Fs.lstat,e).then(function(n){if(n.isSymbolicLink())return Q.when();if(n.isFile()){var i=e.toLowerCase();return r(i)?t(e):Q.when()}if(n.isDirectory()){var o=Q.defer();return Fs.readdir(e,function(n,i){for(var s=[],u=0;u<i.length;u++)s.push(eachFile(FileUtils.join(e,i[u]),t,r));Q.all(s).then(function(){o.resolve()},function(e){o.reject(e)})}),o.promise}})},mkdir=function(e){var t=Q.defer();return mkdirp(e,function(r){r?t.reject(r):t.resolve(e)}),t.promise};exports.mkdir=mkdir,exports.download=function(e,t,r){var n="";return n=0==e.indexOf("${ref-path}")?e.replace("${ref-path}",FileUtils.join(r.basepath,"_ref")):r.isBasic?e.replace("${ref-base}",r.basepath):e.replace("${ref-base}/..",r.basepath),exports.exists(n).then(function(e){return e||!t?Q.when():(0!=t.indexOf("http://")&&(t="http://localhost:3001"+t),exports.copy(t,n))})},exports.getSuffix=function(e){return-1!=e.lastIndexOf(".")?e.substring(e.lastIndexOf(".")+1).toLowerCase():""},exports.getPrefix=function(e){return-1!=e.lastIndexOf(".")?e.substring(0,e.lastIndexOf(".")-1):e};var storeFile=function(e,t,r,n){-1!=t.indexOf("?")&&(t=t.substring(0,t.indexOf("?")));var i=Fs.createReadStream(e),o=Fs.createWriteStream(t);i.pipe(o).on("finish",function(i){if(i)return void n.reject($i18n("server.error.file.save"),i);if(!r)try{Fs.unlinkSync(e)}catch(e){}n.resolve(t)})};exports.copy=function(e,t,r,n){var i=Q.defer(),o=exports.getSuffix(t),s=!1;"gif"!=o&&"jpg"!=o&&"jpeg"!=o&&"png"!=o&&"bmp"!=o||(s=!0);var u=Path.dirname(t);return mkdir(u).then(function(){if(0!=e.indexOf("http"))if(s){var o=sizeOf(e),u=o.width,f=o.height;if(n=n||Fs.statSync(e).size>1048576,u>1620||f>1350||n){var a=Math.min(1620/u,1350/f);a>1&&(a=1),convertImage(e,t,a,n||!1,function(n,o){n?(i.resolve(t),r||Fs.unlinkSync(e)):i.reject(o),setTimeout(function(){},30)})}else storeFile(e,t,r,i)}else storeFile(e,t,r,i);else{var c=FileUtils.join(Path.dirname(t),uuid.v4()+"_temp"),l=Fs.createWriteStream(c);http.get(NormalizeURL(e),function(e){e.pipe(l),l.on("finish",function(){l.close(function(){if(s){var e=sizeOf(c),r=e.width,o=e.height;if(n=n||Fs.statSync(c).size>1048576,r>1620||o>1350||n){var u=Math.min(1620/r,1350/o);u>1&&(u=1),convertImage(c,t,u,n||!1,function(e,r){e?i.resolve(t):i.reject(r),setTimeout(function(){},30),Fs.unlinkSync(c)})}else storeFile(c,t,!1,i)}else storeFile(c,t,!1,i)})}),l.on("error",function(e){fs.unlink(dest),i.reject(e)})}).end()}}),i.promise},exports.exists=function(e){var t=Q.defer();return-1!=e.indexOf("?")&&(e=e.substring(0,e.indexOf("?"))),Fs.exists(e,function(e){t.resolve(e)}),t.promise},exports.existsAll=function(e,t){if(!t||0==t.length)return Q.when(!0);if(-1!=e.indexOf("http://"))return Q.when(!0);for(var r=[],n=0;n<t.length;n++)r.push(exports.exists(FileUtils.join(e,t[n])));return Q.all(r).then(function(e){for(var t=0;t<e.length;t++)if(!e[t])return!1;return!0})},exports.copyFolder=function(e,t){return mkdir(t).then(function(){var r=Q.defer();return ncp.limit=16,ncp(e,t,function(e){e?r.reject(e):r.resolve()}),r.promise})},exports.saveToFile=saveToFile,exports.readFile=readFile,exports.eachFile=eachFile;