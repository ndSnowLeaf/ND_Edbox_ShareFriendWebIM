function getRootPath(){var e=null;if(process.argv.forEach(function(t,i,n){t&&0==t.indexOf("path=")&&(e=t.substring("path=".length),console.log("find path ",e))}),e)return e;var t=Path.join(serverRoot,"../../../Setting/JsonConfig.dat");if(Fs.existsSync(t)){var i=Fs.readFileSync(t,"utf-8").trim();try{var n=JSON.parse(i);if(n&&n.config&&n.config.NDCloudPath){var o=n.config.NDCloudPath;return console.log("find path ",o),Path.join(o,"NDCloud/Question")}}catch(e){console.log(e)}}var r=Path.join(serverRoot,"../../../Setting/config.ini");if(Fs.existsSync(r)){var i=ini.parse(Fs.readFileSync(r,"utf-8")),o=i.getValue("NDCloudPath".toLowerCase());if(o)return console.log("find path ",o),Path.join(o,"NDCloud/Question")}return Path.join(serverRoot,"/userdatas/edu/esp")}function isPublicQuestion(e){return!!(e&&e.tech_info&&e.tech_info.href&&e.tech_info.href.location)&&-1!=e.tech_info.href.location.indexOf("edu_product/esp")}function isBasicQuestion(e){if(!e||!e.categories||!e.categories.res_type)return!1;var t=e.custom_properties;if(t&&t.question_tech_type)return"basic"===t.question_tech_type;for(var i=e.categories.res_type,n=0;n<i.length;n++){if(-1!=i[n].taxoncode.indexOf("$RE02"))return!0}return!1}var uuid=require("node-uuid"),Path=require("path"),Q=require("q"),Fs=require("fs"),ini=require("./ini"),serverRoot=Path.normalize(Path.join(__dirname,"../../..")),root=getRootPath(),BaseQuestionDefaultPath=Path.join(root,"questions"),InteractQuestionDefaultPath=Path.join(root,"interaction"),TemplateCreator=require("./template"),FileUtils=require("./FileUtils");console.log("init root path ");var Context=function(e,t,i,n){this.id=e,this.basepath=-1!=t.indexOf("http://")?t:Path.normalize(t),this.isBasic=i,this.isPublic=n};Context.prototype.fileToRefUrl=function(e){e=Path.normalize(e);var t=Path.normalize(FileUtils.join(this.basepath,"_ref"));return 0==e.indexOf(t)?FileUtils.join("${ref-path}",e.replace(t,"")).replace(/\\/g,"/"):0==e.indexOf(this.basepath)?("${ref-base}"+(this.isBasic?"":"/..")+e.replace(this.basepath,"")).replace(/\\/g,"/"):e},Context.prototype.fileToUrl=function(e,t){if(e=Path.normalize(e),t)return"/v2.0/assets/get?file_path="+encodeURIComponent(this.basepath)+"&file_name="+encodeURIComponent(e.replace(this.basepath,""));if(-1==e.indexOf(serverRoot)){return("/v2.0/assets/proxy3/"+new Buffer(this.basepath).toString("base64")+e.replace(this.basepath,"")).replace(/\\/g,"/")}return e.replace(serverRoot,"").replace(/\\/g,"/")},Context.prototype.refToFilePath=function(e){return-1!=e.indexOf("${ref-path}")?FileUtils.join(this.basepath,"_ref",e.replace("${ref-path}","")):(this.isBasic||(e=e.replace("..","")),FileUtils.join(this.basepath,e.replace("${ref-base}","")))},Context.prototype.distpath=function(e,t){return e=Path.normalize(e),FileUtils.join(t,e.replace(this.basepath,"")).replace(/\\/g,"/")},exports.createContext=function(e,t){var i=uuid.v4(),n=e.query.file_path;return Array.isArray(n)&&n.length>0&&(n=n[0]),TemplateCreator.createTemplate(t).then(function(e){return FileUtils.readFile(FileUtils.join(e.templateDir,"meta.json")).then(function(e){var t=JSON.parse(e);return t&&"basic_question"==t.categoryCode?n?Q.when(new Context(i,Path.normalize(FileUtils.join(n,i+".pkg")),!0)):Q.when(new Context(i,FileUtils.join(BaseQuestionDefaultPath,i+".pkg"),!0)):n?Q.when(new Context(i,Path.normalize(FileUtils.join(n,i+".pkg")),!1)):Q.when(new Context(i,FileUtils.join(InteractQuestionDefaultPath,i+".pkg"),!1))})})},exports.createEmptyContext=function(e,t){return e||(e=uuid.v4()),Q.when(new Context(e,FileUtils.join(t?BaseQuestionDefaultPath:InteractQuestionDefaultPath,e+".pkg"),t))};var createContextByFilePath=function(e){return FileUtils.readFile(FileUtils.join(e,"metadata.json")).then(function(t){var i=JSON.parse(t),n=isBasicQuestion(i),o=isPublicQuestion(i);return Q.when(new Context(i.identifier,e,n,o))})};exports.getContext=function(e,t){var i=e.query.file_path;if(!i){var n=e.query.id||e.params.id,o=e.query.question_base;o&&(i=FileUtils.join(o,n+".pkg"))}if(i)return createContextByFilePath(i);var n=e.query.id||e.params.id,r=FileUtils.join(BaseQuestionDefaultPath,n+".pkg","metadata.json");return FileUtils.exists(r).then(function(e){var t=e?FileUtils.join(BaseQuestionDefaultPath,n+".pkg"):FileUtils.join(InteractQuestionDefaultPath,n+".pkg");return createContextByFilePath(t)})},exports.getInteractionContext=function(e,t){var i=t.param("question_base");return i||(i=FileUtils.join(InteractQuestionDefaultPath,e+".pkg")),new Context(e,i,!1)},exports.toUrl=function(e){return e=Path.normalize(e),e.replace(serverRoot,"").replace(/\\/g,"/")},exports.serverRoot=serverRoot,exports.root=root,exports.setDefaultRoot=function(e){root=e,BaseQuestionDefaultPath=Path.join(root,"questions"),InteractQuestionDefaultPath=Path.join(root,"interaction")};