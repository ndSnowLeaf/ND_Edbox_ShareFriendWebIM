var refbase="${ref-base}",fs=require("fs"),Q=require("q"),$i18n=require("../../support/i18n").i18n;exports.toRefpath=function(e,r){return e=e.replace(/\/v1\.3\/assets\/get\?(.*?)filepath=(.*?)['|"|\\|>]/gi,function(e){var r=e.indexOf("filepath=");return e=e.substring(r+"filepath=".length),refbase+e}),e=e.replace(/\/v1\.3\/assets\/get\?(.*?)filepath=(.*?)/gi,function(e){var r=e.indexOf("filepath=");return e=e.substring(r+"filepath=".length),refbase+e})},exports.fromRefpath=function(e,r,t){for(var s=t.param("question_base"),a=s?"&question_base="+s:"",n=e.replace(refbase,"/v1.3/assets/get?question_id="+r+a+"&filepath=");n!=e;)e=n,n=e.replace(refbase,"/v1.3/assets/get?question_id="+r+a+"&filepath=");return e},exports.fromRefpath2=function(e,r){for(var t=e.toGetUrl(),s=r.replace(refbase,t);s!=r;)r=s,s=r.replace(refbase,t);return r};var createMoveFile=function(e,r,t){var s=e.indexOf("${ref-path}"),a=e.substring(e.lastIndexOf("/")+1);str=e.substring(s+"${ref-path}".length);var n=str.substring(str.length-1);'"'!=n&&"/"!=n&&"'"!=n&&"\\"!=n&&">"!=n&&")"!=n||(str=str.substring(0,str.length-1));for(var f=0;f<t.length;f++)if(t[f].source==str){r=t[f].prefix;var i={source:t[f].src,target:""!=r?r+"_"+a:a,prefix:r+"_",nocopy:!0};return i}return{source:str,target:""!=r?r+"_"+a:a,prefix:r}},formtFilePath=function(e){return-1!=e.indexOf("?")&&(e=e.substring(0,e.indexOf("?"))),e},moveOneFile=function(e,r,t,s,a){var n=Q.defer(),f=s.getQuestionBase(t,a),i=f+"/_ref"+e,o=r.substring(r.length-1);'"'!=o&&"/"!=o&&"'"!=o&&"\\"!=o&&">"!=o&&")"!=o||(r=r.substring(0,r.length-1));var u=f+"/resources/"+r;if(fs.existsSync(formtFilePath(i))){var p=fs.createReadStream(formtFilePath(i)),l=fs.createWriteStream(formtFilePath(u));return p.pipe(l).on("finish",function(e){if(e)return void n.reject($i18n("server.error.file.save"),e);try{fs.unlinkSync(i)}catch(e){console.log(e)}n.resolve()}),n.promise}return n.resolve(),n.promise},refPathToRefBaseRegexReplace=function(e,r,t,s,a){var n=(new Date).getTime(),f=1;return e=e.replace(/\$\{ref-path\}(.*?)['|"|\\|>|)]/gi,function(e){var t=r+".pkg/",s=-1!=e.indexOf(t),i=createMoveFile(e,s?"":n+"_"+f,a);return a.push(i),f++,refbase+"/resources/"+i.target}),e=e.replace(/\$\{ref-path\}(.*?)/gi,function(e){var t=r+".pkg/",s=-1!=e.indexOf(t),i=createMoveFile(e,s?"":n+"_"+f,a);return a.push(i),f++,refbase+"/resources/"+i.target})};exports._refPathToRefBaseRegexReplace=refPathToRefBaseRegexReplace,exports.refPathToRefBase=function(e,r,t,s){var a=[];e=refPathToRefBaseRegexReplace(e,r,t,s,a);for(var n=[],f=0;f<a.length;f++)a.nocopy||n.push(moveOneFile(a[f].source,a[f].target,r,t,s));return Q.all(n).then(function(){return e})};