function getClientIp(e){var t,r=e.headers["x-forwarded-for"];if(r){t=r.split(",")[0]}return t||(t=e.connection.remoteAdress),t||(t=e.socket.remoteAdress),t||(t=e.connection.socket?e.connection.socket.remoteAdress:e.headers.remote_addr?e.headers.remote_addr:e.headers.client_ip?e.headers.client_ip:e.ip),t}var WebSocket=require("faye-websocket"),fs=require("fs"),http=require("http"),log4js=require("log4js"),path=require("path");log4js.configure({appenders:[{type:"file",filename:__dirname+"/server.log",maxLogSize:1048576,backups:3}]});var logger=log4js.getLogger(path.basename(__filename)),INTI_STATE={eventName:"",eventData:{syncId:"",toolKey:"",updateInfo:{},toolState:{}}},port=7001,state=INTI_STATE,wsArray=[],emit=function(e,t){wsArray&&wsArray.forEach(function(r){if(r!=t){var o=JSON.stringify(e);r.send(o),logger.info("发送的消息"+o)}})},upgradeHandler=function(e,t,r){var o=new WebSocket(e,t,r);logger.info("[open websocket]",o.url),wsArray.push(o),logger.info("已连接，目前连接数:"+wsArray.length),state&&state.eventData&&state.eventData.toolKey?(state.eventName="addTool",o.send(JSON.stringify(state)),logger.info("发送状态信息"+JSON.stringify(state))):logger.info("当前没有工具状态"+JSON.stringify(state)),o.onmessage=function(e){logger.info("收到信息"+e.data);try{var t=JSON.parse(e.data);if(logger.info("收到信息的类型"+t.eventName),t&&t.eventName&&t.eventData)switch(t.eventName){case"addTool":case"updateTool":state=t,emit(state,o);break;case"closeTool":state=t,emit(state,o),state=INTI_STATE;break;default:logger.info("收到的消息无法解析：类型不正确")}else logger.info("收到的消息无法解析：缺少类型或内容")}catch(e){logger.info("收到的消息无法解析:"+e)}},o.onclose=function(e){logger.info("[close upgrade]",e.code,e.reason);var t=wsArray.indexOf(o);t>-1&&(wsArray.splice(t,1),logger.info("一个连接断开，目前连接数:"+wsArray.length)),o=null}},requestHandler=function(e,t){if(logger.info("[open request]"),!WebSocket.EventSource.isEventSource(e))return staticHandler(e,t);ws.onclose=function(e){logger.info("[close request]",e.code,e.reason);var t=wsArray.indexOf(ws);t>-1&&(wsArray.splice(t,1),logger.info("一个连接断开，目前连接数:"+wsArray.length)),ws=null}},staticHandler=function(e,t){var r=e.url;if(logger.info("path:"+r),"/close"==r)return state.eventName="closeTool",emit(state),logger.info("下课，清理消息"),state=INTI_STATE,t.writeHead(200,{"Content-Type":"text/html"}),t.write("class is over. clear tool "),void t.end();fs.readFile(__dirname+r,function(e,r){var o=e?404:200;t.writeHead(o,{"Content-Type":"text/html"}),t.write(r||"Not found"),t.end()})};module.exports.run=function(){var e=http.createServer();logger.info("启动服务器.."),e.on("request",requestHandler),e.on("upgrade",upgradeHandler),e.listen(port)};