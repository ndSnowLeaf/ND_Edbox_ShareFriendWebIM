"use strict";var RingBuffer=require("./ring_buffer"),Functor=function(e,t){this._session=e,this._method=t,this._queue=new RingBuffer(Functor.QUEUE_SIZE),this._stopped=!1,this.pending=0};Functor.QUEUE_SIZE=8,Functor.prototype.call=function(e,t,s,o){if(!this._stopped){var n={error:e,message:t,callback:s,context:o,done:!1},u=!1,r=this;if(this._queue.push(n),n.error)return n.done=!0,this._stop(),this._flushQueue();this._session[this._method](t,function(e,t){u^(u=!0)&&(e?(r._stop(),n.error=e,n.message=null):n.message=t,n.done=!0,r._flushQueue())})}},Functor.prototype._stop=function(){this.pending=this._queue.length,this._stopped=!0},Functor.prototype._flushQueue=function(){for(var e,t=this._queue;t.length>0&&t.peek().done;)this.pending-=1,e=t.shift(),e.callback.call(e.context,e.error,e.message)},module.exports=Functor;