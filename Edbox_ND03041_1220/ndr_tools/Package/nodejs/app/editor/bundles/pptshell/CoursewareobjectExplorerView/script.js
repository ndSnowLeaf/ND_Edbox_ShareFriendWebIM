define(["jquery","angular","espEnvironment","espService","i18n!","json!/prepare/mapping","./qtiPlayerDirective","text!./template.html","angular-prompter","angular-slides","css!./style.css"],function($,angular,espEnvironment,espService,i18n,templateResourceTypeMapping,qtiPlayerDirective,template){return function(){return{name:"nd.esp.resource.CoursewareobjectExplorerView",title:"颗粒浏览",render:function(view,viewConfig){function Controller($scope,$http,$q,$prompter,$timeout){function search(){if($scope.keyword){var exists=!1;angular.forEach($scope.keywordHistory,function(k){if(k==$scope.keyword)return exists=!0,!1}),exists||$scope.keywordHistory.push($scope.keyword)}$scope.pagination.page=1,doLoad(1)}function load(){doLoad($scope.pagination.page)}function doLoad(page){var url;url=$scope.isBasic?espEnvironment.url.externalRoot("slidesServer")("/v1.3/questions",{page:page,size:$scope.pagination.size,words:$scope.keyword,coverage:$scope.coverage,chapter_id:$scope.chapterId,question_type:$scope.resourceTypeOption.value}):espEnvironment.url.externalRoot("slidesServer")("/v1.3/courseware_objects",{page:page,size:$scope.pagination.size,words:$scope.keyword,coverage:$scope.coverage,chapter_id:$scope.chapterId,category:$scope.resourceTypeOption.value});$http({url:url,method:"GET",cache:!1}).success(function(result){var items=$scope.items=result.items;angular.forEach(items,processItem),$scope.pagination.totalSize=result.total_count}).error(function(e){var errorMsg=err&&err.message;errorMsg||(errorMsg=i18n.translate("common.hint.http.defaulterror")),$prompter.error(errorMsg)}).finally($prompter.wait("正在加载数据..."))}function processItem(item){if(item.categories&&item.categories.res_type)for(var resTypes=item.categories.res_type,i=0;i<resTypes.length;i++){var resType=resTypes[i];if(resType.taxoncode&&resType.taxoncode.lastIndexOf("00")!=resType.taxoncode.length-2){item.resTypeCode=resType.taxoncode;break}}if($scope.isBasic){for(var i=0;i<$scope.resourceTypeOptions.length;i++){var rto=$scope.resourceTypeOptions[i];if(rto.value==item.resTypeCode){item.title=rto.name;break}}fetchItemAnswer(item)}var href=item.tech_info&&item.tech_info.nd_href&&item.tech_info.nd_href.location||item.tech_info&&item.tech_info.href&&item.tech_info.href.location;if(href){var index=href.lastIndexOf("/");-1!=index&&(href=href.substring(0,index)+($scope.isBasic?"/item.json":"/main.xml"))}item.href=espEnvironment.createReferenceUrlResolver().parse(href);var previewImageHref=item.preview&&(item.preview.big||item.preview.small||item.preview.coursewareobjects_big||item.preview.coursewareobjects_small);previewImageHref&&(item.previewImageHref=espEnvironment.createReferenceUrlResolver().parse(previewImageHref))}function fetchItemAnswer(item){if("$RE0204"!=item.resTypeCode&&"$RE0205"!=item.resTypeCode&&"$RE0207"!=item.resTypeCode){var url=item.tech_info&&item.tech_info.href&&item.tech_info.href.location;if(url){url=espEnvironment.createReferenceUrlResolver().parse(url);var index=url.lastIndexOf("/");-1!=index&&(url=url.substring(0,index+1)+"item.json"),$http.get(url).success(function(result){result&&result.feedbacks&&(item.response="<div>",angular.forEach(result.responses,function(response,i){0!=i&&(item.response+="<br/>");var corrects=[];angular.forEach(response.corrects,function(c){corrects.push("YES"==c?"是":"NO"==c?"否":c)}),item.response+=corrects.join(",")}),item.response+="</div>",angular.forEach(result.feedbacks,function(feedback){"showAnswer"==feedback.identifier?item.contentAnswer=espEnvironment.createReferenceUrlResolver().parseHtml(feedback.content):"showHint"==feedback.identifier&&(item.contentHint=feedback.content)}))})}}}function play(item){angular.forEach($scope.items,function(oItem){oItem.playing=!1,oItem.playerLoaded=!1,oItem.previewHref="about:blank"}),item.playing=!0,item.answerShowed=!1,item.previewHref=espEnvironment.url.coursewareobjectPreviewByMain(item.href)}function onPlayerLoad(item){item.playerLoaded=!0}function cleanKeyword(){$scope.keyword=""}function setKeyword(keyword){$scope.keyword=keyword,search()}function cleanKeywordHistory(){$scope.keywordHistory=[]}function selectResourceType(option){$scope.resourceTypeOption=option,search()}function showAnswer(item){if($scope.isBasic)item.contentAnswerExpand=!item.contentAnswerExpand;else{item.answerShowed=!0;var iframe=angular.element("#iframe_"+item.identifier)[0],player=iframe&&iframe.contentWindow.player;player&&player.getPlayerServices().startFlow("PreviewShowCorrectAnswer")}}function edit(item){callInterface(item,"question_edit")}function insert(item){callInterface(item,"question_insert")}function callInterface(item,message){var code,type,resTypes=item.categories&&item.categories.res_type||[];angular.forEach(resTypes,function(resType){if(angular.forEach(templateResourceTypeMapping,function(mappings){if(angular.forEach(mappings,function(mapping){if(resType.taxoncode==mapping.code)return code=mapping.code,type=mapping.type,!1}),code)return!1}),code)return!1});var text=JSON.stringify({message:message,question_id:item.identifier,question_online:!0,question_store:"Org/nd/"==$scope.coverage?"question_library":0==$scope.coverage.indexOf("User")?"question_disk":"question_school",question_tags:$scope.isBasic?"basic_question":"interact_question",question_type:type,question_code:code,question_title:item.title,question_path:item.href,question_last_update:item.life_cycle.last_update,old_question_id:"",old_question_path:""});console.log("call PCInterface.questionAction: ",text),window.PCInterface&&window.PCInterface.questionAction(text)}$scope.category="interaction"==espEnvironment.location.params.category?"interaction_question":"basic_question",$scope.isBasic="basic_question"==$scope.category,$scope.coverage=espEnvironment.location.params.coverage||"Org/nd/",$scope.chapterId=espEnvironment.location.params.chapterId||"",$scope.pagination={page:1,size:5},$scope.keyword,$scope.keywordHistory=[],$scope.cleanKeyword=cleanKeyword,$scope.setKeyword=setKeyword,$scope.cleanKeywordHistory=cleanKeywordHistory,$scope.resourceTypeOptions=[],$scope.resourceTypeOption,$scope.selectResourceType=selectResourceType,$scope.load=load,$scope.search=search,$scope.items=[],$scope.showAnswer=showAnswer,$scope.play=play,$scope.onPlayerLoad=onPlayerLoad,$scope.edit=edit,$scope.insert=insert,function(){var basicQuestionResourceTypes=[];angular.forEach(espEnvironment.coursewareobjectTemplateDefines,function(define){if(define.categoryCode==$scope.category){if("false"===define.show||!1===define)return;if(!define.resourceType)return void console.log("no resource type:"+define);$scope.resourceTypeOptions.push({name:define.name,value:define.resourceType}),$scope.isBasic&&basicQuestionResourceTypes.push(define.resourceType)}}),$scope.resourceTypeOptions.unshift({name:"全部类型",value:$scope.isBasic?basicQuestionResourceTypes.join(","):"$RE04*",isAll:!0}),$scope.resourceTypeOption=$scope.resourceTypeOptions[0],search(),$timeout(function(){document.body.clientWidth<650&&(console.log("last",document.body.clientWidth/650,document.body.clientWidth/650*24),$scope.rootStyle={"font-size":document.body.clientWidth/650*24+"px"})})}()}angular.quickstart(view.element,{template:template,controller:Controller},["slides","prompter",{translate:i18n},function(module){module.directive("qtiPlayer",qtiPlayerDirective)}]),Controller.$inject=["$scope","$http","$q","$prompter","$timeout"]}}}});