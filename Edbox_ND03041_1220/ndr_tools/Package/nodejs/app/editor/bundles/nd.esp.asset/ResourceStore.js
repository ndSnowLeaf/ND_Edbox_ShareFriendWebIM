define(["jquery","espEnvironment","espService"],function($,espEnvironment,espService){function adjustData(metadata,type){var item={title:metadata.title,type:type};if(item.format=metadata.tech_info&&metadata.tech_info.href&&metadata.tech_info.href.format,item.href=urlResolver.parse(metadata.tech_info&&metadata.tech_info.href&&metadata.tech_info.href.location||""),metadata.preview)for(var key in metadata.preview)if(item.thumbHref=urlResolver.parse(metadata.preview[key]),"120"===key||"240"===key)break;if(item.thumbHref||"$RA0101"==type&&(item.thumbHref=item.href+"?size=240"),metadata.tech_info&&metadata.tech_info.href&&metadata.tech_info.href.requirements&&metadata.tech_info.href.requirements.length)for(var i=0;i<metadata.tech_info.href.requirements.length;i++){var x=metadata.tech_info.href.requirements[i];if("resolution"==x.name){item.resolution=x.value;var parts=item.resolution&&item.resolution.split("*");parts&&2==parts.length&&(item.width=parseInt(parts[0]),item.height=parseInt(parts[1]))}else"duration"==x.name?item.duration=x.value:"code"==x.name&&(item.code=x.value)}return item.size=metadata.tech_info&&metadata.tech_info.href&&metadata.tech_info.href.size,item}var urlResolver=espEnvironment.createReferenceUrlResolver();return function(name,title,coverage,uploadEnabled){return{name:name||"asset",title:title,order:1,paging:15,uploadEnabled:!1!==uploadEnabled,processUploadResponse:function(response,type){return adjustData(response,type)},uploadOptions:{url:espService.asset.getUploadUrl(),multipart_params:{coverage:coverage}},getDataList:function(params){return espService.asset.list($.extend({max_size:15728640,page:1,size:20,coverage:$.isFunction(coverage)?coverage():coverage},params)).then(function(result){for(var items=[],i=0;i<result.items.length;i++)items.push(adjustData(result.items[i],params.type));return{total_count:result.total_count,items:items}})}}}});