define(["jquery","i18n!","espEnvironment","espService","espModel","prompter","../PageStage/script","css!./style.css"],function($,i18n,espEnvironment,espService,espModel,prompter,PageStage){var templates={preview:'<div class="slides-coursewareobject-general-preview"></div>',editor:'<div class="slides-coursewareobject-general-editor"><div class="_body">   <div class="_toolbar"></div>   <div class="_stage-wrap"></div>   <div class="_footbar">       <button class="_preview" translage>view.toolbar.preview</button>       <button class="_save _primary" translate>toolbar.save</button>       <button class="_insert _primary" translate>common.label.insert</button>   </div></div></div>'};return function(){this.name="nd.esp.coursewareobject.GeneralEditor",this.supportTypes=["coursewareobject"],this.render=function(editor,resource,config){function renderPreview(){previewRendered||(previewRendered=!0,$("<iframe></iframe>").appendTo(previewEl)),previewEl.children("iframe").attr("src",espEnvironment.url.coursewareobjectPreview(resource.data.identifier,config&&config.playerCode))}function renderEditor(){function resetSize(){return}function save(){if(!pageStage)return $.Deferred().reject(i18n.translate("no_ready"));var writeMode=espEnvironment.writeMode||"";if("yes"===writeMode)return pageStage.save().then(function(){return coursewareobjectMetadata.identifier});if(0===writeMode.indexOf("copy")){var newIdentifier=writeMode.substring(5)||"$temp";return espModel.repository.coursewareobject(coursewareobjectMetadata.identifier).copyAs(newIdentifier).then(function(identifier){return pageStage.save().then(function(){return identifier})})}return $.Deferred().reject(i18n.translate("not_allow_write"))}if(!editorRendered){editorRendered=!0,setTimeout(function(){},0),$(window).resize(resetSize);var pageStage,coursewareobjectMetadata=resource.data,outerMessage={message:"QuestionSaved",id:coursewareobjectMetadata.identifier,action:"save",question_type:coursewareobjectMetadata.custom_properties&&coursewareobjectMetadata.custom_properties.question_type,question_code:coursewareobjectMetadata.categories&&coursewareobjectMetadata.categories.res_type&&coursewareobjectMetadata.categories.res_type[0]&&coursewareobjectMetadata.categories.res_type[0].taxoncode,file_path:coursewareobjectMetadata.physic_path||espModel.repository.coursewareobject(coursewareobjectMetadata.identifier).getResourceUrl()};espModel.repository.coursewareobject(coursewareobjectMetadata.identifier).get().then(function(coursewareobject){var pr=coursewareobject.getPageReferenceAt(0);pr?pageStage=new PageStage(coursewareobject.id,pr.id,editorEl.find("._body>._stage-wrap"),{moduleWrap:{border:!0,movable:!0,resizable:!0},apiProxy:{selectResource:function(options,dialogOptions){return editor.workbench.openDialog("nd.esp.resource.select",dialogOptions,$.extend({type:"$RA0101",storeParams:{coursewareobject:{coursewareobjectId:coursewareobject.id}}},options)).promise()},getPrompter:function(){return prompter}}}):prompter.error(i18n.translate("no_page"))},prompter.errorIf());var footbarEl=editorEl.find("._body>._footbar");footbarEl.find("button._preview").click(function(){save().done(function(identifier){prompter.dialog({title:i18n.translate("tool.preview.title"),state:"default",size:"full",showClose:!0,backdrop:"static",autoDestroy:!0,width:1280,height:841,src:espEnvironment.url.coursewareobjectPreview(identifier,config&&config.playerCode)}),console.log(JSON.stringify($.extend({},outerMessage,{message:"QuestionPreview",action:"save"})))}).fail(function(error){"string"==typeof error&&prompter.message(error,"error",!0)})}),footbarEl.find("button._save").click(function(){save().done(function(){prompter.success(i18n.translate("tool.save.success")),console.log(JSON.stringify($.extend({},outerMessage,{message:"QuestionSaved",action:"save"})))}).fail(function(error){"string"==typeof error&&prompter.message(error,"error",!0)})}),footbarEl.find("button._insert").click(function(){save().done(function(){console.log(JSON.stringify($.extend({},outerMessage,{message:"QuestionAdd",action:"insert"})))}).fail(function(error){"string"==typeof error&&prompter.message(error,"error",!0)})})}}this.title=resource.data.title;var previewEl=$(templates.preview).appendTo(editor.element).hide(),editorEl=$(templates.editor).appendTo(editor.element).hide(),previewRendered=!1,editorRendered=!1;editor.toolbar.add([{name:"edit",label:i18n.translate("view.toolbar.edit"),visible:config&&!0===config.defaultPreview,handle:function(tb){tb.toggle("preview",!0),tb.toggle("edit",!1),editorEl.show(),previewEl.hide(),renderEditor()}},{name:"preview",label:i18n.translate("view.toolbar.preview"),visible:!config||!0!==config.defaultPreview,handle:function(tb){tb.toggle("edit",!0),tb.toggle("preview",!1),editorEl.hide(),previewEl.show(),renderPreview()}}]),config&&!0===config.defaultPreview?(previewEl.show(),renderPreview()):(editorEl.show(),renderEditor())},this.save=function(editor,resource){console.log("saving...")},this.destroy=function(editor,resource){console.log("destroy editor...",editor)}}});