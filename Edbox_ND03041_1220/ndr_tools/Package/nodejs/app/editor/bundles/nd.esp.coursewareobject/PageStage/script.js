define(["jlang","jquery","prompter","espService","espModel","./ModuleEditorFactory","i18n!","css!./style.css"],function(jlang,$,prompter,espService,espModel,ModuleEditorFactory,i18n){function PageStage(coursewareobjectId,pageId,wrapEl,config){function renderModule(module){var moduleWrap=new ModuleWrap(module);return moduleWraps.push(moduleWrap),moduleWrap._completePromise}function getModuleWraps(filter){for(var results=[],i=0;i<moduleWraps.length;i++){var moduleWrap=moduleWraps[i];$.isFunction(filter)&&!1===filter(moduleWrap)||results.push(moduleWrap)}return results}function getModuleWrapById(id){return getModuleWraps(moduleWrapFilters.id(id))[0]}function getModuleInterfaces(name){var interfaces=[],filter=$.noop;"."==name.charAt(0)?(filter=moduleWrapFilters.moduleId(name.substring(1)),name="."):"#"==name.charAt(0)&&(filter=moduleWrapFilters.id(name.substring(1)),name=".");for(var mws=getModuleWraps(filter),i=0;i<mws.length;i++){var editor=mws[i].editor,interface=editor&&editor.getInterface().as(name);interface&&interfaces.push(interface)}return ModuleEditorFactory.compositeInterface(name,interfaces)}function ModuleWrap(module,isNewly){this._module=module,this._moduleDecorator=new ModuleDecorator(module),this._wrapEl=$(templates.moduleWrap).appendTo(pageEl),!0===moduleWrapConfig.border&&this._wrapEl.addClass("_border"),!0===moduleWrapConfig.movable&&this._wrapEl.addClass("_movable"),!0===moduleWrapConfig.resizable&&this._wrapEl.addClass("_resizable"),module.editorId||this._wrapEl.addClass("_none");var className="slides-module-"+(module.editorId&&module.editorId.toLowerCase()||"$none$");this._editorEl=$(templates.moduleEditor).appendTo(this._wrapEl).addClass(className),jlang.asEventManager(this,["resize","move","rotate","show","hide","invalid","valid"]),this._invalid=!1;var completeDeferred=$.Deferred();this._completePromise=completeDeferred.promise(),this._resetLayout=function(){var position=this._module.position,size=this._module.size;this._wrapEl.css({top:asCssSize(position.top),left:asCssSize(position.left),width:asCssSize(size.width),height:asCssSize(size.height)}),this._wrapEl.css(this._module.style),this._wrapEl.toggle(this._module.visible)},this._resetLayout(),this._switchPresenter=function(){this._editor&&(this._editor.__presenterId&&this._editorEl.removeClass(className+"-"+this._editor.__presenterId.toLowerCase()),this._editor.clean()),this._module.presenterId&&this._editorEl.addClass(className+"-"+this._module.presenterId.toLowerCase()),$(this._editorEl).empty(),this._module.editorId&&ModuleEditorFactory.create(this._module.editorId).then($.proxy(function(editorAndConfig){var editor=editorAndConfig[0],editorConfig=editorAndConfig[1];try{editor.init(this._moduleDecorator,stageCtrl,editorConfig),!0===isNewly&&(isNewly=!1,editor.initDefault(this));(editor.getTemplate()?$.when(editor.getTemplate()):editor.getTemplateUrl()?this._module.editorRepository.getResource(editor.getTemplateUrl()):$.when("")).done($.proxy(function(template){template&&this._editorEl.html(template)},this)).fail($.proxy(function(){console.info(i18n.translate("courseware.error.template.loading")+this._module.editorRepository.getResourceUrl(editor.getTemplateUrl()))},this)).always($.proxy(function(){try{editor.render(this)}catch(e){var errorMessage=i18n.translate("courseware.error.page.render",this._module.editorId);console.error(errorMessage,e),console.log(this),this.setInvalid(errorMessage,e)}},this))}catch(e){var errorMessage=i18n.translate("courseware.error.editor.init",this._module.editorId);console.error(errorMessage,e),this.setInvalid(errorMessage,e)}editor.__presenterId=this._module.presenterId,this._editor=editor,completeDeferred.resolve()},this),function(e){completeDeferred.reject(e)})},this._switchPresenter(),this._wrapEl.on("focusin",$.proxy(function(){this._wrapEl.addClass("_focusin"),this.trigger("startEdit")},this)),this._wrapEl.on("focusout",$.proxy(function(){this._wrapEl.removeClass("_focusin"),this.trigger("endEdit")},this))}function ModuleDecorator(module){this._module=module,$.each(this._module.properties,$.proxy(function(i,prop){Object.defineProperty(this,"$"+prop.name,{get:function(){return prop.value},set:function(val){prop.value=val}})},this))}function asCssSize(value){return value&&(value+="")&&-1==value.indexOf("px")&&-1==value.indexOf("%")?value+"px":value}var eventManager=jlang.EventManager(),apiProxy=$.extend({selectResource:function(options){return $.Deferred().reject(i18n.translate("courseware.select.notallowed"))},getPrompter:function(){return prompter}},config&&config.apiProxy);config=$.extend({},config);var page,pageEl=$(templates.page).appendTo(wrapEl),moduleWraps=[],rendered=!1,coursewareobjectRepository=espModel.repository.coursewareobject(coursewareobjectId);coursewareobjectRepository.getPage(pageId).then(function(p){var transform=config&&config.transform;return transform&&$.isFunction(transform.read)&&(p=transform.read(p)),p}).then(function(p){page=p;for(var modules=page.modules,renderPromises=[],i=0;i<modules.length;i++){var module=modules[i];renderPromises.push(renderModule(module))}$.when.apply($,renderPromises).done(function(){rendered=!0,eventManager.trigger("render")})},apiProxy.getPrompter().errorIf()).always(apiProxy.getPrompter().wait(i18n.translate("courseware.loading"),!1));var moduleWrapFilters={id:function(id){return function(moduleWrap){return moduleWrap.module.id==id}},moduleId:function(moduleId){return function(moduleWrap){return moduleWrap.module.moduleId==moduleId}}};this.save=function(){if(!page||!rendered)return $.Deferred().reject(i18n.translate("courseware.loading.unfinish"));for(var results=[],i=0;i<moduleWraps.length;i++){var editor=moduleWraps[i].editor;editor&&results.push(editor.save())}for(var promises=[],i=0;i<results.length;i++){var result=results[i];!1===result||"string"==typeof result?promises.push($.Deferred().reject(result)):result&&$.isFunction(result.then)&&promises.push(result)}return $.when.apply(null,promises).then(function(){var transform=config&&config.transform;return transform&&$.isFunction(transform.write)?$.when(transform.write(page)).then(function(p){return coursewareobjectRepository.updatePage(p)}):coursewareobjectRepository.updatePage(page)})};var coursewareobjecRepositorytDecorator={getResourceUrl:$.proxy(coursewareobjectRepository,"getResourceUrl"),getResourceUploadUrl:$.proxy(coursewareobjectRepository,"getResourceUploadUrl"),getFileWriter:$.proxy(coursewareobjectRepository,"getFileWriter")};this.on=$.proxy(eventManager,"on"),this.off=$.proxy(eventManager,"off"),this.trigger=$.proxy(eventManager,"trigger"),this.getModuleWrapById=getModuleWrapById,this.getModuleInterfaces=getModuleInterfaces,Object.defineProperties(this,{repository:{get:function(){return coursewareobjecRepositorytDecorator}},coursewareobjectId:{get:function(){return coursewareobjectId}},pageId:{get:function(){return pageId}},prompter:{get:function(){return apiProxy.getPrompter()}}});this.transformScale=function(value,xy){if(!value||!(value=parseFloat(value)))return 0;var scale=1;return pageEl.parents().each(function(i){var transform=$(this).css("transform"),match=transform&&"none"!==transform&&transform.match(/matrix\((\d+(\.\d+)?), (\d+(\.\d+)?), (\d+(\.\d+)?), (\d+(\.\d+)?), (\d+(\.\d+)?), (\d+(\.\d+)?)\)/);if(match){var scaleX=parseFloat(match[1])||1,scaleY=parseFloat(match[7])||1;scale*=xy?scaleX:scaleY}}),value/scale},this.transformScaleX=function(value){return this.transformScale(value,1)},this.transformScaleY=function(value){return this.transformScale(value,0)},this.selectResource=function(options,dialogOptions){return apiProxy.selectResource.apply(config,[options,dialogOptions])};var editable;this.currentEditable=function(type,target){return!1===type?(editable=null,this.trigger("currentEditableChange",null),editable):type?(editable={type:type,target:target},this.trigger("currentEditableChange",editable),editable):editable},pageEl.on("htmlEditorFocus",function(event,htmlEditor){stageCtrl.currentEditable("htmlEditor",htmlEditor)}),pageEl.on("htmlEditorBlur",function(event,htmlEditor){});var stageCtrl=this,moduleWrapConfig=config.moduleWrap||{};Object.defineProperties(ModuleWrap.prototype,{presenterId:{get:function(){return this._module.presenterId},set:function(val){val!==this._module.presenterId&&(this._module.presenterId=val,this._switchPresenter())}},position:{get:function(){return this._module.position},set:function(val){this._module.position=val,val=this._module.position,this._wrapEl.css({top:asCssSize(val.top),left:asCssSize(val.left)}),this.trigger("move",val.top,val.left)}},size:{get:function(){return this._module.size},set:function(val){this._module.size=val,val=this._module.size,this._wrapEl.css({width:asCssSize(val.width),height:asCssSize(val.height)}),this.trigger("resize",val.width,val.height)}},rotate:{get:function(){return this._module.rotate},set:function(val){this._module.rotate=val,val=this._module.rotate,this._wrapEl.css({transform:"rotate("+val+")"}),this.trigger("rotate",val)}},visible:{get:function(){return this._module.visible},set:function(val){this._module.visible=val,val=this._module.visible,this._wrapEl.toggle(val),this.trigger(val?"show":"hide")}},locked:{get:function(){return this._module.locked},set:function(val){this._module.locked=val}},style:{get:function(){return this._module.style},set:function(val){this._module.style=val}},element:{get:function(){return this._editorEl[0]}},editor:{get:function(){return this._editor}},module:{get:function(){return this._moduleDecorator}},invalid:{get:function(){return this._invalid}}}),ModuleWrap.prototype.getElement=function(){return this._editorEl[0]},ModuleWrap.prototype.setInvalid=function(message,cause){this._invalid=!0,this._invalidMessage=message,this._invalidCause=cause,$(this._editorEl).text(message),this.trigger("invalid",message,cause)},ModuleWrap.prototype.cleanInvalid=function(){this._invalid=!1,delete this._invalidMessage,delete this._invalidCause,this.trigger("valid")},Object.defineProperties(ModuleDecorator.prototype,{id:{get:function(){return this._module.id}},moduleId:{get:function(){return this._module.moduleId}},editorId:{get:function(){return this._module.editorId}},editorRepository:{get:function(){return this._module.editorRepository}}}),ModuleDecorator.prototype.getProperty=function(name){return this._module.getProperty(name)},ModuleDecorator.prototype.getPropertyValue=function(name){return this._module.getPropertyValue(name)},ModuleDecorator.prototype.setPropertyValue=function(name,value){this._module.setPropertyValue(name,value)}}var templates={page:'<div class="slides-coursewareobject-page-stage html-editor-scope"></div>',moduleWrap:'<div class="_module-wrap" tabindex="0"></div>',moduleEditor:'<div class="_module-editor"></div>'};return PageStage});