define(["jlang","jquery","espModel","espEnvironment","i18n!"],function(jlang,$,espModel,espEnvironment,i18n){function createInterface(interfaceDefinition){var interfaces=[];if(interfaceDefinition){if("string"==typeof interfaceDefinition)interfaceDefinition={interfaceDefinition:{}};else if($.isArray(interfaceDefinition)&&"string"==typeof interfaceDefinition[0]){var t={};t[interfaceDefinition[0]]=interfaceDefinition[1],interfaceDefinition=t}else if(!$.isPlainObject(interfaceDefinition))throw"invalid interface definition"}else interfaceDefinition={};for(var key in interfaceDefinition){var interface=new Interface(key,interfaceDefinition[key]);interfaces.push(interface)}return new ProxyInterface(interfaces)}function isCustomFunction(name){return"call"!=name&&"isSupport"!=name}function Interface(name,implements){this._name=name,implements=implements||{};var def=interfaceDefinitions[name];if(def)for(var i=0;i<def.length;i++)this[def[i]]=implements[def[i]]||$.noop;else $.extend(this,implements)}function CompositeInterface(name,interfaces){this._name=name,this._interfaces=interfaces=interfaces||[];var def=interfaceDefinitions[name];if(this._invoke=function(name){return $.proxy(function(){var args=$.makeArray(arguments);return args.unshift(name),this.call.apply(this,args)},this)},def)for(var i=0;i<def.length;i++)this[def[i]]=this._invoke(def[i]);else{var sample=this._interfaces[0];if(sample)for(var name in sample)isCustomFunction(name)&&$.isFunction(sample[name])&&(this[name]=this._invoke(name))}this.length=this._interfaces.length}function ProxyInterface(interfaces){this._interfaces=interfaces||[];for(var i=0;i<this._interfaces.length;i++){var interface=this._interfaces[i];for(var name in interface){var value=interface[name];isCustomFunction(name)&&$.isFunction(value)&&(this[name]=$.proxy(value,interface))}}}function ModuleEditor(editorDef){this.init=function(module,stage,config){},this.initDefault=function(moduleWrap){},this.render=function(moduleWrap){},this.clean=function(moduleWrap){},this.save=function(){},this.destroy=function(){},this.getTemplate=function(){},this.getTemplateUrl=function(){},this.getInterfaceDefinition=function(){},this.getInterface=function(){return interfaceObject},$.extend(this,jlang.EventManager(),editorDef);var interfaceObject=createInterface(this.getInterfaceDefinition())}function ErrorModuleEditorDef(editorId,message,cause){this.render=function(moduleWrap){var backgroundEl=$('<div class="slides-module-error-content"></div>').appendTo(moduleWrap.getElement());$('<div class="_image"></div>').appendTo(backgroundEl);$("<p></p>").appendTo(backgroundEl).text(message+"--\x3e"+cause)}}function ModuleEditorConfig(config){config||(config={}),this._i18n=config.i18n}function ErrorModuleEditorConfig(lang){return new ModuleEditorConfig}function getEditorDef(editorId){var deferred=$.Deferred();return requirejs([espModel.repository.moduleEditor(editorId).getResourceUrl("script.js")],function(editorDef){deferred.resolve(editorDef)},function(error){deferred.reject(i18n.translate("courseware.error.editor.js.loading",editorId)+error)}),deferred.promise()}function getEditorConfig(editorId){var deferred=$.Deferred();return requirejs(["i18n!"+espModel.repository.moduleEditor(editorId).getResourceUrl("i18n")],function(i18n){deferred.resolve(new ModuleEditorConfig({i18n:i18n}))},function(error){deferred.reject(i18n.translate("courseware.error.editor.js.loading",editorId)+error)}),deferred.promise()}var interfaceDefinitions={};return Interface.prototype.isSupport=function(name){return this._name===name},Interface.prototype.call=function(name){var fn=this[name];if($.isFunction(fn))return fn.apply(this,$.makeArray(arguments).slice(1))},CompositeInterface.prototype.isSupport=function(name){return this._name===name},CompositeInterface.prototype.each=function(callback){return $.each(this._interfaces,callback)},CompositeInterface.prototype.call=function(name){for(var args=$.makeArray(arguments),results=[],i=0;i<this._interfaces.length;i++){var interface=this._interfaces[i];results.push(interface.call.apply(interface,args))}return results},ProxyInterface.prototype.isSupport=function(name){for(var i=0;i<this._interfaces.length;i++)if(this._interfaces[i].isSupport(name))return!0;return!1},ProxyInterface.prototype.as=function(name){for(var i=0;i<this._interfaces.length;i++)if(this._interfaces[i].isSupport(name))return this._interfaces[i];return null},ProxyInterface.prototype.call=function(name){var fn=this[name];if($.isFunction(fn))return fn.apply(this,$.makeArray(arguments).slice(1))},Object.defineProperties(ModuleEditorConfig.prototype,{i18n:{get:function(){return this._i18n}}}),{create:function(editorId){return $.when(getEditorDef(editorId),getEditorConfig(editorId)).then(function(editorDef,editorConfig){try{$.isFunction(editorDef)&&(editorDef=new editorDef);var editor=new ModuleEditor(editorDef);return[editor,editorConfig]}catch(e){var errorMessage=i18n.translate("courseware.error.editor.init",editorId);console.error(errorMessage,e);var editor=new ModuleEditor(new ErrorModuleEditorDef(editorId,errorMessage,e));return[editor,new ErrorModuleEditorConfig]}},function(error){var errorMessage=i18n.translate("courseware.error.editors.loading");console.error(errorMessage,error);var editor=new ModuleEditor(new ErrorModuleEditorDef(editorId,errorMessage,error));return $.when([editor,new ErrorModuleEditorConfig])})},compositeInterface:function(name,interfaces){return new CompositeInterface(name,interfaces)}}});