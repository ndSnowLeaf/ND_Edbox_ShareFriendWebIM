define(["jquery","i18n!","espEnvironment","espService","espModel","slides","prompter","../PageStage/script","css!./style.css","css!./style-ex.css"],function($,i18n,espEnvironment,espService,espModel,slides,prompter,PageStage){var templates={preview:'<div class="slides-coursewareobject-basic-q-preview"></div>',editor:'<div class="module_edit"><div id="topSpace" style="display: none"></div><div class="ed_module_toolbar">   <div class="module_edit_toolbar">       <div class="ed_toolbar_wrap"></div>   </div>   </div><div class="ed_module_content"></div><div class="ed_module_footer">   <div class="module_edit_footer">       <a href="javascript:" class="ed_footer_btn font_color_gary btn_perview">'+i18n.translate("toolbar.preview")+'</a>       <a href="javascript:" class="ed_footer_btn font_color_orange btn_save">'+i18n.translate("toolbar.save")+'</a>       <a href="javascript:" class="ed_footer_btn font_color_orange btn_insert">'+i18n.translate("toolbar.insert")+"</a>   </div></div></div>",toolbarGroup:'<div class="ed_toolbar_col">',toolbarBtn:"<span></span>"};return prompter=prompter.as("wood"),function(){this.name="nd.esp.coursewareobject.NewBasicQEditor",this.supportTypes=["coursewareobject"],this.render=function(editor,resource,config){function renderPreview(){previewRendered||(previewRendered=!0,$("<iframe></iframe>").appendTo(previewEl)),previewEl.children("iframe").attr("src",espEnvironment.url.coursewareobjectPreview(resource.data.identifier,config&&config.playerCode))}function renderEditor(){function currentEditableChange(editable){var htmlEditor=editable&&"htmlEditor"==editable.type&&editable.target;editorEl.find(".module_edit_toolbar span").each(function(){var $btn=$(this),name=$btn.attr("name");name&&(htmlEditor&&!1!==htmlEditor.getCommandState(name)?$btn.removeClass("click_disabled"):$btn.addClass("click_disabled"))})}function currentHtmlEditor(){if(pageStage){var editable=pageStage.currentEditable();return editable&&"htmlEditor"==editable.type&&editable.target}}function execHtmlEditorCommand(name,params){var htmlEditor=currentHtmlEditor();htmlEditor&&htmlEditor.execCommand(name,params)}function command(name,params){return function(){execHtmlEditorCommand(name,params)}}function save(){return function(){if(!pageStage)return $.Deferred().reject(i18n.translate("no_ready"));var writeMode=espEnvironment.writeMode||"";if("yes"===writeMode)return pageStage.save().then(function(){return coursewareobjectMetadata.identifier});if(0===writeMode.indexOf("copy")){var newIdentifier=writeMode.substring(5)||"$temp";return espModel.repository.coursewareobject(coursewareobjectMetadata.identifier).copyAs(newIdentifier).then(function(identifier){return pageStage.save().then(function(){return identifier})})}return $.Deferred().reject(i18n.translate("not_allow_write"))}().then(function(identifier){return espModel.repository.coursewareobject(coursewareobjectMetadata.identifier).update(coursewareobject).then(function(){return identifier})}).fail(function(error){"string"==typeof error?prompter.message(error,"error",!0):!1!==typeof error&&prompter.errorIf()(error)})}if(!editorRendered){editorRendered=!0;var pageStage,coursewareobject,coursewareobjectMetadata=resource.data,outerMessage={message:"QuestionSaved",id:coursewareobjectMetadata.identifier,action:"save",question_type:coursewareobjectMetadata.custom_properties&&coursewareobjectMetadata.custom_properties.question_type,question_code:coursewareobjectMetadata.categories&&coursewareobjectMetadata.categories.res_type&&coursewareobjectMetadata.categories.res_type[0]&&coursewareobjectMetadata.categories.res_type[0].taxoncode,file_path:coursewareobjectMetadata.physic_path||espModel.repository.coursewareobject(coursewareobjectMetadata.identifier).getResourceUrl()},apiProxy={selectResource:function(options,dialogOptions){return editor.workbench.openDialog("nd.esp.resource.select",$.extend({theme:"basic",bodyOverflow:"visible"},dialogOptions),$.extend({type:"$RA0101",storeParams:{coursewareobject:{coursewareobjectId:coursewareobjectMetadata.identifier},baidu:{question_id:coursewareobjectMetadata.identifier},public:{max_size:options&&options.maxSize},personal:{max_size:options&&options.maxSize}},theme:"basic"},options)).promise()},getPrompter:function(){return prompter}};espModel.repository.coursewareobject(coursewareobjectMetadata.identifier).get().then(function(co){coursewareobject=co;var pr=coursewareobject.getPageReferenceAt(0);pr?(pageStage=new PageStage(coursewareobject.id,pr.id,editorEl.find(".ed_module_content"),{apiProxy:apiProxy}),pageStage.on("currentEditableChange",currentEditableChange)):prompter.error(i18n.translate("no_page"))},prompter.errorIf());var checkImage=function(result,success,item){if(!success)return!0;if(!item)return prompter.message(i18n.translate("common.hint.select")),!1;var href=item.href;-1==href.indexOf("?")?href+="?size=1200":href+="&size=1200",item.href=href},checkVideo=function(result,success,item){if(!success)return!0;if(!item)return prompter.message(i18n.translate("common.hint.select")),!1;var deferred=$.Deferred(),size=parseInt(item.size)||0,sizeError=size>1048576e3,code=item.code,codeError=!code;if(code&&!/(H\.264)|(AVC)/i.test(code))prompter.message(i18n.translate("resource.upload.video.codeerror")),deferred.reject();else if(sizeError||codeError){var message;sizeError&&codeError?message=i18n.translate("resource.upload.video.maxsize_and_emptycode"):sizeError?message=i18n.translate("resource.upload.video.maxsize"):item._fromLocale||(message=i18n.translate("resource.upload.video.formaterror")),void 0!=message?prompter.confirm(message,function(){deferred.resolve()},function(){deferred.reject()}):deferred.resolve()}else deferred.resolve();return deferred.promise()},checkAudio=function(result,success,item){if(!success)return!0;if(!item)return prompter.message(i18n.translate("common.hint.select")),!1;var deferred=$.Deferred();if((parseInt(item.size)||0)>1048576e3){var message=i18n.translate("resource.upload.audio.maxsize");prompter.confirm(message,function(){deferred.resolve()},function(){deferred.reject()})}else deferred.resolve();return deferred.promise()},tools=[[{name:"bold",cls:"bold",title:i18n.translate("toolbar.bold"),dimension:"1",on:!1,click:command("bold")},{name:"italic",cls:"italic",title:i18n.translate("toolbar.italic"),dimension:"1",on:!1,click:command("italic")},{name:"underline",cls:"underline",title:i18n.translate("toolbar.underline"),dimension:"1",on:!1,click:command("underline")},{name:"removeFormat",cls:"clear",title:i18n.translate("toolbar.through"),dimension:"1",on:!1,click:command("removeFormat")},{name:"fontsize",cls:"font_size",title:i18n.translate("toolbar.fontsize"),dimension:"1",on:!1,dropdown:function(el){el.addClass("ng-isolate-scope"),new slides.PixelPicker(el).on("pick",function(p){execHtmlEditorCommand("fontsize",p),el.hide()})}},{name:"superscript",cls:"sup",title:i18n.translate("toolbar.superscript"),dimension:"1",on:!1,click:command("superscript")},{name:"subscript",cls:"sub",title:i18n.translate("toolbar.subscript"),dimension:"1",on:!1,click:command("subscript")},{name:"color",cls:"text_color",title:i18n.translate("toolbar.textcolor"),dimension:"1",on:!1,dropdown:function(el){new slides.ColorPicker(el).on("pick",function(color){execHtmlEditorCommand("color","#"+color),el.hide()})}},{name:"backgroundcolor",cls:"bg_color",title:i18n.translate("toolbar.bgColor"),dimension:"1",on:!1,dropdown:function(el){new slides.ColorPicker(el).on("pick",function(color){execHtmlEditorCommand("backgroundcolor","#"+color),el.hide()})}}],[{name:"table",cls:"table",title:i18n.translate("toolbar.table"),dimension:"2",on:!1,click:command("table")},{name:"horizontalrule",cls:"horizontal",title:i18n.translate("toolbar.horizontalrule"),dimension:"2",on:!1,click:command("horizontalrule")}],[{name:"justifyleft",cls:"image_left",title:i18n.translate("toolbar.imageleft"),dimension:"2",on:!1,click:command("justifyleft")},{name:"justifyright",cls:"image_right",title:i18n.translate("toolbar.imageright"),dimension:"2",on:!1,click:command("justifyright")}],[{name:"justifyright",cls:"justify_right",title:i18n.translate("toolbar.justifyright"),dimension:"2",on:!1,click:command("justifyright")},{name:"justifyleft",cls:"justify_block",title:i18n.translate("toolbar.justifyleft"),dimension:"2",on:!1,click:command("justifyleft")},{name:"justifyblock",cls:"justify_left",title:i18n.translate("toolbar.justifyblock"),dimension:"2",on:!1,click:command("justifyblock")},{name:"justifycenter",cls:"justify_center",title:i18n.translate("toolbar.justifycenter"),dimension:"2",on:!1,click:command("justifycenter")}],[{name:"image",cls:"add_image",title:i18n.translate("toolbar.image"),dimension:"3",on:!1,click:function(){apiProxy.selectResource({type:"$RA0101"},{check:checkImage}).done(function(item){item&&execHtmlEditorCommand("image",{src:item.href})})}},{name:"video",cls:"add_video",title:i18n.translate("toolbar.video"),dimension:"3",on:!1,click:function(){apiProxy.selectResource({type:"$RA0103"},{check:checkVideo}).done(function(item){execHtmlEditorCommand("video",{src:item.href,width:300,height:300,poster:espEnvironment.url.referenceIcon("default_video.png")})})}},{name:"audio",cls:"add_music",title:i18n.translate("toolbar.audio"),dimension:"3",on:!1,click:function(){apiProxy.selectResource({type:"$RA0102"},{check:checkAudio}).done(function(item){execHtmlEditorCommand("audio",{src:item.href,width:50,height:30,poster:espEnvironment.url.referenceIcon("default_audio.png")})})}},{name:"mathjax",cls:"add_formula",title:i18n.translate("toolbar.math"),dimension:"3",on:!1,click:function(){execHtmlEditorCommand("mathjax")}},{cls:"add_example",title:i18n.translate("asset.label.insert.sample_b"),dimension:"3",on:!1,click:function(){var params=$.extend({},espEnvironment.location.params);params.old_identifier=params.id,params.old_file_path=params.file_path,delete params.file_path;var url=espEnvironment.url.makeRoot("/basic-question/question.html#")("import_sample",params);prompter.dialog({title:i18n.translate("asset.label.insert.sample_b"),src:url,width:1200,height:840})}}]],toolbarEl=editorEl.find(".ed_toolbar_wrap");toolbarEl.mousedown(function(){return!1}),$.each(tools,function(i,group){var groupEl=$(templates.toolbarGroup).appendTo(toolbarEl).addClass("col_"+(i+1));$.each(group,function(j,btn){if("/"==btn)groupEl.append("<br/>");else{var btnEl=$(templates.toolbarBtn).appendTo(groupEl).attr("title",btn.title);btnEl.addClass("toolbar_btn_com_"+btn.dimension).addClass("btn_"+btn.cls),btnEl.attr("name",btn.name),btn.disabled&&btnEl.addClass("click_disabled"),btn.on&&btnEl.addClass("ui_btn_active"),"3"==btn.dimension&&$('<span class="ed_add_text"></span>').html(btn.title).appendTo(btnEl),btn.click&&btnEl.click(function(){btnEl.hasClass("click_disabled")||btn.click()}),btn.dropdown&&btnEl.click(function(){btnEl.hasClass("click_disabled")||setTimeout(function(){$(document).off("._toolbar_dropdown_");var dropdownEl=btnEl.find("._dropdown");dropdownEl.length||(dropdownEl=$('<div class="_dropdown"></div>').appendTo(btnEl),dropdownEl.click(function(){return!1}),btn.dropdown(dropdownEl)),dropdownEl.show(),$(document).on("click._toolbar_dropdown_",function(){dropdownEl.hide(),$(document).off("._toolbar_dropdown_")})},0)})}})}),currentEditableChange();var footbarEl=editorEl.find(".module_edit_footer");footbarEl.find("a.btn_perview").click(function(){save().done(function(identifier){pageStage.trigger("preview");var sizeObject=function(){var screenHeight=$(window).height(),screenWidth=$(window).width(),height=Math.min(900,screenHeight-50),width=Math.min(1280,screenWidth-100);return{width:width/(16/9)>height-41?16/9*(height-41):width,height:width/(16/9)>height-41?height:width/(16/9)+41}}(),urlParams=$.extend({},espEnvironment.location.params);delete urlParams.file_path,prompter.dialog({title:i18n.translate("toolbar.preview.title"),state:"default",size:"full",showClose:!0,backdrop:"static",autoDestroy:!0,width:sizeObject.width,height:sizeObject.height,src:espEnvironment.url.coursewareobjectPreview(identifier,config&&config.playerCode,urlParams)});var message=$.extend({},outerMessage,{message:"QuestionPreview",action:"save"});try{PCInterface.questionEdit(JSON.stringify(message))}catch(ex){}window.parent!=window&&window.parent.postMessage({prefix:"[PROJECT_NAME]_:_:",data:message},"*")})}),footbarEl.find("a.btn_save").click(function(){save().done(function(){prompter.message(i18n.translate("toolbar.save.success"));var message=$.extend({},outerMessage,{message:"QuestionSaved",action:"save"});try{PCInterface.questionEdit(JSON.stringify(message))}catch(ex){}window.parent!=window&&window.parent.postMessage({prefix:"[PROJECT_NAME]_:_:",data:message},"*")})}),footbarEl.find("a.btn_insert").click(function(){save().done(function(){var message=$.extend({},outerMessage,{message:"QuestionAdd",action:"insert"});try{PCInterface.questionInsert(JSON.stringify(message))}catch(ex){}window.parent!=window&&window.parent.postMessage({prefix:"[PROJECT_NAME]_:_:",data:message},"*")})}),"true"==espEnvironment.location.params.noinsert&&footbarEl.find("a.btn_insert").hide()}}this.title=resource.data.title;var previewEl=$(templates.preview).appendTo(editor.element).hide(),editorEl=$(templates.editor).appendTo(editor.element).hide(),previewRendered=!1,editorRendered=!1;editor.toolbar.add([{name:"edit",label:i18n.translate("view.toolbar.edit"),visible:config&&!0===config.defaultPreview,handle:function(tb){tb.toggle("preview",!0),tb.toggle("edit",!1),editorEl.show(),previewEl.hide(),renderEditor()}},{name:"preview",label:i18n.translate("view.toolbar.preview"),visible:!config||!0!==config.defaultPreview,handle:function(tb){tb.toggle("edit",!0),tb.toggle("preview",!1),editorEl.hide(),previewEl.show(),renderPreview()}}]),config&&!0===config.defaultPreview?(previewEl.show(),renderPreview()):(editorEl.show(),renderEditor())},this.save=function(editor,resource){console.log("saving...")},this.destroy=function(editor,resource){console.log("destroy editor...",editor)}}});