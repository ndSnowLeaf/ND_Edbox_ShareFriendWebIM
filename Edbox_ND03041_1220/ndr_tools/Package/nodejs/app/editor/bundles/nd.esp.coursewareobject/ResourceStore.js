define(["jquery","espEnvironment","espModel","i18n!"],function($,espEnvironment,espModel,i18n){function adjustData(metadata,type,repository){var item={title:metadata.title,type:type,_fromLocale:!0};if(item.format=metadata.tech_info&&metadata.tech_info.href&&metadata.tech_info.href.format,item.href=repository.getResourceUrl(metadata.tech_info&&metadata.tech_info.href&&metadata.tech_info.href.location||""),metadata.preview)for(var key in metadata.preview)if(item.thumbHref=repository.getResourceUrl(metadata.preview[key]),"120"===key||"240"===key)break;if(item.thumbHref||"$RA0101"==type&&(item.thumbHref=item.href),metadata.tech_info&&metadata.tech_info.href&&metadata.tech_info.href.requirements&&metadata.tech_info.href.requirements.length)for(var j=0;j<metadata.tech_info.href.requirements.length;j++){var x=metadata.tech_info.href.requirements[j];if("resolution"==x.name){item.resolution=x.value;var parts=item.resolution&&item.resolution.split("*");parts&&2==parts.length&&(item.width=parseInt(parts[0]),item.height=parseInt(parts[1]))}else"duration"==x.name?item.duration=x.value:"code"==x.name&&(item.code=x.value)}return item.size=metadata.tech_info&&metadata.tech_info.href&&metadata.tech_info.href.size,item}return function(){return{name:"coursewareobject",title:function(type){return i18n.translate("asset.label.local."+type.typeName)},order:0,paging:!1,uploadEnabled:!0,processUploadResponse:function(response,type,params){if(!params||!params.coursewareobjectId)throw i18n.translate("courseware.error.id.missing");return adjustData(response,type,espModel.repository.coursewareobject(params.coursewareobjectId))},uploadOptions:function(params){if(!params||!params.coursewareobjectId)throw i18n.translate("courseware.error.id.missing");return{url:espModel.repository.coursewareobject(params.coursewareobjectId).getAssetUploadUrl()}},getFileWriter:function(params){if(!params||!params.coursewareobjectId)throw i18n.translate("courseware.error.id.missing");return espModel.repository.coursewareobject(params.coursewareobjectId).getAssetFileWriter()},getDataList:function(params){if(!params||!params.coursewareobjectId)return $.Deferred().reject(i18n.translate("courseware.error.id.missing"));var repository=espModel.repository.coursewareobject(params.coursewareobjectId);return repository.listAssets(params).then(function(result){$.isArray(result)||(result=[]);for(var items=[],i=0;i<result.length;i++)items.push(adjustData(result[i],params.type,repository));return items})}}}});