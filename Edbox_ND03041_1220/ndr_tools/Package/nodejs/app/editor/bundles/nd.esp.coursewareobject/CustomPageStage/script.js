define(["jlang","jquery","prompter","espEnvironment","espService","espModel","./PageEditorFactory","require","i18n!"],function(jlang,$,prompter,espEnvironment,espService,espModel,PageEditorFactory,requirejs,i18n){function PageStage(coursewareobjectId,pageId,pageType,wrapEl,config){function renderPage(module){pageEl.addClass("_"+pageType),pageType&&PageEditorFactory.create(pageType).then(function(editorAndConfig){editor=editorAndConfig[0],editorConfig=editorAndConfig[1];try{editor.init(new PageDecorator(page,pageType),stageCtrl,editorConfig);try{editor.render(pageEl)}catch(e){var errorMessage=i18n.translate("courseware.error.page.render",pageType);console.error(errorMessage,e)}}catch(e){var errorMessage=i18n.translate("courseware.error.editor.init",pageType);console.error(errorMessage,e)}})}var eventManager=jlang.EventManager(),apiProxy=$.extend({selectResource:function(options){return $.Deferred().reject(i18n.translate("courseware.select.notallowed"))},getPrompter:function(){return prompter}},config&&config.apiProxy);config=$.extend({},config);var page,editor,pageEl=$(templates.page).appendTo(wrapEl),coursewareobjectRepository=espModel.repository.coursewareobject(coursewareobjectId);coursewareobjectRepository.getPage(pageId).then(function(p){page=p,renderPage(page)},apiProxy.getPrompter().errorIf()).always(apiProxy.getPrompter().wait(i18n.translate("courseware.loading"),!1)),this.save=function(){if(!page)return $.Deferred().reject(i18n.translate("courseware.loading.unfinish"));var result=editor&&editor.save();return!1===result||"string"==typeof result?$.Deferred().reject(result):$.when(result).then(function(){return coursewareobjectRepository.updatePage(page)})};var coursewareobjecRepositorytDecorator={getResourceUrl:$.proxy(coursewareobjectRepository,"getResourceUrl"),getResourceUploadUrl:$.proxy(coursewareobjectRepository,"getResourceUploadUrl")};this.on=$.proxy(eventManager,"on"),this.off=$.proxy(eventManager,"off"),this.trigger=$.proxy(eventManager,"trigger"),Object.defineProperties(this,{repository:{get:function(){return coursewareobjecRepositorytDecorator}},coursewareobjectId:{get:function(){return coursewareobjectId}},pageId:{get:function(){return pageId}},prompter:{get:function(){return apiProxy.getPrompter()}}}),this.selectResource=function(options,dialogOptions){return apiProxy.selectResource.apply(config,[options,dialogOptions])};var editable;this.currentEditable=function(type,target){return!1===type?editable=null:type?editable={type:type,target:target}:editable};var stageCtrl=this}function PageDecorator(page,pageType){this._page=page,this._pageType=pageType;var editorRoot=espEnvironment.url.makeRoot(requirejs.toUrl("./implements/"+pageType));this._editorRepository={getResourceUrl:function(path,v1,v2,v3){return editorRoot(path,v1,v2,v3)}}}var templates={page:'<div class="slides-coursewareobject-custom-page-stage"></div>'};return Object.defineProperties(PageDecorator.prototype,{id:{get:function(){return this._page.id}},modules:{get:function(){return this._page.modules}},layout:{get:function(){return this._page.layout},set:function(val){this._page.layout=val}},width:{get:function(){return this._page.width},set:function(val){this._page.width=val}},height:{get:function(){return this._page.height},set:function(val){this._page.height=val}},isReportable:{get:function(){return this._page.isReportable},set:function(val){this._page.isReportable=!!val}},scoring:{get:function(){return this._page.scoring},set:function(val){this._page.scoring=val}},editorRepository:{get:function(){return this._editorRepository}}}),PageDecorator.prototype.getModule=function(id){return this._page.getModule(id)},PageDecorator.prototype.getModuleAt=function(index){return this._page.getModuleAt(index)},PageDecorator.prototype.getModuleByPresenterId=function(presenterId,single){return this._page.getModuleByPresenterId(presenterId,single)},PageStage});