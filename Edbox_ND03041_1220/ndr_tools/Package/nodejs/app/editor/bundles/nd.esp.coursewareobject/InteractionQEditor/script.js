define(["jquery","i18n!","espEnvironment","espService","espModel","prompter","../PageStage/script","css!./style.css","css!./prompter-wood.css"],function($,i18n,espEnvironment,espService,espModel,prompter,PageStage){function createPanel(name,parentEl,title,body,buttons,init){var panelEl=$(parentEl).find("._pop-panel");return panelEl.length&&panelEl.is(":visible")&&$(document).off("._pop-panel"),panelEl.length||(panelEl=$(templates.panel).addClass("_"+name).appendTo(parentEl),panelEl.on("click",function(event){event.stopPropagation()}),title?panelEl.find("._header").append(title):panelEl.find("._header").hide(),panelEl.find("._body").append(body),buttons&&$.each(buttons,function(i,btn){var btnEl=$(templates.panel_button).appendTo(panelEl.find("._footer"));btnEl.text(btn.label),btn.primary&&btnEl.addClass("_primary"),btnEl.on("click",$.proxy(function(event){!1!==(this.handle||$.noop)(event,panelEl)&&(panelEl.hide(),$(parentEl).removeClass("_on"),$(document).off("._pop-panel"))},btn))}),$.isFunction(init)&&init(panelEl)),panelEl.show(),$(parentEl).addClass("_on"),setTimeout(function(){$(document).one("click._pop-panel",function(){panelEl.hide(),$(parentEl).removeClass("_on")})},0),panelEl}var templates={preview:'<div class="slides-interaction-q-preview"></div>',editor:'<div class="slides-interaction-q-editor"><div class="_body"><div class="_stage-wrap"></div><div class="_toolbar"></div></div></div>',button:'<div class="_btn"><div class="_icon"></div><div class="_label"></div></div>',panel:'<div class="_pop-panel"><div class="_header"></div><div class="_body"></div><div class="_footer"></div></div>',panel_body_description:'<div class="_video-box"></div><div class="_image-box"><div class="_title _preview"></div><div class="_title _editor"></div><div class="_title _example"></div><ul class="_preview"></ul><ul class="_editor"></ul><div class="_switch _preview"></div><div class="_switch _editor"></div></div><div class="_text"></div>',panel_button:'<div class="_btn _hover"></div>',panel_body_skin:"<ul></ul>",panel_body_time:'<div class="_form-row _on"><span class="_radio" value="sequence">'+i18n.translate("tool.time.sequence")+'</span></div><div class="_form-row"><span class="_radio" value="countdown">'+i18n.translate("tool.time.countdown")+'</span><input name="minute" type="number" max="59" min="0" class="_text" value="0"/><label class="_label">'+i18n.translate("common.label.minute")+'</label><input name="second" type="number" max="59" min="0" class="_text" value="0"/><label class="_label">'+i18n.translate("common.label.second")+"</label></div>"};return prompter=prompter.as("wood"),function(){this.name="nd.esp.coursewareobject.InteractionQEditor",this.supportTypes=["coursewareobject"],this.render=function(editor,resource,config){function renderPreview(){previewRendered||(previewRendered=!0,$("<iframe></iframe>").appendTo(previewEl)),previewEl.children("iframe").attr("src",espEnvironment.url.coursewareobjectPreview(resource.data.identifier,config&&config.playerCode))}function renderEditor(){function resetSize(){var width=editorEl.width(),height=editorEl.height(),scale=Math.min(width/1600,height/1e3);editorEl.children("._body").css("transform","scale("+scale+")")}function afterPageStageRender(){var gameQuestionTimer=pageStage.getModuleInterfaces("Timer"),type=gameQuestionTimer.call("getType")[0]||"sequence";toolbarEl.find("._btn._time").toggleClass("_countdown","countdown"==type)}function save(){return function(){if(!pageStage)return $.Deferred().reject(i18n.translate("no_ready"));var writeMode=espEnvironment.writeMode||"";if("yes"===writeMode)return pageStage.save().then(function(){return coursewareobjectMetadata.identifier});if(0===writeMode.indexOf("copy")){var newIdentifier=writeMode.substring(5)||"$temp";return espModel.repository.coursewareobject(coursewareobjectMetadata.identifier).copyAs(newIdentifier).then(function(identifier){return pageStage.save().then(function(){return identifier})})}return $.Deferred().reject(i18n.translate("not_allow_write"))}().then(function(identifier){return espModel.repository.coursewareobject(coursewareobjectMetadata.identifier).update(coursewareobject).then(function(){return identifier})}).fail(function(error){"string"==typeof error?prompter.message(error,"error",!0):!1!==error&&prompter.errorIf()(error)}).always(prompter.wait(i18n.translate("common.wait.save")))}if(!editorRendered){editorRendered=!0,setTimeout(function(){resetSize()},0),$(window).resize(resetSize);var pageStage,coursewareobject,coursewareobjectMetadata=resource.data,outerMessage={message:"QuestionSaved",id:coursewareobjectMetadata.identifier,action:"save",question_type:coursewareobjectMetadata.custom_properties&&coursewareobjectMetadata.custom_properties.question_type,question_code:coursewareobjectMetadata.categories&&coursewareobjectMetadata.categories.res_type&&coursewareobjectMetadata.categories.res_type[0]&&coursewareobjectMetadata.categories.res_type[0].taxoncode,file_path:coursewareobjectMetadata.physic_path||espModel.repository.coursewareobject(coursewareobjectMetadata.identifier).getResourceUrl()};espModel.repository.coursewareobject(coursewareobjectMetadata.identifier).get().then(function(co){coursewareobject=co;var pr=coursewareobject.getPageReferenceAt(0);pr?(pageStage=new PageStage(coursewareobject.id,pr.id,editorEl.find("._body>._stage-wrap"),{transform:config&&config.pageTransformFactory&&config.pageTransformFactory.create(0),apiProxy:{selectResource:function(options,dialogOptions){return editor.workbench.openDialog("nd.esp.resource.select",$.extend({theme:"basic",bodyOverflow:"visible"},dialogOptions),$.extend({type:"$RA0101",storeParams:{coursewareobject:{coursewareobjectId:coursewareobject.id},baidu:{question_id:coursewareobject.id},public:{max_size:options&&options.maxSize},personal:{max_size:options&&options.maxSize}},theme:"basic"},options)).promise()},getPrompter:function(){return prompter}}}),pageStage.on("render",afterPageStageRender)):prompter.error(i18n.translate("no_page"))},prompter.errorIf());var toolbarEl=editorEl.find("._body>._toolbar"),coursewareobjectTemplateRepository=espModel.repository.coursewareobjectTemplate(config.$template),buttons=[{name:"skin",label:i18n.translate("tool.skin"),iconClass:"skin",handle:function(event){createPanel("skin",event.currentTarget,null,templates.panel_body_skin,null,$.proxy(function(panelEl){var themes=this.themes?$.isArray(this.themes)?this.themes:[this.themes]:[],ul=panelEl.find("ul");themes.length?$.each(themes,function(i,theme){var img="string"==typeof theme?theme:theme.image;$('<li><a href="javascript:void(0)"><img src="'+coursewareobjectTemplateRepository.getResourceUrl(img)+'" alt="..."/></a></li>').appendTo(ul)}):$('<li class="_wood"><a href="javascript:void(0)"></a></li>').appendTo(ul)},this))}},{name:"description",label:i18n.translate("tool.description"),iconClass:"description",handle:function(event){createPanel("description",event.currentTarget,"",templates.panel_body_description,[{label:i18n.translate("tool.description.ok"),primary:!0}],$.proxy(function(panelEl){panelEl.find("._text").html(this.content);var video=this.video,imageRoot=this.imageRoot||"$/guide",imagePreview=this.imagePreview,imageList=this.imageList,imagePrefix=this.imagePrefix,imageSuffix=this.imageSuffix,imageAmount=this.imageAmount,contents=this.contents||[],interval=this.interval||1500,mode=(this.autoSwitch,this.mode);if(video)panelEl.find("._video-box").show().append('<video preload="false" controls="controls" src="'+coursewareobjectTemplateRepository.getResourceUrl(video)+'"></video>');else if(imagePreview||imageList||imagePrefix||imageSuffix||imageAmount){var imageUrl=function(path){return coursewareobjectTemplateRepository.getResourceUrl([imageRoot,path])},images=[];if($.isArray(imageList))$.each(imageList,function(i,image){images.push(image)});else if("number"==typeof imageAmount&&imageAmount>0)for(var i=0;i<imageAmount;i++)images.push(imagePrefix+(i+1)+imageSuffix);var imageBoxEl=panelEl.find("._image-box").show();if("example"!=mode){imageBoxEl.find("._example").hide();var carousel,switchToPreview=function(){imageBoxEl.find("._preview").show(),imageBoxEl.find("._editor").hide(),stopCarousel()},switchToEditor=function(){imageBoxEl.find("._preview").hide(),imageBoxEl.find("._editor").show(),startCarousel()},startCarousel=function(){stopCarousel();var lis=imageBoxEl.find("ul._editor > li");lis.removeClass("_current").eq(0).addClass("_current"),carousel=setInterval(function(){var currentIndex=lis.filter("._current").index();if(currentIndex>=lis.length-1)return stopCarousel(),void setTimeout(startCarousel,3e3);lis.removeClass("_current").eq(currentIndex+1).addClass("_current")},interval)},stopCarousel=function(){carousel&&clearInterval(carousel)};$("<li></li>").appendTo(imageBoxEl.find("ul._preview")).html('<img src="'+imageUrl(imagePreview||imagePrefix+imageSuffix)+'" alt="..."/>'),$.each(images,function(i,image){$("<li></li>").appendTo(imageBoxEl.find("ul._editor")).html('<img src="'+imageUrl(image)+'" alt="..."/>')}),imageBoxEl.find("._switch._preview").click(switchToEditor),imageBoxEl.find("._switch._editor").click(switchToPreview),switchToPreview()}else{imageBoxEl.find("._preview").hide(),imageBoxEl.find("._editor").show();var exampleEl=imageBoxEl.find("ul._editor"),next=function(){var lis=exampleEl.find("li"),currentIndex=lis.filter("._current").index();-1==currentIndex||currentIndex>=lis.length-1||(lis.removeClass("_current").eq(currentIndex+1).addClass("_current"),contents[currentIndex+1]&&panelEl.find("._text").html(contents[currentIndex+1]),toggleButton())},previous=function(){var lis=exampleEl.find("li"),currentIndex=lis.filter("._current").index();-1!=currentIndex&&0!=currentIndex&&(lis.removeClass("_current").eq(currentIndex-1).addClass("_current"),contents[currentIndex-1]&&panelEl.find("._text").html(contents[currentIndex-1]),toggleButton())},toggleButton=function(){var lis=exampleEl.find("li"),currentIndex=lis.filter("._current").index();console.log(currentIndex),imageBoxEl.find("._switch._editor").toggle(!(-1==currentIndex||0==currentIndex)),imageBoxEl.find("._switch._preview").toggle(!(-1==currentIndex||currentIndex>=lis.length-1)),imageBoxEl.find("._title._example").html('<span class="'+i18n.translate("tool.description.example.language")+'">'+i18n.translate("tool.description.example."+(currentIndex+1))+"</span>")};$.each(images,function(i,image){$("<li></li>").appendTo(exampleEl).html('<img src="'+imageUrl(image)+'" alt="..."/>')}),exampleEl.find("li").eq(0).addClass("_current"),contents[0]&&panelEl.find("._text").html(contents[0]),toggleButton(),imageBoxEl.find("._switch._editor").click(previous),imageBoxEl.find("._switch._preview").click(next)}}},this))}},{name:"time",label:i18n.translate("tool.time"),iconClass:"time",handle:function(event){if(pageStage){var btnEl=event.currentTarget,panelEl=createPanel("time",btnEl,i18n.translate("tool.time.title"),templates.panel_body_time,[{label:i18n.translate("tool.time.ok"),primary:!0,handle:function(event,panelEl){var type=panelEl.find("._form-row._on>._radio").attr("value");if("countdown"==type){var minute=parseInt(panelEl.find('input[name="minute"]').val()),second=parseInt(panelEl.find('input[name="second"]').val()),invalid=!1;if((isNaN(minute)||minute<0||minute>59)&&(panelEl.find('input[name="minute"]').val(0),invalid=!0),(isNaN(second)||second<0||second>59)&&(panelEl.find('input[name="second"]').val(0),invalid=!0),0==minute&&0==second&&(invalid=!0),invalid)return prompter.message(i18n.translate("question.timer.invalid")),!1;gameQuestionTimer.call("setType",type),gameQuestionTimer.call("setDuration",60*minute+second),$(btnEl).addClass("_countdown")}else gameQuestionTimer.call("setType",type),gameQuestionTimer.call("setDuration",0),$(btnEl).removeClass("_countdown")}},{label:i18n.translate("tool.time.cancel")}],function(panelEl){panelEl.find("._form-row").click(function(event){if(!$(this).hasClass("_on")){panelEl.find("._form-row").removeClass("_on"),$(this).addClass("_on");if("countdown"==($(this).find("._radio").attr("value")||"sequence")){panelEl.find('input[name="minute"]').val(parseInt(1)),panelEl.find('input[name="second"]').val(0)}else panelEl.find('input[name="minute"]').val(0),panelEl.find('input[name="second"]').val(0)}})}),gameQuestionTimer=pageStage.getModuleInterfaces("Timer"),type=gameQuestionTimer.call("getType")[0]||"sequence";if(panelEl.find("._form-row").removeClass("_on"),panelEl.find('._form-row>._radio[value="'+type+'"]').parent().addClass("_on"),"countdown"==type){var duration=parseInt(gameQuestionTimer.call("getDuration")[0])||0;panelEl.find('input[name="minute"]').val(parseInt(duration/60)),panelEl.find('input[name="second"]').val(duration%60)}else panelEl.find('input[name="minute"]').val(0),panelEl.find('input[name="second"]').val(0)}}},{name:"preview",label:i18n.translate("tool.preview"),iconClass:"preview",handle:function(){save().done(function(identifier){pageStage.trigger("preview");var sizeObject=function(){var screenHeight=$(window).height(),screenWidth=$(window).width(),height=Math.min(900,screenHeight-50),width=Math.min(1280,screenWidth-100);return{width:width/(16/9)>height-41?16/9*(height-41):width,height:width/(16/9)>height-41?height:width/(16/9)+41}}(),urlParams=$.extend({},espEnvironment.location.params);delete urlParams.file_path,prompter.dialog({title:i18n.translate("tool.preview.title"),state:"default",size:"full",showClose:!0,backdrop:"static",autoDestroy:!0,width:sizeObject.width,height:sizeObject.height,src:espEnvironment.url.coursewareobjectPreview(identifier,config&&config.playerCode,urlParams)});try{PCInterface.questionEdit(JSON.stringify($.extend({},outerMessage,{message:"QuestionSaved",action:"save"})))}catch(ex){}var message=$.extend({},outerMessage,{message:"QuestionPreview",action:"save"});window.parent!=window&&window.parent.postMessage({prefix:"[PROJECT_NAME]_:_:",data:message},"*")})}},{name:"save",label:i18n.translate("tool.save"),iconClass:"save",handle:function(){save().done(function(){prompter.message(i18n.translate("tool.save.success"));var message=$.extend({},outerMessage,{message:"QuestionSaved",action:"save"});try{PCInterface.questionEdit(JSON.stringify(message))}catch(ex){}window.parent!=window&&window.parent.postMessage({prefix:"[PROJECT_NAME]_:_:",data:message},"*")})}},{name:"insert",label:i18n.translate("tool.insert"),iconClass:"insert",handle:function(){save().done(function(){var message=$.extend({},outerMessage,{message:"QuestionAdd",action:"insert"});try{PCInterface.questionInsert(JSON.stringify(message))}catch(ex){}window.parent!=window&&window.parent.postMessage({prefix:"[PROJECT_NAME]_:_:",data:message},"*")})}}],tools=config&&config.tools||[];if($.each(tools,function(i,tool){var btn={name:"string"==typeof tool?tool:tool.name};if(btn.name&&"skin"!=btn.name){$.each(buttons,function(ii,button){if(button.name==btn.name)return $.extend(btn,button),!1}),"string"!=typeof tool&&$.extend(btn,tool);var btnEl=$(templates.button).appendTo(toolbarEl);btnEl.addClass("_"+btn.iconClass),btnEl.children("._icon").addClass("_"+btn.iconClass),btnEl.children("._label").text(btn.label),btnEl.on("click",$.proxy(function(event){(this.handle||$.noop).apply(this,[event])},btn))}}),"true"!=espEnvironment.location.params.isPreview){for(var cookieKey="iqv_"+config.$template,strCookie=document.cookie,visited=!1,arrCookie=strCookie.split("; "),i=0;i<arrCookie.length;i++){if(arrCookie[i].split("=")[0]==cookieKey){visited=!0;break}}visited||toolbarEl.find("._btn > ._description").parent().click();var date=new Date;date.setTime(date.getTime()+864e7),document.cookie=cookieKey+"=true;expires="+date.toGMTString()}}}this.title=resource.data.title;var previewEl=$(templates.preview).appendTo(editor.element).hide(),editorEl=$(templates.editor).appendTo(editor.element).hide(),previewRendered=!1,editorRendered=!1;editor.toolbar.add([{name:"edit",label:i18n.translate("view.toolbar.edit"),visible:config&&!0===config.defaultPreview,handle:function(tb){tb.toggle("preview",!0),tb.toggle("edit",!1),editorEl.show(),previewEl.hide(),renderEditor()}},{name:"preview",label:i18n.translate("view.toolbar.preview"),visible:!config||!0!==config.defaultPreview,handle:function(tb){tb.toggle("edit",!0),tb.toggle("preview",!1),editorEl.hide(),previewEl.show(),renderPreview()}}]),config&&!0===config.defaultPreview?(previewEl.show(),renderPreview()):(editorEl.show(),renderEditor())},this.save=function(editor,resource){console.log("saving...")},this.destroy=function(editor,resource){console.log("destroy editor...",editor)}}});