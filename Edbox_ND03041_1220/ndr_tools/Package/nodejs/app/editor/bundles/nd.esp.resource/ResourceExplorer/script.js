define(["jlang","jquery","espService","espModel","angular","i18n!","angular-prompter","angular-slides","css!./style.css"],function(jlang,$,espService,espModel,angular,i18n){function ResourceExplorer(wrapEl,type,stores,storeConfigs,storeParams,options){var eventManager=jlang.EventManager(this,["select"]),maxSelect=options&&options.maxSelect||-1,multiSelect=maxSelect>1||options&&options.multiSelect;angular.quickstart(wrapEl,{templateUrl:"bundles/nd.esp.resource/ResourceExplorer/template.html",controller:["$scope","$prompter","$timeout","$q",function($scope,$prompter,$timeout,$q){function fireSelectChange(){if($scope.currentStore){var data;multiSelect?(data=[],angular.forEach($scope.selectedDataArray,function(d){data.push(angular.extend({},d))})):data=$scope.selectedData?angular.extend({},$scope.selectedData):null,eventManager.trigger("select",data)}}function prepareUpload(){if(!$scope.currentStore||!0!==$scope.currentStore.uploadEnabled)for(var i=0;i<$scope.stores.length;i++)!0===$scope.stores[i].uploadEnabled&&($scope.currentStore=$scope.stores[i])}function checkFile(item){var deferred=$q.defer();return deferred.resolve(),deferred.promise}$scope.theme=options&&options.theme,$scope.assetType=assetTypes[type]||assetTypes.$RA0101,$scope.stores=[],stores=stores?angular.isArray(stores)?stores:[stores]:[],angular.forEach(stores,function(s){if(!(storeConfigs&&!1===storeConfigs[s.name]||s.supports&&s.supports.length&&-1==$.inArray(type,s.supports))){var store=angular.extend({title:i18n.translate("asset.label.unkonwname"),datas:[],order:1,uploadItems:[],uploadEnabled:!1,processUploadResponse:angular.noop,getDataList:function(params){return $.when([])}},s,storeConfigs&&storeConfigs[s.name]);if(angular.isFunction(store.title)&&(store.title=store.title($scope.assetType)),s.paging&&(store.pagination={page:1,size:parseInt(s.paging)||20}),s.uploadOptions)try{store.uploadOptions=angular.isFunction(s.uploadOptions)?s.uploadOptions(storeParams&&storeParams[s.name]):s.uploadOptions}catch(e){console.error(i18n.translate("resource.upload.option.fail")+e),store.uploadEnabled=!1}if(angular.isFunction(s.getFileWriter))try{store.fileWriter=s.getFileWriter(storeParams&&storeParams[s.name])}catch(e){console.error(i18n.translate("resource.upload.writer.fail")+e),store.uploadEnabled=!1}$scope.stores.push(store)}}),$scope.stores.sort(function(a,b){var a=parseFloat(a.order),b=parseFloat(b.order);return(isNaN(a)?1:a)-(isNaN(b)?1:b)}),$scope.currentStore,$scope.selectedData,$scope.selectedDataArray=[],$scope.doSearch=function(page){$scope.select();var store=$scope.currentStore;if(store){var params=angular.extend({type:type,words:$scope.keyword},storeParams&&storeParams[$scope.currentStore.name]);store.pagination&&(params.page=store.pagination.page=page||store.pagination.page,params.size=store.pagination.size),$q.proxy(store.getDataList(params)).then(function(result){!1===result||"string"==typeof result?(store.datas=[],store.pagination&&(store.pagination.totalSize=0),store.invalid=!0):(store.invalid=!1,store.pagination?(store.datas=result.items,store.pagination.totalSize=result.total_count):store.datas=result?angular.isArray(result)?result:[result]:[])},$prompter.errorIf()).finally($prompter.wait(i18n.translate("resource.type.loading"),!1))}},$scope.select=function(data){if($scope.currentStore){if(multiSelect)if(data){var exists=!1;angular.forEach($scope.selectedDataArray,function(d,i){if(d==data)return $scope.selectedDataArray.splice(i,1),exists=!0,!1}),exists||(maxSelect>1&&$scope.selectedDataArray.length>=maxSelect?$prompter.message(i18n.translate("asset.hint.select.max."+$scope.assetType.typeName,maxSelect)):$scope.selectedDataArray.push(data))}else $scope.selectedDataArray=[];else $scope.selectedData=data;fireSelectChange()}},$scope.isSelected=function(data){if(multiSelect){var exists=!1;return angular.forEach($scope.selectedDataArray,function(d,i){if(d==data)return exists=!0,!1}),exists}return $scope.selectedData==data},$scope.preview=function(data){console.log(data)},$scope.uploadConfig={filters:$scope.assetType.uploadFilters,onAdded:function(item){prepareUpload(),item.promise=checkFile(item),item.promise.then(function(){item.writer=$scope.currentStore.fileWriter&&function(item,file){return $scope.currentStore.fileWriter(file)},item.options=$scope.currentStore.uploadOptions,$scope.currentStore.uploadItems.push(item)},function(error){$prompter.message(error)})},onUploaded:function(item){try{var data=$scope.currentStore.processUploadResponse(item.response,type,storeParams&&storeParams[$scope.currentStore.name]);data&&$scope.currentStore.datas.unshift(data)&&$scope.select(data)}catch(e){console.error(i18n.translate("resource.upload.result.fail")+e)}item.remove()},onError:function(item){},onRemove:function(item){for(var i=0;i<$scope.currentStore.uploadItems.length;i++)item==$scope.currentStore.uploadItems[i]&&$scope.currentStore.uploadItems.splice(i,1)}},$scope.switchStore=function(store){$scope.currentStore=store,store&&$scope.doSearch()},$timeout(function(){$scope.switchStore($scope.stores[0])},0)}]},["slides","prompter",{translate:i18n}])}var assetTypes={$RA0101:{typeName:"image",title:i18n.translate("asset.label.image"),defaultThumbHref:"bundles/nd.esp.resource/ResourceExplorer/images/picture.png",uploadFilters:{mime_types:[{title:i18n.translate("resource.label.file_type.image"),extensions:"jpg,jpeg,gif,png,bmp"}],max_file_size:"100m"}},$RA0102:{typeName:"audio",title:i18n.translate("asset.label.audio"),defaultThumbHref:"bundles/nd.esp.resource/ResourceExplorer/images/audio.png",uploadFilters:{mime_types:[{title:i18n.translate("resource.label.file_type.audio"),extensions:"mp3"}],max_file_size:"15m"}},$RA0103:{typeName:"video",title:i18n.translate("asset.label.video"),defaultThumbHref:"bundles/nd.esp.resource/ResourceExplorer/images/video.png",uploadFilters:{mime_types:[{title:i18n.translate("resource.label.file_type.video"),extensions:"mp4"}],max_file_size:"15m"}},$RA0104:{typeName:"flash",title:"Flash",defaultThumbHref:"bundles/nd.esp.resource/ResourceExplorer/images/flash.png",uploadFilters:{mime_types:[{title:i18n.translate("resource.label.file_type.flash"),extensions:"swf"}],max_file_size:"10m"}}};return ResourceExplorer.getAssetType=function(type){return assetTypes[type]},ResourceExplorer});