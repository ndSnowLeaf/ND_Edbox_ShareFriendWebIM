define(["jquery","prompter","./ResourceExplorer/script","./ResourceExplorer/ImageCropper","espModel","i18n!"],function($,prompter,ResourceExplorer,ImageCropper,espModel,i18n){return function(){var stores=[];return{requires:"workbench",activator:function(bundleContext){},extensionPoints:[{point:"store",resolve:function(config){config=config?$.isArray(config)?config:[config]:[],$.each(config,function(){stores.push(this)})}}],extensions:function(bundleContext){return[{targetBundle:"workbench",point:"dialog",config:[{name:"nd.esp.resource.select",title:function(contentOptions){var typeName=ResourceExplorer.getAssetType(contentOptions.type).typeName;return i18n.translate("asset.label.insert."+typeName)},content:function(bodyEl,contentOptions,layer){var storeParams=contentOptions.storeParams,storeConfigs=contentOptions.storeConfigs,explorer=new ResourceExplorer(bodyEl,contentOptions.type,stores,storeConfigs,storeParams,{multiSelect:!0===contentOptions.multiSelect,maxSelect:contentOptions.maxSelect||-1,theme:contentOptions.theme});layer.contentOptions=contentOptions,explorer.on("select",function(data){layer.data=data})},check:function(result,success,data){if(success&&(!data||$.isArray(data)&&0==data.length))return prompter.message(i18n.translate("common.hint.select")),!1},width:1008,height:768,buttons:[{name:"ok",label:i18n.translate("toolbar.insert"),handle:function(contentEL,layer,btn){if(layer.data&&!$.isArray(layer.data)&&layer.contentOptions&&"$RA0101"==layer.contentOptions.type&&!0===layer.contentOptions.crop&&layer.contentOptions.storeParams&&layer.contentOptions.storeParams.coursewareobject&&layer.contentOptions.storeParams.coursewareobject.coursewareobjectId){var coursewareobjectId=layer.contentOptions.storeParams.coursewareobject.coursewareobjectId;ImageCropper.crop(layer.data.href,{aspectRatio:1}).then(function(blob){if(!blob)return void layer.close(btn.name,!0);var file=new File([blob],"hello.png");espModel.repository.coursewareobject(coursewareobjectId).getFileWriter()(file,"resource").then(function(result){for(var i=0;i<stores.length;i++){var store=stores[i];if("coursewareobject"==store.name){result=store.processUploadResponse(result,layer.contentOptions.type,layer.contentOptions.storeParams.coursewareobject);break}}layer.data=result,layer.close(btn.name,!0)}).always(prompter.wait(i18n.translate("common.wait.save")))},function(){layer.close(btn.name,!1)})}else layer.close(btn.name,!0)}}]}]}]}}}});