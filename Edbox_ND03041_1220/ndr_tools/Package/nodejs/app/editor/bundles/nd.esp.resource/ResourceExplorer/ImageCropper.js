define(["jquery","prompter","i18n!","cropper","css!./ImageCropper.css"],function($,prompter,i18n){function getRoundedCanvas(sourceCanvas){var canvas=document.createElement("canvas"),context=canvas.getContext("2d"),width=sourceCanvas.width,height=sourceCanvas.height;return canvas.width=width,canvas.height=height,context.beginPath(),context.arc(width/2,height/2,Math.min(width,height)/2,0,2*Math.PI),context.strokeStyle="rgba(0,0,0,0)",context.stroke(),context.clip(),context.drawImage(sourceCanvas,0,0,width,height),canvas}var ImageCropper={};return ImageCropper.crop=function(src,options){options=options||{};var deferred=$.Deferred();return prompter.dialog({title:"裁剪图片",width:820,height:700,theme:"basic",content:function(bodyEl,contentOptions,layer){bodyEl.html('<div class="image-cropper"><div class="_target"><img crossOrigin="Anonymous" src="'+src+'"></div><div class="_preview"><div class="_title">预览：</div><div class="_content"></div></div></div>');var $target=bodyEl.find("._target > img"),$preview=bodyEl.find("._preview > ._content");$target.cropper({aspectRatio:options.aspectRatio,ready:function(e){var $clone=$(this).clone().removeClass("cropper-hidden");$clone.css({display:"block",width:"100%",minWidth:0,minHeight:0,maxWidth:"none",maxHeight:"none"}),$preview.css({width:"100%",overflow:"hidden"}).html($clone)},crop:function(e){var imageData=$(this).cropper("getImageData"),previewAspectRatio=e.width/e.height,previewWidth=$preview.width(),previewHeight=previewWidth/previewAspectRatio,imageScaledRatio=e.width/previewWidth;$preview.height(previewHeight).find("img").css({width:imageData.naturalWidth/imageScaledRatio,height:imageData.naturalHeight/imageScaledRatio,marginLeft:-e.x/imageScaledRatio,marginTop:-e.y/imageScaledRatio}),layer.ready=!0}}),layer.data=$target},buttons:["close",{name:"ok",label:i18n.translate("toolbar.insert"),handle:function(contentEL,layer,btn){layer.ready?layer.close(btn.name,btn.success):prompter.message(i18n.translate("common.wait.load"))}}]}).then(function($target){getRoundedCanvas($target.cropper("getCroppedCanvas")).toBlob(function(blob){deferred.resolve(blob)})},function(){deferred.reject()}),deferred.promise()},ImageCropper});