define("generate/template_cache",["angular"],function(angular){angular.module("plugin.templates",[]).run(["$templateCache",function($templateCache){"use strict"}])}),define("init",["require","angular","angular-nd","angular-ngui-ex","angular-ui-router","angular-cookies","ui-bootstrap-tooltip","./generate/template_cache"],function(require,angular){var module=angular.module("questions",["nd.ngui","nd.util","gettext","ui.router","ngCookies","ui.bootstrap.bindHtml","ui.bootstrap.tooltip","plugin.templates"]);return module}),define("question-module",["require","angular","init"],function(require,angular){var module=angular.module("questions");return module}),define("service/$base",["require","question-module","css!lib/fancybox/1.3.1/fancybox.css","jquery","fancybox","plupload"],function(require,module){module.factory("$context",["$auth","$requestInfo","$security","$i18n",function($auth,$requestInfo,$security,$i18n){var userInfo=($security.getAuthInfo()?$security.getAuthInfo().userInfo:{},{});userInfo.userId=$requestInfo.params.creator,userInfo.userName=$requestInfo.params.creator,userInfo.nickName=$requestInfo.params.creator;var getLang=function(){var lang=$requestInfo.params._lang_;return lang||(lang="zh-CN"),lang=lang.toLowerCase(),"zh-tw"==lang||"zh-hk"==lang||"zh_tw"==lang||"zh_hk"==lang?lang="zh-tw":lang.indexOf("_")!=-1?lang=lang.substring(0,lang.indexOf("_")):lang.indexOf("-")!=-1&&(lang=lang.substring(0,lang.indexOf("-"))),lang},lang=getLang(),plui18n={zh:"lib/plu/i18n/zh_CN",ja:"lib/plu/i18n/ja",en:"lib/plu/i18n/en",es:"lib/plu/i18n/es_EC"};return require([plui18n[lang]]),{getLang:getLang,currentUser:function(){return userInfo},currentOrg:function(){return $requestInfo.params.org},currentCreator:function(){var userName=userInfo.userId;return userName},coverageObject:{user:{target_type:"User",target:userInfo.userId,target_title:userInfo.nickName,strategy:"OWNER"},common:{target_type:"Org",target:"nd",target_title:$i18n("resource.nd.title"),strategy:"OWNER"},baidu:{target_type:"Baidu",target:"bd",target_title:$i18n("resource.baidu.title"),strategy:"OWNER"}},coverage:{user:"User/"+userInfo.userId+"/OWNER",common:"Org/nd/",baidu:"Baidu/bd/"},resourceSpace:$requestInfo.params.space}}]),module.factory("$url",["$urlHelper","$config","$i18n","$stateParams",function($urlHelper,$config,$i18n,$stateParams){var fn=function(path,v1,v2,v3){return $urlHelper.buildUrl($config.contextPath+(path||""),v1,v2,v3)};return fn.getFilePath=function(){return fn.file_path||(fn.file_path=$stateParams.file_path),fn.file_path},fn.getExtraInfo=function(){if(fn.file_path||(fn.file_path=$stateParams.file_path),fn.file_path){var result="?file_path="+encodeURIComponent(fn.file_path);return result+"&"}return"?"},fn.portal=function(path,v1,v2,v3){return fn(path,v1,v2,v3)},fn.portalURL=function(path,v1,v2,v3){return $urlHelper.buildUrl($config.portalServer+(path||""),v1,v2,v3)},fn.editor=function(path,v1,v2,v3){return $urlHelper.buildUrl($config.editorServer+(path||""),v1,v2,v3)},fn.staticFiles=function(file,id){var extra=this.getExtraInfo($stateParams),question_id=$stateParams.id;return $urlHelper.buildUrl("/v2.0/assets/get"+extra+"&question_id="+question_id+"&file_name=/resources/"+file)},fn.editor.qtiPlayer=function(url){var lang=$i18n.getLanguage();lang&&(lang=lang.replace("-","_"));var url=url.replace("item.json","main.xml"),base=$stateParams.question_base?"file://"+$stateParams.question_base:"/userdatas";return url=url.replace("${ref-path}",base),fn.editor("/player/index.html",{main:url,_lang_:lang})},fn.slides=function(path,v1,v2,v3){return $urlHelper.buildUrl($config.slideServer+(path||""),v1,v2,v3)},fn.slidesRemote=function(path,v1,v2,v3){return $urlHelper.buildUrl($config.slideServer2+(path||""),v1,v2,v3)},fn.lifecycle=function(path,v1,v2,v3){return $urlHelper.buildUrl($config.lifecycleServer+(path||""),v1,v2,v3)},fn.cs=function(path,v1,v2,v3){return $urlHelper.buildUrl($config.csServer+(path||""),v1,v2,v3)},fn.cscdn=function(path,v1,v2,v3){return $urlHelper.buildUrl($config.csCdn+(path||""),v1,v2,v3)},fn.uc=function(path,v1,v2,v3){return $urlHelper.buildUrl($config.ucServer+(path||""),v1,v2,v3)},fn.csref=function(path){var refPath=$urlHelper.buildUrl($config.csServer2),result=path?path.replace(/\$\{ref-path\}/g,function(text){return refPath+text.replace("${ref-path}","")}):"";return result},fn.ref=function(path,encodeFileName){var result=(fn.cscdn(""),path?path.replace(/\$\{ref-base\}/g,function(text){var extra=fn.getExtraInfo($stateParams),question_id=$stateParams.id;return"/v1.3/assets/get"+extra+"&question_id="+question_id+"&filepath="}):"");if(encodeFileName!==!1){var indexOf=result.lastIndexOf("/");if(indexOf!=-1){var queryParam,fileName=result.substring(indexOf+1),querySplit=fileName.lastIndexOf("?");querySplit!=-1&&(queryParam=fileName.substring(querySplit),fileName=fileName.substring(0,querySplit)),result=result.substring(0,indexOf+1)+encodeURIComponent(fileName)+(queryParam||"")}}return result},fn.build=function(path,v1,v2,v3){return $urlHelper.buildUrl(path,v1,v2,v3)},fn}]),module.filter("userName",[function(){return function(value){if(!value)return"";var indexOf=value.indexOf("(");return indexOf!=-1?value.substring(0,indexOf):value}}]),module.filter("refPath",["$url",function($url){return function(value,encodeFileName){return $url.ref(value,encodeFileName)}}]),module.provider("$security",function(){var serviceName,$securityProvider={$get:["$injector","$q","$cookieStore",function($injector,$q,$cookieStore){function getAuthService(){return serviceName?$injector.get(serviceName):defaultService}var defaultService={get:function(){return null},login:function(username,password){return reject()},logout:function(authInfo){return when()}},authInfoStoreKey="slides-security-auth",authInfo=getAuthService().get();authInfo||(authInfo=$cookieStore.get(authInfoStoreKey));var $security={login:function(username,password){var deferred=$q.defer();return getAuthService().login(username,password).then(function(result){authInfo=result,$cookieStore.put(authInfoStoreKey,authInfo),deferred.resolve()},function(result){deferred.reject(result)}),deferred.promise},logout:function(){var deferred=$q.defer();return getAuthService().logout(authInfo).then(function(){$cookieStore.put(authInfoStoreKey,null),deferred.resolve()},function(){deferred.reject()}),deferred.promise},checkLogin:function(){return!!authInfo},getAuthInfo:function(){return authInfo}};return $security}],setServiceName:function(name){serviceName=name}};return $securityProvider});var $=require("jquery");module.directive("lcFancybox",[function(){return{restrict:"A",replace:!1,scope:{fancyType:"@",fancyWidth:"@",fancyHeight:"@",fancyAutoScale:"@",fancyCyclic:"@"},link:function(scope,element,iAttrs){var config={};config.type=scope.fancyType,scope.fancyWidth&&(config.width=parseInt(scope.fancyWidth)),scope.fancyHeight&&(config.height=parseInt(scope.fancyHeight)),config.cyclic=scope.fancyCyclic,config.autoScale="true"===scope.fancyAutoScale,$(element).fancybox(config)}}}]),module.config(["$i18nProvider","$securityProvider",function($i18nProvider,$securityProvider){$i18nProvider.setDefaultLanguage("zh-CN"),$i18nProvider.setSupportLanguages(["zh-CN","es-EC","ja-JP","ja","en-US","zh-TW","zh-HK","zh_TW","zh_HK","ru-RU","ru_RU"]),$i18nProvider.addModule("questions"),$securityProvider.setServiceName("$auth")}])}),define("service/$i18n",["require","angular","angular-gettext","question-module","/editor/basic-question/$i18n/zh-CN.js","/editor/basic-question/$i18n/es-EC.js","/editor/basic-question/$i18n/ja-JP.js","/editor/basic-question/$i18n/en-US.js","/editor/basic-question/$i18n/zh-TW-HK.js","/editor/basic-question/$i18n/ru-RU.js"],function(require,angular,gettext,module,zhCn,esEc,jaJp,enUS,zhTwHK,ruRU){module.factory("$session",["$http","$q",function($http,$q){var sessionObject=_requestInfo.session||{},session=sessionObject.value?angular.fromJson(sessionObject.value):{},saveUrl=sessionObject.saveUrl||"",saveSession=function(){return $http({method:"POST",url:saveUrl,data:angular.toJson(session)})};return{set:function(key,value){var deferred=$q.defer();return session[key]=value,saveSession().success(function(data){deferred.resolve(value)}).error(function(data){deferred.reject(data)}),deferred.promise},get:function(key){return session[key]}}}]);var _requestInfo=window._request_info_||{};return module.factory("$requestInfo",["$stateParams","$location",function($stateParams,$location){var requestInfo={};return requestInfo=_requestInfo&&void 0!==_requestInfo.params?{params:_requestInfo.params||{},variables:_requestInfo.variables||{},headers:_requestInfo.headers||{}}:{params:$location.search()}}]),module.factory("$module",["$url",function($url){var Module=function(moduleName){this.name=moduleName,this.path=moduleName.replace(/\./g,"/"),this.template=function(name){return $url.module("/"+this.path+"/"+(name||"index")+".html")},this.file=function(name){return $url.module("/"+this.path+"/"+(name||""))},this.messageFile=function(lang){return this.file("$i18n/"+lang+".json")},this.controller=function(name){return this.name+"."+(name||"")+"Ctrl"}};return function(moduleName){return new Module(moduleName)}}]),module.provider("$i18n",function(){var supportLanguages,moduleNames=[],defaultLanguage="zh-CN";return{addModule:function(name){moduleNames.push(name)},setDefaultLanguage:function(lang){defaultLanguage=lang},setSupportLanguages:function(langs){supportLanguages=langs},$get:["gettextCatalog",function(gettextCatalog){var $i18n=function(string,scope,tScope){if(angular.isString(scope))scope=tScope===!0?{$:gettextCatalog.getString(scope)}:{$:scope};else if(angular.isNumber(scope))scope={$:scope};else if(angular.isArray(scope)){for(var temp={},i=0;i<scope.length;i++)temp["$"+i]=scope[i];scope=temp}return gettextCatalog.getString(string,scope)};return $i18n.plural=function(n,string,stringPlural,context){return gettextCatalog.getPlural(n,string,stringPlural,context)},$i18n.$$moduleNames=moduleNames,$i18n.$$defaultLanguage=defaultLanguage,$i18n.$$supportLanguages=supportLanguages,$i18n.setMessages=function(lang,messages){gettextCatalog.setStrings(lang,messages)},$i18n.setLanguage=function(lang){gettextCatalog.setCurrentLanguage(lang)},$i18n.getLanguage=function(){return gettextCatalog.getCurrentLanguage()},$i18n.getSupportLanguages=function(){return supportLanguages},$i18n}]}}),module.run(["gettextCatalog","$i18n","$locale","$module","$requestInfo","$window","$urlHelper","$document",function(gettextCatalog,$i18n,$locale,$module,$requestInfo,$window,$urlHelper,$document){window.$i18n=$i18n;var lang,LANGUAGE_PARAM_NAME="_lang_",loadMessage=function(moduleName,lang){return"es-EC"==lang||"es"==lang?esEc:"ja-JP"==lang||"ja"==lang?jaJp:"en-US"==lang||lang.indexOf("en")!=-1?enUS:"zh-TW"==lang||"zh_TW"==lang||"zh-HK"==lang||"zh_HK"==lang?zhTwHK:"ru-RU"==lang||"ru_RU"==lang?ruRU:zhCn},supportLanguages=$i18n.$$supportLanguages||[];if(supportLanguages.length>1){var navigatorLanguages=navigator.languages||[navigator.language],urlLang=$requestInfo.params[LANGUAGE_PARAM_NAME];if(angular.isString(urlLang))urlLang=urlLang.replace("_","-"),$document[0].cookie="language="+urlLang+";path=/";else{var cookie=$document[0].cookie;if(cookie)for(cookieArray=cookie.split("; "),i=0;i<cookieArray.length;i++)cookie=cookieArray[i],0==cookie.indexOf("language=")&&(urlLang=cookie.substring("language=".length))}for(var exceptLanguages=[urlLang,angular.isString(urlLang)?urlLang.replace(/-.+/,""):""].concat(navigatorLanguages),i=0;i<navigatorLanguages.length;i++){var nl=navigatorLanguages[i];nl&&nl.indexOf("-")!=-1&&exceptLanguages.push(nl.substring(0,nl.indexOf("-")))}outer:for(var i=0;i<exceptLanguages.length;i++)for(var j=0;j<supportLanguages.length;j++)if(exceptLanguages[i]==supportLanguages[j]){lang=supportLanguages[j];break outer}}else 1==supportLanguages.length&&(lang=supportLanguages[0]);lang||(lang=$i18n.$$defaultLanguage);for(var moduleNames=$i18n.$$moduleNames,i=0;i<moduleNames.length;i++)try{var messages=loadMessage(moduleNames[i],lang);$i18n.setMessages(lang,messages)}catch(e){}$i18n.setLanguage(lang);var langParamReg=new RegExp("([\\?&])("+LANGUAGE_PARAM_NAME+"=[^&]+(&?))","g");$i18n.changeLanguage=function(lang){var href=$window.location.href;if(langParamReg.test(href))href=href.replace(new RegExp("([\\?&])("+LANGUAGE_PARAM_NAME+"=[^&]+(&?))","g"),"$1"+(LANGUAGE_PARAM_NAME+"="+lang)+"$3");else{var params={};params[LANGUAGE_PARAM_NAME]=lang,href=$urlHelper.buildUrl(href,params)}$window.location.href=href}}]),angular}),define("service/$config",["question-module"],function(module){module.factory("$config",[function(){var $espConfig={contextPath:"",portalServer:"http://esp-portal.web.sdp.101.com",editorServer:"",lifecycleServer:"http://esp-lifecycle.web.sdp.101.com",customEditorServer:"http://ceditor-front-xm.edu.web.sdp.101.com",csServer:"/userdatas/",moocLmsServer:"http://mooc-lms.web.sdp.101.com",csCdn:"/userdatas/",csIconFolder:"edu/esp",ucServer:"https://aqapi.101.com",ucOrg:"org_esp_integration",refpathaddon:"http://sdpcs.beta.web.sdp.101.com/v0.1/static/preproduction_content_module_mng/test",keyUserInfo:"13465c85caab4dfd8b1cb5093131c6d0",slideServer:"",slideServer2:"http://esp-slides.edu.web.sdp.101.com/",csServer2:"http://cs.101.com/v0.1/static",playerCode:"teacher",maxfilesize:{video:"15728640",audio:"15728640",image:"15728640"}};return $espConfig.checkUrl=$espConfig.slideServer2+"questions/edit.html",$espConfig.ignoreUrls=["/user"],window.$config=$espConfig,$espConfig}]),module.config(["$httpProvider",function($httpProvider){$httpProvider.defaults.headers.common["Content-Type"]="application/json; charset=utf-8",$httpProvider.interceptors.push(["$injector","$q","$urlHelper",function($injector,$q,$urlHelper){return{request:function(config){var url=config.url;if(url&&url.indexOf(".html")!=-1)return config;var headers=config.headers;if(headers||(headers=config.headers={}),!headers.Authorization){var $auth=$injector.get("$auth");$auth.generateAuthHeader(config.url,config.method)}return config},responseError:function(rejection){for(var handle=!1,i=0;i<$config.ignoreUrls.length;i++){var url=$config.ignoreUrls[i];rejection.config.url.indexOf(url)!=-1&&(handle=!0)}if(!handle){var $console=$injector.get("$console"),$i18n=$injector.get("$i18n"),status=rejection.status;"403"==status?$console.error($i18n("common.hint.http.403")):"401"==status?$console.error($i18n("common.hint.http.401")):rejection.data&&rejection.data.message?$console.error($i18n("common.hint.http.error",rejection.data?rejection.data.message:"")):$console.error($i18n("common.hint.http.defaulterror",rejection.data?rejection.data.message:""))}return $q.reject(rejection)}}}]),$httpProvider.interceptors.push(["$q","$rootScope","$location","$timeout",function($q,$rootScope,$location,$timeout){var isIELower=CORSCustom.isIELower(),setLoadingDataTimer=function(isloading){$rootScope.loadingDataTimer&&$timeout.cancel($rootScope.loadingDataTimer),$rootScope.loadingDataTimer=$timeout(function(){$rootScope.loadingData=isloading},300)};return{request:function(config){setLoadingDataTimer(!0);var isAjax=config.url&&config.url.indexOf("http")!==-1,host=[config.url.split("//")[0],"//",config.url.split("/")[2]].join("");if(isAjax&&angular.isDefined($rootScope.userObj)){var unAuth=config.params&&1==config.params.unAuth;unAuth||(config.headers=angular.extend({"Content-Type":"application/json","Accept-Charset":"utf-8"},config.headers))}return isAjax&&isIELower&&CORSCustom.isXDomain(config.url)&&(config.data=CORSCustom.encodeData(config.method,config.data,angular.extend({Host:host.replace("http://","").replace("https://","")},config.headers))),config.params&&delete config.params.unAuth,config||$q.when(config)},response:function(response){return setLoadingDataTimer(!1),response},requestError:function(rejection){return setLoadingDataTimer(!1),$q.reject(rejection)},responseError:function(rejection){return setLoadingDataTimer(!1),$q.reject(rejection)}}}])}])}),define("service/$espUserCenter",["question-module","cryptojs"],function(module,CryptoJS){function rhex(num){for(var str="",j=0;j<=3;j++)str+=hex_chr.charAt(num>>8*j+4&15)+hex_chr.charAt(num>>8*j&15);return str}function str2blks_MD5(str){var i,nblk=(str.length+8>>6)+1,blks=new Array(16*nblk);for(i=0;i<16*nblk;i++)blks[i]=0;for(i=0;i<str.length;i++)blks[i>>2]|=str.charCodeAt(i)<<i%4*8;return blks[i>>2]|=128<<i%4*8,blks[16*nblk-2]=8*str.length,blks}function add(x,y){var lsw=(65535&x)+(65535&y),msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|65535&lsw}function rol(num,cnt){return num<<cnt|num>>>32-cnt}function cmn(q,a,b,x,s,t){return add(rol(add(add(a,q),add(x,t)),s),b)}function ff(a,b,c,d,x,s,t){return cmn(b&c|~b&d,a,b,x,s,t)}function gg(a,b,c,d,x,s,t){return cmn(b&d|c&~d,a,b,x,s,t)}function hh(a,b,c,d,x,s,t){return cmn(b^c^d,a,b,x,s,t)}function ii(a,b,c,d,x,s,t){return cmn(c^(b|~d),a,b,x,s,t)}function MD5(str){for(var x=str2blks_MD5(str),a=1732584193,b=-271733879,c=-1732584194,d=271733878,i=0;i<x.length;i+=16){var olda=a,oldb=b,oldc=c,oldd=d;a=ff(a,b,c,d,x[i+0],7,-680876936),d=ff(d,a,b,c,x[i+1],12,-389564586),c=ff(c,d,a,b,x[i+2],17,606105819),b=ff(b,c,d,a,x[i+3],22,-1044525330),a=ff(a,b,c,d,x[i+4],7,-176418897),d=ff(d,a,b,c,x[i+5],12,1200080426),c=ff(c,d,a,b,x[i+6],17,-1473231341),b=ff(b,c,d,a,x[i+7],22,-45705983),a=ff(a,b,c,d,x[i+8],7,1770035416),d=ff(d,a,b,c,x[i+9],12,-1958414417),c=ff(c,d,a,b,x[i+10],17,-42063),b=ff(b,c,d,a,x[i+11],22,-1990404162),a=ff(a,b,c,d,x[i+12],7,1804603682),d=ff(d,a,b,c,x[i+13],12,-40341101),c=ff(c,d,a,b,x[i+14],17,-1502002290),b=ff(b,c,d,a,x[i+15],22,1236535329),a=gg(a,b,c,d,x[i+1],5,-165796510),d=gg(d,a,b,c,x[i+6],9,-1069501632),c=gg(c,d,a,b,x[i+11],14,643717713),b=gg(b,c,d,a,x[i+0],20,-373897302),a=gg(a,b,c,d,x[i+5],5,-701558691),d=gg(d,a,b,c,x[i+10],9,38016083),c=gg(c,d,a,b,x[i+15],14,-660478335),b=gg(b,c,d,a,x[i+4],20,-405537848),a=gg(a,b,c,d,x[i+9],5,568446438),d=gg(d,a,b,c,x[i+14],9,-1019803690),c=gg(c,d,a,b,x[i+3],14,-187363961),b=gg(b,c,d,a,x[i+8],20,1163531501),a=gg(a,b,c,d,x[i+13],5,-1444681467),d=gg(d,a,b,c,x[i+2],9,-51403784),c=gg(c,d,a,b,x[i+7],14,1735328473),b=gg(b,c,d,a,x[i+12],20,-1926607734),a=hh(a,b,c,d,x[i+5],4,-378558),d=hh(d,a,b,c,x[i+8],11,-2022574463),c=hh(c,d,a,b,x[i+11],16,1839030562),b=hh(b,c,d,a,x[i+14],23,-35309556),a=hh(a,b,c,d,x[i+1],4,-1530992060),d=hh(d,a,b,c,x[i+4],11,1272893353),c=hh(c,d,a,b,x[i+7],16,-155497632),b=hh(b,c,d,a,x[i+10],23,-1094730640),a=hh(a,b,c,d,x[i+13],4,681279174),d=hh(d,a,b,c,x[i+0],11,-358537222),c=hh(c,d,a,b,x[i+3],16,-722521979),b=hh(b,c,d,a,x[i+6],23,76029189),a=hh(a,b,c,d,x[i+9],4,-640364487),d=hh(d,a,b,c,x[i+12],11,-421815835),c=hh(c,d,a,b,x[i+15],16,530742520),b=hh(b,c,d,a,x[i+2],23,-995338651),a=ii(a,b,c,d,x[i+0],6,-198630844),d=ii(d,a,b,c,x[i+7],10,1126891415),c=ii(c,d,a,b,x[i+14],15,-1416354905),b=ii(b,c,d,a,x[i+5],21,-57434055),a=ii(a,b,c,d,x[i+12],6,1700485571),d=ii(d,a,b,c,x[i+3],10,-1894986606),c=ii(c,d,a,b,x[i+10],15,-1051523),b=ii(b,c,d,a,x[i+1],21,-2054922799),a=ii(a,b,c,d,x[i+8],6,1873313359),d=ii(d,a,b,c,x[i+15],10,-30611744),c=ii(c,d,a,b,x[i+6],15,-1560198380),b=ii(b,c,d,a,x[i+13],21,1309151649),a=ii(a,b,c,d,x[i+4],6,-145523070),d=ii(d,a,b,c,x[i+11],10,-1120210379),c=ii(c,d,a,b,x[i+2],15,718787259),b=ii(b,c,d,a,x[i+9],21,-343485551),a=add(a,olda),b=add(b,oldb),c=add(c,oldc),d=add(d,oldd)}return rhex(a)+rhex(b)+rhex(c)+rhex(d)}function getMD5Value(data){var a=data,b="£¬¡£",c="fdjf,jkgfkl",s=a+b+c;return MD5(s)}var hex_chr="0123456789abcdef";module.factory("$espUserCenter",["$http","$url","$config","$urlHelper","$q",function($http,$url,$config,$urlHelper,$q){var ucUrlInfo=$urlHelper.analyse($url.uc()),realm="portal.services.sdp.nd",headers={Accept:"application/json","Content-Type":"application/json"};ucUrlInfo.port&&(headers["X-Proxy-Port"]=ucUrlInfo.port);var randomCode=function(){code="";for(var codeLength=8,chars=new Array(0,1,2,3,4,5,6,7,8,9,"a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"),i=0;i<codeLength;i++){var charIndex=Math.floor(36*Math.random());code+=chars[charIndex]}return code},$userCenter={login:function(username,password){var encryptedPassword=getMD5Value(password);return $http({method:"POST",url:$url.uc("/v0.8/tokens"),data:{login_name:username+"@"+$config.ucOrg,password:encryptedPassword},headers:headers}).success(function(data){data.adjust_time=new Date(data.server_time).getTime()-(new Date).getTime()})},loadUser:function(loginResp){var uri="/v0.8/users/{user_id}",params={user_id:loginResp.user_id,realm:realm},auth=$userCenter.generateAuthHeader($url.uc(uri,params),"GET",loginResp.adjust_time,loginResp.access_token,loginResp.mac_key);return $http({method:"GET",url:$url.uc(uri,params),headers:angular.extend({Authorization:auth},headers)})},loadRoles:function(loginResp){var uri="/v0.8/users/{user_id}/roles",params={user_id:loginResp.user_id,realm:realm},auth=$userCenter.generateAuthHeader($url.uc(uri,params),"GET",loginResp.adjust_time,loginResp.access_token,loginResp.mac_key);return $http({method:"GET",url:$url.uc(uri,params),headers:angular.extend({Authorization:auth},headers)})},loadPermissions:function(loginResp){return $q.when([])},generateAuthHeader:function(url,method,adjustTime,access_token,mac_key){if(access_token&&mac_key&&CryptoJS){var nonce=(new Date).getTime()+(adjustTime||0)+":"+randomCode(),auth='MAC id="'+access_token+'",nonce="'+nonce+'",mac="',urlInfo=$urlHelper.analyse(url)||{},request_content=nonce+"\n"+method+"\n"+urlInfo.uri+"\n"+(urlInfo.host+(urlInfo.port&&"80"!=urlInfo.port?":"+urlInfo.port:""))+"\n",hash=CryptoJS.HmacSHA256(request_content,mac_key),mac=hash.toString(CryptoJS.enc.Base64);return auth+=mac+'"'}}};return $userCenter}])}),define("service/$espAuth",["question-module"],function(module){module.factory("$auth",["$espUserCenter","$q","$injector","$location",function($espUserCenter,$q,$injector,$location){return $auth={get:function(){var tokenEncrypt=$location.search().token_info;if(tokenEncrypt)try{var key="13465c85caab4dfd8b1cb5093131c6d0",tokenDecrypt=CryptoJS.TripleDES.decrypt(decodeURIComponent(tokenEncrypt),key).toString(CryptoJS.enc.Utf8),tokenInfo=angular.fromJson(tokenDecrypt);tokenInfo.adjust_time=new Date(tokenInfo.server_time).getTime()-new Date(tokenInfo.local_time).getTime();var authInfo={loginInfo:tokenInfo,userInfo:{user_id:tokenInfo.user_id,user_name:tokenInfo.user_id,nick_name:tokenInfo.user_id},roleInfo:{}};return authInfo}catch(e){return console&&console.log(e),null}},login:function(username,password){var loginResp,userResp,roleResp,permissionResp;return $espUserCenter.login(username,password).then(function(response){return loginResp=response.data,$espUserCenter.loadUser(loginResp)},function(response){return $q.reject(response)}).then(function(response){return userResp=response.data,$espUserCenter.loadRoles(loginResp)},function(response){return $q.reject(response)}).then(function(response){return roleResp=response.data,$espUserCenter.loadPermissions(loginResp)},function(response){return $q.reject(response.data)}).then(function(response){permissionResp=response.data;var authInfo={loginInfo:loginResp,userInfo:userResp,roleInfo:roleResp,permissionInfo:permissionResp};return $q.when(authInfo)},function(response){return $q.reject(response)})},logout:function(){return $q.when()},generateAuthHeader:function(url,method){var authInfo=$injector.get("$security").getAuthInfo();return!(!authInfo||!authInfo.loginInfo)&&$espUserCenter.generateAuthHeader(url,method,authInfo.loginInfo.adjust_time,authInfo.loginInfo.access_token,authInfo.loginInfo.mac_key)}},$auth}])}),define("service/convert",["question-module"],function(module){return{convert:function(item){return item}}}),define("service/$qti",["require","question-module","./convert"],function(require,module,convert){module.factory("$qti",["$http","$url","$i18n","$stateParams",function($http,$url,$i18n,$stateParams){var itemTypes=[{code:"$RE0201",category:"objective",name:"choice",label:$i18n("qti.type.choice"),P:!0,S:!0,fchar:$i18n("question.data.char.choice")},{code:"$RE0202",category:"objective",name:"multiplechoice",label:$i18n("qti.type.multiplechoice"),P:!0,S:!0,fchar:$i18n("question.data.char.multiplechoice")},{code:"$RE0204",category:"objective",name:"order",label:$i18n("qti.type.order"),P:!0,S:!0,fchar:$i18n("question.data.char.order")},{code:"$RE0203",category:"objective",name:"judge",label:$i18n("qti.type.judge"),P:!0,S:!0,fchar:$i18n("question.data.char.judge")},{code:"$RE0209",category:"objective",name:"textentry",label:$i18n("qti.type.textentry"),P:!0,S:!1},{code:"$RE0216",category:"objective",name:"textentrymultiple",label:$i18n("qti.type.textentrymultiple"),P:!1,S:!0,fchar:$i18n("question.data.char.textentrymultiple")},{code:"$RE0205",category:"objective",name:"match",label:$i18n("qti.type.match"),P:!0,S:!0,fchar:$i18n("question.data.char.match")},{code:"$RE0206",category:"subjective",name:"extendedtext",label:$i18n("qti.type.extendedtext"),P:!0,S:!1},{code:"$RE0207",category:"objective",name:"graphicgapmatch",label:$i18n("qti.type.graphicgapmatch"),P:!0,S:!0,fchar:$i18n("question.data.char.graphicgapmatch")},{code:"$RE0211",category:"subjective",name:"drawing",label:$i18n("qti.type.drawing"),P:!0,S:!1},{code:"$RE0215",category:"objective",name:"gapmatch",label:$i18n("qti.type.gapmatch"),P:!0,S:!1},{code:"$RE0217",category:"objective",name:"inlinechoice",label:$i18n("qti.type.inlinechoice"),P:!0,S:!1},{code:"$RE0210",category:"subjective",name:"handwrite",label:$i18n("qti.type.handwrite"),P:!0,S:!0,fchar:$i18n("question.data.char.handwrite")},{code:"$RE0212",category:"subjective",name:"specialcomplextext",label:$i18n("qti.type.specialcomplextext"),P:!0,S:!1},{code:"$RE0225",category:"objective",name:"vote",label:$i18n("qti.type.vote"),P:!0,S:!0,fchar:$i18n("question.data.char.vote")},{code:"$RE0208",category:"compound",name:"data",label:$i18n("qti.type.data"),P:!0,S:!1},{code:"$RE0213",category:"compound",name:"reading",label:$i18n("qti.type.reading"),P:!0,S:!1},{code:"$RE0218",category:"compound",name:"comprehensivelearning",label:$i18n("qti.type.comprehensivelearning"),P:!0,S:!1},{code:"$RE0219",category:"compound",name:"application",label:$i18n("qti.type.application"),P:!0,S:!1},{code:"$RE0220",category:"compound",name:"calculation",label:$i18n("qti.type.calculation"),P:!0,S:!1},{code:"$RE0223",category:"compound",name:"proof",label:$i18n("qti.type.proof"),P:!0,S:!1},{code:"$RE0221",category:"compound",name:"explain",label:$i18n("qti.type.explain"),P:!0,S:!1},{code:"$RE0222",category:"compound",name:"readingcomprehension",label:$i18n("qti.type.readingcomprehension"),P:!0,S:!1},{code:"$RE0214",category:"compound",name:"experimentandinquiry",label:$i18n("qti.type.experimentandinquiry"),P:!0,S:!1},{code:"$RE0224",category:"compound",name:"inference",label:$i18n("qti.type.inference"),P:!0,S:!1},{code:"$RE0226",category:"subjective",name:"applicationbase",label:$i18n("qti.type.applicationbase"),P:!0,S:!1},{code:"$RE0227",category:"subjective",name:"proofbase",label:$i18n("qti.type.proofbase"),P:!0,S:!1},{code:"$RE0228",category:"subjective",name:"calculationbase",label:$i18n("qti.type.calculationbase"),P:!0,S:!1},{code:"$RE0229",category:"subjective",name:"explainbase",label:$i18n("qti.type.explainbase"),P:!0,S:!1},{code:"$RE0230",category:"subjective",name:"readingbase",label:$i18n("qti.type.readingbase"),P:!0,S:!1},{code:"$RE0231",category:"subjective",name:"readingcomprehensionbase",label:$i18n("qti.type.readingcomprehensionbase"),P:!0,S:!1},{code:"$RE0232",category:"subjective",name:"subjectivebase",label:$i18n("qti.type.subjectivebase"),P:!0,S:!1,fchar:$i18n("question.data.char.subjectivebase")},{code:"$RE0234",category:"compound",name:"data",label:$i18n("qti.type.data"),P:!0,S:!1}];return{mergeQuestion:function(params){return params.lifecycleServer=$config.lifecycleServer,$http.post($url.slides("/v0.1/tools/merge_questions"),params)},loadAssessmentItems:function(chapterId,categories,questionType,status,page,size,keyword){return $http.get($url.slides("/v1.3/questions",{page:page,size:size,words:keyword||"",chapter_id:chapterId,categories:categories,status:status,question_type:questionType}))},formatItem:function(item){for(var restypes=item.categories.res_type,i=0;i<restypes.length;i++)restypes[i].taxoncode&&restypes[i].taxoncode.lastIndexOf("00")!=restypes[i].taxoncode.length-2&&(item.question_type=restypes[i]);item.categories.source||(item.categories.source=[]),item.chapter_ids=[],item.relations||(item.relations=[]);for(var i=0;i<item.relations.length;i++){var relation=item.relations[i];"chapters"==relation.source_type&&item.chapter_ids.push(relation.source)}item.source=[];for(var i=0;i<item.categories.source.length;i++)item.source[i]=item.categories.source[i].taxoncode;item.categories.subject||(item.categories.subject=[]),item.subject=[];for(var i=0;i<item.categories.subject.length;i++)item.categories.subject[i].taxonpath||item.subject.push(item.categories.subject[i].taxoncode);return item.education_info||(item.education_info={}),item},loadAssessmentItem:function(identifier){return $http.get($url.slides("/v1.3/questions/{0}"+$url.getExtraInfo(),identifier))},createAssessmentItem:function(metadata){return $http.post($url.slides("/v1.3/questions"+$url.getExtraInfo()),metadata)},updateAssessmentItem:function(metadata){return $http.put($url.slides("/v1.3/questions/{0}"+$url.getExtraInfo(),metadata.identifier),metadata)},deleteAssessmentItem:function(metadata){return $http.delete($url.slides("/v1.3/questions/{0}"+$url.getExtraInfo(),metadata.identifier))},loadAssessmentItemContent:function(identifier){return $http.get($url.slides("/v1.3/questions/{0}/item"+$url.getExtraInfo(),identifier))},saveAssessmentItemContent:function(identifier,data){return $http.put($url.slides("/v1.3/questions/{0}/item"+$url.getExtraInfo(),identifier),data)},getAllItemTypes:function(){return itemTypes},getIndependentItemTypes:function(){for(var result=[],i=0;i<itemTypes.length;i++)itemTypes[i].P&&result.push(itemTypes[i]);return result},getSubItemTypes:function(){for(var result=[],i=0;i<itemTypes.length;i++)itemTypes[i].S&&result.push(itemTypes[i]);return result},getItemType:function(typeName){for(var i=0;i<itemTypes.length;i++)if(itemTypes[i].code==typeName)return itemTypes[i]},getItemTypeByName:function(name){for(var i=0;i<itemTypes.length;i++)if(itemTypes[i].name==name)return itemTypes[i]},convert:function(item){return convert.convert(item)},loadHandwriteContent:function(identifier){return $http.get($url.slides("/v1.3/questions/{0}/handwrite"+$url.getExtraInfo(),identifier))},saveHandwriteContent:function(identifier,content){return $http.put($url.slides("/v1.3/questions/{0}/handwrite"+$url.getExtraInfo(),identifier),content)},getQtiPlayerUri:function(id,type){return $http.get($url.slides("/v1.3/questions/{0}/qtiplayer"+$url.getExtraInfo(),id))},loadUser:function(id){var realm="portal.services.sdp.nd";return id&&id.indexOf("@")!=-1&&(id=id.substring(0,id.indexOf("@"))),$http.get($url.slidesRemote("/v1.3/user/"+id+"?realm="+encodeURIComponent(realm)))}}}])}),define("service/$category",["require","question-module"],function(require,module){module.factory("$category",["$http","$q","$url","$cacheFactory",function($http,$q,$url,$cacheFactory){var categoryRelationsCache=$cacheFactory("$category.relations");return{loadCategoryPatterns:function(){var promise=$http({method:"GET",url:$url.portal("/v0.9/category_patterns",{page:1,size:1e4}),cache:!0});return promise.success(function(data){for(var i=0;i<data.items.length;i++)"K12"==data.items[i].pattern_name&&(data.items[i].pattern_path="$O$S$E")}),promise},loadCategoryPattern:function(patternName){if("K12"==patternName)return $http.success({description:"适用于K12基础教育，6年制",identifier:"9de92145-6dd0-43eb-96a4-9e0747d9759e",pattern_name:"K12",purpose:"对资源的分类检索",pattern_path:"$O$S$E",title:"学段年级学科版本模式"});var promise=$http({method:"GET",url:$url.portal("/v0.9/category_patterns",{words:patternName,page:1,size:1e4}),cache:!0});return promise.then(function(response){
var data=response.data;data.items.length?response.data=data.items[0]:response.data=null}),promise},createCategoryPattern:function(pattern){return $http.post($url.portal("/v0.9/category_patterns"),pattern)},updateCategoryPattern:function(pattern){return $http.put($url.portal("/v0.9/category_patterns/{0}",pattern.identifier),pattern)},deleteCategoryPattern:function(identifier){return $http.delete($url.portal("/v0.9/category_patterns/{0}",identifier))},loadCategories:function(levelDefine){return"$O$S$E"==levelDefine?$http.success({items:[{gb_code:"GO",identifier:"3c72d912-c430-498b-aead-3873a91e4057",nd_code:"$O",purpose:"根据国家教育信息化分类标准，进行分类划分",short_name:"applicableobject",source:"国家分类标准",title:"适用对象"},{gb_code:"GS",identifier:"786a7f89-cd90-4207-90b3-9805ef740608",nd_code:"$S",purpose:"根据国家学科分类标准，进行分类",short_name:"subject",source:"国家分类标准",title:"学科"},{gb_code:null,identifier:"c66e6c26-67b7-44a8-ade1-08e4412d08fe",nd_code:"$E",purpose:"将资源根据版本进行分类",short_name:"edition",source:"自定义的分类",title:"版本"}]}):$http({method:"GET",url:$url.portal("/v0.9/categories",{page:1,size:1e4}),cache:!0})},createCategory:function(category){return $http.post($url.portal("/v0.9/categories"),category)},updateCategory:function(category){return $http.put($url.portal("/v0.9/categories/{0}",category.identifier),category)},deleteCategory:function(identifier){return $http.delete($url.portal("/v0.9/categories/{0}",identifier))},loadCategoryRelations:function(patternPath){var cachedRelations=categoryRelationsCache.get(patternPath);if(cachedRelations)return $http.success(cachedRelations);var promise=$http.get($url.portal("/v0.9/category_relation_data",{path:patternPath}));return promise.then(function(response){for(var data=response.data.items,relations=data[0]?data[0].items:[],i=1;i<data.length;i++){var firstItem=data[i].items[0];firstItem&&categoryRelationsCache.put(firstItem.pattern_path,data[i].items)}categoryRelationsCache.put(patternPath,relations),response.data=relations}),promise},clearCategoryRelationCache:function(){categoryRelationsCache.removeAll()},createRelation:function(relation){return $http.post($url.portal("/v0.9/category_patterns/data_relations"),relation)},updateRelation:function(relation){return $http.put($url.portal("/v0.9/category_patterns/data_relations/{0}",relation.identifier),relation)},deleteRelation:function(identifier){return $http.delete($url.portal("/v0.9/category_patterns/data_relations/{0}",identifier))},relationsToPath:function(relations,patterns){for(var result="",i=0,l=0;i<patterns.length;i+=2,l++){var ndCode=patterns.substr(i,2),rs=relations[ndCode];if(rs){angular.isArray(rs)||(rs=[rs]);for(var j=0;j<rs.length;j++){var r=rs[j];r&&(result+="/"+r.target.nd_code)}}}return result},toPath:function(){for(var codes=[],i=0;i<arguments.length;i++)codes[i]=arguments[i]||"";return codes.join("/")},codes:{subject:"$S",source:"RF"},loadCategoryDatas:function(categoryCode,excludeRoot,plane){var promise=$http.get($url.portal("/v0.9/categories/{0}/data",categoryCode));return excludeRoot!==!1&&promise.success(function(data){for(var i=0;i<data.items.length;i++)"ROOT"==data.items[i].parent&&data.items.splice(i,1)}),plane===!1&&promise.success(function(data){for(var items=data.items,result=[],mapping={},i=0;i<items.length;i++)mapping[items[i].identifier]=items[i],items[i].children=[];for(var i=0;i<items.length;i++){var item=items[i],parent=item.parent?mapping[item.parent]:null;parent?parent.children.push(item):result.push(item)}data.items=result}),promise},createData:function(data){return $http.post($url.portal("/v0.9/categories/{0}/data",data.category),data)},updateData:function(data){return $http.put($url.portal("/v0.9/categories/data/{0}",data.identifier),data)},deleteData:function(identifier){return $http.delete($url.portal("/v0.9/categories/data/{0}",identifier))},applyData:function(category,parentData){return $http.get($url.lifecycle("/v0.6/categories/datas/actions/apply",{nd_code:parentData?parentData.nd_code:category.nd_code}))}}}])}),define("service/$messenger.service",["require","question-module","messenger"],function(require,module,messenger){module.factory("$messenger",[function(){var senders={},listeners={},defaultKey="__";return{send:function(data,projectName){try{var sender=senders[projectName||defaultKey];sender||(sender=new Messenger("portal",projectName),sender.addTarget(window.parent,"parent"),senders[projectName||defaultKey]=sender),sender.targets.parent.send(data);try{console.log("send message to parent : "),console.log(data)}catch(e){}}catch(e){console.error("通知消息失败")}},listen:function(fn,projectName){var listener=listeners[projectName||defaultKey];listener||(listener=new Messenger("parent",projectName),listeners[projectName||defaultKey]=listener),listener.listen(fn)}}}])}),define("service/$materialAPI",["require","question-module"],function(require,module){module.factory("$materialAPI",["$http","$url","$category","$context",function($http,$url,$category,$context){String.prototype.format=function(){var args=arguments;return this.replace(/\{(\d+)\}/g,function(s,i){return args[i]})};var recompose=function(rootid,items,root){for(var i=items.length-1;i>=0;i--){var it=items[i];rootid==it.parent&&(it.items=[],it.old=it.title,root.push(it),recompose(it.identifier,items,it.items))}root&&root.length&&root.sort(function(a,b){return a.order_num>b.order_num?1:-1})};return{loadMaterials:function(phase,grade,subject,edition,subedition,words,page,size){var _url="/v1.5/teaching_materials?category={p}/{g}/{s}/{e}/{sube}&words={w}&page={page}&size={size}";return $http({url:$url(_url,{p:phase,g:grade,s:subject,e:edition,sube:subedition,w:words,page:page,size:size}),method:"GET"})},loadMaterial:function(identifier){return $http.get($url.portal("/v1.5/teaching_materials/{0}",identifier))},loadMaterialx:function(phase,grade,subject,edition,subedition,words,page,size){var _url="/v1.5/teaching_materials/single?category={p}/{g}/{s}/{e}/{sube}";return $http({url:$url(_url,{p:phase,g:grade,s:subject,e:edition,sube:subedition}),method:"GET"})},loadChapter:function(identifier){return $http.get($url.portal("/v0.9/teaching_materials/none/chapters/{0}",identifier))},loadChapters:function(identifier,callback){var _url="/v0.9/teaching_materials/{identifier}/tree?level=0";$http({url:$url(_url,{identifier:identifier}),method:"GET"}).success(function(data){var _items=data.items,root=[];recompose(identifier,_items,root),callback(root)}).error(function(data){callback(null,data)})},load2Chapters:function(identifier,callback){var _url="/v0.9/teaching_materials/{identifier}/tree?level=0";$http({url:$url(_url,{identifier:identifier}),method:"GET"}).success(function(data){var _items=data.items;callback(_items)}).error(function(data){callback(null,data)})},createMaterial:function(material){material.creator=$context.currentCreator();var _url="/v1.5/teaching_materials";return $http({url:_url,method:"POST",data:material})},updateMaterial:function(material){var _url="/v1.5/teaching_materials/{identifier}";return $http({url:$url(_url,{identifier:material.identifier}),method:"PUT",data:material})},deleteMaterial:function(identifier,callback){var _url="/v1.5/teaching_materials/{identifier}";$http({url:$url(_url,{identifier:identifier}),method:"DELETE"}).success(function(data){callback(data)}).error(function(data){callback(null,data)})},createChapter:function(materialid,pcid,chapter,callback){var _url="/v0.9/teaching_materials/{identifier}/chapters";chapter.parent=chapter.parent||pcid,$http({url:$url(_url,{identifier:materialid}),method:"POST",data:chapter}).success(function(data){callback(chapter,data)}).error(function(data){callback(null,data)})},createBatchChapters:function(material){var _url="/v0.9/teaching_materials/{identifier}/chapters/actions/batchAdd",chapters=material.chapters;return chapters||(chapters=[]),$http({url:$url(_url,{identifier:material.identifier}),method:"POST",data:chapters})},updateChapter:function(materialid,chapter,callback){var _url="/v0.9/teaching_materials/{materialid}/chapters/{identifier}";$http({url:$url(_url,{materialid:materialid,identifier:chapter.identifier}),method:"PUT",data:chapter}).success(function(data){callback(chapter,data)}).error(function(data){callback(null,data)})},deleteChapter:function(materialid,chapter,callback){var _url="/v0.9/teaching_materials/{materialid}/chapters/{identifier}";$http({url:$url(_url,{materialid:materialid,identifier:chapter.identifier}),method:"DELETE"}).success(function(data){callback(chapter,data)}).error(function(data){callback(null,data)})},load3Chapters:function(materialid,callback){var _url="/v0.9/teaching_materials/{materialid}/include_lesson_chapters";return $http({url:$url(_url,{materialid:materialid}),method:"GET"}).success(function(data){for(var _items=data.items,k=0;k<data.items.length;k++){var it=data.items[k],less=it.lessons;if(less&&less.length)for(var m=0;m<it.lessons.length;m++){var lesson=it.lessons[m];lesson.parent=it.identifier,lesson.order_num=lesson.order_num||m,lesson.islesson=!0,_items.push(lesson)}}callback(_items)}).error(function(data){callback(null,data)})},toCategoryPath:function(material){return console.log(material),$category.toPath(material.phase,material.grade,material.subject,material.edition,material.sub_edition)},loadChapterChain:function(chapterId){return $http.get($url.portal("/v0.9/teaching_materials/none/chapters/{0}",chapterId))},getMaterialUploadAddr:function(){return $http.get($url.portal("/v0.9/resources/assets/upload_info"))}}}])}),define("service/$questionTemplates",["require","question-module","./convert"],function(require,module,convert){module.factory("$questionTemplates",["$http","$url","$i18n","$stateParams","$location",function($http,$url,$i18n,$stateParams,$location){return{getTemplates:function(type){var language=$location.search()._lang_||"zh_CN";return"basic_question"==type?$http.get("/v0.1/public/templates?categoryCode=basic_question&_lang_="+language):$http.get("/v0.1/public/templates?categoryCode=interaction_question&_lang_="+language)},getTemplate:function(code){return $http.get("/v0.1/public/template?code="+code)}}}])}),define("asset/$directives/lcAssetSelect",["require","question-module","jquery","plupload"],function(require,module){var $=require("jquery");module.directive("lcAssetSelect",["$asset","$i18n","$context","$console","$timeout","$document","$filter","$config","$stateParams",function($asset,$i18n,$context,$console,$timeout,$document,$filter,$config,$stateParams){return{restrict:"EA",replace:!0,scope:{handler:"@",firstLoad:"@",category:"@",onSelect:"&",multiSelect:"@",assetSpace:"@",chapterIds:"=",defaultKeyword:"="},templateUrl:"asset/$directives/lcAssetSelect.html",controller:["$scope",function($scope){function join(url,params){if(url)return url.indexOf("?")==-1&&(url+="?size=1200&"),url+params}function identifyInteraction(item,category){if($stateParams.is_interaction){var extra_params="&from_ref_base=true&is_interaction="+($stateParams.is_interaction||"");item.thumbHref=join(item.thumbHref,extra_params),item.actualHref=join(item.actualHref,extra_params),item.previewHref&&("video"===category||"audio"===category?item.previewHref=join(item.previewHref,"%26from_ref_base=true%26is_interaction="+($stateParams.is_interaction||"")):item.previewHref=join(item.previewHref,"&from_ref_base=true&is_interaction="+($stateParams.is_interaction||"")))}}function finishLoad(){var callback=$console.wait($i18n("common.wait.load"),!1);return function(result){callback(result),$scope.loading=!1}}var maxSizeParam=$stateParams.max_size||$config.maxfilesize.image,getDefaultPreview=function(type){return"image"==type?"/editor/basic-question/asset/images/default_image.png":"video"==type?"/editor/basic-question/asset/images/default_video.png":"audio"==type?"/editor/basic-question/asset/images/default_music.png":void 0};$scope.defaultPreview=getDefaultPreview($scope.category),$scope.currentuser=$context.currentUser().userId;var filters={},category=$scope.category||"image";filters="image"==category?{max_file_size:100*$config.maxfilesize.image,mime_types:[{title:$i18n("resource.label.file_type.image"),extensions:"jpg,jpeg,gif,png,bmp"}]}:"audio"==category?{max_file_size:$config.maxfilesize.audio,mime_types:[{title:$i18n("resource.label.file_type.audio"),extensions:"mp3"}]}:{max_file_size:$config.maxfilesize.video,mime_types:[{title:$i18n("resource.label.file_type.video"),extensions:"mp4"}]},$scope.lang=$context.getLang();var filterKeyword=function(str){var isEmpty=function(value){return!value.trim()},isSkip=function(value){return value=value.trim(),null!=value.match(/^[0123456789\.]*$/gi)||(null!=value.match(/^实验：$/gi)||(null!=value.match(/^第.*?(章|节|课)$/gi)||null!=value.match(/^(附录|问题研究)/gi)))};if(!str)return str;str=str.trim();for(var values=str.split(" "),fvalues=[],first=!0,i=0;i<values.length;i++)first?isEmpty(values[i])||isSkip(values[i])||(fvalues.push(values[i].trim()),first=!1):fvalues.push(values[i].trim());var value=fvalues.join(" ");return value=value.replace(/\(.*?\)/gi,""),value=value.replace(/（.*?）/gi,""),value.trim()};$scope.isPersonal="personal"==($scope.assetSpace||$context.resourceSpace),$scope.store="local",$scope.localPagination={page:1,size:24},$scope.minePagination={page:1,size:24},$scope.ndChapterPagination={page:1,size:24},$scope.ndPagination={page:1,size:24},$scope.bdPagination={page:1,size:24},$scope.mineKeyword="",$scope.keyword=filterKeyword($scope.defautlKeyword||$stateParams.chapter_name||""),$scope.keyword2=filterKeyword($scope.defautlKeyword||$stateParams.chapter_name||""),$scope.$watch("defaultKeyword",function(newValue,oldValue){$scope.defaultKeyword&&(""!=$scope.keyword&&""!=$scope.keyword2||(""==$scope.keyword&&($scope.keyword=filterKeyword($scope.defaultKeyword)),""==$scope.keyword2&&($scope.keyword2=filterKeyword($scope.defaultKeyword)),$scope.search()))});var multiSelect="true"===$scope.multiSelect;$scope.search=function(){"local"==$scope.store?($scope.localPagination.page=1,$scope.doSearchLocal()):"mine"==$scope.store?($scope.minePagination.page=1,$scope.doSearchMine()):"ndChapter"==$scope.store?($scope.ndChapterPagination.page=1,$scope.doSearchNdChapter()):"nd"==$scope.store?($scope.ndPagination.page=1,$scope.doSearchNd()):"baidu"==$scope.store&&$scope.doSearchBaidu()},$scope.refresh=function(){"local"==$scope.store?$scope.doSearchLocal():"mine"==$scope.store?$scope.doSearchMine():"ndChapter"==$scope.store?$scope.doSearchNdChapter():"nd"==$scope.store?$scope.doSearchNd():"baidu"==$scope.store&&$scope.doSearchBaidu()},$scope.doSearchLocal=function(){var category=$scope.category||"image";delete $scope.selected,$scope.localItems=[],$scope.loading=!0,$asset.loadAssets(category,$scope.minePagination.page,$scope.minePagination.size,"","local").success(function(data){for(var items=data.items,i=0;i<items.length;i++)$asset.processItem(items[i],category),identifyInteraction(items[i],category);$scope.localItems=items,$scope.localPagination.totalItems=data.total_count}).finally(finishLoad())},$scope.doSearchMine=function(){var category=$scope.category||"image";delete $scope.selected,$scope.mineItems=[],$scope.loading=!0,$asset.loadAssets(category,$scope.minePagination.page,$scope.minePagination.size,$scope.mineKeyword||"",$context.coverage.user,"",maxSizeParam).success(function(data){for(var items=data.items,i=0;i<items.length;i++)$asset.processItem(items[i],category),identifyInteraction(items[i],category);$scope.mineItems=items,$scope.minePagination.totalItems=data.total_count,$scope.loading=!1}).finally(finishLoad())},$scope.doSearchNdChapter=function(page,size){var category=$scope.category||"image";delete $scope.selected,$scope.ndChapterItems=[],$scope.loading=!0,$asset.loadAssets(category,$scope.ndChapterPagination.page,$scope.ndChapterPagination.size,$scope.keyword||"",$context.coverage.common,$scope.chapterIds&&$scope.chapterIds[0],maxSizeParam).success(function(data){for(var items=data.items,i=0;i<items.length;i++)$asset.processItem(items[i],category),identifyInteraction(items[i],category);$scope.ndChapterItems=items,$scope.ndChapterPagination.totalItems=data.total_count,$scope.loading=!1}).finally(finishLoad())},$scope.doSearchNd=function(page,size){var category=$scope.category||"image";delete $scope.selected,$scope.ndItems=[],$scope.loading=!0,$asset.loadAssets(category,$scope.ndPagination.page,$scope.ndPagination.size,$scope.keyword||"",$context.coverage.common,"",maxSizeParam).success(function(data){for(var items=data.items,i=0;i<items.length;i++)$asset.processItem(items[i],category),identifyInteraction(items[i],category);$scope.ndItems=items,$scope.ndPagination.totalItems=data.total_count,$scope.loading=!1}).finally(finishLoad())},$scope.doSearchBaidu=function(page,size){var category="image";delete $scope.selected,$scope.bdItems=[],$scope.loading=!0,$asset.loadAssets(category,$scope.bdPagination.page,$scope.bdPagination.size,$scope.keyword2||"",$context.coverage.baidu,"",maxSizeParam).success(function(data){for(var items=data.items,i=0;i<items.length;i++)$asset.processItem(items[i],category),identifyInteraction(items[i],category);$scope.bdItems=items,$scope.bdPagination.totalItems=data.total_count,$scope.loading=!1}).finally(finishLoad())},"true"===$scope.firstLoad&&$scope.search(),$scope.remove=function(item){$console.confirm($i18n("common.hint.delete"),function(){item==$scope.selected&&delete $scope.selected,$asset.deleteAsset(item).success(function(){if($scope.mineItems.length<=1)return void $scope.search();for(var deleteIndex=-1,i=0;i<$scope.mineItems.length;i++)if(item==$scope.mineItems[i]){deleteIndex=i;break}deleteIndex!=-1&&$scope.mineItems.splice(deleteIndex,1)}).finally($console.wait($i18n("common.wait.delete")))})};var getShortTitle=function(title){if(!title)return title;var i=title.lastIndexOf(".");return i==-1?title:title.substring(0,i)};$scope.beginEditTitle=function(item,$event){item.titleEditing=!0,item.shortTitle=getShortTitle(item.title);var el=angular.element($event.target).parent().find("input");$timeout(function(){$(el).focus()},100)},$scope.cancelEditTitle=function(item){item.titleEditing=!1},$scope.updateTitle=function(item){if($scope.cancelEditTitle(item),item.shortTitle){var i=item.title.lastIndexOf("."),suffix=i==-1?"":item.title.substring(i+1);if(item.shortTitle.length+suffix.length>=100)return void $console.error($i18n("resource.error.title.maxlength"));item.title||(item.title=item.shortTitle),item.title=i==-1?item.shortTitle:item.shortTitle+"."+suffix,$asset.updateAsset(item).success(function(){$console.message($i18n("common.hint.rename.success"))})}},$scope.select=function(item){multiSelect?item._selected=!item._selected:$scope.selected=item},$scope.doSelect=function(){if(multiSelect){var items="local"==$scope.store?$scope.localItems:"mine"==$scope.store?$scope.mineItems:"ndChapter"==$scope.store?$scope.ndChapterItems:$scope.ndItems,selecteds=[];if(items&&items.length)for(var i=0;i<items.length;i++)items[i]._selected&&selecteds.push(items[i]);selecteds.length?$scope.onSelect({items:selecteds}):$console.message($i18n("asset.validate.require.select","asset.label."+$scope.category,!0))}else if($scope.selected){var size=$scope.selected.tech_info.href.size;if(size&&size>1*filters.max_file_size)return void $console.message($i18n("asset.maxsize.select",[$i18n("asset.label."+$scope.category),plupload.formatSize(filters.max_file_size)]));$scope.onSelect({item:$scope.selected,items:[$scope.selected]})}else $console.message($i18n("asset.validate.require.select","asset.label."+$scope.category,!0))},$scope.gotoStore=function(name){$scope.loading||($scope.store=name,$scope.refresh())},$scope.creator=$context.currentCreator(),$scope.creatorName=$context.currentUser().nickName,$scope.cancelUpload=function(uploadItems,item){$console.confirm($i18n("common.hint.cancel"),function(){uploadItems.removeItem(item)})},$scope.onLocalItemCreated=function(item){$scope.localItems.unshift($asset.processItem(item,$scope.category)),identifyInteraction(item,$scope.category),$scope.select(item)},$scope.onMineItemCreated=function(item){$scope.mineItems.unshift($asset.processItem(item,$scope.category)),identifyInteraction(item,$scope.category),$scope.select(item)},$scope.onNdChapterItemCreated=function(item){$scope.ndChapterItems.unshift($asset.processItem(item,$scope.category))},$scope.onNdItemCreated=function(item){$scope.ndItems.unshift($asset.processItem(item,$scope.category))}}],link:function($scope,iElement,iAttrs){$asset.check_net().then(function(result){$scope.net=!0,result.handle=!0},function(result){$scope.net=!1,result.handle=!0}),$scope.handler&&$scope.$parent.$eval(function(s){s[$scope.handler]={refresh:$scope.refresh}})}}}])}),define("asset/$directives/lcAssetStore",["require","question-module","jquery","plupload"],function(require,module){var $=require("jquery");module.directive("lcAssetStore",["$asset","$i18n","$context","$console","$timeout","$document","$filter","$config","$stateParams",function($asset,$i18n,$context,$console,$timeout,$document,$filter,$config,$stateParams){return{restrict:"EA",replace:!0,scope:{category:"@",onSelect:"&",multiSelect:"@",coverage:"@",defaultKeyword:"=",searchAction:"&",loading:"="},templateUrl:"asset/$directives/lcAssetStore.html",controller:["$scope",function($scope){function identifyInteraction(item,category){if($stateParams.is_interaction){var extra_params="&from_ref_base=true&is_interaction="+($stateParams.is_interaction||"");!!item.thumbHref&&(item.thumbHref+=extra_params),!!item.actualHref&&(item.actualHref+=extra_params),item.previewHref&&("video"===category||"audio"===category?item.previewHref+="%26from_ref_base=true%26is_interaction="+($stateParams.is_interaction||""):item.previewHref+="&from_ref_base=true&is_interaction="+($stateParams.is_interaction||""))}}var filters={},category=$scope.category||"image";filters="image"==category?{max_file_size:$config.maxfilesize.image,mime_types:[{title:$i18n("resource.label.file_type.image"),extensions:"jpg,jpeg,gif,png,bmp"}]}:"audio"==category?{max_file_size:$config.maxfilesize.audio,mime_types:[{title:$i18n("resource.label.file_type.audio"),extensions:"mp3"}]}:{max_file_size:$config.maxfilesize.video,mime_types:[{title:$i18n("resource.label.file_type.video"),extensions:"mp4"}]};var filterKeyword=function(str){var isEmpty=function(value){return!value.trim()},isSkip=function(value){return value=value.trim(),null!=value.match(/^[0123456789\.]*$/gi)||(null!=value.match(/^实验：$/gi)||(null!=value.match(/^第.*?(章|节|课)$/gi)||null!=value.match(/^(附录|问题研究)/gi)))};if(!str)return str;str=str.trim();for(var values=str.split(" "),fvalues=[],first=!0,i=0;i<values.length;i++)first?isEmpty(values[i])||isSkip(values[i])||(fvalues.push(values[i].trim()),first=!1):fvalues.push(values[i].trim());var value=fvalues.join(" ");return value=value.replace(/\(.*?\)/gi,""),value=value.replace(/（.*?）/gi,""),value.trim()};$scope.pagination={page:1,size:24},$scope.keyword=filterKeyword($scope.defautlKeyword||$stateParams.chapter_name||""),$scope.$watch("defaultKeyword",function(newValue,oldValue){$scope.defaultKeyword&&(""!=$scope.keyword&&""!=$scope.keyword2||(""==$scope.keyword&&($scope.keyword=filterKeyword($scope.defaultKeyword)),""==$scope.keyword2&&($scope.keyword2=filterKeyword($scope.defaultKeyword)),$scope.search()))});var multiSelect="true"===$scope.multiSelect;$scope.search=function(){$scope.minePagination.page=1,$scope.doSearch()},$scope.refresh=function(){$scope.doSearch()},$scope.doSearch=function(){var category=$scope.category||"image";delete $scope.selected,$scope.mineItems=[],$scope.loading=!0,$scope.searchAction(category,$scope.minePagination.page,$scope.minePagination.size,$scope.keyword||"",$context.coverage.user).success(function(data){for(var items=data.items,i=0;i<items.length;i++)$asset.processItem(items[i],category),identifyInteraction(items[i],category);$scope.items=items,$scope.pagination.totalItems=data.total_count,$scope.loading=!1}).finally($console.wait($i18n("common.wait.load"),!1))},"true"===$scope.firstLoad&&$scope.search(),$scope.remove=function(item){$console.confirm($i18n("common.hint.delete"),function(){item==$scope.selected&&delete $scope.selected,$asset.deleteAsset(item).success(function(){if($scope.mineItems.length<=1)return void $scope.search();for(var deleteIndex=-1,i=0;i<$scope.mineItems.length;i++)if(item==$scope.mineItems[i]){deleteIndex=i;break}deleteIndex!=-1&&$scope.mineItems.splice(deleteIndex,1)}).finally($console.wait($i18n("common.wait.delete")))})};var getShortTitle=function(title){if(!title)return title;var i=title.lastIndexOf(".");return i==-1?title:title.substring(0,i)};$scope.beginEditTitle=function(item,$event){item.titleEditing=!0,item.shortTitle=getShortTitle(item.title);var el=angular.element($event.target).parent().find("input");$timeout(function(){$(el).focus()},100)},$scope.cancelEditTitle=function(item){item.titleEditing=!1},$scope.updateTitle=function(item){if($scope.cancelEditTitle(item),item.shortTitle){var i=item.title.lastIndexOf("."),suffix=i==-1?"":item.title.substring(i+1);if(item.shortTitle.length+suffix.length>=100)return void $console.error($i18n("resource.error.title.maxlength"));item.title||(item.title=item.shortTitle),item.title=i==-1?item.shortTitle:item.shortTitle+"."+suffix,$asset.updateAsset(item).success(function(){$console.message($i18n("common.hint.rename.success"))})}},$scope.select=function(item){multiSelect?item._selected=!item._selected:$scope.selected=item},$scope.doSelect=function(){if(multiSelect){var items=$scope.items,selecteds=[];if(items&&items.length)for(var i=0;i<items.length;i++)items[i]._selected&&selecteds.push(items[i]);selecteds.length?$scope.onSelect({items:selecteds}):$console.message($i18n("asset.validate.require.select","asset.label."+$scope.category,!0))}else if($scope.selected){var size=$scope.selected.tech_info.href.size;if(size&&size>1*filters.max_file_size)return void $console.message($i18n("asset.maxsize.select",[$i18n("asset.label."+$scope.category),plupload.formatSize(filters.max_file_size)]));$scope.onSelect({item:$scope.selected,items:[$scope.selected]})}else $console.message($i18n("asset.validate.require.select","asset.label."+$scope.category,!0))},$scope.gotoStore=function(name){$scope.loading||($scope.store=name,$scope.refresh())},$scope.creator=$context.currentCreator(),$scope.creatorName=$context.currentUser().nickName,$scope.cancelUpload=function(uploadItems,item){$console.confirm($i18n("common.hint.cancel"),function(){uploadItems.removeItem(item)})},$scope.onItemCreated=function(item){$scope.items.unshift($asset.processItem(item,$scope.category)),identifyInteraction(item,$scope.category),$scope.select(item)}}],link:function($scope,iElement,iAttrs){}}}])}),define("asset/$directives/lcAssetUpload",["require","question-module","jquery","plupload"],function(require,module){require("plupload");require("jquery");module.directive("lcAssetUpload",["$asset","$context","$document","$console","$window","$q","$i18n","$filter","$timeout","$url","$auth","$requestInfo","$stateParams","$config",function($asset,$context,$document,$console,$window,$q,$i18n,$filter,$timeout,$url,$auth,$requestInfo,$stateParams,$config){return{restrict:"A",scope:{onItemCreated:"&",uploadItems:"=",assetSpace:"@",assetCoverage:"@"},link:function(scope,iElement,iAttrs){var uploadBasePath="/lib/plu/",url="#",filters={},category=iAttrs.lcAssetUpload||"image",assetType="image"==category?"$RA0101":"video"==category?"$RA0103":"$RA0102";filters="image"==category?{max_file_size:100*$config.maxfilesize.image,mime_types:[{title:$i18n("resource.label.file_type.image"),extensions:"jpg,jpeg,gif,png,bmp"}]}:"audio"==category?{max_file_size:$config.maxfilesize.audio,mime_types:[{title:$i18n("resource.label.file_type.audio"),extensions:"mp3"}]}:{max_file_size:$config.maxfilesize.video,mime_types:[{title:$i18n("resource.label.file_type.video"),extensions:"mp4"}]};var uploadConfig={runtimes:"html5,flash,silverlight,html4",browse_button:iElement[0],container:iElement.parent()[0],url:url,flash_swf_url:uploadBasePath+"/lib/plu/Moxie.swf",silverlight_xap_url:uploadBasePath+"Moxie.xap",headers:{},filters:filters,init:{PostInit:function(up){},FilesAdded:function(up,files){scope.$root.$$phase?scope.onFilesAdded(up,files):scope.$apply(function(){scope.onFilesAdded(up,files)})},BeforeUpload:function(up,file){scope.$root.$$phase?scope.onBeforeUpload(up,file):scope.$apply(function(){scope.onBeforeUpload(up,file)})},UploadProgress:function(up,file){scope.$root.$$phase?scope.onUploadProgress(up,file):scope.$apply(function(){scope.onUploadProgress(up,file)})},FileUploaded:function(up,file,data){scope.$root.$$phase?scope.onFileUploaded(up,file,data):scope.$apply(function(){scope.onFileUploaded(up,file,data)})},Error:function(up,err){scope.$root.$$phase?scope.onError(up,err):scope.$apply(function(){scope.onError(up,err)})}}};scope.uploader=new plupload.Uploader(uploadConfig),scope.uploader.init();var fileItemMapping={};scope.uploadItems=[],scope.uploadItems.removeItem=function(item){scope.uploader.removeFile(item.fileId);for(var deleteIndex=-1,i=0;i<scope.uploadItems.length;i++)if(scope.uploadItems[i]==item){deleteIndex=i;break}deleteIndex!=-1&&scope.uploadItems.splice(deleteIndex,1),delete fileItemMapping[item.fileId]},scope.onFilesAdded=function(up,files){for(var i=0;i<files.length;i++){var file=files[i],newItem={progress:0,size:"0mb",title:file.name,fullsize:plupload.formatSize(file.size),fileId:file.id};scope.uploadItems.push(newItem),fileItemMapping[file.id]=newItem}up.state!=plupload.STARTED&&scope.nextUpload()},scope.nextUpload=function(){scope.uploader.stop();var file=scope.uploader.files[scope.uploader.total.uploaded+scope.uploader.total.failed];file&&$timeout(function(){var chapter_id=$requestInfo.params.chapter_id;fileItemMapping[file.id].uploadUrl=$url.portal("/"+$asset.version()+"/assets/actions/upload",{asset_type:assetType,coverage:scope.assetCoverage,chapter_id:chapter_id,file_path:$url.getFilePath(),is_interaction:$stateParams.is_interaction,question_id:$stateParams.id,question_base:$stateParams.question_base}),scope.uploader.start()})},scope.onBeforeUpload=function(up,file){up.setOption("url",fileItemMapping[file.id].uploadUrl);var authKey=$auth.generateAuthHeader(fileItemMapping[file.id].uploadUrl,"POST");up.setOption("headers",{Authorization:authKey})},scope.onUploadProgress=function(up,file){var item=fileItemMapping[file.id];item.progress=file.percent+"%",item.size=plupload.formatSize(file.loaded)},scope.onFileUploaded=function(up,file,data){scope.nextUpload();var response=angular.fromJson(data.response),identifier=response.identifier,uploadItem=fileItemMapping[file.id];if(identifier){for(var deleteIndex=-1,i=0;i<scope.uploadItems.length;i++)if(scope.uploadItems[i]==uploadItem){deleteIndex=i;break}deleteIndex!=-1&&scope.uploadItems.splice(deleteIndex,1),delete fileItemMapping[file.id],scope.onItemCreated({item:response})}},scope.onError=function(up,err){var errorMessage,item=fileItemMapping[err.file.id];try{var response=angular.fromJson(err.response);errorMessage=response.message}catch(e){}errorMessage=errorMessage||err.message,item?(item.error=!0,item.errorMessage=errorMessage):$console.message(err.file.name+" : "+errorMessage)}}}}])}),define("asset/$directives/lcAssetUploadSingle",["require","question-module","jquery","plupload"],function(require,module){require("plupload");var $=require("jquery");module.directive("lcAssetUploadSingle",["$asset","$context","$console","$document","$window","$q","$i18n","$filter",function($asset,$context,$console,$document,$window,$q,$i18n,$filter){return{restrict:"A",scope:{onItemCreated:"&"},templateUrl:"asset/$directives/lcAssetUploadSingle.html",link:function(scope,iElement,iAttrs){var uploadBasePath="/lib/plu/",url="#",chunkSize="1mb",filters={},category=scope.category=iAttrs.lcAssetUploadSingle||"image";filters="image"==category?{max_file_size:"5mb",mime_types:[{title:$i18n("resource.label.file_type.image"),extensions:"jpg,gif,png,bmp"}]}:"audio"==category?{max_file_size:"100mb",mime_types:[{title:$i18n("resource.label.file_type.audio"),
extensions:"mp3"}]}:{max_file_size:"1000mb",mime_types:[{title:$i18n("resource.label.file_type.video"),extensions:"mp4"}]};var uploadConfig={runtimes:"html5,flash,silverlight,html4",browse_button:$(iElement).find(".upload-area")[0],url:url,flash_swf_url:uploadBasePath+"/lib/plu/Moxie.swf",silverlight_xap_url:uploadBasePath+"Moxie.xap",chunk_size:chunkSize,headers:{},filters:filters,multi_selection:!1,init:{PostInit:function(up){},FilesAdded:function(up,files){scope.onFilesAdded(up,files)},BeforeUpload:function(up,file){scope.onBeforeUpload(up,file)},UploadProgress:function(up,file){scope.onUploadProgress(up,file)},FileUploaded:function(up,file,data){scope.onFileUploaded(up,file,data)},Error:function(up,err){scope.onError(up,err)}}};scope.uploader=new plupload.Uploader(uploadConfig),scope.uploader.init();var processFile=function(file,item){var defererd=$q.defer();if("image"==category)if(window.FileReader){item.duration=0;var nativeFile=file.getNative(),mimeType=file.type||nativeFile.type;if(mimeType&&0==mimeType.indexOf("image/")){var fr=new FileReader;fr.onload=function(e,f){var img=new Image;img.onload=function(e){item.resolution=this.width+"*"+this.height,defererd.resolve(item)},img.onerror=function(){defererd.resolve(item)},img.src=e.target.result,item.src=e.target.result,scope.$digest()},fr.readAsDataURL(nativeFile)}}else defererd.resolve(item);else if("video"==category){var video=angular.element("video")[0];video.preload="metadata",video.onloadedmetadata=function(e){($window.URL||$window.webkitURL).revokeObjectURL(this.src);var duration=parseInt(this.duration);isNaN(duration)&&(duration=-1),item.duration=duration,item.resolution=this.videoWidth+"*"+this.videoHeight,defererd.resolve(item)},video.onerror=function(e){($window.URL||$window.webkitURL).revokeObjectURL(this.src),item.duration=0,defererd.resolve(item)},video.src=($window.URL||$window.webkitURL).createObjectURL(file.getNative())}else if("audio"==category){var audio=angular.element("audio")[0];audio.preload="metadata",audio.oncanplaythrough=function(e){($window.URL||$window.webkitURL).revokeObjectURL(this.src);var duration=parseInt(this.duration);isNaN(duration)&&(duration=-1),item.duration=duration,defererd.resolve(item)},audio.onerror=function(e){($window.URL||$window.webkitURL).revokeObjectURL(this.src),item.duration=0,defererd.resolve(item)},audio.src=($window.URL||$window.webkitURL).createObjectURL(file.getNative())}return defererd.promise};scope.onFilesAdded=function(up,files){for(var allFiles=up.files,i=0;i<allFiles.length-files.length;i++)allFiles[i].status==plupload.QUEUED&&up.removeFile(allFiles[i]);scope.hint="";for(var i=0;i<files.length;i++){var file=files[i];scope.uploadItem={name:file.name,title:file.name,progress:0,size:"0mb",fullsize:plupload.formatSize(file.size),duration:-1},scope.file=file,scope.processPromise=processFile(file,scope.uploadItem),scope.$digest()}},scope.start=function(){scope.uploadItem&&$q.all([scope.processPromise,$asset.getUploadInfo().success(function(data){scope.uploadItem.identifier=data.resource_id,scope.uploadItem.csPath=data.dist_path,scope.uploader.setOption("url",data.upload_url),scope.uploader.setOption("multipart_params",{path:data.dist_path,name:scope.uploadItem.name,file_title:scope.uploadItem.title,file_description:scope.uploadItem.description,file_type:scope.file.type,scope:1,size:scope.file.size})})]).then(function(){scope.uploader.start()})},scope.onBeforeUpload=function(up,file){scope.uploadItem.start=!0},scope.onUploadProgress=function(up,file){scope.uploadItem.progress=file.percent+"%",scope.uploadItem.size=plupload.formatSize(file.loaded),scope.$digest()},scope.onFileUploaded=function(up,file,data){var json=angular.fromJson(data.response);if(json.dentry_id){var cat=scope.category,item={identifier:scope.uploadItem.identifier,title:scope.uploadItem.title,description:scope.uploadItem.description,keywords:[],tags:[],preview:{},life_cycle:{creator:iAttrs.assetCreator||"",publisher:iAttrs.assetPublisher||"",provider:"",provider_source:""},tech_info:{href:{location:"${ref-path}"+scope.uploadItem.csPath+"/"+file.name,format:file.type,size:parseInt(json.inode.size),md5:"",requirements:[]}},coverages:[$context.coverageObject[iAttrs.assetCoverage||"user"]],categories:{assets_type:[{taxoncode:"image"==cat?"$RA0101":"video"==cat?"$RA0103":"$RA0102"}]}};"image"==cat&&(item.preview={240:"${ref-path}"+scope.uploadItem.csPath+"/"+file.name+"?size=240"}),"image"!=cat&&"video"!=cat||item.tech_info.href.requirements.push({name:"resolution",value:scope.uploadItem.resolution}),"video"!=cat&&"audio"!=cat||item.tech_info.href.requirements.push({name:"duration",value:$filter("duration_to_iso")(scope.uploadItem.duration)}),$asset.createAsset(item).success(function(){scope.onItemCreated({item:item})})}scope.hint=$i18n("resource.upload.hint.reselect",item.title),delete scope.uploadItem},scope.onError=function(up,err){scope.uploadItem?(scope.uploadItem.error=!0,scope.uploadItem.errorMessage=err.message,scope.$digest()):$console.message(err.file.name+" : "+err.message)},scope.reset=function(){delete scope.uploadItem,scope.hint=$i18n("resource.upload.label.select")},scope.reset()}}}])}),define("asset/$services/$asset",["require","question-module"],function(require,module){function parseResolutionToSize(resolution){if(resolution&&resolution.indexOf("*")!=-1){var parts=resolution.split("*");if(2==parts.length)return{width:parseInt(parts[0]),height:parseInt(parts[1])}}}module.factory("$asset",["$http","$url","$stateParams","$config","$auth","$context",function($http,$url,$stateParams,$config,$auth,$context){var version=function(){return $stateParams.is_interaction?"v1.3":"v2.0"};return{version:function(){return version()},loadAssets:function(category,page,size,keyword,coverage,chapterId,maxSize){var type="video"==category?"$RA0103":"audio"==category?"$RA0102":"$RA0101";return $http.get($url.slides("/"+version()+"/assets",{type:type,coverage:coverage,page:page,size:size,words:keyword,chapter_id:chapterId,slideServer:$config.slideServer2,csserver:$config.csServer2,main_type:$stateParams.main_type,question_id:$stateParams.id,question_base:$stateParams.question_base||"",is_interaction:$stateParams.is_interaction||"",file_path:$url.getFilePath(),max_size:maxSize}))},getUploadInfo:function(space){return $http.get($url.portal("/v0.9/resources/assets/upload_info"+$url.getExtraInfo(),{space:space}))},createAsset:function(metadata){return $http.post($url.portal("/"+version()+"/assets"+$url.getExtraInfo()),metadata)},deleteAsset:function(metadata){return $http.delete($url.portal("/"+version()+"/assets/{0}"+$url.getExtraInfo(),metadata.identifier))},updateAsset:function(metadata){return $http.put($url.portal("/"+version()+"/assets/{0}"+$url.getExtraInfo(),metadata.identifier),metadata)},check_net:function(){return $http.get($config.checkUrl+"?version="+(new Date).getTime())},processItem:function(item,category){if(!item.tech_info||!item.tech_info.href)return item;item.href=item.tech_info.href.location;var thumbHref;if("video"!=category&&"audio"!=category&&item.preview)for(var key in item.preview)thumbHref=$url.ref(item.preview[key]);if(thumbHref||"image"==category&&(thumbHref=$url.ref(item.href)),item.thumbHref=thumbHref,item.actualHref=$url.ref(item.href),"image"==category)item.previewHref=item.actualHref;else{var media=item.preview&&item.preview.media?item.preview.media:item.actualHref;media+=media.indexOf("?")==-1?"?":"&",item.previewHref=$url.slides("/editor/basic-question/player.html",{mediaUrl:media+("video"==category?".mp4":".mp3")})}if(item.tech_info.href.requirements&&item.tech_info.href.requirements.length)for(var i=0;i<item.tech_info.href.requirements.length;i++){var x=item.tech_info.href.requirements[i];x.name&&"resolution"==x.name.toLowerCase()?(item.resolution=x.value,angular.extend(item,parseResolutionToSize(item.resolution))):x.name&&"duration"==x.name.toLowerCase()&&(item.duration=x.value)}return item.previewHref&&(item.previewHref=item.previewHref.replace("proxy","proxy2")),item}}}])}),define("asset/$filters/assetCategory",["require","question-module"],function(require,module){module.filter("assetCategory",["$i18n",function($i18n){return function(value,type){return"local"==type?value?$i18n("asset.label.local."+value):"":"mine"==type?value?$i18n("asset.label.mine."+value):"":"ndChapter"==type?value?$i18n("asset.label.nd_chapter."+value):"":"nd"==type?value?$i18n("asset.label.nd."+value):"":"baidu"==type?value?$i18n("asset.label.bd."+value):"":value?$i18n("asset.label."+value):""}}]),module.filter("nosuffix",["$i18n",function($i18n){return function(value){return value&&value.lastIndexOf(".")!=-1?value.substring(0,value.lastIndexOf(".")):value}}])}),define("asset/asset_all",["require","question-module","./$directives/lcAssetSelect","./$directives/lcAssetStore","./$directives/lcAssetUpload","./$directives/lcAssetUploadSingle","./$services/$asset","./$filters/assetCategory","css!./style.css"],function(require,module){}),define("qti/ckeditor/lcCkeditor.directive",["require","question-module","jquery","ckeditor","messenger","css!./style.css"],function(require,module){module.directive("lcCkeditor",["$document","$i18n","$timeout","$console",function($document,$i18n,$timeout,$console){return{restrict:"A",require:"?ngModel",scope:{type:"@lcCkeditor",onCreated:"&",onDataChange:"&",enableTextentryInteraction:"@?"},link:function(scope,iElement,attrs,ngModel){var calculateCkeditorCount=function(html){var div=$("<div></div>").html(html);return div.find("img.cke_textEntryInteraction").length+div.find("textentryinteraction").length};if("false"!==attrs.lcCkeditor){var ckeditor,config={language:$i18n.getLanguage()};if(attrs.pasteType&&(config.pasteFilter=attrs.pasteType),scope.type&&"inline"!=scope.type?ckeditor=CKEDITOR.replace(iElement[0],config):(iElement&&iElement.attr("contenteditable",!1),ckeditor=CKEDITOR.inline(iElement[0],config)),"true"===attrs.autoFocus&&(CKEDITOR.last_editor=ckeditor),"true"==attrs.oneline&&(ckeditor.on("key",function(evt){13==evt.data.keyCode&&evt.cancel()}),ckeditor.on("paste",function(evt){var value=$("<div></div>").html(evt.data.dataValue).text();evt.data.dataValue=value,evt.data.type="text"})),!ngModel)return;scope.enableTextentryInteraction||ckeditor.on("paste",function(event){var type=event.data.type,value=event.data.dataValue;"html"==type&&calculateCkeditorCount(value)>0&&($console.alert($i18n("qti.textentry.insert.notallowed")),event.data.dataValue="",event.stop())}),ckeditor.on("instanceReady",function(){var value=ngModel.$viewValue||ngModel.$modelValue||"";"null"==value&&(value=""),setData(value)});var getData=function(){try{return ckeditor.getData()}catch(e){return ckeditor.getData()}},setData=function(data){if(""==data){var read=getData();if(""==read)return}try{ckeditor.setData(data)}catch(e){ckeditor.setData(data)}};ckeditor.on("pasteState",function(){if("$apply"!=scope.$root.$$phase&&"$digest"!=scope.$root.$$phase)scope.$apply(function(){var data=getData();ngModel.$setViewValue(data),scope.onDataChange({data:data,element:iElement,attrs:attrs})});else{var data=getData();ngModel.$setViewValue(data),scope.onDataChange({data:data,element:iElement,attrs:attrs})}}),ckeditor.on("activeEnterModeChange",function(evt){}),ngModel.$render=function(value){setData(ngModel.$viewValue)},scope.onCreated({name:ckeditor.name,ckeditor:ckeditor});var textLength=function(){for(var text=ckeditor.element.getText().replace(/(^\s*)|(\s*$)/g,""),len=0,i=0;i<text.length;i++)8203!=text.charCodeAt(i)&&len++;return len};if(attrs.ndMaxlength){var maxlength=parseInt(attrs.ndMaxlength),maxLengthValidator=function(value){return!isNaN(maxlength)&&!ngModel.$isEmpty(value)&&textLength()>maxlength?void ngModel.$setValidity("maxlength",!1):(ngModel.$setValidity("maxlength",!0),value)};ngModel.$parsers.push(maxLengthValidator),ngModel.$formatters.push(maxLengthValidator)}}else attrs.editorDisable="$all";var disableChange=function(){var disableButtons=(attrs.editorDisable||"").split(",");angular.isFunction(window.disableButtons)&&window.disableButtons(disableButtons)};iElement.on("focus",function(){disableChange()}),attrs.$observe("editorDisable",function(){document.activeElement==iElement[0]&&disableChange()}),ngModel.$isEmpty=function(value){return!(!angular.isUndefined(value)&&""!==value&&null!==value&&value===value)||(value=value.replace(/(&nbsp;)|\s|(<div class=\"background_image\"[^>]*>)/g,""),"<p></p>"==value||"<p></p></div>"==value||"</div>"==value)}}}}])}),define("qti/$directives/lcChoiceItem",["require","question-module"],function(require,module){var itemType="choice",choiceIdentifiers=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O"],createChoice=function(identifier){return{identifier:identifier,text:"",fixed:!1,group_id:"",match_max:1}},createResponse=function(identifier){return{identifier:identifier,cardinality:"single",base_type:"identifier",corrects:[choiceIdentifiers[0]]}},createItem=function(responseIdentifier){return{identifier:null,type:itemType,response_identifier:responseIdentifier,prompt:"",shuffle:!1,choices:[createChoice(choiceIdentifiers[0]),createChoice(choiceIdentifiers[1]),createChoice(choiceIdentifiers[2]),createChoice(choiceIdentifiers[3])],min_choices:0,max_choices:1}},createFeedbackHint=function(responseIdentifier){return{identifier:"showHint",outcomeIdentifier:responseIdentifier,show_hide:"show",content:""}},createFeedbackAnswer=function(responseIdentifier){return{identifier:"showAnswer",outcomeIdentifier:responseIdentifier,show_hide:"show",content:""}};module.directive("lcChoiceItem",["$identifier","$console","$i18n",function($identifier,$console,$i18n){return{restrict:"EA",replace:!0,scope:{assessment:"="},templateUrl:"qti/$directives/lcChoiceItem.html",controller:["$scope",function($scope){$scope.addChoice=function(){var a=$scope.assessment;return a.item.choices.length>=choiceIdentifiers.length?void $console.alert($i18n("qti.choice.validate.max.choice",choiceIdentifiers.length)):void(a.item.choices.length>=choiceIdentifiers.length||a.item.choices.push(createChoice(choiceIdentifiers[a.item.choices.length])))},$scope.removeChoice=function(c){$console.confirm($i18n("common.hint.delete"),function(){for(var a=$scope.assessment,deleted=-1,i=0,len=a.item.choices.length;i<len;i++)deleted!=-1?($scope.answer.value==a.item.choices[i].identifier&&($scope.answer.value=choiceIdentifiers[i-1]),a.item.choices[i].identifier=choiceIdentifiers[i-1]):a.item.choices[i]==c&&($scope.answer.value==c.identifier&&delete $scope.answer.value,deleted=i);a.item.choices.splice(deleted,1)})};var countMediaContent=function(data){if(!data)return 0;var match=data.match(/(<img)|(<video)|(<audio)/g);return match?match.length:0},countMediaData=function(data){if(!data)return 0;var match=data.match(/<img(.*?)((src=\"http:)|(data-widget=\"image\")|(data-cke-real-element-type=\"video\")|(data-cke-real-element-type=\"audio\"))/g);return match?match.length:0};$scope.onChoiceDataChange=function(data,attrs){countMediaContent(data)>0?attrs.$set("editorDisable","image,video,audio,background"):attrs.$set("editorDisable","background")},$scope.onChoiceEditorCreated=function(ckeditor){ckeditor.on("paste",function(evt){var data=evt.editor.getData(),dataValueMediaCount=countMediaData(evt.data.dataValue);(dataValueMediaCount>1||dataValueMediaCount>0&&countMediaContent(data)>0)&&($console.message($i18n("qti.choice.validate.no_allow_multi_media.choice")),evt.stop())})}}],link:function(scope,iElement,iAttrs){scope.assessment||(scope.assessment={type:itemType}),scope.assessment.response||(scope.assessment.response=createResponse("s-"+$identifier.guid())),scope.assessment.item||(scope.assessment.item=createItem(scope.assessment.response.identifier)),scope.assessment.feedbackHint||(scope.assessment.feedbackHint=createFeedbackHint(scope.assessment.response.identifier)),scope.assessment.feedbackAnswer||(scope.assessment.feedbackAnswer=createFeedbackAnswer(scope.assessment.response.identifier)),scope.answer={},scope.assessment.response.corrects&&(scope.answer.value=scope.assessment.response.corrects[0]),scope.$watch("answer.value",function(newV){scope.assessment.response.corrects=[newV]});var trimText=function(text){return text?text.replace(/(^<p>((&nbsp;)|\s)*)|(((&nbsp;)|\s)*<\/p>\s*$)/gim,""):text};scope.assessment.beforeCommit=function(a,errors){var choices=scope.assessment.item.choices;if(choices.length<2)return errors.push({message:$i18n("qti.choice.validate.min.choice",2)}),!1;for(var i=0;i<choices.length;i++){console.log(choices[i].text),console.log(trimText(choices[i].text));for(var j=0;j<choices.length;j++)if(i!=j&&trimText(choices[i].text)==trimText(choices[j].text))return errors.push({message:$i18n("qti.choice.validate.repeat.choice",[choices[i].identifier,choices[j].identifier])}),!1}var corrects=scope.assessment.response.corrects;corrects&&corrects.length&&corrects[0]||errors.push({message:$i18n("qti.choice.validate.require.answer")})}}}}])}),define("qti/$directives/lcDataInteraction",["require","question-module"],function(require,module){var itemType="data",createItem=function(){return{identifier:null,type:itemType,prompt:"",shuffle:!1,min_choices:0,max_choices:1}};module.directive("lcDataInteraction",[function(){return{restrict:"EA",replace:!0,scope:{assessment:"="},controller:["$scope",function($scope){$scope.setPromptEditorName=function(name){$scope.assessment._defaultEditorName=name}}],templateUrl:"qti/$directives/lcDataInteraction.html",link:function(scope,iElement,iAttrs){scope.assessment||(scope.assessment={type:itemType}),scope.assessment._editable=!0,scope.assessment._width||(scope.assessment._width=500),scope.assessment._height||(scope.assessment._height=300),scope.assessment.item?"<p/>"==scope.assessment.item.prompt&&(scope.assessment.item.prompt=""):scope.assessment.item=createItem()}}}])}),define("qti/$directives/lcDataItem",["require","question-module"],function(require,module){var itemType="data",createItem=function(){return{identifier:null,type:itemType,prompt:"",shuffle:!1,min_choices:0,max_choices:1}};module.directive("lcDataItem",[function(){return{restrict:"EA",replace:!0,scope:{assessment:"="},templateUrl:"qti/$directives/lcDataItem.html",controller:["$scope",function($scope){}],link:function(scope,iElement,iAttrs){scope.assessment||(scope.assessment={type:itemType}),scope.assessment.item?"<p/>"==scope.assessment.item.prompt&&(scope.assessment.item.prompt=""):scope.assessment.item=createItem()}}}])}),define("qti/$directives/lcDrawingItem",["require","question-module"],function(require,module){var itemType="drawing",createResponse=function(identifier){return{identifier:identifier,cardinality:"single",base_type:"file",corrects:[]}},createItem=function(responseIdentifier){return{identifier:null,type:itemType,response_identifier:responseIdentifier,prompt_object:{title:"",content:"",assets:["",""]},shuffle:!1,papertype:"1",titletype:"1"}};module.directive("lcDrawingItem",["$identifier","$console","$i18n","$stateParams","$url","$timeout","$filter","$document",function($identifier,$console,$i18n,$stateParams,$url,$timeout,$filter,$document){var papers=[{type:"1",title:$i18n("qti.drawing.label.paper_1")},{type:"5",title:$i18n("qti.drawing.label.paper_5")},{type:"2",title:$i18n("qti.drawing.label.paper_2")},{type:"3",title:$i18n("qti.drawing.label.paper_3")},{type:"6",title:$i18n("qti.drawing.label.paper_6")},{type:"7",title:$i18n("qti.drawing.label.paper_7")},{type:"4",title:$i18n("qti.drawing.label.paper_4")}],subjectPapers={$DEFAULT:["1","6","7","4"],$SB0100:["1","6","7+","4"],$SB0300:["6","7","4","5+"]};return{restrict:"EA",replace:!0,scope:{assessment:"=",subject:"="},templateUrl:"qti/$directives/lcDrawingItem.html",controller:["$scope",function($scope){$scope.createDefaultTitle=function(){for(var index=0,name=$i18n("qti.drawing.label.asset")+(index+1);existTitle(name);)index++,name=$i18n("qti.drawing.label.asset")+(index+1);return name},$scope.insertTextEntryInteraction=function(){if($scope.assessment.response.length>=10)return void $console.alert($i18n("qti.drawing.validate.max.interaction",10));var editor=CKEDITOR.instances[$scope.titleEditorName];if(editor)try{editor.execCommand("textEntryInteraction")}catch(e){editor.execCommand("textEntryInteraction")}},$scope.setPromptEditorName=function(name){$scope.titleEditorName=name},$scope.addAsset=function(){if($scope.assets.length>=20)return void $console.alert($i18n("qti.drawing.validate.max.asset",20));var asset={content:"",title:$scope.createDefaultTitle()};$scope.assets.push(asset),$scope.selectedTab=asset,$scope.assets.length>$scope.MAX_IN_ONEPAGE+$scope.startTabIndex&&($scope.startTabIndex=$scope.assets.length-$scope.MAX_IN_ONEPAGE)},$scope.textentryCount=function(){var count=$(CKEDITOR.instances[$scope.titleEditorName].element.$).find(".cke_textEntryInteraction").length;return count},$scope.assettitle=function(asset,$index){return asset.title},$scope.changeAssetName=function(asset,$event){$scope.stopEdit()&&(asset.editing=!0,asset.lastTitle=asset.title,$event&&$event.stopPropagation())};var existTitle=function(name){for(var i=0;i<$scope.assets.length;i++){var item=$scope.assets[i];if(item.title==name)return!0}return!1},hasSameTitle=function(asset,assetIndex){for(var i=0;i<$scope.assets.length;i++){var item=$scope.assets[i];if(item!=asset&&$scope.assettitle(item,i)==$scope.assettitle(asset,assetIndex))return!0}return!1};$scope.saveAssetName=function(asset,index){return""==asset.title&&(asset.title=asset.lastTitle),hasSameTitle(asset,index)?($console.message($i18n("qti.drawing.asset.title.unique")),!1):(asset.editing=!1,!0)},$scope.stopEvent=function($event){console.log("stop click event "),$event.stopPropagation()},$scope.stopEdit=function(){for(var result=!0,i=0;i<$scope.assets.length;i++)if($scope.assets[i].editing){var one=$scope.saveAssetName($scope.assets[i],i);one||(result=!1)}return result},$scope.alttitle={},$scope.showTitleByMouse=function($event,title){$scope.alttitle.show=!0,$scope.alttitle.title=title;var element=$event.currentTarget;if($(element).hasClass("att_title")){var offset=$(element).offset();$scope.alttitle.top=offset.top+$(element).height()-$($scope.root).offset().top,$scope.alttitle.left=offset.left+$(element).height()/2-$($scope.root).offset().left}},$scope.hideTitleByMouse=function(){console.log("hide title by mouse"),$scope.alttitle.show=!1},$scope.removeAsset=function(asset,$event){for(var deleteIndex=-1,i=0;i<$scope.assets.length;i++)if(asset==$scope.assets[i]){deleteIndex=i;break}deleteIndex!=-1&&$console.confirm($i18n("qti.drawing.hint.delete_asset",$scope.assettitle(asset,deleteIndex)),function(){$scope.assets.splice(i,1),$scope.selectedTab==asset&&($scope.selectedTab=$scope.assets[i],!$scope.selectedTab&&i>0&&($scope.selectedTab=$scope.assets[i-1]))}),$event&&$event.stopPropagation()},$scope.startTabIndex=0,$scope.previousTab=function(){$scope.startTabIndex>0&&$scope.startTabIndex--},$scope.nextTab=function(){$scope.startTabIndex<$scope.assets.length-1&&$scope.startTabIndex++},$scope.changePaperType=function($event,paper){$scope.assessment.item.papertype=paper.type,$event.preventDefault(),$event.stopPropagation()}}],link:function(scope,iElement,iAttrs){scope.assessment||(scope.assessment={type:itemType}),scope.assessment.response||(scope.assessment.response=createResponse("s-"+$identifier.guid())),scope.assessment.item||(scope.assessment.item=createItem(scope.assessment.response.identifier));var paperTypes=[];if(scope.subject&&scope.subject.length)for(var i=0;i<scope.subject.length;i++)paperTypes=paperTypes.concat(subjectPapers[scope.subject[i]]||[]);paperTypes.length||(paperTypes=paperTypes.concat(subjectPapers.$DEFAULT)),scope.papers=[];for(var defaultPaperType,i=0,pm={};i<paperTypes.length;i++){var pt=paperTypes[i];if(pt.indexOf("+")==pt.length-1&&(pt=pt.substring(0,pt.length-1),defaultPaperType=pt),!pm[pt]){pm[pt]=!0;for(var j=0;j<papers.length;j++)pt==papers[j].type&&(papers[j].order=j,scope.papers.push(papers[j]))}}if(scope.papers.sort(function(a,b){return a.order-b.order}),scope.assessment.item.papertype||(scope.assessment.item.papertype=defaultPaperType||scope.papers[0].type),scope.assets=[],scope.assessment.item.prompt_object&&scope.assessment.item.prompt_object.assets)for(var as=scope.assessment.item.prompt_object.assets,i=0;i<as.length;i++){var title=scope.assessment.item.prompt_object.asset_titles?scope.assessment.item.prompt_object.asset_titles[i]:scope.createDefaultTitle();scope.assets.push({content:as[i],title:title})}scope.assets.length&&(scope.selectedTab=scope.assets[0]),scope.hasSameTitle=function(){for(var titleSet={},i=0;i<scope.assets.length;i++){if(titleSet[scope.assets[i].title])return!0;titleSet[scope.assets[i].title]=!0}return!1},scope.assessment.beforeCommit=function(a,errors){if(scope.hasSameTitle())return errors.push($i18n("qti.drawing.asset.title.unique")),!1;for(var as=scope.assessment.item.prompt_object.assets=[],titles=scope.assessment.item.prompt_object.asset_titles=[],i=0;i<scope.assets.length;i++)as.push(scope.assets[i].content),titles.push(scope.assets[i].title||"");return"1"!=scope.assessment.item.titletype||scope.assessment.item.prompt_object.title?("2"==scope.assessment.item.titletype&&(scope.assessment.item.prompt_object.title=""),scope.assessment.item.papertype?scope.assessment.item.titletype?void(scope.assessment.item.object={data:$url.staticFiles("papertype_"+scope.assessment.item.papertype+".png",$stateParams.id),type:"image/png"}):(errors.push({message:$i18n("qti.drawing.validate.require.titletype")}),!1):(errors.push({message:$i18n("qti.drawing.validate.require.paper")}),!1)):(errors.push({message:$i18n("qti.drawing.validate.require.title")}),!1)},scope.MAX_IN_ONEPAGE=5,$(window).resize(function(){$timeout(function(){scope.changeElementWidth()})}),scope.changeElementWidth=function(){var itemWidth=298,width=$(iElement).find(".asset_wrapper").width();return scope.MAX_IN_ONEPAGE=Math.floor(width/itemWidth)-1,scope.MAX_IN_ONEPAGE},$timeout(function(){scope.changeElementWidth()}),scope.root=iElement}}}])}),define("qti/$directives/lcExtendedtextItem",["require","question-module"],function(require,module){var itemType="extendedtext",createResponse=function(identifier){return{identifier:identifier,cardinality:"single",base_type:"string",corrects:[""]}},createItem=function(responseIdentifier){return{identifier:null,type:itemType,response_identifier:responseIdentifier,prompt:"",shuffle:!1}},createFeedbackHint=function(responseIdentifier){return{identifier:"showHint",outcomeIdentifier:responseIdentifier,show_hide:"show",content:""}},createFeedbackAnswer=function(responseIdentifier){return{identifier:"showAnswer",outcomeIdentifier:responseIdentifier,show_hide:"show",content:""}};module.directive("lcExtendedtextItem",["$identifier",function($identifier){return{restrict:"EA",replace:!0,scope:{assessment:"="},templateUrl:"qti/$directives/lcExtendedtextItem.html",controller:["$scope",function($scope){}],link:function(scope,iElement,iAttrs){scope.assessment||(scope.assessment={type:itemType}),scope.assessment.response||(scope.assessment.response=createResponse("s-"+$identifier.guid())),scope.assessment.item||(scope.assessment.item=createItem(scope.assessment.response.identifier)),scope.assessment.feedbackHint||(scope.assessment.feedbackHint=createFeedbackHint(scope.assessment.response.identifier)),scope.assessment.feedbackAnswer||(scope.assessment.feedbackAnswer=createFeedbackAnswer(scope.assessment.response.identifier))}}}])}),define("qti/$directives/lcGapmatchItem",["require","question-module"],function(require,module){var itemType="gapmatch",createChoice=function(identifier){return{identifier:identifier,text:"",fixed:!1,group_id:"",match_max:0}},createResponse=function(identifier){return{identifier:identifier,cardinality:"multiple",base_type:"directedPair",corrects:[]}},createItem=function(responseIdentifier){return{identifier:null,type:itemType,response_identifier:responseIdentifier,prompt:"",shuffle:!1,choices:[],table:{column_names:[{title:"",size:0},{title:"",size:0}],row_names:[{title:"",size:0},{title:"",size:0},{title:"",size:0}],prefix:"G"}}};module.directive("lcGapmatchItem",["$identifier","$console","$i18n",function($identifier,$console,$i18n){return{restrict:"EA",replace:!0,scope:{assessment:"="},templateUrl:"qti/$directives/lcGapmatchItem.html",controller:["$scope",function($scope){var maxRow=5,minRow=2,maxCol=5,minCol=1;$scope.increaseRow=function(){return $scope.table.rows.length>=maxRow?void $console.message($i18n("qti.gapmatch.validate.max.row",maxRow)):void $scope.table.rows.push({title:"",size:0})},$scope.decreaseRow=function(){return $scope.table.rows.length<=minRow?void $console.message($i18n("qti.gapmatch.validate.min.row",minRow)):void $console.confirm($i18n("qti.gapmatch.hint.delete.row"),function(){$scope.table.rows.length=$scope.table.rows.length-1,$scope.choices.length=$scope.table.rows.length})},$scope.increaseCol=function(){return $scope.table.cols.length>=maxCol?void $console.message($i18n("qti.gapmatch.validate.max.column",maxCol)):void $scope.table.cols.push({title:"",size:0})},$scope.decreaseCol=function(){return $scope.table.cols.length<=minCol?void $console.message($i18n("qti.gapmatch.validate.min.column",minCol)):void $console.confirm($i18n("qti.gapmatch.hint.delete.column"),function(){$scope.table.cols.length=$scope.table.cols.length-1;for(var i=0;i<$scope.choices.length;i++)$scope.choices[i].length=$scope.table.cols.length})},$scope.addTextChoice=function(rowIndex,colIndex){$scope.getCell(rowIndex,colIndex).push({identifier:"s-"+$identifier.guid(),type:"text",value:""})},$scope.addImageChoice=function(rowIndex,colIndex){$scope.currentRowIndex=rowIndex,$scope.currentColIndex=colIndex,$scope.imageDialog.open().openPromise.then(function(){$scope.imageSelector.refresh()})},$scope.onImageSelect=function(item){var href=item.actualHref;$scope.getCell($scope.currentRowIndex,$scope.currentColIndex).push({identifier:"s-"+$identifier.guid(),type:"image",value:href}),$scope.imageDialog.close()},$scope.removeChoice=function(rowIndex,colIndex,item){$console.confirm($i18n("qti.gapmatch.hint.delete.choice"),function(){for(var array=$scope.getCell(rowIndex,colIndex),i=0;i<array.length;i++)if(array[i]==item){array.splice(i,1);break}})}}],link:function(scope,iElement,iAttrs){scope.assessment||(scope.assessment={type:itemType}),scope.assessment.response||(scope.assessment.response=createResponse("s-"+$identifier.guid())),scope.assessment.item||(scope.assessment.item=createItem(scope.assessment.response.identifier)),scope.table={rows:scope.assessment.item.table.row_names,cols:scope.assessment.item.table.column_names},scope.choices=[],scope.getCell=function(rowIndex,colIndex){var row=scope.choices[rowIndex];row||(row=scope.choices[rowIndex]=[]);var cell=row[colIndex];return cell||(cell=row[colIndex]=[]),cell};for(var choicesMapping={},i=0;i<scope.assessment.item.choices.length;i++){var c=scope.assessment.item.choices[i],choice={identifier:c.identifier},el=angular.element("<div>"+c.text+"</div>"),src=el.find("img").attr("src");src?(choice.type="image",choice.value=src):(choice.type="text",choice.value=el.find("p").html()),choicesMapping[choice.identifier]=choice}for(var i=0;i<scope.assessment.response.corrects.length;i++){var c=scope.assessment.response.corrects[i],split=c.split(" "),identifier=split[0],cellIndexStr=split[1],cellIndex=cellIndexStr.substring(scope.assessment.item.table.prefix.length).split("_");scope.getCell(parseInt(cellIndex[0])-1,parseInt(cellIndex[1])-1).push(choicesMapping[identifier])}scope.assessment.beforeCommit=function(a,errors){for(var i=0;i<scope.table.rows.length;i++)if(!scope.table.rows[i].title)return errors.push({message:$i18n("qti.gapmatch.validate.require.row_title",i+1)}),!1;for(var i=0;i<scope.table.cols.length;i++)if(!scope.table.cols[i].title)return errors.push({message:$i18n("qti.gapmatch.validate.require.column_title",i+1)}),!1;scope.assessment.item.choices.length=0,scope.assessment.response.corrects.length=0;for(var i=0;i<scope.choices.length;i++){
var row=scope.choices[i];if(row)for(var j=0;j<row.length;j++){var cell=row[j];if(cell)for(var k=0;k<cell.length;k++){var c=cell[k],choice=createChoice(c.identifier);"text"==c.type?choice.text="<p>"+c.value+"</p>":choice.text='<img src="'+c.value+'"/>',scope.assessment.item.choices.push(choice),scope.assessment.response.corrects.push(choice.identifier+" "+scope.assessment.item.table.prefix+(i+1)+"_"+(j+1))}}}}}}}])}),define("qti/$directives/lcGraphicgapmatchItem",["require","question-module","jquery"],function(require,module){var $=require("jquery"),itemType="graphicgapmatch",createResponse=function(identifier){return{identifier:identifier,cardinality:"multiple",base_type:"directedPair",corrects:[]}},createItem=function(responseIdentifier){return{identifier:null,type:itemType,response_identifier:responseIdentifier,prompt:"",shuffle:!1,choices:[],object:{data:""},rows:3,columns:2}},createFeedbackHint=function(responseIdentifier){return{identifier:"showHint",outcomeIdentifier:responseIdentifier,show_hide:"show",content:""}},createFeedbackAnswer=function(responseIdentifier){return{identifier:"showAnswer",outcomeIdentifier:responseIdentifier,show_hide:"show",content:""}};module.directive("lcGraphicgapmatchItem",["$identifier","$console","$i18n",function($identifier,$console,$i18n){return{restrict:"EA",replace:!0,scope:{assessment:"=",defaultKeyword:"="},templateUrl:"qti/$directives/lcGraphicgapmatchItem.html",controller:["$scope",function($scope){function getParam(name,location){return location&&(name=new RegExp("[?&]"+encodeURIComponent(name)+"=([^&]*)").exec(location))?decodeURIComponent(name[1]):""}$scope.selectImage=function(index){$scope.currentIndex=index,$scope.imageDialog.open().openPromise.then(function(){$scope.imageSelector.refresh()})};var findSuffix=function(item){var title=item.title;if(title.indexOf(".")!=-1)return title.substring(title.lastIndexOf(".")+1).toLowerCase();var href=item.tech_info&&item.tech_info.href?item.tech_info.href.location:"",location=getParam("url",href);return location&&location.indexOf("?")!=-1&&(location=location.substring(0,location.indexOf("?"))),location&&location.lastIndexOf(".")!=-1?location.substring(location.lastIndexOf(".")+1).toLowerCase():""};$scope.onImageSelect=function(item){var href=(item.title,findSuffix(item),item.href);$scope.assessment.item.object.data=href,$scope.imageDialog.close()},$scope.rowOptions=[],$scope.columnOptions=[];for(var i=1;i<=9;i++)$scope.rowOptions.push({value:i,label:$i18n("qti.graphicgapmatch.label.row",i)}),$scope.columnOptions.push({value:i,label:$i18n("qti.graphicgapmatch.label.column",i)})}],link:function(scope,iElement,iAttrs){scope.assessment||(scope.assessment={type:itemType}),scope.assessment.response||(scope.assessment.response=createResponse("s-"+$identifier.guid())),scope.assessment.item||(scope.assessment.item=createItem(scope.assessment.response.identifier)),scope.assessment.feedbackHint||(scope.assessment.feedbackHint=createFeedbackHint(scope.assessment.response.identifier)),scope.assessment.feedbackAnswer||(scope.assessment.feedbackAnswer=createFeedbackAnswer(scope.assessment.response.identifier)),scope.assessment.item.object||(scope.assessment.item.object={}),scope.assessment.item.object.params||(scope.assessment.item.object.params={}),scope.assessment.item.object.params.blankImage&&(scope.assessment.item.object.data=scope.assessment.item.object.params.originalImage),scope.lastObject={href:scope.assessment.item.object.params.originalImage,rows:scope.assessment.item.rows,columns:scope.assessment.item.columns},scope.assessment.beforeCommit=function(a,errors){scope.assessment.item.object.data!=scope.lastObject.href||scope.assessment.item.rows!=scope.lastObject.rows||scope.assessment.item.columns!=scope.lastObject.columns?scope.assessment.item.graphchange=!0:scope.assessment.item.graphchange=!1},scope.assessment.afterSave=function(data){scope.lastObject={href:scope.assessment.item.object.data,rows:scope.assessment.item.rows,columns:scope.assessment.item.columns};var find=function(items,id,field){for(var i=0;i<items.length;i++)if(items[i][field]==id)return items[i];throw"保存习题错误"};scope.assessment.item=find(data.items,scope.assessment.item.response_identifier,"response_identifier"),scope.assessment.response=find(data.responses,scope.assessment.item.response_identifier,"identifier")},scope.onImageLoad=function(){scope.imageHeight=$(iElement).find(".qti-ed-graphic-image img").height()};var toRefpath=function(path){var key="/static";return path&&path.indexOf(key)!=-1&&(path="${ref-path}"+path.substring(path.indexOf(key)+key.length)),path};scope.assessment.item.object.data&&(scope.assessment.item.object.data=toRefpath(scope.assessment.item.object.data))}}}])}),define("qti/$directives/lcHandwriteInteraction",["require","question-module"],function(require,module){var itemType="handwrite",createResponse=function(identifier){return{identifier:identifier,cardinality:"single",base_type:"file",corrects:[]}},createItem=function(responseIdentifier){return{identifier:null,type:itemType,response_identifier:responseIdentifier,prompt:"",shuffle:!1,choices:[],min_choices:0,max_choices:1,object:{data:"",width:"1000",height:"600"}}};module.directive("lcHandwriteInteraction",["$identifier","$console","$i18n",function($identifier,$console,$i18n){return{restrict:"EA",replace:!0,scope:{assessment:"="},templateUrl:"qti/$directives/lcHandwriteInteraction.html",controller:["$scope",function($scope){$scope.setBackground=function(){$scope.imageDialog.open().openPromise.then(function(){$scope.imageSelector.refresh()})};$scope.onImageSelect=function(item){var href=item.actualHref;$scope.assessment.item.object.data=href,$scope.assessment.item.object.type=item.tech_info.href.format,$scope.imageDialog.close()},$scope.cancelBackground=function(){$scope.assessment.item.object.data="",$scope.assessment.item.object.type=""}}],link:function(scope,iElement,iAttrs){scope.assessment||(scope.assessment={type:itemType}),scope.assessment._width||(scope.assessment._width=500),scope.assessment._height||(scope.assessment._height=300),scope.assessment.response||(scope.assessment.response=createResponse("s-"+$identifier.guid())),scope.assessment.item||(scope.assessment.item=createItem(scope.assessment.response.identifier)),scope.assessment.beforeCommit=function(a,errors){a.item.object.width=a._width+"",a.item.object.height=a._height+""}}}}])}),define("qti/$directives/lcHandwriteItem",["require","question-module"],function(require,module){var itemType="handwrite",MAX_WIDTH=1620,MAX_HEIGHT=1350,createResponse=function(identifier){return{identifier:identifier,cardinality:"single",base_type:"multipleString",corrects:[""]}},createItemResponse=function(identifier){return{identifier:identifier,cardinality:"single",base_type:"file",corrects:[]}},createItem=function(responseIdentifier){return{identifier:null,type:itemType,response_identifier:responseIdentifier,prompt:"",shuffle:!1,choices:[],min_choices:0,max_choices:1,object:{data:"",type:1,top:0,left:0,right:0,bottom:0,width:MAX_WIDTH,height:MAX_HEIGHT}}},createFeedbackHint=function(){return{identifier:"showHint",outcomeIdentifier:null,show_hide:"show",content:""}},createFeedbackAnswer=function(){return{identifier:"showAnswer",outcomeIdentifier:null,show_hide:"show",content:""}};module.directive("lcHandwriteItem",["$identifier","$console","$i18n",function($identifier,$console,$i18n){return{restrict:"EA",replace:!0,scope:{assessment:"=",responses:"=",defaultKeyword:"="},templateUrl:"qti/$directives/lcHandwriteItem.html",controller:["$scope",function($scope){$scope.insertTextEntryInteraction=function(){if($scope.assessment.response.length>=25)return void $console.alert($i18n("qti.textentry.validate.max.interaction",25));var editor=CKEDITOR.instances[$scope.editorName];if(editor)try{editor.execCommand("textEntryInteraction")}catch(e){editor.execCommand("textEntryInteraction")}},$scope.setPromptEditorName=function(name){$scope.editorName=name},$scope.removeAnswer=function(deleteEntry){$console.confirm($i18n("common.hint.delete"),function(){for(var el=angular.element("<div>"+$scope.assessment.item.prompt+"</div>"),entrys=el.find("textentryinteraction"),i=0;i<entrys.length;i++){var entry=entrys[i];if(angular.element(entry).attr("responseidentifier")==deleteEntry.identifier){angular.element(entry).remove();break}}$scope.assessment.item.prompt=el.html()})};var calculateWidthAndHeight=function(){$scope.background.width=MAX_WIDTH-$scope.background.right-$scope.background.left,$scope.background.height=MAX_HEIGHT-$scope.background.bottom-$scope.background.top},cureentBackground={};$scope.onResizeStart=function(){cureentBackground.top=parseInt($scope.background.top),cureentBackground.bottom=parseInt($scope.background.bottom),cureentBackground.left=parseInt($scope.background.left),cureentBackground.right=parseInt($scope.background.right)};var calculatePosition=function(value,min,max){return value<=min?min:value>=max?max:value};$scope.onResize=function($event,type){"right-bottom"==type?($scope.background.right=calculatePosition(cureentBackground.right-$event.incrementX,0,MAX_WIDTH-$scope.background.left-100),$scope.background.bottom=calculatePosition(cureentBackground.bottom-$event.incrementY,0,MAX_HEIGHT-$scope.background.top-100)):"right-top"==type?($scope.background.right=calculatePosition(cureentBackground.right-$event.incrementX,0,MAX_WIDTH-$scope.background.left-100),$scope.background.top=calculatePosition(cureentBackground.top+$event.incrementY,0,MAX_HEIGHT-$scope.background.bottom-100)):"left-bottom"==type?($scope.background.left=calculatePosition(cureentBackground.left+$event.incrementX,0,MAX_WIDTH-$scope.background.right-100),$scope.background.bottom=calculatePosition(cureentBackground.bottom-$event.incrementY,0,MAX_HEIGHT-$scope.background.top-100)):"left-top"==type?($scope.background.left=calculatePosition(cureentBackground.left+$event.incrementX,0,MAX_WIDTH-$scope.background.right-100),$scope.background.top=calculatePosition(cureentBackground.top+$event.incrementY,0,MAX_HEIGHT-$scope.background.bottom-100)):"move"==type&&($scope.background.left=calculatePosition(cureentBackground.left+$event.incrementX,0,MAX_WIDTH-$scope.background.width),$scope.background.top=calculatePosition(cureentBackground.top+$event.incrementY,0,MAX_HEIGHT-$scope.background.height),$scope.background.right=MAX_WIDTH-$scope.background.left-$scope.background.width,$scope.background.bottom=MAX_HEIGHT-$scope.background.top-$scope.background.height),calculateWidthAndHeight()},$scope.setBackground=function(){$scope.imageDialog.open().openPromise.then(function(){$scope.imageSelector.refresh()})};$scope.onImageSelect=function(item){var resolution=item.resolution;if(resolution){var width=1*resolution.split("*")[0],height=1*resolution.split("*")[1],bg=$scope.background;if(bg.left+bg.right+width>MAX_WIDTH&&(bg.right=Math.max(0,MAX_WIDTH-bg.left-width)),bg.left+bg.right+width>MAX_WIDTH&&(bg.left=Math.max(0,MAX_WIDTH-width)),bg.top+bg.bottom+height>MAX_HEIGHT&&(bg.bottom=Math.max(0,MAX_HEIGHT-bg.top-height)),bg.top+bg.bottom+height>MAX_HEIGHT&&(bg.top=Math.max(0,MAX_HEIGHT-height)),bg.left+bg.right+width<MAX_WIDTH){var differ=MAX_WIDTH-bg.left-bg.right-width;bg.left=bg.left+differ/2,bg.right=bg.right+differ/2}if(bg.top+bg.bottom+height<MAX_HEIGHT){var differ=MAX_HEIGHT-bg.top-bg.bottom-height;bg.top=bg.top+differ/2,bg.bottom=bg.bottom+differ/2}}var href=item.actualHref;$scope.background.url=href,$scope.background.type=2,$scope.imageDialog.close(),calculateWidthAndHeight()},$scope.cancelBackground=function(){$scope.background.url=""}}],link:function(scope,iElement,iAttrs){scope.assessment||(scope.assessment={type:itemType}),scope.assessment.item?"<p/>"==scope.assessment.item.prompt&&(scope.assessment.item.prompt=""):scope.assessment.item=createItem("s-"+$identifier.guid());try{scope.background=JSON.parse(scope.assessment.item.object.data)}catch(e){var item=scope.assessment.item;scope.background={url:item.object.data||"",type:1,top:0,left:0,right:0,bottom:0,width:item.object.width,height:item.object.height}}scope.assessment.response=[];for(var responses=scope.responses||[],i=0;i<responses.length;i++){var r=responses[i];r.identifier==scope.assessment.item.response_identifier?scope.itemResponse=r:scope.assessment.response.push(r)}scope.itemResponse||(scope.itemResponse=createItemResponse(scope.assessment.item.response_identifier)),scope.assessment.feedbackHint||(scope.assessment.feedbackHint=createFeedbackHint()),scope.assessment.feedbackAnswer||(scope.assessment.feedbackAnswer=createFeedbackAnswer());for(var i=0;i<scope.assessment.response.length;i++){var r=scope.assessment.response[i];r._text="<p>"+(r.corrects[0]||"")+"</p>"}scope.$watch("assessment.item.prompt",function(newV){var div=angular.element("<div>"+(newV||"")+"</div>"),entrys=div.find("textentryinteraction"),temp=scope.assessment.response;scope.assessment.response=[];for(var i=0,len=entrys.length;i<len;i++){for(var id=angular.element(entrys[i]).attr("responseidentifier"),f=!1,j=0;j<temp.length;j++)if(temp[j].identifier==id){scope.assessment.response.push(temp[j]),f=!0;break}f||scope.assessment.response.push(createResponse(id,"latex"))}}),scope.assessment.beforeCommit=function(a,errors){var responses=scope.assessment.response;scope.assessment.item.object.data=JSON.stringify(scope.background);for(var i=0;i<responses.length;i++){var text=responses[i]._text||"";if(text=text.replace(/<(?!\/?latex)[^>]*>/gim,""),text=text.replace(/(^((&nbsp;)|\s)*)|(((&nbsp;)|\s)*$)/gim,""),!text)return errors.push({message:$i18n("qti.textentry.validate.require.interaction")}),!1;responses[i].corrects[0]=text}var result=angular.extend({},scope.assessment);return result.response=[scope.itemResponse].concat(scope.assessment.response),result}}}}])}),define("qti/$directives/lcHandwriteItemOld",["require","question-module"],function(require,module){var itemType="handwrite",createResponse=function(identifier){return{identifier:identifier,cardinality:"single",base_type:"multipleString",corrects:[""]}},createItemResponse=function(identifier){return{identifier:identifier,cardinality:"single",base_type:"file",corrects:[]}},createItem=function(responseIdentifier){return{identifier:null,type:itemType,response_identifier:responseIdentifier,prompt:"",shuffle:!1,choices:[],min_choices:0,max_choices:1,object:{data:"",width:"960",height:"640"}}},createFeedbackHint=function(){return{identifier:"showHint",outcomeIdentifier:null,show_hide:"show",content:""}},createFeedbackAnswer=function(){return{identifier:"showAnswer",outcomeIdentifier:null,show_hide:"show",content:""}};module.directive("lcHandwriteItemOld",["$identifier","$console","$i18n",function($identifier,$console,$i18n){return{restrict:"EA",replace:!0,scope:{assessment:"=",responses:"=",defaultKeyword:"="},templateUrl:"qti/$directives/lcHandwriteItemOld.html",controller:["$scope",function($scope){$scope.insertTextEntryInteraction=function(){if($scope.assessment.response.length>=25)return void $console.alert($i18n("qti.textentry.validate.max.interaction",25));var editor=CKEDITOR.instances[$scope.editorName];if(editor)try{editor.execCommand("textEntryInteraction")}catch(e){editor.execCommand("textEntryInteraction")}},$scope.setPromptEditorName=function(name){$scope.editorName=name},$scope.removeAnswer=function(deleteEntry){$console.confirm($i18n("common.hint.delete"),function(){for(var el=angular.element("<div>"+$scope.assessment.item.prompt+"</div>"),entrys=el.find("textentryinteraction"),i=0;i<entrys.length;i++){var entry=entrys[i];if(angular.element(entry).attr("responseidentifier")==deleteEntry.identifier){angular.element(entry).remove();break}}$scope.assessment.item.prompt=el.html()})};var currentWidth,currentHeight;$scope.onResizeStart=function(){currentWidth=parseInt($scope.assessment.item.object.width),currentHeight=parseInt($scope.assessment.item.object.height)},$scope.onResize=function($event){$scope.assessment.item.object.width=Math.min(Math.max(100,currentWidth+$event.incrementX),1620)+"",$scope.assessment.item.object.height=Math.min(Math.max(100,currentHeight+$event.incrementY)+"",1350)},$scope.setBackground=function(){$scope.imageDialog.open().openPromise.then(function(){$scope.imageSelector.refresh()})};var isCorrectResolution=function(text){if(text){var width=text.split("*")[0],height=text.split("*")[1];return width<=1620&&height<=1350}return!1};$scope.onImageSelect=function(item){if(item.tech_info.href&&item.tech_info.href.format&&item.tech_info.href.format.indexOf("gif")!=-1)return void $console.error("不能将GIF图片设为背景");var resolution=item.resolution;if(!isCorrectResolution(resolution))return void $console.error("分辨率不能超过1620*1350.");var href=item.actualHref;$scope.assessment.item.object.data=href,$scope.assessment.item.object.type=item.tech_info.href.format,$scope.imageDialog.close()},$scope.cancelBackground=function(){$scope.assessment.item.object.data="",$scope.assessment.item.object.type=""}}],link:function(scope,iElement,iAttrs){scope.assessment||(scope.assessment={type:itemType}),scope.assessment.item?"<p/>"==scope.assessment.item.prompt&&(scope.assessment.item.prompt=""):scope.assessment.item=createItem("s-"+$identifier.guid()),scope.assessment.response=[];for(var responses=scope.responses||[],i=0;i<responses.length;i++){var r=responses[i];r.identifier==scope.assessment.item.response_identifier?scope.itemResponse=r:scope.assessment.response.push(r)}scope.itemResponse||(scope.itemResponse=createItemResponse(scope.assessment.item.response_identifier)),scope.assessment.feedbackHint||(scope.assessment.feedbackHint=createFeedbackHint()),scope.assessment.feedbackAnswer||(scope.assessment.feedbackAnswer=createFeedbackAnswer());for(var i=0;i<scope.assessment.response.length;i++){var r=scope.assessment.response[i];r._text="<p>"+(r.corrects[0]||"")+"</p>"}scope.$watch("assessment.item.prompt",function(newV){var div=angular.element("<div>"+(newV||"")+"</div>"),entrys=div.find("textentryinteraction"),temp=scope.assessment.response;scope.assessment.response=[];for(var i=0,len=entrys.length;i<len;i++){for(var id=angular.element(entrys[i]).attr("responseidentifier"),f=!1,j=0;j<temp.length;j++)if(temp[j].identifier==id){scope.assessment.response.push(temp[j]),f=!0;break}f||scope.assessment.response.push(createResponse(id,"latex"))}}),scope.assessment.beforeCommit=function(a,errors){for(var responses=scope.assessment.response,i=0;i<responses.length;i++){var text=responses[i]._text||"";if(text=text.replace(/<(?!\/?latex)[^>]*>/gim,""),text=text.replace(/(^((&nbsp;)|\s)*)|(((&nbsp;)|\s)*$)/gim,""),!text)return errors.push({message:$i18n("qti.textentry.validate.require.interaction")}),!1;responses[i].corrects[0]=text}var result=angular.extend({},scope.assessment);return result.response=[scope.itemResponse].concat(scope.assessment.response),result}}}}])}),define("qti/$directives/lcInlinechoiceItem",["require","question-module"],function(require,module){var itemType="inlinechoice",choiceIdentifiers=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O"],createChoice=function(identifier){return{identifier:identifier,text:"",fixed:!1,group_id:"",match_max:1}},createResponse=function(identifier){return{identifier:identifier,cardinality:"multiple",base_type:"identifier",corrects:[choiceIdentifiers[0]]}},createItem=function(){return{identifier:null,type:itemType,response_identifier:null,prompt:'<p><inlinechoiceinteraction responseidentifier="1"></inlinechoiceinteraction><inlinechoiceinteraction responseidentifier="2"></inlinechoiceinteraction></p>',shuffle:!1,choices:[],min_choices:0,max_choices:0,children:[]}},createChildItem=function(responseIdentifier){return{identifier:null,type:itemType,response_identifier:responseIdentifier,prompt:"",shuffle:!1,choices:[createChoice(choiceIdentifiers[0]),createChoice(choiceIdentifiers[1]),createChoice(choiceIdentifiers[2]),createChoice(choiceIdentifiers[3])],min_choices:0,max_choices:0}},createFeedbackHint=function(){return{identifier:"showHint",outcomeIdentifier:null,show_hide:"show",content:""}},createFeedbackAnswer=function(){return{identifier:"showAnswer",outcomeIdentifier:null,show_hide:"show",content:""}};module.directive("lcInlinechoiceItem",["$identifier","$console","$i18n",function($identifier,$console,$i18n){return{restrict:"EA",replace:!0,scope:{assessment:"=",responses:"="},templateUrl:"qti/$directives/lcInlinechoiceItem.html",controller:["$scope",function($scope){$scope.insertInteraction=function(){if($scope.assessment.response.length>=50)return void $console.alert($i18n("qti.textentry.validate.max.interaction",50));var editor=CKEDITOR.instances[$scope.editorName];if(editor)try{editor.execCommand("inlinechoiceinteraction")}catch(e){editor.execCommand("inlinechoiceinteraction")}},$scope.setPromptEditorName=function(name){$scope.editorName=name},$scope.removeInteraction=function(identifier){$console.confirm($i18n("common.hint.delete"),function(){for(var el=angular.element("<div>"+$scope.assessment.item.prompt+"</div>"),entrys=el.find("inlinechoiceinteraction"),i=0;i<entrys.length;i++){var entry=entrys[i];if(angular.element(entry).attr("responseidentifier")==identifier){angular.element(entry).remove();break}}$scope.assessment.item.prompt=el.html()})},$scope.addChoice=function(item){return item.choices.length>=choiceIdentifiers.length?void $console.alert($i18n("qti.choice.validate.max.choice",choiceIdentifiers.length)):void item.choices.push(createChoice(choiceIdentifiers[item.choices.length]))},$scope.removeChoice=function(item,c){$console.confirm($i18n("common.hint.delete"),function(){for(var answer=$scope.answers[item.response_identifier]||{},deleted=-1,i=0,len=item.choices.length;i<len;i++)deleted!=-1?(answer[choiceIdentifiers[i-1]]=answer[item.choices[i].identifier],delete answer[item.choices[i].identifier],item.choices[i].identifier=choiceIdentifiers[i-1]):item.choices[i]==c&&(delete answer[c.identifier],deleted=i);item.choices.splice(deleted,1)})}}],link:function(scope,iElement,iAttrs){scope.assessment||(scope.assessment={type:itemType}),scope.assessment.response||(scope.assessment.response=scope.responses||[]),scope.assessment.item?"<p/>"==scope.assessment.item.prompt&&(scope.assessment.item.prompt=""):scope.assessment.item=createItem(),scope.assessment.feedbackHint||(scope.assessment.feedbackHint=createFeedbackHint()),scope.assessment.feedbackAnswer||(scope.assessment.feedbackAnswer=createFeedbackAnswer()),scope.answers={};for(var i=0;i<scope.assessment.response.length;i++)for(var r=scope.assessment.response[i],answer=scope.answers[r.identifier]={},j=0,len=r.corrects.length;j<len;j++)answer[r.corrects[j]]="1";scope.$watch("assessment.item.prompt",function(newV){var div=angular.element("<div>"+(newV||"")+"</div>"),entrys=div.find("inlinechoiceinteraction"),tempResponses=scope.assessment.response,tempAnswers=scope.answers,tempItems=scope.assessment.item.children;scope.assessment.response=[],scope.answers={},scope.assessment.item.children=[];for(var i=0,len=entrys.length;i<len;i++){for(var id=angular.element(entrys[i]).attr("responseidentifier"),f=!1,j=0;j<tempResponses.length;j++)if(tempResponses[j].identifier==id){scope.assessment.response.push(tempResponses[j]),scope.answers[id]=tempAnswers[id]||{},f=!0;break}f||(scope.assessment.response.push(createResponse(id)),scope.answers[id]={});for(var f=!1,j=0;j<tempItems.length;j++)if(tempItems[j].response_identifier==id){scope.assessment.item.children.push(tempItems[j]),f=!0;break}f||scope.assessment.item.children.push(createChildItem(id))}}),scope.assessment.beforeCommit=function(a,errors){var items=scope.assessment.item.children,responses=scope.assessment.response;if(!items||!items.length)return errors.push({message:$i18n("qti.textentry.validate.min.interaction",1)}),!1;for(var i=0;i<items.length;i++){var choices=items[i].choices;if(choices.length<2)return errors.push({message:$i18n("qti.choice.validate.min.choice",2)}),!1;for(var j=0;j<choices.length;j++)for(var k=0;k<choices.length;k++)if(j!=k&&(choices[j].text||"")==(choices[k].text||""))return errors.push({message:$i18n("qti.choice.validate.repeat.choice",[choices[j].identifier,choices[k].identifier])}),!1}for(var i=0;i<responses.length;i++){var corrects=responses[i].corrects=[],answer=scope.answers[responses[i].identifier]||{};for(var key in answer)"1"===answer[key]&&corrects.push(key);if(!corrects.length||!corrects[0])return void errors.push({message:$i18n("qti.choice.validate.require.answer")})}}}}}])}),define("qti/$directives/lcJudgeItem",["require","question-module"],function(require,module){var itemType="judge",createResponse=function(identifier){return{identifier:identifier,cardinality:"single",base_type:"identifier",corrects:["YES"]}},createItem=function(responseIdentifier){return{identifier:null,type:itemType,response_identifier:responseIdentifier,prompt:"",shuffle:!1,choices:[],min_choices:0,max_choices:1}},createFeedbackHint=function(responseIdentifier){return{identifier:"showHint",outcomeIdentifier:responseIdentifier,show_hide:"show",content:""}},createFeedbackAnswer=function(responseIdentifier){return{identifier:"showAnswer",outcomeIdentifier:responseIdentifier,show_hide:"show",content:""}};module.directive("lcJudgeItem",["$identifier","$i18n",function($identifier,$i18n){return{restrict:"EA",replace:!0,scope:{assessment:"="},templateUrl:"qti/$directives/lcJudgeItem.html",controller:["$scope",function($scope){}],link:function(scope,iElement,iAttrs){scope.assessment||(scope.assessment={type:itemType}),scope.assessment.response||(scope.assessment.response=createResponse("s-"+$identifier.guid())),scope.assessment.item||(scope.assessment.item=createItem(scope.assessment.response.identifier)),scope.assessment.feedbackHint||(scope.assessment.feedbackHint=createFeedbackHint(scope.assessment.response.identifier)),scope.assessment.feedbackAnswer||(scope.assessment.feedbackAnswer=createFeedbackAnswer(scope.assessment.response.identifier)),console.log(scope.assessment),scope.assessment.beforeCommit=function(a,errors){if(scope.assessment.item.choices&&0!=scope.assessment.item.choices.length)for(var i=0;i<scope.assessment.item.choices.length;i++)"YES"==scope.assessment.item.choices[i].identifier&&(scope.assessment.item.choices[i].text=$i18n("common.label.yes")),"NO"==scope.assessment.item.choices[i].identifier&&(scope.assessment.item.choices[i].text=$i18n("common.label.no"));else scope.assessment.item.choices=[{identifier:"YES",fixed:!1,text:$i18n("common.label.yes"),group_id:"",correct:!1,match_max:1},{identifier:"NO",fixed:!1,text:$i18n("common.label.no"),group_id:"",correct:!1,match_max:1}]}}}}])}),define("qti/$directives/lcMatchItem",["require","question-module","jquery"],function(require,module){var $=require("jquery"),itemType="match",choiceIdentifiers=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],groups=["group_1","group_2","group_3"],createChoice=function(identifier,group){return{identifier:identifier,text:"",fixed:!1,group_id:group,match_max:1}},createResponse=function(identifier){return{identifier:identifier,cardinality:"multiple",base_type:"pair",corrects:["A B","C D"]}},createItem=function(responseIdentifier){return{identifier:null,type:itemType,response_identifier:responseIdentifier,prompt:"",shuffle:!0,choices:[createChoice(choiceIdentifiers[0],groups[0]),createChoice(choiceIdentifiers[1],groups[1]),createChoice(choiceIdentifiers[2],groups[0]),createChoice(choiceIdentifiers[3],groups[1])],min_choices:0,max_choices:1}},createFeedbackHint=function(responseIdentifier){return{identifier:"showHint",outcomeIdentifier:responseIdentifier,show_hide:"show",content:""}},createFeedbackAnswer=function(responseIdentifier){return{identifier:"showAnswer",outcomeIdentifier:responseIdentifier,show_hide:"show",content:""}};module.directive("lcMatchItem",["$identifier","$console","$i18n",function($identifier,$console,$i18n){return{restrict:"EA",replace:!0,scope:{assessment:"=",defaultKeyword:"="},templateUrl:"qti/$directives/lcMatchItem.html",controller:["$scope",function($scope){$scope.selectImage=function(choice){$scope.currentChoice=choice,$scope.imageDialog.open().openPromise.then(function(){$scope.imageSelector.refresh()})},$scope.onImageSelect=function(item){var href=item.actualHref;$scope.currentChoice._image=href,$scope.imageDialog.close()},$scope.deleteImage=function(choice){delete choice._image},$scope.addChoiceRow=function(){var row=[],len=$scope.columnCount*$scope.choiceRows.length;if(len+$scope.columnCount>choiceIdentifiers.length)return void $console.alert($i18n("qti.match.validate.max.row",$scope.choiceRows.length));for(var i=0;i<$scope.columnCount;i++)row.push(createChoice(choiceIdentifiers[len++],$scope.choiceRows[0]?$scope.choiceRows[0][i].group_id:groups[i]));$scope.choiceRows.push(row)},$scope.removeChoiceRow=function(index){$console.confirm($i18n("qti.match.hint.delete.choice_row"),function(){$scope.choiceRows.splice(index,1);for(var i=0,len=$scope.choiceRows.length;i<len;i++)for(var row=$scope.choiceRows[i],j=0;j<$scope.columnCount;j++)row[j].identifier=choiceIdentifiers[i*$scope.columnCount+j]})},$scope.$watch("columnCount",function(newV,oldV){for(var i=0,len=$scope.choiceRows.length;i<len;i++)for(var row=$scope.choiceRows[i],j=0;j<$scope.columnCount;j++)row[j]||(row[j]=createChoice("",0==i?groups[j]:$scope.choiceRows[0][j].group_id)),row[j].identifier=choiceIdentifiers[i*$scope.columnCount+j]})}],link:function(scope,iElement,iAttrs){scope.assessment||(scope.assessment={type:itemType}),scope.assessment.response||(scope.assessment.response=createResponse("s-"+$identifier.guid())),scope.assessment.item||(scope.assessment.item=createItem(scope.assessment.response.identifier)),scope.assessment.feedbackHint||(scope.assessment.feedbackHint=createFeedbackHint(scope.assessment.response.identifier)),scope.assessment.feedbackAnswer||(scope.assessment.feedbackAnswer=createFeedbackAnswer(scope.assessment.response.identifier)),scope.disableEditor=function(name){};for(var a=scope.assessment,rows=scope.choiceRows=[],groupIndex={},column=0,i=0,len=a.item.choices.length;i<len;i++){var c=a.item.choices[i],index=groupIndex[c.group_id];index||(groupIndex[c.group_id]=index=[0,column++]);var row=rows[index[0]];if(row||(rows[index[0]]=row=[]),index[0]=index[0]+1,row[index[1]]=c,c.text){var el=angular.element("<div>"+c.text+"</div>");c._image=el.find("img").attr("src"),c._text=el.find("p").prop("outerHTML")}}scope.columnCount=column,scope.$watchCollection("choiceRows",function(){scope.assessment.item.choices=[],scope.assessment.response.corrects=[];for(var i=0,len=scope.choiceRows.length;i<len;i++)for(var row=scope.choiceRows[i],j=0;j<scope.columnCount;j++)scope.assessment.item.choices.push(row[j]),j+1<scope.columnCount&&scope.assessment.response.corrects.push(row[j].identifier+" "+row[j+1].identifier)}),scope.assessment.beforeCommit=function(a,errors){if(scope.choiceRows.length<2)return errors.push({message:$i18n("qti.match.validate.min.row",2)}),!1;for(var imgs=iElement.find("img"),i=0,len=a.item.choices.length;i<len;i++){var c=a.item.choices[i],text="";if(c._image){for(var rawWidth,rawHeight,j=0;j<imgs.length;j++){var img=$(imgs[j]);if(img.attr("src")==c._image){var imgObj=new Image;imgObj.src=c._image,rawWidth=imgObj.width,rawHeight=imgObj.height;break}}text+='<img src="'+c._image+'"',rawWidth&&(text+=' width="'+rawWidth+'"'),rawHeight&&(text+=' height="'+rawHeight+'"'),text+="/>"}if(c._text){var startP=0==c._text.trim().indexOf("<p");text+=startP?c._text:"<p>"+c._text+"</p>"}if(!text)return errors.push({message:$i18n("qti.match.validate.require.choice")}),!1;c.text=text}return a}}}}])}),define("qti/$directives/lcMultiplechoiceItem",["require","question-module"],function(require,module){var itemType="multiplechoice",choiceIdentifiers=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O"],createChoice=function(identifier){return{identifier:identifier,text:"",fixed:!1,group_id:"",match_max:1}},createResponse=function(identifier){return{identifier:identifier,
cardinality:"multiple",base_type:"identifier",corrects:[choiceIdentifiers[0]]}},createItem=function(responseIdentifier){return{identifier:null,type:itemType,response_identifier:responseIdentifier,prompt:"",shuffle:!1,choices:[createChoice(choiceIdentifiers[0]),createChoice(choiceIdentifiers[1]),createChoice(choiceIdentifiers[2]),createChoice(choiceIdentifiers[3])],min_choices:0,max_choices:0}},createFeedbackHint=function(responseIdentifier){return{identifier:"showHint",outcomeIdentifier:responseIdentifier,show_hide:"show",content:""}},createFeedbackAnswer=function(responseIdentifier){return{identifier:"showAnswer",outcomeIdentifier:responseIdentifier,show_hide:"show",content:""}};module.directive("lcMultiplechoiceItem",["$identifier","$console","$i18n",function($identifier,$console,$i18n){return{restrict:"EA",replace:!0,scope:{assessment:"="},templateUrl:"qti/$directives/lcMultiplechoiceItem.html",controller:["$scope",function($scope){$scope.addChoice=function(){var a=$scope.assessment;return a.item.choices.length>=choiceIdentifiers.length?void $console.alert($i18n("qti.choice.validate.max.choice",choiceIdentifiers.length)):void(a.item.choices.length>=choiceIdentifiers.length||a.item.choices.push(createChoice(choiceIdentifiers[a.item.choices.length])))},$scope.removeChoice=function(c){$console.confirm($i18n("common.hint.delete"),function(){for(var a=$scope.assessment,deleted=-1,i=0,len=a.item.choices.length;i<len;i++)deleted!=-1?($scope.answer[choiceIdentifiers[i-1]]=$scope.answer[a.item.choices[i].identifier],delete $scope.answer[a.item.choices[i].identifier],a.item.choices[i].identifier=choiceIdentifiers[i-1]):a.item.choices[i]==c&&(delete $scope.answer[c.identifier],deleted=i);a.item.choices.splice(deleted,1)})};var countMediaContent=function(data){if(!data)return 0;var match=data.match(/(<img)|(<video)|(<audio)/g);return match?match.length:0},countMediaData=function(data){if(!data)return 0;var match=data.match(/<img(.*?)((src=\"http:)|(data-widget=\"image\")|(data-cke-real-element-type=\"video\")|(data-cke-real-element-type=\"audio\"))/g);return match?match.length:0};$scope.onChoiceDataChange=function(data,attrs){countMediaContent(data)>0?attrs.$set("editorDisable","image,video,audio,background"):attrs.$set("editorDisable","background")},$scope.onChoiceEditorCreated=function(ckeditor){ckeditor.on("paste",function(evt){var data=evt.editor.getData(),dataValueMediaCount=countMediaData(evt.data.dataValue);(dataValueMediaCount>1||dataValueMediaCount>0&&countMediaContent(data)>0)&&($console.message($i18n("qti.choice.validate.no_allow_multi_media.choice")),evt.stop())})}}],link:function(scope,iElement,iAttrs){if(scope.assessment||(scope.assessment={type:itemType}),scope.assessment.response||(scope.assessment.response=createResponse("s-"+$identifier.guid())),scope.assessment.item||(scope.assessment.item=createItem(scope.assessment.response.identifier)),scope.assessment.feedbackHint||(scope.assessment.feedbackHint=createFeedbackHint(scope.assessment.response.identifier)),scope.assessment.feedbackAnswer||(scope.assessment.feedbackAnswer=createFeedbackAnswer(scope.assessment.response.identifier)),scope.answer={},scope.assessment.response.corrects)for(var i=0,len=scope.assessment.response.corrects.length;i<len;i++)scope.answer[scope.assessment.response.corrects[i]]="1";scope.$watch("answer",function(newV){scope.assessment.response.corrects=[];for(var key in newV)"1"===newV[key]&&scope.assessment.response.corrects.push(key)},!0);var trimText=function(text){return text?text.replace(/(^<p>((&nbsp;)|\s)*)|(((&nbsp;)|\s)*<\/p>\s*$)/gim,""):text};scope.assessment.beforeCommit=function(a,errors){var choices=scope.assessment.item.choices;if(choices.length<2)return errors.push({message:$i18n("qti.choice.validate.min.choice",2)}),!1;for(var i=0;i<choices.length;i++)for(var j=0;j<choices.length;j++)if(i!=j&&trimText(choices[i].text)==trimText(choices[j].text))return errors.push({message:$i18n("qti.choice.validate.repeat.choice",[choices[i].identifier,choices[j].identifier])}),!1;var corrects=scope.assessment.response.corrects;corrects&&corrects.length&&corrects[0]||errors.push({message:$i18n("qti.choice.validate.require.answer")})}}}}])}),define("qti/$directives/lcOrderItem",["require","question-module"],function(require,module){var itemType="order",choiceIdentifiers=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O"],createChoice=function(identifier){return{identifier:identifier,text:"",fixed:!1,group_id:"",match_max:1}},createResponse=function(identifier){return{identifier:identifier,cardinality:"ordered",base_type:"identifier",corrects:choiceIdentifiers.slice(0,3)}},createItem=function(responseIdentifier){return{identifier:null,type:itemType,response_identifier:responseIdentifier,prompt:"",shuffle:!0,choices:[createChoice(choiceIdentifiers[0]),createChoice(choiceIdentifiers[1]),createChoice(choiceIdentifiers[2])],min_choices:0,max_choices:1}},createFeedbackHint=function(responseIdentifier){return{identifier:"showHint",outcomeIdentifier:responseIdentifier,show_hide:"show",content:""}},createFeedbackAnswer=function(responseIdentifier){return{identifier:"showAnswer",outcomeIdentifier:responseIdentifier,show_hide:"show",content:""}};module.directive("lcOrderItem",["$identifier","$console","$i18n",function($identifier,$console,$i18n){return{restrict:"EA",replace:!0,scope:{assessment:"=",defaultKeyword:"="},templateUrl:"qti/$directives/lcOrderItem.html",controller:["$scope",function($scope){$scope.selectImage=function(choice){$scope.currentChoice=choice,$scope.imageDialog.open().openPromise.then(function(){$scope.imageSelector.refresh()})},$scope.onImageSelect=function(item){var href=item.actualHref;$scope.currentChoice._image=href,$scope.imageDialog.close()},$scope.deleteImage=function(choice){delete choice._image},$scope.addChoice=function(){var a=$scope.assessment;if(a.item.choices.length>=choiceIdentifiers.length)return void $console.message($i18n("qti.order.validate.max.choice",choiceIdentifiers.length));var identifier=choiceIdentifiers[a.item.choices.length];a.item.choices.push(createChoice(identifier)),a.response.corrects.push(identifier)},$scope.removeChoice=function(c){$console.confirm($i18n("common.hint.delete"),function(){for(var a=$scope.assessment,deleted=-1,i=0,len=a.item.choices.length;i<len;i++)if(deleted!=-1){for(var j=0;j<a.response.corrects.length;j++)if(a.response.corrects[j]==a.item.choices[i].identifier){a.response.corrects[j]=choiceIdentifiers[i-1];break}a.item.choices[i].identifier=choiceIdentifiers[i-1]}else if(a.item.choices[i]==c){deleted=i;for(var j=0;j<a.response.corrects.length&&a.response.corrects[j]!=a.item.choices[i].identifier;j++);a.response.corrects.splice(j,1)}a.item.choices.splice(deleted,1)})}}],link:function(scope,iElement,iAttrs){scope.assessment||(scope.assessment={type:itemType}),scope.assessment.response||(scope.assessment.response=createResponse("s-"+$identifier.guid())),scope.assessment.item||(scope.assessment.item=createItem(scope.assessment.response.identifier)),scope.assessment.feedbackHint||(scope.assessment.feedbackHint=createFeedbackHint(scope.assessment.response.identifier)),scope.assessment.feedbackAnswer||(scope.assessment.feedbackAnswer=createFeedbackAnswer(scope.assessment.response.identifier));for(var i=0,len=scope.assessment.item.choices.length;i<len;i++){var c=scope.assessment.item.choices[i];if(c.text){var el=angular.element("<div>"+c.text+"</div>");c._image=el.find("img").attr("src"),c._text=el.find("p").prop("outerHTML")}}scope.assessment.beforeCommit=function(a,errors){if(scope.assessment.item.choices.length<2)return errors.push({message:$i18n("qti.order.validate.min.choice",2)}),!1;for(var i=0,len=a.item.choices.length;i<len;i++){var c=a.item.choices[i],text="";if(c._image&&(text+='<img src="'+c._image+'"/>'),c._text){var startP=0==c._text.trim().indexOf("<p");text+=startP?c._text:"<p>"+c._text+"</p>"}if(!text)return errors.push({message:$i18n("qti.order.validate.require.choice")}),!1;c.text=text}return a}}}}])}),define("qti/$directives/lcRichEditor",["require","question-module","jquery"],function(require,module){var $=require("jquery");module.directive("lcRichEditor",["$i18n","$document","$timeout","$config","$url","$console","$q","$asset","$stateParams","$location","$context",function($i18n,$document,$timeout,$config,$url,$console,$q,$asset,$stateParams,$location,$context){return{restrict:"EA",replace:!0,scope:{beforeCommand:"&",showItemCommand:"@",assetChapterIds:"=",defaultKeyword:"="},templateUrl:"qti/$directives/lcRichEditor.html",link:function(scope,iElement,iAttrs){function isUnstylable(ele){return"false"==ele.getAttribute("contentEditable")||ele.getAttribute("data-nostyle")}scope.lang=$context.getLang();var executeCommand=function(commandName,fn){var editor=scope.beforeCommand({commandName:commandName});executeCommandFn(editor,fn)},executeCommandFn=function(editor,fn){editor!==!1&&(editor?angular.isString(editor)&&(editor=CKEDITOR.instances[editor]):editor=CKEDITOR.last_editor,editor&&(editor.then?editor.then(function(ed){executeCommandFn(ed,fn)}):("ready"==editor.status?fn(editor):editor.on("instanceReady",function(){fn(editor)}),CKEDITOR.last_editor=editor)))};scope.onImageSelect=function(item){item=$asset.processItem(item,"image");var width=item.width||200,height=item.height||0,rate=300/item.width;width>300&&(width*=rate,height*=rate);var href=item.actualHref;executeCommand("image",function(editor){insert_image(editor,{filename:item.title,type:"image",url:href,width:width,height:height}),editor.focus()}),scope.imageDialog.close()};var checkVideo=function(item){var code,deferred=$q.defer(),href=item.tech_info.href,size=parseInt(href.size)||0,sizeError=size>$config.maxfilesize.video;if(href.requirements)for(var i=0;i<href.requirements.length;i++)if("code"==href.requirements[i].name){code=href.requirements[i].value;break}var codeError=!1;if(sizeError||codeError){var message;message=$i18n(sizeError&&codeError?"resource.upload.video.maxsize_and_emptycode":sizeError?"resource.upload.video.maxsize":"resource.upload.video.formaterror"),$console.confirm(message,function(){deferred.resolve()},function(){deferred.reject()})}else deferred.resolve();return deferred.promise},checkAudio=function(item){var deferred=$q.defer(),href=item.tech_info.href,size=parseInt(href.size)||0,sizeError=size>$config.maxfilesize.audio;if(sizeError){var message=i18n("resource.upload.audio.maxsize");$console.confirm(message,function(){deferred.resolve()},function(){deferred.reject()})}else deferred.resolve();return deferred.promise};scope.onVideoSelect=function(item){checkVideo(item).then(function(){var href=item.actualHref,preview=$url.staticFiles("default_video.png",$stateParams.id);executeCommand("video",function(editor){insert_video_or_audio(editor,{filename:item.title,type:"video",url:href,poster:preview,width:300,height:300}),editor.focus()}),scope.videoDialog.close()})},scope.onAudioSelect=function(item){checkAudio(item).then(function(){var href=item.actualHref,preview=$url.staticFiles("default_audio.png",$stateParams.id);executeCommand("audio",function(editor){insert_video_or_audio(editor,{filename:item.title,type:"audio",url:href,poster:preview,width:50,height:30}),editor.focus()}),scope.audioDialog.close()})},scope.clickButton=function(btn,$event){btn.disabled||angular.isFunction(btn.click)&&btn.click($event)};var command=function(name){return function(){return executeCommand(name,function(editor){editor.execCommand(name),editor.focus()}),!1}},noop=function(name){return function(){executeCommand(name,angular.noop)}};scope.colorPicker={left:88,top:43,show:!1};var typeForColorSet,hideColorPicker=function(){scope.colorPicker.show=!1,$document.find("body").off("click",hideColorPicker),scope.$digest()},showColorPicker=function(type){return function($event){$document.find("body").off("click",hideColorPicker),typeForColorSet=type,scope.colorPicker.show=!0;var pos=$($event.target).position();scope.colorPicker.top=pos.top,scope.colorPicker.left=pos.left;var editor=CKEDITOR.last_editor;return editor&&editor.focus(),$timeout(function(){$document.find("body").on("click",hideColorPicker)}),!1}};scope.onColorSelect=function(color){if(typeForColorSet){var type=typeForColorSet;executeCommand("back"==type?"bgcolor":"textcolor",function(editor){var config=editor.config;if(editor.removeStyle(new CKEDITOR.style(config["colorButton_"+type+"Style"],{color:"inherit"})),color){var colorStyle=config["colorButton_"+type+"Style"];colorStyle.childRule="back"==type?function(element){return isUnstylable(element)}:function(element){return!(element.is("a")||element.getElementsByTag("a").count())||isUnstylable(element)},editor.applyStyle(new CKEDITOR.style(colorStyle,{color:color}))}editor.focus()})}},scope.pixelPicker={left:0,top:0,show:!1};var hidePixelPicker=function(){scope.pixelPicker.show=!1,$document.find("body").off("click",hidePixelPicker),scope.$digest()},showPixelPicker=function(){return function($event){$document.find("body").off("click",hidePixelPicker),scope.pixelPicker.show=!0;var pos=$($event.target).position();scope.pixelPicker.top=pos.top,scope.pixelPicker.left=pos.left;var editor=CKEDITOR.last_editor;return editor&&editor.focus(),$timeout(function(){$document.find("body").on("click",hidePixelPicker)}),!1}};scope.onPixelSelect=function(value){value&&executeCommand("fontsize",function(editor){var config=editor.config;if(editor.focus(),""==editor.getSelection().getSelectedText())return void $console.message(i18n("common.select.font-size"));var style=new CKEDITOR.style(config.fontSize_style,{size:value+"px"});style.apply(editor.document),editor.focus()})};var toUrl=function(url,params){url+="?";for(var key in params)url+=key+"="+encodeURIComponent(params[key])+"&";return url},calculatePreviewSize=function(){var titleHeight=82,rate=16/9,screenHeight=$(window).height(),screenWidth=$(window).width(),height=Math.min(900,screenHeight-50),width=Math.min(1280,screenWidth-100),rwidth=width/rate>height-titleHeight?(height-titleHeight)*rate:width,rheight=width/rate>height-titleHeight?height:width/rate+titleHeight;return{width:rwidth,height:rheight}},size=calculatePreviewSize();scope.sampleUrl=function(){var params=angular.copy($location.search());return params.old_identifier=$stateParams.id,params.old_file_path=params.file_path,params.width=size.width,params.height=size.height,delete params.file_path,toUrl("question.html#/import_sample",params)};var openDialog=function(type){return function(){return"image"==type?scope.imageDialog.open().openPromise.then(function(){scope.imageSelector.refresh()}):"video"==type?scope.videoDialog.open().openPromise.then(function(){scope.videoSelector.refresh()}):"audio"==type?scope.audioDialog.open().openPromise.then(function(){scope.audioSelector.refresh()}):"math"==type?executeCommand("mathjax",function(editor){editor.execCommand("mathjax")}):"sample"==type&&scope.sampleDialog.open({width:size.width+"px",height:size.height+"px"}).openPromise.then(function(){}),!1}},showSample="true"!=$stateParams.hideSample&&"true"!=$stateParams.isSample;scope.btns=[[{name:"bold",title:$i18n("qti.editor.label.tools.bold"),dimension:"small",on:!1,click:command("bold")},{name:"italic",title:$i18n("qti.editor.label.tools.italic"),dimension:"small",on:!1,click:command("italic")},{name:"underline",title:$i18n("qti.editor.label.tools.underline"),dimension:"small",on:!1,click:command("underline")},{name:"through",title:$i18n("qti.editor.label.tools.through"),dimension:"small",on:!1,click:command("removeFormat")},{name:"fontsize",title:$i18n("qti.editor.label.tools.fontsize"),dimension:"small",on:!1,click:showPixelPicker()},"/",{name:"superscript",title:$i18n("qti.editor.label.tools.superscript"),dimension:"small",on:!1,click:command("superscript")},{name:"subscript",title:$i18n("qti.editor.label.tools.subscript"),dimension:"small",on:!1,click:command("subscript")},{name:"textcolor",title:$i18n("qti.editor.label.tools.textcolor"),dimension:"small",on:!1,click:showColorPicker("fore")},{name:"bgColor",title:$i18n("qti.editor.label.tools.bgColor"),dimension:"small",on:!1,click:showColorPicker("back")}],[{name:"table",title:$i18n("qti.editor.label.tools.table"),dimension:"small",on:!1,click:command("table")},"/",{name:"horizontalrule",title:$i18n("qti.editor.label.tools.horizontalrule"),dimension:"small",on:!1,click:command("horizontalrule")}],[{name:"imageleft",title:$i18n("qti.editor.label.tools.imageleft"),dimension:"small",disabled:!0,on:!1,click:command("justifyleft")},"/",{name:"imageright",title:$i18n("qti.editor.label.tools.imageright"),dimension:"small",disabled:!0,on:!1,click:command("justifyright")}],[{name:"justifyright",title:$i18n("qti.editor.label.tools.justifyright"),dimension:"small",on:!1,click:command("justifyright")},{name:"justifyblock",title:$i18n("qti.editor.label.tools.justifyblock"),dimension:"small",on:!1,click:command("justifyblock")},"/",{name:"justifyleft",title:$i18n("qti.editor.label.tools.justifyleft"),dimension:"small",on:!1,click:command("justifyleft")},{name:"justifycenter",title:$i18n("qti.editor.label.tools.justifycenter"),dimension:"small",on:!1,click:command("justifycenter")}],[{name:"image",title:$i18n("asset.label.insert.image_b"),dimension:"large",on:!1,click:openDialog("image")}],[{name:"video",title:$i18n("asset.label.insert.video_b"),dimension:"large",on:!1,click:openDialog("video")}],[{name:"audio",title:$i18n("asset.label.insert.audio_b"),dimension:"large",on:!1,click:openDialog("audio")}],[{name:"math",title:$i18n("asset.label.insert.math_b"),dimension:"large",on:!1,click:openDialog("math")}],[{name:"sample",title:$i18n("asset.label.insert.sample_b"),dimension:"large",hide:!showSample,on:!1,click:openDialog("sample")}],[{name:"item_data",title:$i18n("asset.label.insert.item_data"),dimension:"large",isItem:!0,on:!1,click:noop("item_data")}],[{name:"item_textentry",title:$i18n("asset.label.insert.item_textentry"),dimension:"large",isItem:!0,on:!1,click:noop("item_textentry")}],[{name:"item_handwrite",title:$i18n("asset.label.insert.item_handwrite"),dimension:"large",isItem:!0,on:!1,click:noop("item_handwrite")}]];var disableChange=function(){for(var disableButtons=(iAttrs.editorDisable||"").split(","),i=0;i<disableButtons.length;i++)for(var j=0;j<scope.btns.length;j++)for(var k=0;k<scope.btns[j].length;k++)disableButtons[i]==scope.btns[j][k].name&&(scope.btns[j][k].hide=!0)};disableChange(),window.setButtonStatus=function(commandName,status){for(var i=0;i<scope.btns.length;i++)for(var j=0;j<scope.btns[i].length;j++){var button=scope.btns[i][j];button&&button.name&&button.name==commandName.toLowerCase()&&(button.on=1==status)}},window.disableButtons2=function(disabled){for(var names=["imagetop","imagebottom","imageleft","imageright"],names2=["justifyleft","justifycenter","justifyright","justifyblock"],i=0;i<scope.btns.length;i++)for(var j=0;j<scope.btns[i].length;j++){var button=scope.btns[i][j];button&&button.name&&names.indexOf(button.name)!=-1&&(button.disabled=disabled),button&&button.name&&names2.indexOf(button.name)!=-1&&(button.disabled=!disabled)}},window.disableButtons=function(dis){for(var i=0;i<scope.btns.length;i++)for(var j=0;j<scope.btns[i].length;j++){var button=scope.btns[i][j];if(angular.isObject(button)){button.disabled=!1;for(var k=0;k<dis.length;k++)if("$all"==dis[k]||dis[k]==button.name){button.disabled=!0;break}}}"$apply"!=scope.$root.$$phase&&"$digest"!=scope.$root.$$phase&&scope.$digest()}}}}])}),define("qti/$directives/lcTextentryInteraction",["require","question-module"],function(require,module){var itemType="textentry",createResponse=function(identifier){return{identifier:identifier,cardinality:"single",base_type:"multipleString",corrects:[""]}},createItem=function(){return{identifier:null,type:itemType,response_identifier:null,prompt:"",shuffle:!1,choices:[],min_choices:0,max_choices:1}};module.directive("lcTextentryInteraction",["$identifier","$console","$i18n",function($identifier,$console,$i18n){return{restrict:"EA",replace:!0,scope:{assessment:"=",responses:"="},templateUrl:"qti/$directives/lcTextentryInteraction.html",controller:["$scope",function($scope){$scope.setPromptEditorName=function(name){$scope.editorName=name,$scope.assessment._defaultEditorName=name},$scope.toggleInteraction=function(){var editor=CKEDITOR.instances[$scope.editorName];if(editor)try{editor.execCommand("insertpre")}catch(e){if("no_text"==e)$console.message($i18n("qti.textentry.validate.require.select.text"));else try{editor.execCommand("insertpre")}catch(e){"no_text"==e&&$console.message($i18n("qti.textentry.validate.require.select.text"))}}}}],link:function(scope,iElement,iAttrs){scope.assessment||(scope.assessment={type:itemType}),scope.assessment._editable=!0,scope.assessment._width||(scope.assessment._width=500),scope.assessment._height||(scope.assessment._height=300),scope.assessment.response||(scope.assessment.response=scope.responses||[]),scope.assessment.item?"<p/>"==scope.assessment.item.prompt&&(scope.assessment.item.prompt=""):scope.assessment.item=createItem(),scope.prompt=scope.assessment.item.prompt.replace(/<textentryinteraction responseidentifier="([^\"]+)" ([^>].*?)><\/textentryinteraction>/gm,function(text,identifier){for(var responseText="",i=0;i<scope.assessment.response.length;i++){var r=scope.assessment.response[i];if(r.identifier==identifier){responseText=r.corrects[0]||"";break}}return'<span class="textentryinline">'+responseText+"</span>"}),scope.assessment.beforeCommit=function(a,errors){var responses=[];a.item.prompt=scope.prompt.replace(/<span class=\"textentryinline\">((<span[^>]*>(<span[^>]*>(<span[^>]*>.*?<\/span>|.|\s)*?<\/span>|.|\s)*?<\/span>|.|\s)*?)<\/span>/gm,function(text,content){if(content=content.replace(/<(?!\/?latex)[^>]*>/gim,""),!content)return"";if(!content.replace(/((&nbsp;)|\s)*/gim,""))return errors.push({message:$i18n("qti.textentry.validate.require.interaction")}),"";var r=createResponse("s-"+$identifier.guid());return r.corrects[0]=content,responses.push(r),'<textentryinteraction responseidentifier="'+r.identifier+'"></textentryinteraction>'}),a.response=responses}}}}])}),define("qti/$directives/lcTextentryInteractionExtend",["require","question-module"],function(require,module){module.directive("lcTextentryInteractionExtend",["$identifier","$console","$i18n",function($identifier,$console,$i18n){return{restrict:"EA",replace:!0,scope:{assessment:"=",responses:"="},templateUrl:"qti/$directives/lcTextentryInteractionExtend.html",controller:["$scope",function($scope){$scope.insertTextEntryInteraction=function(){if($scope.assessment.response.length>=50)return void $console.alert($i18n("qti.textentry.validate.max.interaction",50));var editor=CKEDITOR.instances[$scope.assessment._editorName];if(editor)try{editor.execCommand("textEntryInteraction")}catch(e){editor.execCommand("textEntryInteraction")}},$scope.removeAnswer=function(deleteEntry){$console.confirm($i18n("common.hint.delete"),function(){for(var el=angular.element("<div>"+$scope.assessment.item.prompt+"</div>"),entrys=el.find("textentryinteraction"),i=0;i<entrys.length;i++){var entry=entrys[i];if(angular.element(entry).attr("responseidentifier")==deleteEntry.identifier){angular.element(entry).remove();break}}$scope.assessment.item.prompt=el.html()})}}],link:function(scope,iElement,iAttrs){}}}])}),define("qti/$directives/lcTextentryItem",["require","question-module"],function(require,module){var itemType="textentry",createResponse=function(identifier){return{identifier:identifier,cardinality:"single",base_type:"multipleString",corrects:[""]}},createItem=function(){return{identifier:null,type:itemType,response_identifier:null,prompt:'<p><textEntryInteraction responseidentifier="1"></textEntryInteraction><textEntryInteraction responseidentifier="2"></textEntryInteraction></p>',shuffle:!1,choices:[],min_choices:0,max_choices:1}},createFeedbackHint=function(){return{identifier:"showHint",outcomeIdentifier:null,show_hide:"show",content:""}},createFeedbackAnswer=function(){return{identifier:"showAnswer",outcomeIdentifier:null,show_hide:"show",content:""}};module.directive("lcTextentryItem",["$identifier","$console","$i18n",function($identifier,$console,$i18n){return{restrict:"EA",replace:!0,scope:{assessment:"=",responses:"="},templateUrl:"qti/$directives/lcTextentryItem.html",controller:["$scope",function($scope){var maxInteractionCount=25;$scope.insertTextEntryInteraction=function(){if($scope.assessment.response.length>=maxInteractionCount)return void $console.alert($i18n("qti.textentry.validate.max.interaction",maxInteractionCount));var editor=CKEDITOR.instances[$scope.editorName];if(editor)try{editor.execCommand("textEntryInteraction")}catch(e){editor.execCommand("textEntryInteraction")}};var calculateCkeditorCount=function(html){var div=$("<div></div>").html(html);return div.find("img.cke_textEntryInteraction").length+div.find("textentryinteraction").length};$scope.setPromptEditorName=function(name){$scope.editorName=name;var editor=CKEDITOR.instances[$scope.editorName];editor&&editor.on("paste",function(event){var value=(event.data.type,event.data.dataValue),pasteCount=calculateCkeditorCount(value),allCount=calculateCkeditorCount(editor.getData()),selectCount=0,selection=editor.getSelection().getNative();if(selection){for(var container=document.createElement("div"),i=0,len=selection.rangeCount;i<len;++i)container.appendChild(selection.getRangeAt(i).cloneContents());var text=container.innerHTML;selectCount=calculateCkeditorCount(text)}allCount-selectCount+pasteCount>maxInteractionCount&&($console.alert($i18n("qti.textentry.validate.max.interaction",maxInteractionCount)),event.data.dataValue="",event.stop())})},$scope.removeAnswer=function(deleteEntry){$console.confirm($i18n("common.hint.delete"),function(){for(var el=angular.element("<div>"+$scope.assessment.item.prompt+"</div>"),entrys=el.find("textentryinteraction"),i=0;i<entrys.length;i++){var entry=entrys[i];if(angular.element(entry).attr("responseidentifier")==deleteEntry.identifier){angular.element(entry).remove();break}}$scope.assessment.item.prompt=el.html()})}}],link:function(scope,iElement,iAttrs){scope.assessment||(scope.assessment={type:itemType}),scope.assessment.response||(scope.assessment.response=scope.responses||[]),scope.assessment.item?"<p/>"==scope.assessment.item.prompt&&(scope.assessment.item.prompt=""):scope.assessment.item=createItem(),scope.assessment.feedbackHint||(scope.assessment.feedbackHint=createFeedbackHint()),scope.assessment.feedbackAnswer||(scope.assessment.feedbackAnswer=createFeedbackAnswer());for(var i=0;i<scope.assessment.response.length;i++){var r=scope.assessment.response[i];r._text="<p>"+(r.corrects[0]||"")+"</p>"}scope.$watch("assessment.item.prompt",function(newV,oldV){var div=angular.element("<div>"+(newV||"")+"</div>"),entrys=div.find("textentryinteraction"),temp=scope.assessment.response;scope.assessment.response=[];for(var i=0,len=entrys.length;i<len;i++){for(var id=angular.element(entrys[i]).attr("responseidentifier"),f=!1,j=0;j<temp.length;j++)if(temp[j].identifier==id){scope.assessment.response.push(temp[j]),f=!0;break}f||scope.assessment.response.push(createResponse(id,"latex"))}}),scope.assessment.beforeCommit=function(a,errors){var responses=scope.assessment.response;if(!responses||!responses.length)return errors.push({message:$i18n("qti.textentry.validate.min.interaction",1)}),!1;for(var i=0;i<responses.length;i++){var text=responses[i]._text||"";if(text=text.replace(/<(?!\/?latex)[^>]*>/gim,""),text=text.replace(/(^((&nbsp;)|\s)*)|(((&nbsp;)|\s)*$)/gim,""),!text)return errors.push({message:$i18n("qti.textentry.validate.require.interaction")}),!1;responses[i].corrects[0]=text}}}}}])}),define("qti/$directives/lcTextentrymultipleItem",["require","question-module"],function(require,module){var itemType="textentrymultiple",createResponse=function(identifier,cardinality){return{identifier:identifier,cardinality:cardinality,base_type:"multipleString",corrects:[]}},createItem=function(responseIdentifier){return{identifier:null,type:itemType,response_identifier:responseIdentifier,prompt:"",shuffle:!1}},createFeedbackHint=function(responseIdentifier){return{identifier:"showHint",outcomeIdentifier:responseIdentifier,show_hide:"show",content:""}},createFeedbackAnswer=function(responseIdentifier){return{identifier:"showAnswer",outcomeIdentifier:responseIdentifier,show_hide:"show",content:""}};module.directive("lcTextentrymultipleItem",["$identifier","$console","$i18n",function($identifier,$console,$i18n){return{restrict:"EA",replace:!0,scope:{assessment:"="},templateUrl:"qti/$directives/lcTextentrymultipleItem.html",controller:["$scope",function($scope){var maxInteractionCount=25;$scope.insertTextEntryInteraction=function(){if($scope.corrects.length>=maxInteractionCount)return void $console.alert($i18n("qti.textentry.validate.max.interaction",maxInteractionCount));var editor=CKEDITOR.instances[$scope.editorName];if(editor)try{editor.execCommand("textEntryInteraction")}catch(e){editor.execCommand("textEntryInteraction")}};var calculateCkeditorCount=function(html){var div=$("<div></div>").html(html);return div.find("img.cke_textEntryInteraction").length+div.find("textentryinteraction").length};$scope.setPromptEditorName=function(name){$scope.editorName=name;var editor=CKEDITOR.instances[$scope.editorName];editor&&editor.on("paste",function(event){var value=(event.data.type,event.data.dataValue),pasteCount=calculateCkeditorCount(value),allCount=calculateCkeditorCount(editor.getData()),selectCount=0,selection=editor.getSelection().getNative();if(selection){for(var container=document.createElement("div"),i=0,len=selection.rangeCount;i<len;++i)container.appendChild(selection.getRangeAt(i).cloneContents());var text=container.innerHTML;selectCount=calculateCkeditorCount(text)}allCount-selectCount+pasteCount>maxInteractionCount&&($console.alert($i18n("qti.textentry.validate.max.interaction",maxInteractionCount)),event.data.dataValue="",event.stop())})},$scope.removeAnswer=function(deleteEntry){$console.confirm($i18n("common.hint.delete"),function(){for(var el=angular.element("<div>"+$scope.assessment.item.prompt+"</div>"),entrys=el.find("textentryinteraction"),i=0;i<entrys.length;i++){var entry=entrys[i];if(angular.element(entry).attr("responseidentifier")==deleteEntry.identifier){angular.element(entry).remove();break}}$scope.assessment.item.prompt=el.html()})}}],link:function(scope,iElement,iAttrs){scope.assessment||(scope.assessment={type:itemType}),scope.assessment.response||(scope.assessment.response=createResponse("s-"+$identifier.guid(),scope.assessment.cardinality||"multiple")),scope.assessment.item||(scope.assessment.item=createItem(scope.assessment.response.identifier)),scope.assessment.feedbackHint||(scope.assessment.feedbackHint=createFeedbackHint(scope.assessment.response.identifier)),scope.assessment.feedbackAnswer||(scope.assessment.feedbackAnswer=createFeedbackAnswer(scope.assessment.response.identifier)),scope.corrects=[];for(var entrys=angular.element("<div>"+scope.assessment.item.prompt+"</div>").find("textentryinteraction"),i=0,len=entrys.length;i<len;i++){var id=angular.element(entrys[i]).attr("responseidentifier");scope.corrects.push({identifier:id,text:scope.assessment.response.corrects[i]})}scope.$watch("assessment.item.prompt",function(newV){var entrys=angular.element("<div>"+newV+"</div>").find("textentryinteraction"),temp=scope.corrects;scope.corrects=[];for(var i=0,len=entrys.length;i<len;i++){for(var id=angular.element(entrys[i]).attr("responseidentifier"),f=!1,j=0;j<temp.length;j++)if(temp[j].identifier==id){scope.corrects.push(temp[j]),f=!0;break}f||scope.corrects.push({identifier:id,text:""})}}),scope.$watch("corrects",function(newV){scope.assessment.response.corrects=[];for(var i=0;i<newV.length;i++)scope.assessment.response.corrects.push(newV[i].text||"")},!0),scope.assessment.beforeCommit=function(a,errors){if(!scope.corrects.length)return errors.push({message:$i18n("qti.textentry.validate.min.interaction",1)
}),!1;scope.assessment.response.corrects=[];for(var i=0;i<scope.corrects.length;i++){var text=scope.corrects[i].text||"";if(text=text.replace(/<(?!\/?latex)[^>]*>/gim,""),text=text.replace(/(^((&nbsp;)|\s)*)|(((&nbsp;)|\s)*$)/gim,""),!text)return errors.push({message:$i18n("qti.textentry.validate.require.interaction")}),!1;scope.assessment.response.corrects.push(text)}}}}}])}),define("qti/$directives/lcVoteItem",["require","question-module"],function(require,module){var itemType="vote",choiceIdentifiers=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],createChoice=function(identifier){return{identifier:identifier,text:"",fixed:!1,group_id:"",match_max:1}},createResponse=function(identifier){return{identifier:identifier,cardinality:"single",base_type:"identifier",corrects:[]}},createItem=function(responseIdentifier){return{identifier:null,type:itemType,response_identifier:responseIdentifier,prompt:"",shuffle:!1,choices:[createChoice(choiceIdentifiers[0]),createChoice(choiceIdentifiers[1]),createChoice(choiceIdentifiers[2]),createChoice(choiceIdentifiers[3])],min_choices:0,max_choices:1}},identifierPrefix="ndvote_";module.directive("lcVoteItem",["$identifier","$console","$i18n",function($identifier,$console,$i18n){return{restrict:"EA",replace:!0,scope:{assessment:"="},templateUrl:"qti/$directives/lcVoteItem.html",controller:["$scope",function($scope){function resetChoiceIdentifier(){for(var a=$scope.assessment,b=a.item.choices.length>26,i=0;i<a.item.choices.length;i++)a.item.choices[i].identifier=b?identifierPrefix+(i+1):choiceIdentifiers[i]}function isEmpty(value){return!(!angular.isUndefined(value)&&""!==value&&null!==value&&value===value)||(value=value.replace(/(&nbsp;)|\s|(<div class=\"background_image\"[^>]*>)/g,""),"<p></p>"==value||"<p></p></div>"==value||"</div>"==value)}function doRemoveChoice(c){for(var a=$scope.assessment,i=0,len=a.item.choices.length;i<len;i++)if(a.item.choices[i]==c){a.item.choices.splice(i,1),resetChoiceIdentifier();break}}$scope.filterChoiceIdentifier=function(identifier){return 0==identifier.indexOf(identifierPrefix)&&(identifier=identifier.substring(identifierPrefix.length)),identifier},$scope.addChoice=function(){var a=$scope.assessment;return a.item.choices.length>=50?void $console.alert($i18n("qti.choice.validate.max.choice",50)):(a.item.choices.push(createChoice()),void resetChoiceIdentifier())},$scope.removeChoice=function(c){return $scope.assessment.item.choices.length<=2?void $console.alert($i18n("qti.choice.validate.min.choice",2)):void(isEmpty(c.text)?doRemoveChoice(c):$console.confirm($i18n("common.hint.delete"),function(){doRemoveChoice(c)}))};var countMediaContent=function(data){if(!data)return 0;var match=data.match(/(<img)|(<video)|(<audio)/g);return match?match.length:0},countMediaData=function(data){if(!data)return 0;var match=data.match(/<img(.*?)((src=\"http:)|(data-widget=\"image\"))/g);return match?match.length:0},countVideoAudioData=function(data){if(!data)return 0;var match=data.match(/<img(.*?)((data-cke-real-element-type=\"video\")|(data-cke-real-element-type=\"audio\"))/g);return match?match.length:0};$scope.onChoiceDataChange=function(data,attrs){countMediaContent(data)>0?attrs.$set("editorDisable","background,horizontalrule,table,image,video,audio,math"):attrs.$set("editorDisable","background,horizontalrule,table,video,audio,math")},$scope.onChoiceEditorCreated=function(ckeditor){ckeditor.on("paste",function(evt){var data=evt.editor.getData(),dataValueMediaCount=countMediaData(evt.data.dataValue);(dataValueMediaCount>1||dataValueMediaCount>0&&countMediaContent(data)>0)&&($console.message($i18n("qti.choice.validate.no_allow_multi_media.choice")),evt.stop());var videoAudioCount=countVideoAudioData(evt.data.dataValue);videoAudioCount&&($console.message($i18n("qti.choice.validate.no_allow_multi_media.choice")),evt.stop())})}}],link:function(scope,iElement,iAttrs){scope.assessment||(scope.assessment={type:itemType}),scope.assessment.response||(scope.assessment.response=createResponse("s-"+$identifier.guid())),scope.assessment.item||(scope.assessment.item=createItem(scope.assessment.response.identifier));var trimText=function(text){return text?text.replace(/(^<p>((&nbsp;)|\s)*)|(((&nbsp;)|\s)*<\/p>\s*$)/gim,""):text};scope.assessment.beforeCommit=function(a,errors){var choices=scope.assessment.item.choices;if(choices.length<2)return errors.push({message:$i18n("qti.choice.validate.min.choice",2)}),!1;for(var i=0;i<choices.length;i++)for(var j=0;j<choices.length;j++)if(i!=j&&trimText(choices[i].text)==trimText(choices[j].text))return errors.push({message:$i18n("qti.choice.validate.repeat.choice",[scope.filterChoiceIdentifier(choices[i].identifier),scope.filterChoiceIdentifier(choices[j].identifier)])}),!1;for(var i=0;i<choices.length;i++){var c=choices[i];c.text=c.text.replace(/^<p>&nbsp;\s?/,"<p>")}}}}}])}),define("qti/$directives/lcSubjectiveBase",["require","question-module"],function(require,module){var itemType="subjectivebase",createResponse=function(identifier){return{identifier:identifier,cardinality:"single",base_type:"string",corrects:[""]}},createItem=function(responseIdentifier){return{identifier:null,type:itemType,response_identifier:responseIdentifier,prompt:"",shuffle:!1}},createFeedbackHint=function(responseIdentifier){return{identifier:"showHint",outcomeIdentifier:responseIdentifier,show_hide:"show",content:""}},createFeedbackAnswer=function(responseIdentifier){return{identifier:"showAnswer",outcomeIdentifier:responseIdentifier,show_hide:"show",content:""}},toHtml=function(object,textclass){textclass||(textclass="subjectivebase_text");var div=$("<div></div>");$("<div></div>").addClass(textclass).html(object.text).appendTo(div);for(var root=$("<div></div>").addClass("subjectivebase_asset").appendTo(div),i=0;i<object.assets.length;i++){var assetDiv=$("<div></div>").addClass("asset"),asset=object.assets[i];assetDiv.attr("data-type",asset.type),assetDiv.attr("data-poster",asset.poster),assetDiv.attr("data-src",asset.src),assetDiv.attr("width",asset.width),assetDiv.attr("height",asset.height),assetDiv.appendTo(root)}return div.html()},parseHtml=function(text,textclass){textclass||(textclass="subjectivebase_text");for(var div=$("<div></div>").html(text),text=div.find("."+textclass).html()||"",assetElements=div.find(".subjectivebase_asset .asset"),assets=[],i=0;i<assetElements.length;i++){var element=$(assetElements[i]),type=element.data("type"),width=element.attr("width"),height=element.data("height"),poster=element.data("poster"),src=element.data("src");type&&src&&assets.push({type:type,width:width,height:height,poster:poster,src:src})}return{text:text,assets:assets}};module.directive("lcSubjectiveBase",["$identifier","$console",function($identifier,$console){return{restrict:"EA",replace:!0,scope:{assessment:"="},templateUrl:"qti/$directives/lcSubjectiveBase.html",controller:["$scope",function($scope){$scope.getAssets=function(type){return"prompt"==type?$scope.prompt.assets:"response"==type?$scope.response.assets:"hint"==type?$scope.hint.assets:"answer"==type?$scope.answer.assets:void 0},$scope.setCkeditor=function(name,ckeditor,type){window.ckeditorHandlers||(window.ckeditorHandlers={}),window.ckeditorHandlers[name]={insertResource:function(resourceType,src,width,height,poster){var array=$scope.getAssets(type);return array.length>=10?void $console.message($i18n("qti.subjectivebase.asset.max",10)):void array.push({type:resourceType,src:src,width:width,height:height,poster:poster,newCreate:!0})}}}}],link:function(scope,iElement,iAttrs){scope.assessment||(scope.assessment={type:itemType}),scope.assessment.response||(scope.assessment.response=createResponse("s-"+$identifier.guid())),scope.assessment.item||(scope.assessment.item=createItem(scope.assessment.response.identifier)),scope.assessment.feedbackHint||(scope.assessment.feedbackHint=createFeedbackHint(scope.assessment.response.identifier)),scope.assessment.feedbackAnswer||(scope.assessment.feedbackAnswer=createFeedbackAnswer(scope.assessment.response.identifier)),scope.prompt=parseHtml(scope.assessment.item.prompt||""),scope.response=parseHtml(scope.assessment.response.corrects[0]||"","response_text"),scope.hint=parseHtml(scope.assessment.feedbackHint.content||""),scope.answer=parseHtml(scope.assessment.feedbackAnswer.content||""),scope.assessment.beforeCommit=function(a,errors){scope.assessment.item.prompt=toHtml(scope.prompt),scope.assessment.response.corrects[0]=toHtml(scope.response,"response_text"),scope.assessment.feedbackHint.content=toHtml(scope.hint),scope.assessment.feedbackAnswer.content=toHtml(scope.answer)}}}}])}),define("qti/other/resource-navigator",["require","question-module"],function(require,module){var resetIndex=function(array){for(var i=0;i<array.length;i++)array[i].index=i};module.directive("resourceNavigator",["$identifier","$modal","$console","$timeout","$i18n",function($identifier,$modal,$console,$timeout,$i18n){return{restrict:"EA",replace:!0,scope:{items:"=",current:"=?",showPreview:"@",onSelect:"&?"},templateUrl:"qti/other/tpl/resource-navigator.html",controller:["$scope",function($scope){$scope.currentindex=0,$scope.$watch("items.length",function(){resetIndex($scope.items);for(var i=0;i<$scope.items.length;i++)$scope.items[i].newCreate&&($scope.current=$scope.items[i],$scope.startIndex=$scope.current.index,$scope.items[i].newCreate=!1)}),!$scope.current&&$scope.items.length>0&&($scope.current=$scope.items[0]),resetIndex($scope.items),$scope.select=function(item){$scope.current=item,$scope.startIndex=$scope.current.index,$scope.onSelect&&$scope.onSelect({item:item})},$scope.hasPrev=function(){return $scope.startIndex>=$scope.maxCount},$scope.previous=function(){var prevIndex=$scope.startIndex-$scope.maxCount;return prevIndex>=0?void($scope.startIndex=prevIndex):void($scope.startIndex=0)},$scope.next=function(){var nextIndex=$scope.startIndex+$scope.maxCount;nextIndex<$scope.items.length?$scope.startIndex=nextIndex:$scope.startIndex=$scope.items.length-1},$scope.hasNext=function(){var page=Math.floor($scope.startIndex/$scope.maxCount)+1,index=page*$scope.maxCount;return $scope.items.length>index},$scope.deleteItem=function(item){$console.confirm($i18n("common.confirm.delete"),function(){var index=$scope.items.indexOf(item);if(index!=-1){var del=$scope.items.splice(index,1);$scope.current==del[0]&&(index<$scope.items.length?$scope.current=$scope.items[index]:index-1<$scope.items.length?$scope.current=$scope.items[index-1]:$scope.current=null),resetIndex($scope.items)}})},$scope.preview=function(item){if($scope.showPreview)var dialog=$modal.open({templateUrl:"qti/other/tpl/resource-dialog.html",size:"lg",title:$i18n("resource.asset.preview"),backdrop:!1,controller:["$scope","$resolver",function(_scope,$resolver){_scope.current=item,_scope.items=$scope.items,_scope.deleteCurrent=function(){$console.confirm($i18n("common.confirm.delete"),function(){var item=_scope.current,index=_scope.items.indexOf(item);if(index!=-1){var del=_scope.items.splice(index,1);_scope.current==del[0]&&(index<_scope.items.length?_scope.current=_scope.items[index]:index-1<_scope.items.length?_scope.current=_scope.items[index-1]:_scope.current=null),resetIndex(_scope.items),del[0]==$scope.current&&($scope.current=_scope.current)}0==_scope.items.length&&dialog.close()})}}]})}}],link:function($scope,element,iAttrs){$scope.startIndex=$scope.current.index;var itemWidth=153;$(window).resize(function(){$timeout(function(){$scope.changeElementWidth()})}),$scope.changeElementWidth=function(){var width=$(element).width();return $scope.maxCount=Math.floor(width/itemWidth),$scope.maxCount},$scope.inRange=function(item){var page=Math.floor($scope.startIndex/$scope.maxCount)+1,index=item.index,max=Math.min($scope.items.length,page*$scope.maxCount);return index>=max-$scope.maxCount&&index<max},$timeout(function(){$scope.changeElementWidth()})}}}])}),define("qti/other/resource-preview",["require","question-module"],function(require,module){module.directive("resourcePreview",["$identifier","$config","$sce","$console",function($identifier,$config,$sce,$console){return{restrict:"EA",replace:!0,scope:{items:"=",current:"="},templateUrl:"qti/other/tpl/resource-preview.html",controller:["$scope",function($scope){$scope.getPreviewUrl=function(){var type=$scope.current.type,suffix="video"==type?"mp4":"mp3",src=$scope.current.src;return src=src.indexOf("?")==-1?src+"?."+suffix:src+"&."+suffix,$sce.trustAsResourceUrl("/editor/basic-question/player.html?mediaUrl="+encodeURIComponent(src))},$scope.changePreview=function(item){$scope.current=item}}],link:function($scope,iElement,iAttrs){$scope.select=$scope.current}}}])}),define("qti/other/autofocus",["require","question-module"],function(require,module){module.directive("autofocus",["$timeout",function($timeout){return{restrict:"A",link:function($scope,$element){$timeout(function(){$element[0].focus()})}}}])}),define("qti/qti_all",["require","question-module","./ckeditor/lcCkeditor.directive","./$directives/lcChoiceItem","./$directives/lcDataInteraction","./$directives/lcDataItem","./$directives/lcDrawingItem","./$directives/lcExtendedtextItem","./$directives/lcGapmatchItem","./$directives/lcGraphicgapmatchItem","./$directives/lcGapmatchItem","./$directives/lcHandwriteInteraction","./$directives/lcHandwriteItem","./$directives/lcHandwriteItemOld","./$directives/lcInlinechoiceItem","./$directives/lcJudgeItem","./$directives/lcMatchItem","./$directives/lcMultiplechoiceItem","./$directives/lcOrderItem","./$directives/lcRichEditor","./$directives/lcTextentryInteraction","./$directives/lcTextentryInteractionExtend","./$directives/lcTextentryItem","./$directives/lcTextentrymultipleItem","./$directives/lcVoteItem","./$directives/lcSubjectiveBase","./other/resource-navigator","./other/resource-preview","./other/autofocus","css!./$directives/style.css","css!./oui/style.css","css!./$directives/newdata.css"],function(require,module){}),define("controller/metadata-controller",["require","question-module"],function(require,module){module.controller("metadataController",["$scope","$i18n","$qti","$category","$materialAPI","$resourceStatus","$context","$url","$console","$timeout","$messenger","$stateParams","$isoDate","$state","$filter",function($scope,$i18n,$qti,$category,$material,$resourceStatus,$context,$url,$console,$timeout,$messenger,$stateParams,$isoDate,$state,$filter){$scope.itemTypes=$qti.getIndependentItemTypes(),$scope.itemStatus=$resourceStatus,$scope.itemTypeOptions=[{value:"",label:$i18n("common.label.all")}];for(var i=0;i<$scope.itemTypes.length;i++){var itemType=$scope.itemTypes[i];$scope.itemTypeOptions.push({value:itemType.name,label:itemType.label})}$scope.isDisableStatusOption=function(status,editItemStatus){return"CREATING"==editItemStatus||"CREATING"==status||"CREATED"==status&&"CREATED"!=editItemStatus},$scope.itemStatusOptions=[{value:"",label:$i18n("common.label.all")}];for(var i=0;i<$scope.itemStatus.length;i++){var itemStatus=$scope.itemStatus[i];$scope.itemStatusOptions.push({value:itemStatus.name,label:itemStatus.label})}$scope.difficultyOptions=[{value:"none",label:$i18n("qti.label.difficulty.none")},{value:"very easy",label:$i18n("qti.label.difficulty.veryeasy")},{value:"easy",label:$i18n("qti.label.difficulty.easy")},{value:"medium",label:$i18n("qti.label.difficulty.medium")},{value:"difficult",label:$i18n("qti.label.difficulty.difficult")},{value:"very difficult",label:$i18n("qti.label.difficulty.verydifficult")}],$scope.questionType="",$scope.status="",$scope.options={},$category.loadCategoryDatas($category.codes.subject).success(function(data){$scope.options.subject=data.items}),$category.loadCategoryDatas($category.codes.source).success(function(data){$scope.options.source=data.items}),$scope.pagination={size:20,page:1,totalItems:0};var formatItem=function(item){return $qti.formatItem(item)},beforeSave=function(item){item.categories.source=[];for(var i=0;i<item.source.length;i++)item.categories.source[i]={taxoncode:item.source[i]};item.language&&(item.language=item.language.replace("-","_")),item.categories.subject=[];for(var i=0;i<item.subject.length;i++)item.categories.subject[i]={taxoncode:item.subject[i]};return item};$scope.createMetadata=function(){$scope.itemStatus=[{name:"CREATING",label:$i18n("common.status.CREATING")}],$scope.editItem=formatItem({source:[],subject:[],chapter_ids:$scope.selectedChapter?[$scope.selectedChapter.identifier]:[],categories:{res_type:[{taxcode:""}],source:[]},creator:$context.currentCreator(),publisher:"NetDragon",status:"CREATING"})},$scope.editMetadata=function(id){$scope.itemStatus=$resourceStatus,$qti.loadAssessmentItem(id).success(function(editItem){return editItem?(console.log(editItem),$scope.editItem=formatItem(editItem),void($scope.editItemType=$qti.getItemType($scope.editItem.question_type))):void $console.error($i18n("common.hint.noexists"))}).finally($console.wait($i18n("common.wait.load")))};var init=function(){var id=$stateParams.id;id?$scope.editMetadata(id):$scope.createMetadata()};init();var QUESTION_ADD_METADATA_MESSAGE="QuestionMetadataAdd",QUESTION_UPDATE_METADATA_MESSAGE="QuestionMetadataUpdate",postMessageToParent=function(message,id,action){$messenger.send({message:message,id:id,action:action})};$scope.editContent=function(id){$state.go("questions.edit",{id:id})},$scope.saveMetadata=function(gotoEditor){$scope.editItem=beforeSave($scope.editItem),$scope.editItem.identifier?$qti.updateAssessmentItem($scope.editItem).success(function(data){gotoEditor===!0?$scope.editContent($scope.editItem):postMessageToParent(QUESTION_UPDATE_METADATA_MESSAGE,$scope.editItem.identifier,"insert")}).finally($console.wait($i18n("common.wait.save"))):$qti.createAssessmentItem($scope.editItem).success(function(data){gotoEditor===!0?$scope.editContent(data):postMessageToParent(QUESTION_ADD_METADATA_MESSAGE,data.identifier,"insert")}).finally($console.wait($i18n("common.wait.save")))}}])}),define("controller/asset-select-controller",["require","question-module"],function(require,module){module.controller("assetSelectController",["$scope","$requestInfo","$messenger",function($scope,$requestInfo,$messenger){$scope.category=$requestInfo.params.category||"image",$scope.multiSelect="multiple"==$requestInfo.params.select_type,$scope.onAssetSelect=function(items){for(var hrefs=[],actualHrefs=[],ids=[],titles=[],i=0;i<items.length;i++)hrefs.push(items[i].href),actualHrefs.push(items[i].actualHref),ids.push(items[i].identifier),titles.push(items[i].title);$messenger.send({message:"AssetsSelected",data:hrefs,actualHrefs:actualHrefs,identifiers:ids,titles:titles})}}])}),define("controller/qti-controller",["require","question-module","ckeditor"],function(require,module){module.controller("qtiController",["$scope","$i18n","$qti","$url","$requestInfo","$context","$window","$console","$q","$filter","$config","$messenger","$timeout","$stateParams","$security","$anchorScroll","$identifier","$espChapter","$document","$location",function($scope,$i18n,$qti,$url,$requestInfo,$context,$window,$console,$q,$filter,$config,$messenger,$timeout,$stateParams,$security,$anchorScroll,$identifier,$espChapter,$document,$location){window.CKEDITOR_BASEPATH="/lib/ckeditor/4.4.7/",window.$iconFolder=$config.csIconFolder,CKEDITOR.config.extraAllowedContent="textentryinteraction[*];inlinechoiceinteraction[*];video[*];audio[*];span{*};div[*]{*};",CKEDITOR.config.disallowedContent="a",CKEDITOR.config.extraPlugins="insertpre,simplebox,background,sharedspace,image2,video,audio,textEntryInteraction,inlinechoiceinteraction,mathjax,clearfloat,linebreakbefore,linebreakafter,jme,confighelper",CKEDITOR.disableAutoInline=!0,CKEDITOR.config.sharedSpaces={top:"topSpace",bottom:"bottomSpace"},CKEDITOR.config.toolbar=[["Source","Cut","Copy","Paste","PasteText","PasteFromWord","-","Undo","Redo"],["Find","Replace","-","SelectAll","SpellChecker"],["Image","video","audio","Table","HorizontalRule","Smiley","SpecialChar","PageBreak","Mathjax","clearFloat","Simplebox","InsertPre"],"/",["Bold","Italic","Subscript","Superscript","-","RemoveFormat","Underline","Background"],["NumberedList","BulletedList","-","Outdent","Indent","-","JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock","linebreakbefore","linebreakafter"],["Styles","Format","Font","FontSize"],["TextColor","BGColor"]],CKEDITOR.config.resourceSpace=$context.resourceSpace,$scope.lang=$context.getLang(),$scope.disableEditor=function(name){alert(name)},$scope.noinsert=$requestInfo.params.noinsert,$scope.assessments=[],$scope.data={},$scope.isEmbed=!!$stateParams.id,$scope.disalbeButtons={},$requestInfo.params.disableInsert&&($scope.disalbeButtons.insert=!0),$scope.itemTypes=$qti.getSubItemTypes(),$scope.addingType="choice",$scope.addAssessment=function(type){if($scope.assessments.length>20)return void $console.message($i18n("qti.validate.max.item",20));if(type){var assessment={type:type,metadata:$scope.metadata};return"textentrymultiple"==assessment.type&&(assessment.cardinality="ordered"),$scope.assessments.push(assessment),parsePosition(assessment),$timeout(function(){$scope.selectAssessment(assessment,$scope.assessments.length-1)}),assessment}},$scope.validData=function(){return $scope.itemType&&("data"!=$scope.itemType.name||$scope.assessments.length>1)},$scope.removeAssessment=function(assessment){$console.confirm($i18n("qti.hint.delete.item"),function(){for(var deleteIndex=-1,i=0;i<$scope.assessments.length;i++)if($scope.assessments[i]==assessment){deleteIndex=i;break}deleteIndex!=-1&&($scope.assessments.splice(deleteIndex,1),$scope.selectAssessment())})},$scope.selectAssessment=function(assessment,$index){$scope.activedAssessment&&($scope.activedAssessment._active=!1),$scope.editingAssessment&&($scope.editingAssessment._editing=!1,delete $scope.editingAssessment),$scope.activedAssessment=assessment,$scope.activedAssessment&&($scope.activedAssessment._active=!0),$anchorScroll("assessment_"+$index)},$scope.beginEditAssessment=function(assessment){if($scope.selectAssessment(assessment),$scope.editingAssessment=assessment&&assessment._editable?assessment:null,$scope.editingAssessment&&($scope.editingAssessment._editing=!0,$scope.editingAssessment._defaultEditorName)){var editor=CKEDITOR.instances[$scope.editingAssessment._defaultEditorName];editor&&editor.focus()}},$scope.onKeydown=function(assessment,$event){46==$event.keyCode||8==$event.keyCode?$scope.removeAssessment(assessment):27==$event.keyCode&&$scope.selectAssessment(),$event.preventDefault(),$event.stopPropagation()};var currentWidth,currentHeight;$scope.onResizeStart=function(assessment){currentWidth=parseInt(assessment._width),currentHeight=parseInt(assessment._height)},$scope.onResize=function(assessment,$event){assessment._width=Math.min(Math.max(100,5-assessment._left,currentWidth+$event.incrementX),$scope.areaWidth-10)+"",assessment._height=Math.min(Math.max(100,5-assessment._top,currentHeight+$event.incrementY),$scope.areaHeight-10)+""},$scope.areaWidth=960,$scope.areaHeight=640;var currentLeft,currentTop;$scope.onDragStart=function(assessment){currentLeft=parseInt(assessment._left),currentTop=parseInt(assessment._top)},$scope.onDrag=function(assessment,$event){assessment._left=Math.min(Math.max(5-assessment._width,currentLeft+$event.incrementX),$scope.areaWidth-5)+"",assessment._top=Math.min(Math.max(5-assessment._height,currentTop+$event.incrementY),$scope.areaHeight-5)+""},$scope.beforeCommand=function(commandName){if("specialcomplextext"==$scope.itemType.name){if(commandName&&0==commandName.indexOf("item_"))return $scope.addAssessment(commandName.substring(5)),!1;if(!$scope.editingAssessment){if("image"==commandName||"video"==commandName||"audio"==commandName){var assessment=$scope.addAssessment("data");if(assessment)return $timeout(function(){return $scope.beginEditAssessment(assessment),assessment._defaultEditorName})}return!1}}};var QUESTION_SAVED_MESSAGE="QuestionSaved",QUESTION_PREVIEW_MESSAGE="QuestionPreview",QUESTION_ADD_MESSAGE="QuestionAdd",QUESTION_EDIT_CANCEL_MESSAGE="QuestionEditCancel",postMessageToParent=function(message,id,action){var isEdit="true"==$location.search().noinsert,lastId=$location.search().old_identifier,isReplace=lastId,message="";message=isReplace&&"insert"!=action?"question_replace":isEdit?"question_saved":"insert"==action?"question_insert":"question_saved";var data={message:message,question_id:id,question_online:!1,question_tags:"basic_question",question_type:$scope.itemType.name,question_code:$scope.itemType.code,question_titile:$scope.itemType.label,question_path:$scope.metadata.physic_path};if(isReplace){data.old_question_id=lastId;var path=$location.search().old_file_path;data.old_question_path=path}try{console.log("data is ",data),PCInterface.questionAction(JSON.stringify(data))}catch(ex){}},handleResponseSequence=function(data){for(var i=0;i<data.feedbacks.length;i++)data.feedbacks[i].outcomeIdentifier="FEEDBACK";for(var sequenceCount=(new Date).getTime(),rs={},i=0;i<data.responses.length;i++)rs[data.responses[i].identifier]=data.responses[i];for(var i=0;i<data.items.length;i++){var item=data.items[i],step=data.items.length>1?0:1,isTextentry="handwrite"==item.type||"textentry"==item.type||"data"==item.type;if(isTextentry){for(var startSequence="handwrite"==item.type?1:0,idCache=[],texts=$("<div></div>").html(item.prompt).find("textentryinteraction"),j=0;j<texts.length;j++){var responseId=$(texts[j]).attr("responseidentifier"),tempId="temp_"+sequenceCount++,newId="RESPONSE_"+(i+step)+"-"+(j+1+startSequence);item.prompt=item.prompt.replace(responseId,tempId),idCache.push({oid:tempId,nid:newId});var response=rs[responseId];response&&(response.identifier=newId)}for(var j=0;j<idCache.length;j++)item.prompt=item.prompt.replace(idCache[j].oid,idCache[j].nid)}var id=item.response_identifier,response=rs[id];if(response){var newId="RESPONSE_"+response.sequence;response.identifier=newId,item.response_identifier=newId}}return data},trimNbsp=function(text){var nbsp="&nbsp;";if(!text)return"";for(text=text.trim();0==text.indexOf(nbsp);)text=text.substring(nbsp.length).trim();for(;text.lastIndexOf(nbsp)!=-1&&text.lastIndexOf(nbsp)==text.length-nbsp.length;)text=text.substring(0,text.length-nbsp.length).trim();return text},handleTextentryResponse=function(response){if("multipleString"==response.base_type&&response.corrects.length>0){for(var correct=response.corrects[0],arr=correct.split("|"),result="",i=0;i<arr.length;i++)arr[i]=trimNbsp(arr[i]);result=arr.join("|"),response.corrects[0]=result}};$scope.doSave=function(){var deferred=$q.defer();if($scope.form.$invalid||!$scope.validData())deferred.reject();else{var canceled=!1,errors=[];$scope.data.items=[],$scope.data.responses=[],$scope.data.feedbacks=[];for(var basesequence=1,i=0,len=$scope.assessments.length;i<len;i++){var a=$scope.assessments[i];if(angular.isFunction(a.beforeCommit)){var result=a.beforeCommit(a,errors);if(result===!1){canceled=!0;break}angular.isObject(result)&&(a=result)}formatPosition(a),$scope.data.items.push(a.item);var res=a.response;if(res){if(angular.isArray(res))for(var j=0;j<res.length;j++)res[j].sequence=basesequence+"-"+(j+1),handleTextentryResponse(res[j]),$scope.data.responses.push(res[j]);else res.sequence=basesequence+"-1",handleTextentryResponse(res),$scope.data.responses.push(res);a.feedbackHint&&(a.feedbackHint.sequence=basesequence,$scope.data.feedbacks.push(a.feedbackHint)),a.feedbackAnswer&&(a.feedbackAnswer.sequence=basesequence,$scope.data.feedbacks.push(a.feedbackAnswer)),basesequence++}}if(errors.length>0){var firstError=errors[0];$console.message(firstError.message||firstError),canceled=!0}canceled?deferred.reject(errors):($scope.data=handleResponseSequence($scope.data),$qti.saveAssessmentItemContent($scope.metadata.identifier,$scope.data).success(function(data){for(var i=0,len=$scope.assessments.length;i<len;i++){var a=$scope.assessments[i];angular.isFunction(a.afterSave)&&a.afterSave(data)}deferred.resolve()}).error(function(data,status){console&&console.log($i18n("common.hint.save.failed",(data?data.message:"")+"("+status+")")),deferred.reject()}).finally($console.wait($i18n("common.wait.save"))))}return deferred.promise},$scope.save=function(){$timeout(function(){$scope.doSave().then(function(){$console.message($i18n("common.label.save.success")),postMessageToParent(QUESTION_SAVED_MESSAGE,$scope.metadata.identifier,"save")})})},$scope.preview=function(){$timeout(function(){$scope.realPreview()})};var calculatePreviewSize=function(){var width,height,titleHeight=82,rate=16/9,screenHeight=$(window).height(),screenWidth=$(window).width();"gapmatch"==$scope.itemType.name?(height=Math.min(900,screenHeight-50)+"px",width=Math.min(1500,screenWidth-100)+"px"):(height=Math.min(900,screenHeight-50),width=Math.min(1280,screenWidth-100));var rwidth=width/rate>height-titleHeight?(height-titleHeight)*rate:width,rheight=width/rate>height-titleHeight?height:width/rate+titleHeight;return{width:rwidth,height:rheight}};$scope.realPreview=function(){$scope.doSave().then(function(metadata){$console.message($i18n("common.label.save.success")),postMessageToParent(QUESTION_SAVED_MESSAGE,$scope.metadata.identifier,"save");var language=$requestInfo.params._lang_||"zh_CN",qtiplayerurl="/prepare/player.html?isPreview=true&file_path="+encodeURIComponent($url.file_path)+"&hidePage=toolbar&_lang_="+language+"&hidePage=footer&sys=pptshell",previewSize=calculatePreviewSize();postMessageToParent(QUESTION_PREVIEW_MESSAGE,$scope.metadata.identifier,"preview");var dialog=$scope.previewDialog.open({title:$filter("dict")($scope.itemType.name,$qti.getAllItemTypes(),"name","label"),width:previewSize.width,height:previewSize.height});dialog.openPromise.then(function(d){d.element.find("iframe").attr("src",qtiplayerurl)}),dialog.closePromise.then(function(d){d.element.find("iframe").attr("src","about:blank")})})},$scope.insert=function(){$timeout(function(){$scope.doSave().then(function(){$console.message($i18n("common.label.insert.success")),postMessageToParent(QUESTION_ADD_MESSAGE,$scope.metadata.identifier,"insert")})})},$scope.cancel=function(){postMessageToParent(QUESTION_EDIT_CANCEL_MESSAGE,$scope.metadata.identifier,"cancel")},$scope.showStartAddQuestion=function($event){$scope.startAddQuestion=!0,$event.preventDefault(),$event.stopPropagation()},$($document).on("click",function(){$scope.startAddQuestion=!1});var init=function(){var id=$stateParams.id;return id?void $qti.loadAssessmentItem(id).success(function(metadata){$scope.metadata=$qti.formatItem(metadata),$url.file_path=metadata.physic_path,$scope.itemType=$qti.getItemType(metadata.question_type.taxoncode),$scope.defaultKeyword=metadata.relations&&metadata.relations.length>0?metadata.relations[0].source_title:"";var chapter_id=metadata.relations&&metadata.relations.length>0?metadata.relations[0].source:$stateParams.chapter_id||"";$scope.initChapterId=chapter_id,$qti.loadAssessmentItemContent(metadata.identifier).success(function(data){$scope.data=data;var items=data.items,responses=data.responses,feedbacks=data.feedbacks;if(items&&items.length)for(var i=0,len=items.length;i<len;i++){var assessment={type:items[i].type,item:items[i],metadata:metadata};if("data"==assessment.type&&"textentry"==$scope.itemType.name&&(assessment.type="textentry"),"textentry"==assessment.type||"inlinechoice"==assessment.type||"specialcomplextext"!=$scope.itemType.name&&"handwrite"==assessment.type)for(var k=0;k<feedbacks.length;k++){var f=data.feedbacks[k];"showHint"==f.identifier?assessment.feedbackHint=f:"showAnswer"==f.identifier&&(assessment.feedbackAnswer=f)}else for(var j=0;j<responses.length;j++)if(responses[j].identifier==items[i].response_identifier){assessment.response=responses[j];var sequence=assessment.response.sequence||"1-1",indexOf=sequence.indexOf("-1");sequence=indexOf==sequence.length-2?sequence.substring(0,indexOf):"";for(var k=0;k<feedbacks.length;k++){var f=data.feedbacks[k];f.sequence==sequence&&("showHint"==f.identifier?assessment.feedbackHint=f:"showAnswer"==f.identifier&&(assessment.feedbackAnswer=f));
}break}$scope.assessments[i]=assessment,parsePosition(assessment)}})}).finally($console.block()):void $console.alert($i18n("qti.validate.require.identifier"))};init();var parsePosition=function(assessment){var styles={};if(assessment.item&&assessment.item.style)for(var pairs=assessment.item.style.replace(/\s|(px)/g,"").split(";"),i=0;i<pairs.length;i++){var css=pairs[i].split(":");2==css.length&&(styles[css[0]]=css[1])}assessment._left=parseInt(styles.left)||10,assessment._top=parseInt(styles.top)||10,assessment._width=parseInt(styles.width),assessment._height=parseInt(styles.height)},formatPosition=function(assessment){if("specialcomplextext"==$scope.itemType.name){var style="position:absolute;overflow:hidden";style+=";width:"+(assessment._width?assessment._width+"px":"auto"),style+=";height:"+(assessment._height?assessment._height+"px":"auto"),style+=";top:"+(assessment._top?assessment._top+"px":"0px"),style+=";left:"+(assessment._left?assessment._left+"px":"0px"),assessment.item.style=style}};$scope.downAssessment=function(assessment){var index=$scope.assessments.indexOf(assessment);index>0&&index<$scope.assessments.length-1&&($scope.assessments.splice(index,1),$scope.assessments.splice(index+1,0,assessment),$timeout(function(){$scope.selectAssessment(assessment,index+1)}))},$scope.upAssessment=function(assessment){var index=$scope.assessments.indexOf(assessment);index>1&&($scope.assessments.splice(index,1),$scope.assessments.splice(index-1,0,assessment),$timeout(function(){$scope.selectAssessment(assessment,index-1)}))},$scope.startQuestionSelect=function(){var previewSize=calculatePreviewSize();$scope.questionDialog.open({width:previewSize.width,height:previewSize.height}).openPromise.then(function(){})};var formatNewItem=function(item){var items=item.items,feedbacks=item.feedbacks,responses=item.responses,i=0,assessment={type:items[0].type,item:items[0],metadata:$scope.metadata,response:{}};if("data"==assessment.type||"textentry"==assessment.type||"inlinechoice"==assessment.type||"specialcomplextext"!=$scope.itemType.name&&"handwrite"==assessment.type)for(var k=0;k<feedbacks.length;k++){var f=feedbacks[k];"showHint"==f.identifier?assessment.feedbackHint=f:"showAnswer"==f.identifier&&(assessment.feedbackAnswer=f)}else for(var j=0;j<responses.length;j++)if(responses[j].identifier==items[i].response_identifier){assessment.response=responses[j];var sequence=assessment.response.sequence||"1-1",indexOf=sequence.indexOf("-1");sequence=indexOf==sequence.length-2?sequence.substring(0,indexOf):"";for(var k=0;k<feedbacks.length;k++){var f=feedbacks[k];f.sequence==sequence&&("showHint"==f.identifier?assessment.feedbackHint=f:"showAnswer"==f.identifier&&(assessment.feedbackAnswer=f))}break}if("data"==assessment.type||"textentry"==assessment.type){assessment.type="textentrymultiple",assessment.item.type="textentrymultiple",assessment.response={cardinality:"ordered",base_type:"multipleString",corrects:[]};for(var prompt=$("<div></div>").html(item.items[0]?item.items[0].prompt:""),ts=prompt.find("textentryinteraction"),k=0;k<ts.length;k++){for(var rid=$(ts[k]).attr("responseidentifier"),l=0;l<responses.length;l++)responses[l].identifier==rid&&assessment.response.corrects.push(responses[l].corrects[0]);ts[i].responseidentifier="s-"+$identifier.guid()}}var id="s-"+$identifier.guid();return assessment.item.response_identifier=id,assessment.response.identifier=id,assessment};$scope.showSample="true"!=$stateParams.hideSample,$scope.onQuestionSelect=function(item){if(item.selected){if($scope.assessments.length>20)return item.selected=!1,void $console.message($i18n("qti.validate.max.item",20));for(var types=item.categories.res_type,newHandwrite=!1,i=0;i<types.length;i++)"$RE0445"==types[i].taxoncode&&(newHandwrite=!0);$qti.mergeQuestion({target_file_path:$scope.metadata.physic_path,source_file_path:item.physic_path,source_identifier:item.identifier,newhandwrite:newHandwrite}).then(function(result){var assessment=formatNewItem(result.data);assessment.item.identifier=item.identifier,$scope.assessments.push(assessment)},function(){item.selected=!1}).finally($console.wait($i18n("question.data.wait.insert")))}else for(var i=0;i<$scope.assessments.length;i++)if($scope.assessments[i].item.identifier==item.identifier)return void $scope.assessments.splice(i,1)}}]),module.filter("chineseFirstCharacter",["$qti",function($qti){return function(value){var type=$qti.getItemTypeByName(value);return type?type.fchar:""}}])}),define("controller/import-sample-controller",["require","question-module","css!../import_question_style.css"],function(require,module){module.controller("importSampleController",["$scope","$i18n","$qti","$category","$materialAPI","$context","$url","$console","$timeout","$messenger","$stateParams","$isoDate","$state","$filter","$questionList","$questionTemplates","$sce","$location","$config",function($scope,$i18n,$qti,$category,$material,$context,$url,$console,$timeout,$messenger,$stateParams,$isoDate,$state,$filter,$questionList,$questionTemplates,$sce,$location,$config){var init=function(){$questionTemplates.getTemplates("basic_question").then(function(data){$scope.basic_questions=data.data.items}),$questionTemplates.getTemplates("interaction_question").then(function(data){$scope.interaction_questions=data.data.items});var type=$stateParams.template||"choice";$questionTemplates.getTemplate(type).then(function(data){$scope.selectQuestionType(data.data)})};init();var pageSize=3,doQuery=function(){$scope.loading=!0;var category=$scope.template.lccode,coverageSample=($stateParams.chapter_id,"App/203918ab-cd5a-49da-bff7-c2868bb86382/"),promise=$scope.template.isBasic?$questionList.loadBasicQuestion($scope.page,pageSize,category,null,coverageSample,""):$questionList.loadInteractionQuestionQuestion($scope.page,pageSize,category,null,coverageSample,"");promise.success(function(data){$scope.loading=!1;for(var startIndex=($scope.page-1)*pageSize,i=0;i<data.items.length;i++)$scope.items[startIndex+i]=data.items[i],loadNickName(data.items[i]);$scope.item=$scope.items[$scope.current-1],null==$scope.item?$scope.items.length>0?($scope.current=1,$scope.item=$scope.items[$scope.current-1],$scope.empty=!1):$scope.empty=!0:$scope.empty=!1})},loadNickName=function(item){var userId=item.life_cycle.creator;$qti.loadUser(userId).then(function(data){var user=data.data;item.nickname=user.nick_name},function(err){return item.nickname=item.life_cycle.creator,{handled:!0}})};$scope.next=function(){$scope.current++,$scope.items[$scope.current-1]?$scope.item=$scope.items[$scope.current-1]:($scope.page=Math.floor($scope.current%pageSize==0?$scope.current/pageSize:$scope.current/pageSize+1),doQuery())},$scope.selectQuestionType=function(template){$scope.template&&$scope.template.lccode==template.lccode||($scope.template=template,$scope.current=1,$scope.page=1,$scope.items=[],$scope.item=null,doQuery())};var toUrl=function(url,params){url+="?";for(var key in params)url+=key+"="+encodeURIComponent(params[key])+"&";return url},importQuestion=function(){var defaultParams=$location.search();$questionList.download_and_copy($scope.item.identifier,$scope.template.isBasic).then(function(result){var data=result.data;if("1"==data.result_code)return void $console.message($i18n("sample.inserting.error"));for(var target=window.parent?window.parent:window;target.parent&&target!=target.parent;)target=target.parent;var params={template:$scope.template.code,sys:"pptshell",file_path:data.file_path,id:data.identifier,question_type:$scope.template.code,isSample:!0};target.location=toUrl("/editor/",angular.extend({},defaultParams,params))}).finally($console.wait($i18n("sample.inserting")))};$scope.importQuestion=function(){if($scope.item){var defaultParams=$location.search();defaultParams.old_identifier?$console.confirm($i18n("sample.insert.confirm"),function(){importQuestion()}):importQuestion()}},$scope.getEditUrl=function(){if(!$scope.item)return null;var filepath=$scope.item.tech_info?$scope.item.tech_info.href.entry||$scope.item.tech_info.href.location:"";if(filepath&&filepath.indexOf(".xml")!=-1&&(filepath=filepath.substring(0,filepath.lastIndexOf("/"))),filepath&&"basic_question"==$scope.template.categoryCode){filepath=filepath.replace("${ref-path}",$config.csServer2);var url="/editor/?id="+$scope.item.identifier+"&template="+$scope.template.code+"&file_path="+encodeURIComponent(filepath)+"&hideSample=true&_lang_="+$location.search()._lang_;return $sce.trustAsResourceUrl(url)}filepath=filepath.replace("${ref-path}",$config.csServer2);var url="/editor/?id="+$scope.item.identifier+"&template="+$scope.template.code+"&file_path="+encodeURIComponent(filepath)+"&hideSample=true&isPreview=true&_lang_="+$location.search()._lang_;return $sce.trustAsResourceUrl(url)}}])}),define("questionstore/$directives/lc-question-select",["require","question-module","jquery","plupload"],function(require,module){require("jquery");module.directive("lcQuestionSelect",["$requestInfo","$context",function($requestInfo,$context){return{restrict:"EA",replace:!0,scope:{onSelect:"&",chapterIds:"=",defaultKeyword:"=",selectedQuestions:"=",initChapterId:"="},templateUrl:"questionstore/$directives/lc-question-select.html",controller:["$scope",function($scope){var defaultKeyword="";$scope.selectQuestion=function(question){$scope.onSelect({item:question})},$scope.stores=[],$scope.stores.push({title:$i18n("qti.newdata.nd.question"),coverage:$context.coverage.common,keyword:defaultKeyword}),$context.currentOrg()&&$scope.stores.push({title:$i18n("qti.newdata.school.question"),coverage:"Org/"+$context.currentOrg()+"/",keyword:defaultKeyword}),$context.currentCreator()&&"0"!=$context.currentCreator()&&$scope.stores.push({title:$i18n("qti.newdata.mine.question"),coverage:$context.coverage.user,keyword:defaultKeyword}),$scope.currentStore=$scope.stores[0],$scope.gotoStore=function(store){$scope.currentStore=store},$scope.search=function(){$scope.currentStore.startSearch=!0},$scope.selectQuestion=function(item){$scope.onSelect({item:item})}}],link:function($scope,iElement,iAttrs){}}}])}),define("questionstore/$directives/lc-question-list",["require","question-module","jquery","plupload","mathjax"],function(require,module){require("jquery");module.directive("lcQuestionList",["$requestInfo","$context","$questionList","$console","$timeout","$i18n",function($requestInfo,$context,$questionList,$console,$timeout,$i18n){return{restrict:"EA",replace:!0,scope:{onSelect:"&",store:"=",selectedQuestions:"=",initChapterId:"="},templateUrl:"questionstore/$directives/lc-question-list.html",controller:["$scope",function($scope){function findQuestionName(code){for(var i=0;i<$scope.question_types.length;i++)if($scope.question_types[i].code==code)return $scope.question_types[i].name;return""}$scope.pagination={page:1,size:10},$scope.chapter_id=$requestInfo.params.chapter_id,$scope.$watch("store.startSearch",function(newValue,oldValue){$scope.store&&$scope.store.startSearch&&($scope.store.startSearch=!1,$scope.doSearch())});var setQuestionSelectStatus=function(){for(var i=0;i<$scope.questions.length;i++)$scope.questions[i].selected=!1;for(var i=0;i<$scope.questions.length;i++)for(var j=0;j<$scope.selectedQuestions.length;j++)$scope.questions[i].identifier==$scope.selectedQuestions[j].item.identifier&&($scope.questions[i].selected=!0)};$scope.$watch("selectedQuestions.length",function(newValue,oldValue){newValue!=oldValue&&setQuestionSelectStatus()}),$scope.doSearch=function(){var keyword=$scope.store.keyword,coverage=$scope.store.coverage;$questionList.loadQuestions($scope.pagination.page,$scope.pagination.size,keyword,coverage,$scope.chapter_id,$scope.question_type,$scope.difficulty).then(function(result){$scope.questions=result.data.items,$scope.pagination.totalItems=result.data.total_count,setQuestionSelectStatus()}).finally($console.wait($i18n("qti.newdata.loading")))},$scope.$on("itemsRendered",function(){$timeout(function(){MathJax.Hub.Queue(["Typeset",MathJax.Hub])})}),$scope.question_types=[{code:"$RE0201",name:$i18n("qti.type.choice")},{code:"$RE0202",name:$i18n("qti.type.multiplechoice")},{code:"$RE0204",name:$i18n("qti.type.order")},{code:"$RE0203",name:$i18n("qti.type.judge")},{code:"$RE0209",name:$i18n("qti.type.textentry")},{code:"$RE0205",name:$i18n("qti.type.match")},{code:"$RE0207",name:$i18n("qti.type.graphicgapmatch")},{code:"$RE0210",name:$i18n("qti.type.handwrite")},{code:"$RE0225",name:$i18n("qti.type.vote")}],$scope.difficulties=[{code:"none",name:"未定义"},{code:"very easy",name:"非常简单"},{code:"easy",name:"简单"},{code:"medium",name:"中等"},{code:"difficult",name:"困难"},{code:"very difficult",name:"非常困难"}],$scope.toNumber=function(difficulty){var difficulties={none:0,"very easy":1,easy:2,medium:3,difficult:4,"very difficult":5};return difficulties[difficulty]||0},$scope.addQuestion=function(question){question.selected=!0,$scope.onSelect({item:question})},$scope.removeQuestion=function(question){question.selected=!1,$scope.onSelect({item:question})},$scope.selectQuestion=function(type){$scope.question_type=type,$scope.doSearch()},$scope.selectDifficulty=function(difficulty){$scope.difficulty=difficulty,$scope.doSearch()},$scope.getQuestionType=function(question){for(var restypes=question&&question.categories&&question.categories.res_type?question.categories.res_type:[],i=0;i<restypes.length;i++)if("$RE0200"!=restypes[i].taxoncode)return findQuestionName(restypes[i].taxoncode)},$scope.lang=$context.getLang(),$scope.doSearch()}],link:function($scope,iElement,iAttrs){}}}])}),define("questionstore/$directives/nd-star",["require","question-module","jquery","plupload"],function(require,module){require("jquery");module.directive("ndStar",[function(){return{restrict:"EA",replace:!0,scope:{ndStar:"="},templateUrl:"questionstore/$directives/ndStar.html",controller:["$scope",function($scope){$scope.ndStar=$scope.ndStar||0,$scope.range=function(min,max,step){step=step||1;for(var input=[],i=min;i<max;i+=step)input.push(i);return input}}],link:function($scope,iElement,iAttrs){}}}])}),define("questionstore/$directives/espTree",["question-module","ztree"],function(module,$){module.directive("espTree",[function(){return{restrict:"EA",replace:!0,template:'<div class="ztree"></div>',require:"?ngModel",scope:{idKey:"@",childrenKey:"@",nameKey:"@",titleKey:"@",expandAll:"@",selectedMulti:"@",data:"=espTree",simpleData:"@",onSelect:"&",onInit:"&",showLine:"@",peripheralData:"@"},link:function($scope,iElement,iAttrs,ngModel){var ztree,setting={view:{dblClickExpand:!1,showLine:"false"!==$scope.showLine,selectedMulti:"true"===$scope.selectedMulti,showIcon:!1},data:{simpleData:{enable:"false"!==$scope.simpleData,idKey:$scope.idKey||"identifier",pIdKey:"parent",rootPId:"root"},key:{children:$scope.childrenKey||"children",name:$scope.nameKey||"title",title:$scope.titleKey||"title"}},check:{autoCheckTrigger:"true"===$scope.selectedMulti,enable:!1,chkboxType:{Y:"",N:""},chkStyle:"checkbox",nocheckInherit:!1,chkDisabledInherit:!1,radioType:"all"},callback:{onClick:function(event,treeId,treeNode){var value=setting.view.selectedMulti?ztree.getSelectedNodes():treeNode;if(treeNode.isParent)if(setting.view.selectedMulti){if(value.length)for(var i=0;i<value.length;i++)ztree.cancelSelectedNode(value[i])}else ztree.cancelSelectedNode(value);else"$apply"!=$scope.$root.$$phase&&"$digest"!=$scope.$root.$$phase?$scope.$apply(function(){ngModel&&ngModel.$setViewValue(value),$scope.onSelect({node:value})}):(ngModel&&ngModel.$setViewValue(value),$scope.onSelect({node:value}))}}},setTreeValue=function(value){if(ztree&&value)if(angular.isArray(value))for(var i=0;i<value.length;i++)setTreeValue(value[i]);else if(angular.isString(value)){var nodes=ztree.getNodesByParam(setting.data.simpleData.idKey,value);nodes[0]&&ztree.selectNode(nodes[0])}else ztree.selectNode(value);else if(ztree){var nodes=ztree.getSelectedNodes();if(nodes.length)for(var i=0;i<nodes.length;i++)ztree.cancelSelectedNode(nodes[i])}};ngModel&&(ngModel.$render=function(value){$scope.viewValue=ngModel.$viewValue});var S4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};$scope.$watch("peripheralData",function(newData,oldData){newData!==oldData&&null===$scope.viewValue&&setTreeValue(null)}),$scope.$watch("data",function(newData,oldData){newData!=oldData&&(iElement.attr("id")||iElement.attr("id",S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()),ztree=$.fn.zTree.init($(iElement[0]),setting,newData),"true"===$scope.expandAll&&ztree.expandAll(!0),void 0!==$scope.viewValue&&setTreeValue($scope.viewValue.identifier),$scope.onInit({instance:ztree}))})}}}])}),define("questionstore/$directives/espChapterInputTree",["question-module"],function(module){module.directive("espChapterInputTree",["$espChapter","$console","$document",function($espChapter,$console,$document){return{restrict:"EA",replace:!0,templateUrl:"questionstore/$directives/esp-chapter-input-tree.html",require:"?ngModel",scope:{initChapterId:"@",expandAll:"@",selectedMulti:"@",includeLesson:"@",onSelect:"&"},link:function($scope,$element,iAttrs,ngModel){$scope.chapters=[],$scope.isload=!1,$scope.isdata=!1,$scope.isChange=!1,$scope.$watch("chapterId",function(newValue,oldValue){var chapter_id=$scope.initChapterId;chapter_id&&$espChapter.getCategories(chapter_id).then(function(result){var data=result.data;$scope.category=$espChapter.formatCategory(data),$scope.chapters=[],$scope.isload=!1,$espChapter.list({category:$scope.category},!0).then(function(result){$scope.isload=!0,$scope.chapters=result.data},function(result){$scope.isload=!0})})});var documentHandler=function(event){var target=$(event.target);0==target.closest(".esp-chapter-input-tree").length&&($document.off("click",documentHandler),$scope.$apply(function(){$scope.showChapterTree=!$scope.showChapterTree}))};$scope.showChapterTree=!1,$scope.showPicker=function(){$scope.showChapterTree=!$scope.showChapterTree,$document.on("click",documentHandler)},$scope.pickAll=function(){$document.off("click",documentHandler),$scope.showChapterTree=!1,$scope.pickall=!0,$scope.chapter=null,ngModel.$setViewValue(null),$scope.isChange=!$scope.isChange},ngModel&&(ngModel.$render=function(){var identifier=ngModel.$modelValue;identifier?$espChapter.get(identifier).success(function(chapter){$scope.chapter=chapter}):""===identifier&&$scope.pickAll()}),$scope.onPick=function(chapter){$document.off("click",documentHandler),$scope.pickall=!1,ngModel?(void 0===chapter||void 0!==chapter&&chapter.identifier===ngModel.$modelValue?$scope.showChapterTree=!0:$scope.showChapterTree=!1,ngModel.$setViewValue(chapter&&chapter.identifier)):void 0===chapter?$scope.showChapterTree=!0:$scope.showChapterTree=!1,$scope.showChapterTree=!1,$scope.chapter=chapter,$scope.onSelect({chapter:chapter})}}}}])}),define("questionstore/$directives/select-question-type",["require","question-module","jquery"],function(require,module){var $=require("jquery");module.directive("selectQuestionType",["$document",function($document){return{restrict:"EA",replace:!0,templateUrl:"questionstore/$directives/select-question-type.html",scope:{onSelect:"&",questionTypes:"="},controller:["$scope",function($scope){$scope.selectQuestion=function(type){$scope.question_type=type.name,$scope.onSelect({type:type.code})},$scope.show=function($event){$scope.showSelect=!$scope.showSelect,$event.preventDefault(),$event.stopPropagation()},$($document).on("click",function(){$scope.showSelect=!1})}],link:function($scope,iElement,iAttrs){}}}])}),define("questionstore/$directives/select-difficulty",["require","question-module","jquery"],function(require,module){var $=require("jquery");module.directive("selectDifficulty",["$document",function($document){return{restrict:"EA",replace:!0,templateUrl:"questionstore/$directives/select-difficulty.html",scope:{onSelect:"&",difficulties:"="},controller:["$scope",function($scope){$scope.selectDifficulty=function(difficulty){$scope.difficulty=difficulty.code,$scope.onSelect({difficulty:difficulty.code})},$scope.show=function($event){$scope.showSelect=!$scope.showSelect,$event.preventDefault(),$event.stopPropagation()},$($document).on("click",function(){$scope.showSelect=!1}),$scope.toNumber=function(difficulty){var difficulties={"very easy":1,easy:2,medium:3,difficult:4,"very difficult":5},result=difficulties[difficulty];return void 0==result?-1:result}}],link:function($scope,iElement,iAttrs){}}}])}),define("questionstore/$services/question-list-service",["require","question-module"],function(require,module){module.factory("$questionList",["$http","$url","$stateParams","$config","$auth","$context",function($http,$url,$stateParams,$config,$auth,$context){return{loadBasicQuestion:function(page,size,question_type,keyword,coverage,chapter_id,difficulty){return $http.get($url.slidesRemote("/v1.3/questions",{page:page,size:size,words:keyword||"",coverage:coverage||$context.coverage.common,chapter_id:chapter_id||"",question_type:question_type||"$RE0201",difficulty:difficulty||""}))},loadInteractionQuestionQuestion:function(page,size,question_type,keyword,coverage,chapter_id,difficulty){return $http.get($url.slidesRemote("/v1.3/courseware_objects",{page:page,size:size,words:keyword||"",coverage:coverage||$context.coverage.common,chapter_id:chapter_id||"",category:question_type,difficulty:difficulty||""}))},download_and_copy:function(id,isBasic){return $http.post($url.slides("/v0.1/tools/download_and_copy"),{id:id,isBasic:isBasic,lifecycleServer:$config.lifecycleServer})},loadQuestions:function(page,size,keyword,coverage,chapterId,question_type,difficulty){return $http.get($url.slidesRemote("/v1.3/questions",{page:page,size:size,words:keyword,coverage:coverage,chapter_id:chapterId,question_type:question_type||"$RE0201,$RE0202,$RE0203,$RE0204,$RE0205,$RE0207,$RE0209,$RE0210,$RE0225",difficulty:difficulty||""})).then(function(baseQuestion){if(question_type&&"$RE0210"!=question_type)return baseQuestion;var range=(page-1)*size-baseQuestion.data.total_count,startPage=range>0?range%20==0?Math.floor(range/20):Math.floor(range/20+1):1;return $http.get($url.slidesRemote("/v1.3/courseware_objects",{page:startPage,size:size,words:keyword,coverage:coverage,chapter_id:chapterId,category:"$RE0445",difficulty:difficulty||""})).then(function(iQuestion){var count=baseQuestion.data.total_count+iQuestion.data.total_count,needCount=(page-1)*size;if(baseQuestion.data.total_count>needCount+size){var items=baseQuestion.data.items;return{data:{item_count:size,items:items,total_count:count}}}if(baseQuestion.data.total_count>needCount){for(var items=baseQuestion.data.items,i=0;i<size-items.length&&i<iQuestion.data.items.length;i++)items.push(iQuestion.data.items[i]);return{data:{item_count:size,items:items,total_count:count}}}var range=(page-1)*size-baseQuestion.data.total_count,startPage=range>0?range%20==0?Math.floor(range/20):Math.floor(range/20+1):1;return $http.get($url.slidesRemote("/v1.3/courseware_objects",{page:startPage+1,size:size,words:keyword,coverage:coverage,chapter_id:chapterId,category:"$RE0445",difficulty:difficulty||""})).then(function(fresult){for(var items=[],startIndex=range%20,i=startIndex;i<iQuestion.data.items.length;i++)items.push(iQuestion.data.items[i]);for(var i=0;items.length<size&&i<fresult.data.items.length;i++)items.push(fresult.data.items[i]);return{data:{item_count:size,items:items,total_count:count}}})})})}}}])}),define("questionstore/$services/$espChapter",["question-module"],function(module){module.factory("$espChapter",["$http","$url",function($http,$espUrl){var $espChapter={};return $espChapter.get=function(identifier){return $http.get($espUrl.slidesRemote("/v1.3/chapters/{0}",identifier))},$espChapter.getCategories=function(identifier){return $http.get($espUrl.slidesRemote("/v1.3/chapters/{0}/categories",identifier))},$espChapter.formatCategory=function(data){var edition=data.edition.length>0?data.edition[0].taxoncode:"",grade=data.grade.length>0?data.grade[0].taxoncode:"",phase=data.phase.length>0?data.phase[0].taxoncode:"",sub_edition=data.sub_edition.length>0?data.sub_edition[0].taxoncode:"",subject=data.subject.length>0?data.subject[0].taxoncode:"";return"K12/"+phase+"/"+grade+"/"+subject+"/"+edition+"/"+sub_edition},$espChapter.list=function(params,tree){var promise=$http.get($espUrl.slidesRemote("/v1.3/chapters",params));return tree===!0&&promise.then(function(response){for(var data=response.data,mapping={},i=0;i<data.length;i++)mapping[data[i].identifier]=data[i];for(var root=[],i=0;i<data.length;i++){var chapter=data[i];if(chapter.parent==chapter.teaching_material)root.push(chapter);else{var parent=mapping[chapter.parent];parent&&(parent.children||(parent.children=[]),parent.children.push(chapter))}}return response.data=root,response}),promise},$espChapter.pluckIdentifierFromMetadataRelation=function(metadata){if(!metadata||!metadata.relations)return null;for(var i=0;i<metadata.relations.length;i++){var r=metadata.relations[i];if("chapters"==r.source_type)return r.source}return null},$espChapter}])}),define("questionstore/$filters/refpath",["require","question-module","jquery","plupload"],function(require,module){require("jquery");module.filter("refpath",["$url",function($url){return function(value){return $url.csref(value)}}])}),define("questionstore/module",["question-module","questionstore/$directives/lc-question-select","questionstore/$directives/lc-question-list","questionstore/$directives/nd-star","questionstore/$directives/espTree","questionstore/$directives/espChapterInputTree","questionstore/$directives/select-question-type","questionstore/$directives/select-difficulty","questionstore/$services/question-list-service","questionstore/$services/$espChapter","questionstore/$filters/refpath","css!./style.css"],function(module){}),define("start",["require","jquery","question-module","./init","service/$base","service/$i18n","service/$config","service/$espUserCenter","service/$espAuth","service/$qti","service/$category","service/$messenger.service","service/$materialAPI","service/$questionTemplates","asset/asset_all","qti/qti_all","controller/metadata-controller","controller/asset-select-controller","controller/qti-controller","controller/import-sample-controller","css!style.css","css!decorators/theme/default/main.css","css!$i18n/i18n.css","css!lib/bootstrap/3.3.2/css/bootstrap.min.css","css!lib/angular-nd/0.1.0/ngui/style/nd-ngui-lcms.css","css!lib/angular-nd/0.1.0/ngui/style/nd-ngui-styles-0.1.0.css","css!lib/angular-nd/0.1.0/ngui/style/nd-ngui-styles-ex.css","css!lib/ztree/3.5.17/zTreeStyle/zTreeStyle.css","css!lib/fancybox/1.3.1/fancybox.css","jquery","fancybox","css!lib/nd/externals/tree/style.css","questionstore/module","plupload"],function(require,$,module){module.config(["$stateProvider","$urlRouterProvider","$locationProvider",function($stateProvider,$urlRouterProvider,$locationProvider){$stateProvider.state("questions",{template:"<div ui-view></div>"}).state("questions.create",{url:"/create?question_base&file_path&chapter_name&chapter_id&isSample",controller:"metadataController",templateUrl:"tpl/create.html"}).state("questions.update",{url:"/:id/update?question_base&chapter_name&chapter_id&isSample",controller:"metadataController",templateUrl:"tpl/create.html"}).state("questions.edit",{url:"/:id/edit/:question_type?question_base&file_path&chapter_name&hideSample&isSample&chapter_id",controller:"qtiController",templateUrl:"tpl/edit.html"}).state("questions.asset_select",{url:"/select_asset?question_base&id&is_interaction&chapter_id&chapter_name&file_path&max_size",controller:"assetSelectController",templateUrl:"asset/select/index.html"}).state("questions.import_sample",{url:"/import_sample?question_type&last_id&last_type&template&chapter_id",controller:"importSampleController",templateUrl:"tpl/import_sample.html"}),$locationProvider.html5Mode(!1),$("#start_loading").hide()}])}),window.CKEDITOR_BASEPATH="../lib/ckeditor/4.5.4/",requirejs(["angular","init","start","ndrest"],function(angular){angular.bootstrap(document,["questions"])}),define("app.js",function(){});