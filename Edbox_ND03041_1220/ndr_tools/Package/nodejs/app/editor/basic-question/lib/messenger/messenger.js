window.Messenger=function(){function t(t,e,n){var o="";if(arguments.length<2?o="target error - target and name are both requied":"object"!=typeof t?o="target error - target itself must be window object":"string"!=typeof e&&(o="target error - target name must be string type"),o)throw new Error(o);this.target=t,this.name=e,this.type=n}function e(t){if("object"==typeof t){var e={prefix:o,data:t};try{e=a?c+JSON.stringify(e):e}catch(t){window.console&&console.log("转换成JSON字符串时出错")}return e}return o+t}function n(t,e){this.targets={},this.name=t,this.listenFunc=[],o=(e||o)+"_:_:","string"!=typeof o&&(o=o.toString()),this.initListen()}var o="[PROJECT_NAME]",i="postMessage"in window,r=i&&7===document.documentMode,s=8===document.documentMode||9===document.documentMode,a=s||r,c="PS_JSON:";return t.prototype.send=function(t){var n=this,r=function(){try{return n.target.document,!1}catch(t){return!0}}();try{if("windowOpen"!=this.type||r)if(i)this.target.postMessage(e(t),"*");else{var s=window.navigator[o];if("function"!=typeof s)throw new Error("target callback function is not defined");s(e(t),window)}else this.target.Messenger[o](t)}catch(t){window.console&&console.log("messener's function send:"+t)}},n.prototype.addTarget=function(e,n,o){var i=new t(e,n,o);this.targets[n]=i},n.prototype.initListen=function(){var t=this,e=function(e){if(i&&(e=e.data),a&&0===e.indexOf(c))try{e=e.slice(c.length),e=JSON.parse(e)}catch(t){window.console&&console.log("JSON解析错误")}if("object"==typeof e&&e.data){if(e.prefix!==o)return;e=e.data}else{if(!e||0!==e.toString().indexOf(o))return;e=e.slice(o.length)}for(var n=0;n<t.listenFunc.length;n++)t.listenFunc[n](e)};i?"addEventListener"in document?window.addEventListener("message",e,!1):"attachEvent"in document&&window.attachEvent("onmessage",e):window.navigator[o]=e,window.Messenger[o]=function(e){for(var n=0;n<t.listenFunc.length;n++)t.listenFunc[n](e)}},n.prototype.listen=function(t){this.listenFunc.push(t)},n.prototype.clear=function(){this.listenFunc=[]},n.prototype.send=function(t){var e,n=this.targets;for(e in n)n.hasOwnProperty(e)&&n[e].send(t)},n}();