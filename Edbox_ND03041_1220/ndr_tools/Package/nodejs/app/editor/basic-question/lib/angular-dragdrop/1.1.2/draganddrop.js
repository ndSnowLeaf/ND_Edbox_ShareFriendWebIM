!function(e){"use strict";function a(e){e.dataTransfer&&"none"===e.dataTransfer.dropEffect&&("copy"===e.dataTransfer.effectAllowed||"move"===e.dataTransfer.effectAllowed?e.dataTransfer.dropEffect=e.dataTransfer.effectAllowed:"copyMove"!==e.dataTransfer.effectAllowed&&"copymove"!==e.dataTransfer.effectAllowed||(e.dataTransfer.dropEffect=e.ctrlKey?"copy":"move"))}if(!function(){return"ondrag"in document.createElement("a")}())return void e.module("ang-drag-drop",[]);window.jQuery&&-1===window.jQuery.event.props.indexOf("dataTransfer")&&window.jQuery.event.props.push("dataTransfer");var n=e.module("ang-drag-drop",[]);n.directive("uiDraggable",["$parse","$rootScope","$dragImage",function(n,r,t){return function(o,d,i){function f(e){setTimeout(function(){d.unbind("$destroy",f)},0);var t=i.dragChannel||"defaultchannel";if(r.$broadcast("ANGULAR_DRAG_END",e,t),a(e),e.dataTransfer&&"none"!==e.dataTransfer.dropEffect)if(i.onDropSuccess){var s=n(i.onDropSuccess);o.$evalAsync(function(){s(o,{$event:e})})}else if(i.onDropFailure){var l=n(i.onDropFailure);o.$evalAsync(function(){l(o,{$event:e})})}d.removeClass(c)}function s(a){if(!u||g.classList.contains(l)){var s=i.dragChannel||"defaultchannel",v="";i.drag&&(v=o.$eval(i.drag));var p=i.dragImage||null;d.addClass(c),d.bind("$destroy",f);var $=!(document.uniqueID||window.opera);if(p&&$){var h=n(i.dragImage);o.$apply(function(){var n=h(o,{$event:a});if(n&&(e.isString(n)&&(n=t.generate(n)),n.image)){var r=n.xOffset||0,d=n.yOffset||0;a.dataTransfer.setDragImage(n.image,r,d)}})}var b={data:v,channel:s},m=e.toJson(b);a.dataTransfer.setData("text",m),a.dataTransfer.effectAllowed="copyMove",r.$broadcast("ANGULAR_DRAG_START",a,s,b)}else a.preventDefault()}var l,g,u=!1,c=i.draggingClass||"on-dragging";d.attr("draggable",!1),o.$watch(i.uiDraggable,function(e){e?(d.attr("draggable",e),d.bind("dragend",f),d.bind("dragstart",s)):(d.removeAttr("draggable"),d.unbind("dragend",f),d.unbind("dragstart",s))}),e.isString(i.dragHandleClass)&&(u=!0,l=i.dragHandleClass.trim()||"drag-handle",d.bind("mousedown",function(e){g=e.target}))}}]),n.directive("uiOnDrop",["$parse","$rootScope",function(n,r){return function(t,o,d){function i(e){e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation();var a=n(d.uiOnDragOver);return t.$evalAsync(function(){a(t,{$event:e,$channel:v})}),!1}function f(e){e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),0===--c&&(t.$evalAsync(function(){m(t,{$event:e,$channel:v})}),o.addClass($),o.removeClass(h));var a=n(d.uiOnDragLeave);t.$evalAsync(function(){a(t,{$event:e,$channel:v})})}function s(e){e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),0===c&&(t.$evalAsync(function(){b(t,{$event:e,$channel:v})}),o.removeClass($),o.addClass(h)),c++;var a=n(d.uiOnDragEnter);t.$evalAsync(function(){a(t,{$event:e,$channel:v})}),r.$broadcast("ANGULAR_HOVER",p)}function l(r){r.preventDefault&&r.preventDefault(),r.stopPropagation&&r.stopPropagation();var i=r.dataTransfer.getData("text");i=e.fromJson(i),a(r);var f=n(d.uiOnDrop);t.$evalAsync(function(){f(t,{$data:i.data,$event:r,$channel:i.channel})}),o.removeClass($),c=0}function g(e,a){return"*"===a||new RegExp("(\\s|[,])+("+e+")(\\s|[,])+","i").test(","+a+",")}function u(e){return e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.dataTransfer.dropEffect="none",!1}var c=0,v=d.dropChannel||"defaultchannel",p="",$=d.dragEnterClass||"on-drag-enter",h=d.dragHoverClass||"on-drag-hover",b=n(d.onDragEnter),m=n(d.onDragLeave),D=r.$on("ANGULAR_DRAG_START",function(e,a,r,c){p=r;var h=!0;if(g(r,v)||(h=!1),h&&d.dropValidate){h=n(d.dropValidate)(t,{$drop:{scope:t,element:o},$event:a,$data:c.data,$channel:c.channel})}h?(o.bind("dragover",i),o.bind("dragenter",s),o.bind("dragleave",f),o.bind("drop",l),o.addClass($)):(o.bind("dragover",u),o.bind("dragenter",u),o.bind("dragleave",u),o.bind("drop",u),o.removeClass($))}),A=r.$on("ANGULAR_DRAG_END",function(){o.unbind("dragover",i),o.unbind("dragenter",s),o.unbind("dragleave",f),o.unbind("drop",l),o.removeClass(h),o.removeClass($),o.unbind("dragover",u),o.unbind("dragenter",u),o.unbind("dragleave",u),o.unbind("drop",u)});t.$on("$destroy",function(){D(),A()}),d.$observe("dropChannel",function(e){e&&(v=e)})}}]),n.constant("$dragImageConfig",{height:20,width:200,padding:10,font:"bold 11px Arial",fontColor:"#eee8d5",backgroundColor:"#93a1a1",xOffset:0,yOffset:0}),n.service("$dragImage",["$dragImageConfig",function(a){function n(e,a,n){var t=e.measureText(a).width;if(t<n.width)return a;for(;t+n.padding>n.width;)a=a.substring(0,a.length-1),t=e.measureText(a+r).width;return a+r}var r="â€¦";this.generate=function(r,t){var o=e.extend({},a,t||{}),d=document.createElement("canvas");d.height=o.height,d.width=o.width;var i=d.getContext("2d");i.fillStyle=o.backgroundColor,i.fillRect(0,0,o.width,o.height),i.font=o.font,i.fillStyle=o.fontColor;var f=n(i,r,o);i.fillText(f,4,o.padding+4);var s=new Image;return s.src=d.toDataURL(),{image:s,xOffset:o.xOffset,yOffset:o.yOffset}}}])}(angular);