define(["require","angular"],function(n,t){var e=t.module("nd.util",[]);e.factory("$identifier",function(){var n=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return{guid:function(t){return!0===t?n()+n()+n()+n()+n()+n()+n()+n():n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()}}}),e.factory("$urlHelper",["$location",function(n){var e={protocol:/([^\/]+):\/\/(.*)/i,host:/(^[^\:\/]+)((?:\/|:|$)?.*)/,port:/\:?([^\/]*)(\/?.*)/,path:/([^\?#]+)(\??[^#]*)(#?.*)/},r=function(n){return encodeURIComponent(n).replace(/\'/g,"%27")};return{buildUrl:function(n,e,o,i){if(!n)return n;var u,a,s;!0===e||!1===e?(u=[],a={},s=e):t.isString(e)||t.isArray(e)||!t.isObject(e)?(u=t.isArray(e)?e:[e],t.isObject(o)?(a=o,s=!1!==i):(a={},s=!1!==o)):(u=[],a=e,s=!1!==o);var c={};n=n.replace(/(\{.+?\})/g,function(n){var t,e=n.substring(1,n.length-1),o=parseInt(e);return t=isNaN(o)?a[e]:u[o],s&&t&&(t=r(t)),c[e]=!0,t||""});var f=[];for(var l in a)if(!c[l]){var p=a[l];(null===p||t.isUndefined(p))&&(p=""),t.isArray(p)||(p=[p]);for(var d=0;d<p.length;d++){var h=p[d];t.isObject(h)&&(h=t.toJson(h)),f.push((s?r(l):l)+"="+(s?r(h):h))}}return f.length>0&&(n+=(-1==n.indexOf("?")?"?":"&")+f.join("&")),n},analyse:function(t){if(!t||"/"==t)return{host:n.host(),protocol:n.protocol(),port:n.port(),path:"/"};0==t.indexOf("/")&&(t=n.protocol()+"://"+n.host()+":"+n.port()+t);try{var r,o={};o.href=t;for(var i in e)r=e[i].exec(t),o[i]=r[1],t=r[2],""===t&&(t="/"),"path"===i&&(o.uri=r[1]+r[2],o.path=r[1],o.search=r[2],o.hash=r[3]);return o}catch(n){return null}},populate:function(n){return n.protocol+"://"+host+(n.port?":"+n.port:"")+(n.path?"/"+n.path:"")+(n.hash?"#"+n.hash:"")+(n.search?"?"+n.search:"")}}}]),e.directive("ndArray",function(){return{require:"ngModel",priority:1e3,link:function(n,e,r,o){var i=function(n){var e=r.value,i=o.$modelValue,u=[];if(n){var a=!1;if(t.isArray(i))for(var s=0;s<i.length;s++)u.push(i[s]),e==i[s]&&(a=!0);a||u.push(e)}else if(t.isArray(i))for(var s=0;s<i.length;s++)e!=i[s]&&u.push(i[s]);return u},u=function(e){var o=r.value;if(!o){var i=r.ngValue;i&&(o=n.$eval(i))}if(t.isArray(e))for(var u=0;u<e.length;u++)if(o==e[u])return!0;return!1};o.$parsers.push(i),o.$formatters.push(u),o.$isEmpty=function(n){return!n||!n.length}}}}),e.directive("ndDrag",["$parse","$document",function(n,t){return{compile:function(e,r){var o=n(r.ndDrag),i=n(r.startDrag);return function(n,e){var r,u,a,s,c=function(e){if(0!=e.button)return void t.off("mousemove",c);e.incrementX=e.clientX-a,e.incrementY=e.clientY-s,e.startX=a,e.startY=s,n.$apply(function(){o(n,{$event:e})}),r=e.clientX,u=e.clientY,e.preventDefault(),e.stopPropagation()},f=function(n){t.off("mousemove",c),t.off("mouseup",f)};e.on("mousedown",function(e){0==e.button&&(r=a=e.clientX,u=s=e.clientY,n.$apply(function(){i(n,{$event:e})}),t.on("mousemove",c),t.on("mouseup",f),e.preventDefault(),e.stopPropagation())})}}}}]),e.directive("ndEnter",["$parse",function(n){return{compile:function(t,e){var r=n(e.ndEnter);return function(n,t){t.on("keypress",function(t){13===t.which&&(n.$apply(function(){r(n,{$event:t})}),t.preventDefault())})}}}}]),e.directive("ndCancel",["$parse",function(n){return{compile:function(t,e){var r=n(e.ndCancel);return function(n,t){t.on("keypress",function(t){27===t.which&&(n.$apply(function(){r(n,{$event:t})}),t.preventDefault())})}}}}]),e.directive("ndLoad",function(){return function(n,t,e){t.on("load",function(t){n.$apply(function(){n.$eval(e.ndLoad)})})}}),e.directive("ndDefaultSrc",function(){return function(n,t,e){var r=function(){t.off("error",r),t.attr("src",e.ndDefaultSrc)};t.on("error",r)}}),e.directive("ngTextTruncate",["$compile","ValidationServices","CharBasedTruncation","WordBasedTruncation",function(n,t,e,r){return{restrict:"A",scope:{otext:"=ngTextTruncate",charsThreshould:"@ngTtCharsThreshold",wordsThreshould:"@ngTtWordsThreshold",customMoreLabel:"@ngTtMoreLabel",customLessLabel:"@ngTtLessLabel"},controller:function(n,t,e){n.toggleShow=function(){n.open=!n.open},n.useToggling=void 0===e.ngTtNoToggling},link:function(n,o,i){n.open=!1,n.text=$("<div/>").html(n.otext).text(),t.failIfWrongThreshouldConfig(n.charsThreshould,n.wordsThreshould);var u=parseInt(n.charsThreshould),a=parseInt(n.wordsThreshould);n.$watch("text",function(){o.empty(),u?n.text&&e.truncationApplies(n,u)?e.applyTruncation(u,n,o):o.append(n.text):n.text&&r.truncationApplies(n,a)?r.applyTruncation(a,n,o):o.append(n.text)})}}}]).factory("ValidationServices",function(){return{failIfWrongThreshouldConfig:function(n,t){if(!n&&!t||n&&t)throw"You must specify one, and only one, type of threshould (chars or words)"}}}).factory("CharBasedTruncation",["$compile",function(n){return{truncationApplies:function(n,t){return n.text.length>t},applyTruncation:function(e,r,o){if(r.useToggling){var i=t.element("<span ng-click='toggleShow()'>"+r.text.substr(0,e)+"<span ng-show='!open'></span><span class='btn-link ngTruncateToggleText' ng-show='!open'> "+(r.customMoreLabel?r.customMoreLabel:"...")+"</span><span ng-show='open'>"+r.text.substring(e)+"<span class='btn-link ngTruncateToggleText' "+(r.customLessLabel?r.customLessLabel:"...")+"</span></span></span>");n(i)(r),o.append(i)}else o.append(r.text.substr(0,e)+"...")}}}]).factory("WordBasedTruncation",["$compile",function(n){return{truncationApplies:function(n,t){return n.text.split(" ").length>t},applyTruncation:function(e,r,o){var i=r.text.split(" ");if(r.useToggling){var u=t.element("<span ng-click='toggleShow()'>"+i.slice(0,e).join(" ")+" <span ng-show='!open'>...</span><span class='btn-link ngTruncateToggleText' ng-show='!open'> "+(r.customMoreLabel?r.customMoreLabel:"...")+"</span><span ng-show='open'>"+i.slice(e,i.length).join(" ")+"<span class='btn-link ngTruncateToggleText' "+(r.customLessLabel?r.customLessLabel:"...")+"</span></span></span>");n(u)(r),o.append(u)}else o.append(i.slice(0,e).join(" ")+"...")}}}]),e.directive("ndRepeatFinished",["$timeout",function(n){return{restrict:"A",scope:{eventName:"@ndRepeatFinished"},link:function(t,e,r){!0===t.$parent.$last&&n(function(){t.$emit(t.eventName)})}}}]),e.filter("dict",function(){return function(n,t,e,r,o){if(!t||t.length<1)return"";e=e||"identifier",r=r||"title";for(var i=0;i<t.length;i++)if(t[i][e]==n)return t[i][r]||o||"";return o||""}}),e.filter("dicts",function(){return function(n,t,e,r){if(!t||t.length<1||!n||n.length<1)return"";e=e||"identifier",r=r||"title";for(var o=[],i=0;i<n.length;i++)for(var u=0;u<t.length;u++)if(t[u][e]==n[i]){o.push(t[u][r]);break}return o.join(",")}}),e.filter("encodeURI",function(){return function(n){return n?encodeURI(n):""}}),e.filter("encodeURIComponent",function(){return function(n){return n?encodeURIComponent(n):""}}),e.filter("escape",function(){return function(n){return n?escape(n):""}}),e.filter("trust",["$sce",function(n){return function(t){return n.trustAsHtml(t)}}]),e.filter("fileName",[function(){return function(n){if(!n)return"";var t=n.lastIndexOf("/");return-1!=t&&(n=n.substring(t+1)),n}}]),e.filter("fileSize",[function(){return function(n){return n?isNaN(n)?"":n<1024?n+" B":(n/=1024)<1024?n.toFixed(0)+" KB":(n/=1024)<1024?n.toFixed(1)+" MB":(n/=1024,n<1024?n.toFixed(2)+" GB":void 0):""}}]),e.filter("duration",[function(){return function(n){if(!n)return"";var t=parseInt(n),e=0,r=0;return t>60&&(e=parseInt(t/60),t=parseInt(t%60),e>60&&(r=parseInt(e/60),e=parseInt(e%60))),(r<10?"0"+r:r)+":"+(e<10?"0"+e:e)+":"+(t<10?"0"+t:t)}}]),e.filter("duration_to_iso",[function(){return function(n){return r(n)||""}}]),e.filter("duration_from_iso",[function(){return function(n){return o(n)||""}}]),e.factory("$isoDate",[function(){return{durationToSecond:o,secondToDuration:r}}]);var r=function(n){if(n){if(!/^\d+$/.test(n))return!1;if(n=parseInt(n),isNaN(n)||n<=0)return!1;var t=n,e=0,r=0;return t>=60&&(e=parseInt(t/60),t=parseInt(t%60),e>=60&&(r=parseInt(e/60),e=parseInt(e%60))),"PT"+(r<=0?"":r+"H")+(e<=0?"":e+"M")+t+"S"}},o=function(n){if(!n)return null;for(var t=0,e="",r=!0,o=function(n){var r=parseInt(e);r&&(t+=r*n),e=""},i=0;i<n.length;i++){var u=n.charAt(i);switch(u){case"P":break;case"Y":o(31536e3);break;case"M":o(r?2592e3:60);break;case"D":o(86400);break;case"T":r=!1;break;case"H":o(3600);break;case"S":o(1);break;default:e+=u}}return t};e.directive("ndDuration",["$timeout",function(n){return{restrict:"A",require:"ngModel",link:function(n,t,e,i){var u=function(n){var t=r(n);return!1===t?void i.$setValidity("integer",!1):(i.$setValidity("integer",!0),t)},a=function(n){return o(n)};i.$parsers.push(u),i.$formatters.push(a)}}}])});