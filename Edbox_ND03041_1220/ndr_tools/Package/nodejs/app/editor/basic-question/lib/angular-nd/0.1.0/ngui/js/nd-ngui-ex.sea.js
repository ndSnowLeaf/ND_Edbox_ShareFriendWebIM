define(["require","angular","angular-ngui","jquery"],function(e,t){var n=t.module("nd.ngui");n.directive("ndDialog",["$animate","$q","$document","$layer",function(e,n,o,r){return{template:'<div ng-show="isShow" class="nd-dialog" ng-style="{\'width\':width,\'height\':height}"><div class="nd-dialog-title"><span ng-bind="title"></span><div class="nd-dialog-tools"><a href="javascript:void(0);" class="close" ng-click="name.close()"></a></div></div><div class="nd-dialog-content"></div></div>',transclude:"true",restrict:"A",replace:!0,scope:{name:"=",title:"@dialogTitle",width:"@",height:"@",open:"@",onClose:"&"},link:function(i,l,c,a,s){i.isShow=!1;var d,u,f=!1,p=t.element('<div class="nd-dialog-mask"></div>'),h={};i.$watch("isOpen",function(n){if(!0===n){var c=r.topIndex();f||(s(i.$parent,function(e){h.clone=e,t.element(l.children()[1]).append(e)}),f=!0,e.enter(l,o.find("body"))),l.css("z-index",1050+(c&&2||0)+10*c+""),p.css("z-index",1050+(c&&1||0)+10*c+""),e.enter(p,o.find("body")),i.isShow=!0,d&&d.resolve({element:h.clone})}else e.leave(p),i.isShow=!1});var m=i.title||"",v=i.width||"auto",g=i.height||"auto";i.name={open:function(e){return e||(e={}),i.title=e.title||m,i.width=e.width||v,i.height=e.height||g,i.isOpen=!0,d=n.defer(),u=n.defer(),{openPromise:d.promise,closePromise:u.promise}},close:function(e){i.isOpen=!1,i.onClose({data:e}),u&&u.resolve({data:e,element:h.clone})},isOpen:function(){return i.isOpen}},i.clickBtn=function(e){},"true"===i.open&&i.name.open()}}}]),n.directive("colorPicker",function(){return{replace:!0,restrict:"A",template:'<div class="color-picker"><table><thead><tr><td colspan="{{cols}}" ng-click="selectColor(\'inherit\')" translate>common.label.auto</td></tr></thead><tbody><tr ng-repeat="row in colors"><td ng-repeat="c in row"><span ng-style="{\'background-color\':c}" ng-click="selectColor(c)"></span></td></tr></tbody></table></div>',scope:{onSelect:"&"},link:function(e,t,n,o){var r=["ff7d7e","fcff80","82ff7f","00fe82","7ffffe","0080ff","fe80c0","ff7dff","ff0000","feff00","85fd00","00ff34","04fefd","0081bd","7f80c1","f801ff","7d4140","ff7f3f","00ff00","047d85","00417d","817ffe","810040","f9047b","8a0000","fd8100","008101","017f42","0000ff","0000a0","7e0181","8100ff","430001","7e4003","024001","00403f","02007d","000041","3d0141","41007e","000000","7e8001","80813f","808080","3d827f","c0c0c0","40003f","ffffff"],i=function(){var t=8;e.cols&&(t=parseInt(e.cols)),e.colors=[];for(var n=0,o=0,i=0;i<r.length;i++){o>=t&&(n++,o=0);var l=e.colors[n];l||(l=e.colors[n]=[]),l[o++]="#"+r[i]}};e.cols||(e.cols=8),e.$watch("cols",function(e){i()}),e.selectColor=function(t){e.onSelect({color:t})}}}}),n.directive("pixelPicker",function(){return{replace:!0,restrict:"A",template:'<div class="pixel-picker"><ul><li ng-repeat="pixel in pixels" ng-bind="pixel" ng-click="selectPixel(pixel)"></li></ul></div>',scope:{onSelect:"&"},link:function(e,t,n,o){e.pixels=[8,9,10,11,12,14,16,18,20,22,24,26,28,36,48,72],e.selectPixel=function(t){e.onSelect({pixel:t})}}}}),n.directive("tagInput",function(){return{replace:!0,restrict:"AE",template:'<div class="form-control-tag"><div><span class="label label-default" ng-repeat="tag in tags"><span ng-bind="tag.text"></span><button type="button" ng-click="remove(tag)" class="close" aria-label="Close"><span aria-hidden="true">&times;</span></button></span></div><input type="text" class="form-control" placeholder="输入后按回车键" ng-model="text" ng-keypress="onKeypress($event)"/></div>',require:"?ngModel",scope:!0,link:function(e,n,o,r){if(e.tags=[],e.text="",r){r.$formatters.push(function(n){if(e.tags.length=0,t.isArray(n))for(var o=0;o<n.length;o++)e.tags.push({text:n[o]})});var i=function(){for(var t=[],n=0;n<e.tags.length;n++)t.push(e.tags[n].text);r.$setViewValue(t)};e.onKeypress=function(t){13==t.keyCode&&(e.text&&(e.tags.push({text:e.text}),e.text="",i()),t.preventDefault(),t.stopPropagation())},e.remove=function(t){for(var n=0;n<e.tags.length;n++)if(e.tags[n]==t){e.tags.splice(n,1);break}i()}}}}});var o=e("jquery");return n.directive("layoutBorder",["$timeout","$document",function(e,t){return{restrict:"C",scope:!1,link:function(e,n,r){var i=o(n),l=function(){return i.children(".lr-left").outerWidth()||0},c=function(){return i.children(".lr-right").outerWidth()||0},a=function(){return i.children(".lr-top").outerHeight()||0},s=function(){return i.children(".lr-bottom").outerHeight()||0};e.$watch(l,function(e){i.children(".lr-left").nextAll(".lr-top,.lr-bottom").css("left",e+"px"),i.children(".lr-center").css("left",e+"px")}),e.$watch(c,function(e){i.children(".lr-right").nextAll(".lr-top,.lr-bottom").css("right",e+"px"),i.children(".lr-center").css("right",e+"px")}),e.$watch(a,function(e){i.children(".lr-top").nextAll(".lr-left,.lr-right").css("top",e+"px"),i.children(".lr-center").css("top",e+"px")}),e.$watch(s,function(e){i.children(".lr-bottom").nextAll(".lr-left,.lr-right").css("bottom",e+"px"),i.children(".lr-center").css("bottom",e+"px")});var d=function(t,n){e.$apply(function(){var e=i.find(".lr-left");e.width(Math.max(10,e.width()+t))})},u=function(t,n){e.$apply(function(){var e=i.find(".lr-right");e.width(Math.max(10,e.width()-t))})},f=function(t,n){e.$apply(function(){var e=i.find(".lr-top");e.height(Math.max(10,e.height()+n))})},p=function(t,n){e.$apply(function(){var e=i.find(".lr-bottom");e.height(Math.max(10,e.height()-n))})},h=!1;i.find(".lr-split").click(function(t){e.$apply(function(){h||(o(t.target).parents(".lr-left,.lr-right,.lr-top,.lr-bottom").toggleClass("collapsed"),t.preventDefault(),t.stopPropagation())})}).mousedown(function(e){h=!1;var n,r,i,l=o(e.target);l.parents(".lr-left:not(.collapsed)").length?n=d:l.parents(".lr-right:not(.collapsed)").length?n=u:l.parents(".lr-top:not(.collapsed)").length?n=f:l.parents(".lr-bottom:not(.collapsed)").length&&(n=p),n&&(r=e.clientX,i=e.clientY,o(t).on("mousemove.split_drag",o.proxy(function(e){var t=e.clientX-this.x,n=e.clientY-this.y;this.x=e.clientX,this.y=e.clientY,this.resizeFn(t,n),h=!0},{resizeFn:n,x:r,y:i})).mouseup(function(e){o(t).off(".split_drag")})),e.preventDefault(),e.stopPropagation()})}}}]),n.directive("layerBackdrop",["$layer",function(e){return{restrict:"EA",replace:!0,template:'<div class="layer-backdrop" ng-if="$$index>=0" ng-style="{\'z-index\': 1040 + ($$index && 1 || 0) + $$index*10}" ng-click="$$clickToClose($event)"></div>',link:function(t,n,o){t.$$clickToClose=function(t){var n=e.top();n&&n.$$backdrop&&"static"!=n.$$backdrop&&t.target===t.currentTarget&&(t.preventDefault(),t.stopPropagation(),n.close())}}}}]),n.directive("layerContent",["$layer","$timeout",function(e,t){return{restrict:"EA",replace:!0,transclude:!0,template:'<div class="layer-wrap" ng-class="{\'backdrop\':$$backdrop}" tabindex="-1" ng-keydown="$$onKeydown($event)" ng-style="{\'z-index\': 1050 + $$index*10, display: \'block\'}" layer-transclude ng-click="$$clickToClose($event)"></div>',link:function(n,o,r){n.$$clickToClose=function(t){var n=e.top();n&&n.$$backdrop&&"static"!=n.$$backdrop&&t.target===t.currentTarget&&(t.preventDefault(),t.stopPropagation(),n.close())},t(function(){var e=o[0].querySelectorAll("[autofocus]");e.length?e[0].focus():o[0].focus()})}}}]),n.directive("layerTransclude",function(){return{link:function(e,t,n,o,r){r(e,function(e){t.empty(),t.append(e)})}}}),n.factory("$resolver",function(){return{}}),n.factory("$layer",["$http","$q","$timeout","$templateCache","$animate","$document","$rootScope","$controller","$compile",function(e,n,o,r,i,l,c,a,s){function d(){for(var e=-1,t=0;t<m.length;t++)m[t].$$backdrop&&m[t].opened&&(e=Math.max(e,m[t].$$index));return e}function u(){for(var e,t=0;t<m.length;t++)m[t].opened&&(!e||m[t].$$index>e.$$index)&&(e=m[t]);return e}function f(o){return o.template?n.when(o.template):o.templateUrl?e.get(t.isFunction(o.templateUrl)?o.templateUrl():o.templateUrl,{cache:r}).then(function(e){return e.data}):n.when("")}var p,h,m=[],v=1,g={};return c.$watch(d,function(e){if(h)h.$$index=e;else if(e>=0){h=c.$new(!0),h.$$index=e;var n=t.element("<div layer-backdrop></div>");p=s(n)(h);var o=l.find("body").eq(0);i.enter(p,o),h.$$index=e}}),l.bind("keydown",function(e){if(27===e.which){var t=u();t&&t.$$closeByEscape&&(e.preventDefault(),t.close())}}),g.top=function(){return u()},g.topIndex=function(){return m.length-1},g.create=function(e){e=t.extend({backdrop:!0,closeByEscape:!1,autoClose:!0},e);var r,d,u,p=!1,h=(e.scope||c).$new();if(e.controller){d={$$resolves:[],$$rejects:[],resolve:function(e){t.forEach(this.$$resolves,function(t){t(e)})},reject:function(e){t.forEach(this.$$rejects,function(t){t(e)})},then:function(e,n){t.isFunction(e)&&this.$$resolves.push(e),t.isFunction(n)&&this.$$rejects.push(n)}};t.forEach(e.resolve,function(e,n){"$then"==n?d.then(e):d[n]=t.isFunction(e)?e():e});var g={$scope:h,$resolver:d};r=a(e.controller,g),e.controllerAs&&(h[e.controllerAs]=r)}var $,b,y=f(e).then(function(n){if(t.isFunction(e.compile)){var o=e.compile(h,n,e);o&&(n=o)}var r=t.element("<div layer-content></div>");t.isString(n)?r.html(n):r.append(n),u=s(r)(h)});h.$$backdrop=e.backdrop;var k={opened:!1,$$backdrop:e.backdrop,$$closeByEscape:e.closeByEscape,open:function(){if(p)throw new Error("the layer is destroyed, can not open again.");if($=n.defer(),b=n.defer(),k.opened)$.reject();else{k.$$index=h.$$index=v++,k.opened=!0;var r;e.parent?r=t.element(r):e.parentSelector&&(r=l.find(e.parentSelector).eq(0)),r&&r[0]||(r=l.find("body").eq(0)),u?(i.enter(u,r),k.contentEl=u,$.resolve()):y.then(function(){i.enter(u,r),k.contentEl=u,$.resolve()})}var c=function(e){return k.close(e),c};return t.extend(c,{thenOpen:function(e){return $.promise.then(e),c},thenClose:function(e){return b.promise.then(e),c},autoClose:function(e){if(e&&e.then)e.then(function(){k.close()});else{var t=parseInt(e);isNaN(t)||o(function(){k.close()},t)}return c},close:function(e){return c(e),c},bindClose:function(e){return function(){c(e)}}}),c.thenOpen(e.onOpen).thenClose(e.onClose),c},close:function(t){k.opened&&(k.opened=!1,u&&i.leave(u),!1!==e.autoDestroy&&k.destroy(),b&&b.resolve(t))},destroy:function(){h.$destroy(),delete h,delete r,delete d,delete u,p=!0},ctrl:r};return e.autoClose&&d&&d.then(function(e){k.close(e)},function(e){k.close(e)}),h.$close=k.close,h.$reject=function(e){d?d.reject(e):k.close(e)},h.$resolve=function(e){d?d.resolve(e):k.close(e)},m.push(k),k},g}]),n.provider("$console",function(){var e={fullModalParentSelector:"body",$get:["$layer","$q","$module","$i18n",function(n,o,r,i){var l,c={},a=o.defer(),s=function(e,t,o){var r='<div class="layer-text">'+(e||"")+"</div>";return r=o?'<div class="layer-message layer-state"><div class="layer-state-'+o+'"></div>'+r+"</div>":'<div class="layer-message">'+r+"</div>",n.create({template:r,autoDestroy:!0,backdrop:t}).open().autoClose(a.promise)},d=function(e,n,r){n=n||0;var i=-1,l=o.defer();this.promise=l.promise;var c,a=!1,d=[],u=function(){c&&c.resolve(),l.resolve(d),a=!0},f=function(e){c&&c.resolve(),l.reject(e),a=!0},p=function(l,f){if(!a){if(isNaN(parseInt(l))&&(f=l,l=t.isArray(f)?f.length:1),(i+=l)>0)for(var p=0;p<l;p++)d.push(t.isArray(f)?vlaue[p]:f);i>=n?u():(c&&c.resolve(),c=o.defer(),s(e+"："+(i+1)+"/"+n,r,"wait").autoClose(c.promise))}};this.commit=function(e,t){p(e,t)},this.complete=function(){a||u()},this.destroy=function(e){a||f(e)},p()};c.message=function(e){l&&l.resolve(),l=o.defer(),s(e,!1).autoClose(2e3).autoClose(l.promise)},c.wait=function(e,t){return s(e,!1!==t&&"static","wait")},c.block=function(e,t){return n.create({template:'<div class="layer-text blockonly">&nbsp;</div>',autoDestroy:!0,backdrop:t}).open()},c.counter=function(e,t,n){return new d(e,t,!1!==n&&"static")},c.complete=function(){a.resolve(),a=o.defer()};var u=[{name:"yes",title:i("common.label.yes"),show:!1,primary:!0,keyCode:13},{name:"no",title:i("common.label.no"),show:!1,primary:!1},{name:"cancel",title:i("common.label.cancel"),show:!1,primary:!1,keyCode:27},{name:"ok",title:i("common.label.ok"),show:!1,primary:!0,keyCode:13},{name:"close",title:i("common.label.close"),show:!1,primary:!1,keyCode:[13,27]}],f=function(e){e=t.extend({title:i("common.label.dialog"),state:"default",size:"sm",showClose:!0},e);var o='<div class="modal-dialog state_'+e.state+'" ng-class="\'modal-\'+size"><div class="modal-content"><div ng-class="\'modal-\'+state" class="nd-modal"><div class="modal-header"><button ng-if="showClose" type="button" class="close" ng-click="$close(\'close\')" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button><h4 class="modal-title" ng-bind-html="title | trust"></h4></div><div class="modal-body" style="padding: 30px 20px;"><div class="txt"><h6 ng-bind-html="content | trust"></h6></div></div><div class="modal-footer"><button ng-repeat="btn in buttons" type="button" class="btn btn-lg" ng-class="{\'btn-primary\':btn.primary,\'btn-default\':!btn.primary}" ng-click="$close(btn.name)" ng-bind="btn.title"></button></div></div></div></div>';return n.create({template:o,autoDestroy:!0,backdrop:"static",controller:["$scope",function(n){n.title=e.title,n.content=e.content,n.state=e.state,n.size=e.size,n.showClose=e.showClose;var o=e.buttons?t.isArray(e.buttons)?e.buttons:[e.buttons]:[];n.buttons=[];for(var r=0;r<o.length;r++)for(var i=0;i<u.length;i++)o[r]==u[i].name&&n.buttons.push(u[i]);n.$$onKeydown=function(e){for(var o=e.keyCode,r=0;r<n.buttons.length;r++){var i=n.buttons[r];if(t.isArray(i.keyCode)){for(var l=!1,c=0;c<i.keyCode.length;c++)if(i.keyCode[c]==o){l=!0;break}if(l){n.$close(i.name);break}}else if(i.keyCode==o){n.$close(i.name);break}}}}]}).open()};return c.prompt=function(e,n,o,r){return f({title:t.isString(n)?e:i("common.label.message.info"),content:t.isString(n)?n:e,buttons:["close"],state:r}).thenClose(function(e){(o=t.isFunction(n)?n:o||t.noop)()})},c.info=function(e,t,n){return c.prompt(e,t,n,"success")},c.success=function(e,t,n){return c.prompt(e,t,n,"success")},c.warn=function(e,t,n){return c.prompt(e,t,n,"fail")},c.alert=function(e,t,n){return c.prompt(e,t,n,"fail")},c.error=function(e,t,n){return c.prompt(e,t,n,"fail")},c.confirm=function(e,n,o,r){return f({title:t.isString(n)?e:i("common.label.message.info"),content:t.isString(n)?n:e,buttons:["ok","cancel"],state:"confirm",showClose:!1}).thenClose(function(e){"ok"==e?((o=t.isFunction(n)?n:o)||t.noop)():"cancel"==e&&((r=t.isFunction(n)?o:r)||t.noop)()})},c.ask=function(e,n,o,r,l){return f({title:t.isString(n)?e:i("common.label.message.info"),content:t.isString(n)?n:e,buttons:["yes","no","cancel"],state:"confirm",showClose:!1}).thenClose(function(e){"yes"==e?((o=t.isFunction(n)?n:o)||t.noop)():"no"==e?((r=t.isFunction(n)?o:r)||t.noop)():"cancel"==e&&((l=t.isFunction(n)?r:l)||t.noop)()})},c.dialog=function(e){return f(e)},c.createModal=function(o){if(o=t.extend({size:"lg",showClose:!0},o),o.src)o.template='<div class="modal-body modal-iframe"><iframe src="'+o.src+'"></iframe></div>';else if(o.module){var i=r(o.module);o.templateUrl=i.template(o.page),t.isUndefined(o.controller)&&(o.controller=i.controller(o.page))}return o.compile=function(e,t){var n='<div class="modal-dialog modal-'+o.size+'"><div class="modal-content" style="'+(o.height?"height:"+o.height+"px":"")+'">';return(o.title||o.showClose)&&(n+='<div class="modal-header">',o.showClose&&(n+='<button type="button" class="close" ng-click="$close(\'close\')" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>'),n+='<h3 class="modal-title">'+(o.title||"&nbsp;")+"</h3></div>"),n+=t+"</div></div>"},"full"==o.size&&(o.parentSelector=e.fullModalParentSelector),n.create(o)},c.modal=function(e){return c.createModal(e).open()},c}]};return e}),t});