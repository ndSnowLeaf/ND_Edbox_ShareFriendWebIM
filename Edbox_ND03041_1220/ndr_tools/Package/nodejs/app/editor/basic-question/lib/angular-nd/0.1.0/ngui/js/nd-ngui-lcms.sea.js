define(["require","angular"],function(e,n){return n.module("nd.ngui",["nd.ngui.tpls","nd.ngui.lcms","nd.ngui.modal","nd.ngui.treeview"]),n.module("nd.ngui.tpls",["template/lcms/multiselector.html","template/lcms/nodeReorder.html","template/lcms/relationMap.html","template/modal/backdrop.html","template/modal/window.html","template/treeview/ndTreeview.html"]),n.module("nd.ngui.lcms",[]).filter("msSelectedLabel",function(){return function(e,n){return e=e||0,n.replace(/{n}/,e)}}).constant("lcmsMultiSelectorConfig",{labels:{title:"知识点选择",btn:"选择知识点",top:"学科选择",sub:"知识点选择",selected:"已选择({n})个知识点",searchTip:"请输入要查找的知识点"}}).controller("lcmsMultiSelectorController",["$scope","$attrs","lcmsMultiSelectorConfig",function(e,t,l){e.tmpModel=void 0,e.labels=n.extend(e.labels,l.labels),e.showPanel=!1,e.currentOptions=[],e.searchKey=null,e.tmpModel=[],e.activeGroupIdx=null;var o;this.init=function(e){o=e},e.save=function(){o.$setViewValue(n.copy(e.tmpModel)),e.cancel()},e.doAdd=function(n){e.tmpModel.indexOf(n)>=0||e.tmpModel.push(n)},e.toggleOptionsGroup=function(n){e.searchKey=null,e.activeGroupIdx=n,e.currentOptions=e.options[n]},e.open=function(){e.showPanel=!0,e.tmpModel=n.copy(o.$viewValue)},e.togglePanel=function(){e.showPanel?e.cancel():e.open()},e.doRemove=function(n){e.tmpModel.splice(n,1)},e.cancel=function(){e.showPanel=!1,e.tmpModel=[]}}]).directive("lcmsMultiSelector",[function(){return{scope:{labels:"=",options:"="},controller:"lcmsMultiSelectorController",require:["ngModel","lcmsMultiSelector"],restrict:"E",templateUrl:"template/lcms/multiselector.html",replace:!0,link:function(e,n,t,l){var o=l[0];l[1].init(o)}}}]).directive("lcmsRelationMap",[function(){return{scope:{mapData:"="},restrict:"E",templateUrl:"template/lcms/relationMap.html",link:function(e,n,t,l){}}}]).filter("idx2order",function(){return function(e){return e+1}}).directive("lcmsNodeReorder",[function(){return{require:"ngModel",restrict:"E",templateUrl:"template/lcms/nodeReorder.html",replace:!0,link:function(e,t,l,o){function i(t){var l;n.forEach(e.tmpModel,function(e){e.edit&&(l=e)});var o=l.order,i=o+t;n.forEach(e.tmpModel,function(n,t){console.log(n),n.order==i&&(e.tmpModel[t].order=o,l.order=i)})}e.tmpModel=void 0,e.showPanel=!1,e.editItem=null,e.edit=function(){e.tmpModel=n.copy(o.$viewValue),e.showPanel=!0},e.moveUp=function(e){i(-1)},e.moveDown=function(e){i(1)},e.cancel=function(){e.tmpModel=n.copy(o.$viewValue),e.showPanel=!1},e.save=function(){o.$setViewValue(e.tmpModel),o.$render(),e.showPanel=!1},o.$render=function(){e.tmpModel=n.copy(o.$viewValue),n.forEach(e.tmpModel,function(n){n.edit&&(e.editItem=n)})}}}}]),n.module("nd.ngui.modal",["nd.ngui.transition"]).factory("$$stackedMap",function(){return{createNew:function(){var e=[];return{add:function(n,t){e.push({key:n,value:t})},get:function(n){for(var t=0;t<e.length;t++)if(n==e[t].key)return e[t]},keys:function(){for(var n=[],t=0;t<e.length;t++)n.push(e[t].key);return n},top:function(){return e[e.length-1]},remove:function(n){for(var t=-1,l=0;l<e.length;l++)if(n==e[l].key){t=l;break}return e.splice(t,1)[0]},removeTop:function(){return e.splice(e.length-1,1)[0]},length:function(){return e.length}}}}}).directive("modalBackdrop",["$timeout",function(e){return{restrict:"EA",replace:!0,templateUrl:"template/modal/backdrop.html",link:function(n,t,l){n.backdropClass=l.backdropClass||"",n.animate=!1,e(function(){n.animate=!0})}}}]).directive("modalWindow",["$modalStack","$timeout",function(e,n){return{restrict:"EA",scope:{index:"@",animate:"="},replace:!0,transclude:!0,templateUrl:function(e,n){return n.templateUrl||"template/modal/window.html"},link:function(t,l,o){l.addClass(o.windowClass||""),t.size=o.size,n(function(){t.animate=!0,l[0].querySelectorAll("[autofocus]").length||l[0].focus()}),t.close=function(n){var t=e.getTop();t&&t.value.backdrop&&"static"!=t.value.backdrop&&n.target===n.currentTarget&&(n.preventDefault(),n.stopPropagation(),e.dismiss(t.key,"backdrop click"))}}}}]).directive("modalTransclude",function(){return{link:function(e,n,t,l,o){o(e.$parent,function(e){n.empty(),n.append(e)})}}}).factory("$modalStack",["$transition","$timeout","$document","$compile","$rootScope","$$stackedMap",function(e,t,l,o,i,a){function c(){for(var e=-1,n=v.keys(),t=0;t<n.length;t++)v.get(n[t]).value.backdrop&&(e=t);return e}function r(e){var n=l.find("body").eq(0),t=v.get(e).value;v.remove(e),s(t.modalDomEl,t.modalScope,300,function(){t.modalScope.$destroy(),n.toggleClass(m,v.length()>0),d()})}function d(){if(u&&-1==c()){var e=p;s(u,p,150,function(){e.$destroy(),e=null}),u=void 0,p=void 0}}function s(n,l,o,i){function a(){a.done||(a.done=!0,n.remove(),i&&i())}l.animate=!1;var c=e.transitionEndEventName;if(c){var r=t(a,o);n.bind(c,function(){t.cancel(r),a(),l.$apply()})}else t(a)}var u,p,m="modal-open",v=a.createNew(),f={};return i.$watch(c,function(e){p&&(p.index=e)}),l.bind("keydown",function(e){var n;27===e.which&&(n=v.top())&&n.value.keyboard&&(e.preventDefault(),i.$apply(function(){f.dismiss(n.key,"escape key press")}))}),f.open=function(e,t){v.add(e,{deferred:t.deferred,modalScope:t.scope,backdrop:t.backdrop,keyboard:t.keyboard});var a=l.find("body").eq(0),r=c();if(r>=0&&!u){p=i.$new(!0),p.index=r;var d=n.element("<div modal-backdrop></div>");d.attr("backdrop-class",t.backdropClass),u=o(d)(p),a.append(u)}var s=n.element("<div modal-window></div>");s.attr({"template-url":t.windowTemplateUrl,"window-class":t.windowClass,size:t.size,index:v.length()-1,animate:"animate"}).html(t.content);var f=o(s)(t.scope);v.top().value.modalDomEl=f,a.append(f),a.addClass(m)},f.close=function(e,n){var t=v.get(e);t&&(t.value.deferred.resolve(n),r(e))},f.dismiss=function(e,n){var t=v.get(e);t&&(t.value.deferred.reject(n),r(e))},f.dismissAll=function(e){for(var n=this.getTop();n;)this.dismiss(n.key,e),n=this.getTop()},f.getTop=function(){return v.top()},f}]).provider("$modal",function(){var e={options:{backdrop:!0,keyboard:!0},$get:["$injector","$rootScope","$q","$http","$templateCache","$controller","$modalStack",function(t,l,o,i,a,c,r){function d(e){return e.template?o.when(e.template):i.get(n.isFunction(e.templateUrl)?e.templateUrl():e.templateUrl,{cache:a}).then(function(e){return e.data})}function s(e){var l=[];return n.forEach(e,function(e){(n.isFunction(e)||n.isArray(e))&&l.push(o.when(t.invoke(e)))}),l}var u={};return u.open=function(t){var i=o.defer(),a=o.defer(),u={result:i.promise,opened:a.promise,close:function(e){r.close(u,e)},dismiss:function(e){r.dismiss(u,e)}};if(t=n.extend({},e.options,t),t.resolve=t.resolve||{},!t.template&&!t.templateUrl)throw new Error("One of template or templateUrl options is required.");var p=o.all([d(t)].concat(s(t.resolve)));return p.then(function(e){var o=(t.scope||l).$new();o.$close=u.close,o.$dismiss=u.dismiss;var a,d={},s=1;t.controller&&(d.$scope=o,d.$modalInstance=u,n.forEach(t.resolve,function(n,t){d[t]=e[s++]}),a=c(t.controller,d),t.controllerAs&&(o[t.controllerAs]=a)),r.open(u,{scope:o,deferred:i,content:e[0],backdrop:t.backdrop,keyboard:t.keyboard,backdropClass:t.backdropClass,windowClass:t.windowClass,windowTemplateUrl:t.windowTemplateUrl,size:t.size})},function(e){i.reject(e)}),p.then(function(){a.resolve(!0)},function(){a.reject(!1)}),u},u}]};return e}),n.module("nd.ngui.treeview",[]).filter("array2path",function(){return function(e){return n.isArray(e)?e.join(" > "):e}}).directive("ndTreeview",[function(){return{scope:{treeList:"=",nodeLabel:"@",nodeChildren:"@",title:"@"},require:"ngModel",restrict:"E",templateUrl:"template/treeview/ndTreeview.html",replace:!0,link:function(e,t,l,o){function i(){var t=e.tree.fullPath,l=e.list,o=void 0,i=0,a=e.nodeLabel,c=e.nodeChildren;do{o=void 0,n.forEach(l,function(e){e[a]==t[i]&&e[c]&&(l=e[c]||null,o=e)}),i++}while(i<t.length&&o);return o}e.title=e.title||"请选择..",o.$render=function(){e.tree.fullPath=o.$viewValue,e.tree.currentNode=i(),e.tree.currentNode&&(e.tree.currentNode.selected="selected")},e.cancel=function(){e.tree.fullPath=o.$viewValue,e.showPanel=!1},e.open=function(){e.showPanel=!0},e.save=function(){o.$setViewValue(e.tree.fullPath),e.cancel()}}}}]).directive("treeview",["$compile",function(e){return{restrict:"A",link:function(t,l,o){function i(e,n){var t=[],l=e;do{t.unshift(l.node[n]),l=l.$parent||null}while(l.node&&void 0!=l.node[n]);return t}var a=o.treeId,c=o.treeModel,r=o.nodeId||"id",d=o.nodeLabel||"label",s=o.nodeChildren||"children",u='<ul class="tree-model nd-treeview"><li class="{{node.type ? \'node-\'+node.type : null}}" ng-repeat="node in '+c+'"><i class="collapsed" ng-show="node.'+s+'.length && node.collapsed" ng-click="'+a+'.selectNodeHead(node)"></i><i class="expanded" ng-show="node.'+s+'.length && !node.collapsed" ng-click="'+a+'.selectNodeHead(node)"></i><i class="normal" ng-hide="node.'+s+'.length"></i> <span ng-class="node.selected" ng-click="'+a+'.selectNodeLabel(node,this)">{{node.'+d+'}}</span><div ng-hide="node.collapsed" treeview tree-id="'+a+'" tree-model="node.'+s+'" node-id='+r+" node-label="+d+" node-children="+s+"></div></li></ul>";a&&c&&(t[a]=t[a]||{},t[a].selectNodeHead=t[a].selectNodeHead||function(e){e.collapsed=!e.collapsed},t[a].selectNodeLabel=t[a].selectNodeLabel||function(e,l){n.element(e);var o=i(l,d);t[a].currentNode&&t[a].currentNode.selected&&(t[a].currentNode.selected=void 0),e.selected="selected",t[a].currentNode=e,t[a].fullPath=o},l.html("").append(e(u)(t)))}}}]),n.module("template/lcms/multiselector.html",[]).run(["$templateCache",function(e){e.put("template/lcms/multiselector.html",'<div class="lcms-multi-selector lcms-selector">\n    <button type="button" class="btn btn-primary" ng-click="togglePanel()">{{labels.btn}}</button>\n    <div class="panel" ng-show="showPanel">\n        <h3 class="panel-title">{{labels.title}}</h3>\n        <div class="panel-body">\n            <div class="col col-subject">\n                <div class="name">{{labels.top}}</div>\n                <ul>\n                    <li ng-repeat="option in options" ng-class="{active:activeGroupIdx == $index}" ng-click="toggleOptionsGroup($index)">{{option.label}}</li>\n                </ul>\n            </div>\n            <div class="col col-knowledge">\n                <div class="name">{{labels.sub}}</div>\n                <ul>\n                    <li><input type="text" class="form-control" ng-model="searchKey" placeholder="{{labels.searchTip}}"></li>\n                    <li ng-repeat="option in currentOptions.options | filter:searchKey" title="点击添加" ng-click="doAdd(option)">{{option}}<span class="glyphicon glyphicon-plus"></span></li>\n                </ul>\n            </div>\n            <div class="col col-selected">\n                <div class="name">{{tmpModel.length | msSelectedLabel:labels.selected}}</div>\n                <ul>\n                    <li ng-repeat="item in tmpModel" title="点击移除" ng-click="doRemove($index)">{{item}}<span class="glyphicon glyphicon-minus"></span></li>\n                </ul>\n            </div>\n        </div>\n        <div class="panel-footer">\n            <button type="button" class="btn btn-primary" ng-click="save()">保存</button>\n            <button type="button" class="btn" ng-click="cancel()">取消</button>\n        </div>\n    </div>\n</div>\n')}]),n.module("template/lcms/nodeReorder.html",[]).run(["$templateCache",function(e){e.put("template/lcms/nodeReorder.html",'<div class="lcms-node-reorder lcms-selector nd-layout-col g_complex_input">\n    <div class="col-right com_ml20">\n        <button type="button" class="btn btn-primary" ng-click="edit();">选择</button>\n    </div>\n    <div class="col-compatible">\n        <span class="index">{{editItem.order | idx2order}}</span>\n        <span>{{editItem.label}}</span>\n    </div>\n\t<div class="panel" ng-show="showPanel">\n\t\t<div class="panel-title">知识点序号选择</div>\n\t\t<div class="panel-body">\n\t\t\t<ul>\n\t\t\t\t<li ng-repeat="row in tmpModel | orderBy:\'order\'" ng-class="{\'edit\':row.edit}">\n\t\t\t\t\t<span class="index">{{row.order | idx2order}}</span>\n\t\t\t\t\t<span>{{row.label}}</span>\n\t\t\t\t\t<span class="op-sort" ng-if="row.edit">\n\t\t\t\t\t\t<a class="glyphicon glyphicon-arrow-up" href="javascript:;" ng-show="!$first" ng-click="moveUp($index)"></a>\n\t\t\t\t\t\t<a class="glyphicon glyphicon-arrow-down" href="javascript:;" ng-show="!$last" ng-click="moveDown($index)"></a>\n\t\t\t\t\t</span>\n\t\t\t\t</li>\n\t\t\t</ul>\n\t\t</div>\n\t\t<div class="panel-footer">\n            <button type="button" class="btn btn-default" ng-click="cancel()">取消</button>\n            <button type="button" class="btn btn-primary" ng-click="save()">保存</button>\n\t\t</div>\n\t</div>\n</div>')}]),n.module("template/lcms/relationMap.html",[]).run(["$templateCache",function(e){e.put("template/lcms/relationMap.html",'<div class="lcms-relationmap lcms-selector">\n    <ul class="parent-nodes">\n        <li ng-repeat="node in mapData.parents" class="node-wrap" ng-class="{\'first\':$first,\'last\':$last}">\n            <div class="node">\n            \t<span ng-if="node.new" class="new">new</span>\n                <label>前置知识点</label>\n                <h4>{{node.label}}</h4>\n            </div>\n        </li>\n    </ul>\n    <div class="current-nodes">\n        <div class="node-wrap">\n            <div class="node">\n                <label>源知识点</label>\n                <h4>{{mapData.label}}</h4>\n            </div>\n        </div>\n    </div>\n    <ul class="child-nodes">\n        <li ng-repeat="node in mapData.children" class="node-wrap" ng-class="{\'first\':$first,\'last\':$last}">\n            <div class="node">\n            \t<span ng-if="node.new" class="new">new</span>\n                <label>交叉知识点</label>\n                <h4>{{node.label}}</h4>\n            </div>\n        </li>\n    </ul>\n</div>\n')}]),n.module("template/modal/backdrop.html",[]).run(["$templateCache",function(e){e.put("template/modal/backdrop.html",'<div class="modal-backdrop fade {{ backdropClass }}"\n     ng-class="{in: animate}"\n     ng-style="{\'z-index\': 1040 + (index && 1 || 0) + index*10}"\n></div>\n')}]),n.module("template/modal/window.html",[]).run(["$templateCache",function(e){e.put("template/modal/window.html",'<div tabindex="-1" role="dialog" class="modal fade" ng-class="{in: animate}" ng-style="{\'z-index\': 1050 + index*10, display: \'block\'}" ng-click="close($event)">\n    <div class="modal-dialog" ng-class="{\'modal-sm\': size == \'sm\', \'modal-lg\': size == \'lg\'}"><div class="modal-content" modal-transclude></div></div>\n</div>')}]),n.module("template/treeview/ndTreeview.html",[]).run(["$templateCache",function(e){e.put("template/treeview/ndTreeview.html",'<div class="nd-layout-col g_complex_input nd-treeview">\n    <div class="col-right com_ml20">\n        <button type="button" class="btn btn-primary" ng-click="open()">选择</button>\n    </div>\n    <div class="col-compatible">\n        <p class="tree-result">{{tree.fullPath | array2path }}</p>\n    </div>\n    <div class="modal-content" ng-show="showPanel">\n        <div class="modal_choose">\n            <div class="modal-header">{{title}}</div>\n            <div class="modal-body">\n                <div treeview tree-id="tree" tree-model="treeList" node-label="{{nodeLabel}}" node-children="{{nodeChildren}}"></div>\n            </div>\n            <div class="modal-footer">\n                <button type="button" class="btn btn-primary" ng-click="save()">保存</button>\n                <button type="button" class="btn btn-default" ng-click="cancel()">取消</button>\n            </div>\n        </div>\n    </div>\n</div>\n')}]),n});